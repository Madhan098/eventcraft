{% extends "base.html" %}

{% block title %}{{ invitation.title }} - EventCraft Pro{% endblock %}

{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
{% endblock %}

{% block content %}

{# ========================================
   TRANSLATION MACRO
   ======================================== #}
{% macro translate_text(key) %}
    {% set lang = 'english' %}
    {% if invitation.customization_data %}
        {% set customization = invitation.customization_data|from_json %}
        {% set lang = customization.language|default('english') %}
    {% endif %}
    
    {% set translations = {
        'hindi': {
            'convey_your_wishes': '‡§Ö‡§™‡§®‡•Ä ‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ‡§è‡§Ç ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç',
            'your_name': '‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ',
            'send_wish': '‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ ‡§≠‡•á‡§ú‡•á‡§Ç',
            'wish_them_with_love': '‡§Ö‡§™‡§®‡•á ‡§™‡•ç‡§Ø‡§æ‡§∞ ‡§∏‡•á ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ‡§è‡§Ç ‡§¶‡•á‡§Ç...',
            'rsvp': '‡§Ü‡§∞‡§è‡§∏‡§µ‡•Ä‡§™‡•Ä',
            'im_attending': '‡§Æ‡•à‡§Ç ‡§Ü ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç',
            'unable_to_attend': '‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§§‡•á',
            'wishes_from_loved_ones': '‡§™‡•ç‡§∞‡§ø‡§Ø‡§ú‡§®‡•ã‡§Ç ‡§∏‡•á ‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ‡§è‡§Ç',
            'view_all': '‡§∏‡§≠‡•Ä ‡§¶‡•á‡§ñ‡•á‡§Ç',
            'no_wishes_yet': '‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§ï‡•ã‡§à ‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ ‡§®‡§π‡•Ä‡§Ç‡•§ ‡§™‡§π‡§≤‡•Ä ‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ ‡§≠‡•á‡§ú‡•á‡§Ç!'
        },
        'telugu': {
            'convey_your_wishes': '‡∞Æ‡±Ä ‡∞Ü‡∞∂‡±Ä‡∞∏‡±ç‡∞∏‡±Å‡∞≤‡∞®‡±Å ‡∞§‡±Ü‡∞≤‡∞ø‡∞Ø‡∞ú‡±á‡∞Ø‡∞Ç‡∞°‡∞ø',
            'your_name': '‡∞Æ‡±Ä ‡∞™‡±á‡∞∞‡±Å',
            'send_wish': '‡∞Ü‡∞∂‡±Ä‡∞∏‡±ç‡∞∏‡±Å ‡∞™‡∞Ç‡∞™‡∞Ç‡∞°‡∞ø',
            'wish_them_with_love': '‡∞Æ‡±Ä ‡∞™‡±ç‡∞∞‡±á‡∞Æ‡∞§‡±ã ‡∞µ‡∞æ‡∞∞‡∞ø‡∞ï‡∞ø ‡∞Ü‡∞∂‡±Ä‡∞∏‡±ç‡∞∏‡±Å‡∞≤‡±Å ‡∞§‡±Ü‡∞≤‡∞ø‡∞Ø‡∞ú‡±á‡∞Ø‡∞Ç‡∞°‡∞ø...',
            'rsvp': '‡∞Ü‡∞∞‡±ç‡∞é‡∞∏‡±ç‡∞µ‡±Ä‡∞™‡±Ä',
            'im_attending': '‡∞®‡±á‡∞®‡±Å ‡∞µ‡∞∏‡±ç‡∞§‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞®‡±Å',
            'unable_to_attend': '‡∞µ‡±Ü‡∞≥‡±ç‡∞≤‡∞≤‡±á‡∞®‡±Å',
            'wishes_from_loved_ones': '‡∞™‡±ç‡∞∞‡∞ø‡∞Ø‡∞Æ‡±à‡∞® ‡∞µ‡∞æ‡∞∞‡∞ø ‡∞Ü‡∞∂‡±Ä‡∞∏‡±ç‡∞∏‡±Å‡∞≤‡±Å',
            'view_all': '‡∞Ö‡∞®‡±ç‡∞®‡±Ä ‡∞ö‡±Ç‡∞°‡∞Ç‡∞°‡∞ø',
            'no_wishes_yet': '‡∞á‡∞Ç‡∞ï‡∞æ ‡∞Ü‡∞∂‡±Ä‡∞∏‡±ç‡∞∏‡±Å‡∞≤‡±Å ‡∞≤‡±á‡∞µ‡±Å. ‡∞Æ‡±ä‡∞¶‡∞ü‡∞ø ‡∞Ü‡∞∂‡±Ä‡∞∏‡±ç‡∞∏‡±Å ‡∞™‡∞Ç‡∞™‡∞Ç‡∞°‡∞ø!'
        },
        'kannada': {
            'convey_your_wishes': '‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤Ü‡≤∂‡≥Ä‡≤∞‡≥ç‡≤µ‡≤æ‡≤¶‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤§‡≤ø‡≤≥‡≤ø‡≤∏‡≤ø',
            'your_name': '‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å',
            'send_wish': '‡≤Ü‡≤∂‡≥Ä‡≤∞‡≥ç‡≤µ‡≤æ‡≤¶ ‡≤ï‡≤≥‡≥Å‡≤π‡≤ø‡≤∏‡≤ø',
            'wish_them_with_love': '‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤™‡≥ç‡≤∞‡≥Ä‡≤§‡≤ø‡≤Ø‡≤ø‡≤Ç‡≤¶ ‡≤Ö‡≤µ‡≤∞‡≤ø‡≤ó‡≥Ü ‡≤Ü‡≤∂‡≥Ä‡≤∞‡≥ç‡≤µ‡≤æ‡≤¶‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤§‡≤ø‡≤≥‡≤ø‡≤∏‡≤ø...',
            'rsvp': '‡≤Ü‡≤∞‡≥ç‡≤é‡≤∏‡≥ç‡≤µ‡≤ø‡≤™‡≤ø',
            'im_attending': '‡≤®‡≤æ‡≤®‡≥Å ‡≤¨‡≤∞‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥ç‡≤¶‡≥á‡≤®‡≥Ü',
            'unable_to_attend': '‡≤¨‡≤∞‡≤≤‡≥Å ‡≤∏‡≤æ‡≤ß‡≥ç‡≤Ø‡≤µ‡≤ø‡≤≤‡≥ç‡≤≤',
            'wishes_from_loved_ones': '‡≤™‡≥ç‡≤∞‡≤ø‡≤Ø‡≤∞ ‡≤Ü‡≤∂‡≥Ä‡≤∞‡≥ç‡≤µ‡≤æ‡≤¶‡≤ó‡≤≥‡≥Å',
            'view_all': '‡≤é‡≤≤‡≥ç‡≤≤‡≤µ‡≤®‡≥ç‡≤®‡≥Ç ‡≤®‡≥ã‡≤°‡≤ø',
            'no_wishes_yet': '‡≤á‡≤®‡≥ç‡≤®‡≥Ç ‡≤Ü‡≤∂‡≥Ä‡≤∞‡≥ç‡≤µ‡≤æ‡≤¶‡≤ó‡≤≥‡≤ø‡≤≤‡≥ç‡≤≤. ‡≤Æ‡≥ä‡≤¶‡≤≤ ‡≤Ü‡≤∂‡≥Ä‡≤∞‡≥ç‡≤µ‡≤æ‡≤¶ ‡≤ï‡≤≥‡≥Å‡≤π‡≤ø‡≤∏‡≤ø!'
        }
    } %}
    
    {% set default_translations = {
        'convey_your_wishes': 'Convey Your Wishes',
        'your_name': 'Your Name',
        'send_wish': 'Send Wish',
        'wish_them_with_love': 'Wish them with your love...',
        'rsvp': 'RSVP',
        'im_attending': "I'm Attending",
        'unable_to_attend': 'Unable to Attend',
        'wishes_from_loved_ones': 'Wishes from Loved Ones',
        'view_all': 'View All',
        'no_wishes_yet': 'No wishes yet. Be the first to send your love!'
    } %}
    
    {{ translations.get(lang, {}).get(key, default_translations.get(key, key)) }}
{% endmacro %}

{# ========================================
   TEMPLATE IMAGE URL & CUSTOMIZATION
   ======================================== #}
{% set template_image_url = '' %}
{% set font_style = '' %}
{% if invitation.customization_data %}
    {% set customization = invitation.customization_data|from_json %}
    {% if customization.template_image_url %}
        {% set template_image_url = customization.template_image_url %}
    {% endif %}
    {% if customization.font_style %}
        {% set font_style = customization.font_style %}
    {% endif %}
{% endif %}

{# ========================================
   STYLES
   ======================================== #}
<style>
    /* ==================== 
       RESPONSIVE INVITATION DESIGN
       - Mobile Extra Small: up to 375px
       - Mobile: 376px - 575px
       - Mobile Large: 576px - 767px
       - Tablet: 768px - 991px
       - Desktop: 992px - 1199px
       - Desktop Large: 1200px and above
       ==================== */

    /* ==================== BASE STYLES ==================== */
    * {
        box-sizing: border-box;
    }

    .template-container {
        min-height: 100vh;
        background: #f5f7fa;
        padding: 40px 15px;
        width: 100%;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 15px;
        width: 100%;
    }

    /* ==================== INVITATION CARD ==================== */
    .invitation-card {
        background: #ffffff;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.05);
        position: relative;
        overflow: hidden;
        margin-bottom: 0;
        width: 100%;
    }

    /* Template Design as Card Background - Only if exists */
    {% if template_image_url %}
    .invitation-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        background-image: url('{{ template_image_url }}') !important;
        background-size: cover !important;
        background-position: center !important;
        background-repeat: no-repeat !important;
        opacity: 1 !important;
        filter: brightness(1) contrast(1) !important;
        z-index: 1;
        pointer-events: none;
    }
    {% endif %}
    
    .invitation-card > * {
        position: relative;
        z-index: 2;
    }

    /* ==================== VENUE INFO ==================== */
    .venue-info {
        margin: 1.5rem 0;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .venue-info:hover {
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }

    .venue-info h4 {
        color: #2c3e50;
        font-weight: 700;
        font-size: 1.3rem;
        margin-bottom: 1rem;
        text-align: center;
    }

    .location-link {
        background: #28a745;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        font-size: 1rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
    }

    .location-link:hover {
        background: #218838;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        color: white;
        text-decoration: none;
    }

    /* ==================== WISHES & RSVP SECTION (Within Template) ==================== */
    .wishes-rsvp-section {
        margin-top: 0;
        padding: 30px;
        background: #ffffff;
        border-radius: 0 0 20px 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.05);
        border-top: 2px solid rgba(102, 126, 234, 0.15);
        position: relative;
        top: -10px;
    }

    .section-header {
        color: #2c3e50;
        font-weight: 700;
        font-size: 1.2rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .wish-form .form-control {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 0.75rem;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: #ffffff;
    }

    .wish-form .form-control:focus {
        border-color: #D4AF37;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        outline: none;
    }

    .wish-form .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .wish-form .btn-primary {
        background: #D4AF37;
        border-color: #D4AF37;
    }

    .wish-form .btn-primary:hover {
        background: #5568d3;
        border-color: #5568d3;
        transform: translateY(-1px);
    }

    .wish-card {
        background: #f8f9fa;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
    }

    .wish-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border-color: rgba(102, 126, 234, 0.2);
    }

    .wishes-display {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .wishes-display::-webkit-scrollbar {
        width: 6px;
    }

    .wishes-display::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .wishes-display::-webkit-scrollbar-thumb {
        background: #D4AF37;
        border-radius: 3px;
    }

    .wishes-display::-webkit-scrollbar-thumb:hover {
        background: #5568d3;
    }

    /* ==================== RSVP BUTTONS ==================== */
    .rsvp-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .rsvp-btn {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        font-size: 0.95rem;
        text-decoration: none;
        display: inline-block;
    }

    .rsvp-btn:hover {
        transform: translateY(-2px);
        text-decoration: none;
    }

    .rsvp-btn.btn-success {
        background: #28a745;
        color: white;
        border-color: #28a745;
    }

    .rsvp-btn.btn-success:hover {
        background: #218838;
        border-color: #218838;
        color: white;
    }

    .rsvp-btn.btn-outline-danger {
        color: #dc3545;
        border-color: #dc3545;
        background: white;
    }

    .rsvp-btn.btn-outline-danger:hover {
        background: #dc3545;
        color: white;
    }

    /* ==================== SHARE SECTION ==================== */
    .share-section {
        margin: 20px 0;
        text-align: center;
    }

    .share-section .btn {
        background: #D4AF37;
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1rem;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        transition: all 0.3s ease;
    }

    .share-section .btn:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    /* ==================== TEXT OVERLAYS ==================== */
    .text-overlay {
        background: rgba(255, 255, 255, 0.95);
        color: #333;
        padding: 12px 20px;
        border-radius: 8px;
        display: inline-block;
        margin: 8px 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        /* backdrop-filter removed - no blur */
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    /* ==================== RESPONSIVE DESIGN ==================== */
    
    /* Desktop Large (1200px and above) */
    @media (min-width: 1200px) {
        .container {
            max-width: 1140px;
        }
        
        .invitation-card {
            padding: 40px;
        }
        
        .wishes-rsvp-section {
            padding: 35px 40px;
        }
    }

    /* Desktop (992px - 1199px) */
    @media (min-width: 992px) and (max-width: 1199px) {
        .container {
            max-width: 960px;
        }
        
        .invitation-card {
            padding: 35px;
        }
        
        .wishes-rsvp-section {
            padding: 30px 35px;
        }
    }

    /* Tablet (768px - 991px) */
    @media (min-width: 768px) and (max-width: 991px) {
        .container {
            max-width: 720px;
        }
        
        .template-container {
            padding: 30px 15px;
        }
        
        .invitation-card {
            border-radius: 16px;
            padding: 30px;
        }
        
        .wishes-rsvp-section {
            padding: 25px 30px;
        }
        
        .section-header {
            font-size: 1.15rem;
        }
        
        .rsvp-btn,
        .location-link {
            padding: 0.7rem 1.3rem;
            font-size: 0.95rem;
        }
    }

    /* Mobile Large (576px - 767px) */
    @media (min-width: 576px) and (max-width: 767px) {
        .container {
            max-width: 540px;
        }
        
        .template-container {
            padding: 20px 10px;
        }
        
        .invitation-card {
            border-radius: 14px;
            padding: 25px;
        }
        
        .wishes-rsvp-section {
            padding: 20px 25px;
        }
        
        .section-header {
            font-size: 1.1rem;
        }
        
        .rsvp-btn,
        .location-link {
            padding: 0.65rem 1.2rem;
            font-size: 0.9rem;
        }
        
        .venue-info h4 {
            font-size: 1.25rem;
        }
    }

    /* Mobile (up to 575px) */
    @media (max-width: 575px) {
        .container {
            padding: 0 10px;
        }
        
        .template-container {
            padding: 15px 5px;
            background: #ffffff;
            /* Hardware acceleration */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
        
        .invitation-card {
            border-radius: 12px;
            padding: 20px 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            /* Hardware acceleration */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
        
        .wishes-rsvp-section {
            padding: 20px 15px;
            border-radius: 0 0 12px 12px;
        }
        
        .section-header {
            font-size: 1.05rem;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }
        
        .venue-info {
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .venue-info h4 {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            line-height: 1.3;
        }
        
        .location-link,
        .btn-location {
            padding: 12px 20px;
            font-size: 16px;
            width: 100%;
            justify-content: center;
            min-height: 48px;
            touch-action: manipulation;
        }
        
        .rsvp-btn {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            margin-bottom: 10px;
            min-height: 48px;
            touch-action: manipulation;
        }
        
        /* Gallery images mobile optimization */
        .row.g-3 {
            gap: 0.75rem !important;
        }
        
        .row.g-3 > div {
            margin-bottom: 0.75rem;
        }
        
        /* Image loading optimization */
        img {
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
        
        .wish-form .form-control {
            font-size: 0.9rem;
            padding: 0.65rem;
        }
        
        .wish-form .btn {
            width: 100%;
            margin-top: 10px;
        }
        
        .wish-card {
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .wishes-display {
            max-height: 300px;
        }
        
        .share-section .btn {
            width: 100%;
            padding: 0.7rem 1rem;
            font-size: 0.95rem;
        }
        
        /* Make form layout stack vertically on mobile */
        .wish-form .row.g-2 {
            flex-direction: column;
        }
        
        .wish-form .col-md-6 {
            width: 100%;
            margin-bottom: 10px;
        }
    }

    /* Mobile Extra Small (up to 375px) */
    @media (max-width: 375px) {
        .template-container {
            padding: 10px 2px;
        }
        
        .invitation-card {
            border-radius: 10px;
            padding: 15px 12px;
        }
        
        .wishes-rsvp-section {
            padding: 15px 12px;
        }
        
        .section-header {
            font-size: 1rem;
        }
        
        .wish-card {
            padding: 10px;
        }
        
        .wish-card h6 {
            font-size: 0.95rem;
        }
        
        .wish-card p {
            font-size: 0.875rem;
        }
    }

    /* ==================== MODAL RESPONSIVE ==================== */
    @media (max-width: 767px) {
        .modal-dialog {
            margin: 10px;
            max-width: calc(100% - 20px);
        }
        
        .modal-body {
            padding: 1.25rem !important;
        }
        
        .modal-title {
            font-size: 1.1rem;
        }
        
        .social-share-buttons .btn {
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
        }
        
        #qrcode {
            padding: 0.75rem !important;
        }
        
        #qrcode canvas {
            max-width: 100%;
            height: auto !important;
        }
    }

    @media (max-width: 575px) {
        .modal-dialog {
            margin: 5px;
            max-width: calc(100% - 10px);
        }
        
        .modal-body {
            padding: 1rem !important;
        }
        
        .social-share-buttons .d-flex {
            flex-direction: column !important;
            gap: 0.5rem !important;
        }
        
        .social-share-buttons .btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>

{# ========================================
   MAIN CONTENT
   ======================================== #}
<div class="template-container" {% if font_style %}style="font-family: {{ font_style }} !important;"{% endif %}>
    <div class="container">
        {# ========================================
           TEMPLATE RENDERING
           ======================================== #}
        {% if invitation.template_name %}
            {% if invitation.template_name in ['wedding_elegant', 'wedding_elegant_modern', 'wedding_hindu_traditional'] %}
                {% include 'invitation/templates/wedding_elegant.html' %}
            {% elif invitation.template_name == 'birthday_fun_colorful' %}
                {% include 'invitation/templates/birthday_fun_colorful.html' %}
            {% elif invitation.template_name == 'birthday_elegant_gold_blue' %}
                {% include 'invitation/templates/birthday_elegant_gold_blue.html' %}
            {% elif invitation.template_name == 'birthday_elegant_navy_gold' %}
                {% include 'invitation/templates/birthday_elegant_navy_gold.html' %}
            {% elif invitation.template_name == 'birthday_elegant_purple_gold' %}
                {% include 'invitation/templates/birthday_elegant_purple_gold.html' %}
            {% elif invitation.template_name == 'birthday_elegant_dark_gold' %}
                {% include 'invitation/templates/birthday_elegant_dark_gold.html' %}
            {% elif invitation.template_name == 'birthday_final_elegant' %}
                {% include 'invitation/templates/birthday_final_elegant.html' %}
            {% elif invitation.template_name == 'graduation_success_modern' %}
                {% include 'invitation/templates/graduation_success_modern.html' %}
            {% elif invitation.template_name == 'anniversary_golden_elegant' %}
                {% include 'invitation/templates/anniversary_golden_elegant.html' %}
            {% elif invitation.template_name == 'babyshower_sweet_pink' %}
                {% include 'invitation/templates/babyshower_sweet_pink.html' %}
            {% elif invitation.template_name == 'retirement_golden_classic' %}
                {% include 'invitation/templates/retirement_golden_classic.html' %}
            {% else %}
                {% include 'invitation/fallback_template.html' %}
            {% endif %}
        {% else %}
            {% include 'invitation/preview_card.html' %}
        {% endif %}
        
        {# ========================================
           WISHES & RSVP SECTION
           ======================================== #}
        <div class="wishes-rsvp-section">
            <!-- RSVP Section -->
            <div class="rsvp-section mb-4">
                <h5 class="section-header">
                    <i class="fas fa-calendar-check"></i> {{ translate_text('rsvp') }}
                </h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <button onclick="addToGoogleCalendar()" 
                                class="btn btn-success w-100 rsvp-btn"
                                style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                            <i class="fas fa-check-circle me-2"></i>{{ translate_text('im_attending') }}
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button onclick="showBlessingPopup()" 
                                class="btn btn-outline-danger w-100 rsvp-btn"
                                style="border: 2px solid #dc3545; color: #dc3545; background: white; transition: all 0.3s;"
                                onmouseover="this.style.background='#dc3545'; this.style.color='white';"
                                onmouseout="this.style.background='white'; this.style.color='#dc3545';">
                            <i class="fas fa-times-circle me-2"></i>{{ translate_text('unable_to_attend') }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Wishes Section -->
            <div class="wishes-section-content">
                <h5 class="section-header">
                    <i class="fas fa-heart text-danger"></i> {{ translate_text('convey_your_wishes') }}
                </h5>
                
                <!-- Wish Form -->
                <form id="wishForm" class="wish-form mb-4">
                    <div class="row g-2 mb-2">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="wishName" name="name" 
                                   placeholder="{{ translate_text('your_name') }}" required>
                        </div>
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-paper-plane me-2"></i>{{ translate_text('send_wish') }}
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <textarea class="form-control" id="wishMessage" name="message" rows="2" 
                                      placeholder="{{ translate_text('wish_them_with_love') }}" required></textarea>
                        </div>
                    </div>
                </form>

                <!-- Wishes Display -->
                <div>
                    <h6 class="mb-3">
                        <i class="fas fa-gift me-2"></i>{{ translate_text('wishes_from_loved_ones') }}
                    </h6>
                    <div id="wishesContainer" class="wishes-display">
                        {% for wish in wishes %}
                        <div class="wish-card">
                            <div class="d-flex align-items-start">
                                <div class="me-3">
                                    <i class="fas fa-user-circle fa-2x text-primary"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1"><strong>{{ wish.name }}</strong></h6>
                                    <p class="mb-1">{{ wish.message }}</p>
                                    <small class="text-muted">
                                        {% if wish.created_at %}
                                            {{ wish.created_at.strftime('%B %d, %Y') if wish.created_at is not string else wish.created_at }}
                                        {% else %}
                                            Recently
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div id="noWishes" class="text-center text-muted py-3" {% if wishes %}style="display: none;"{% endif %}>
                        <i class="fas fa-heart-broken fa-2x mb-2 d-block"></i>
                        <p class="mb-0">{{ translate_text('no_wishes_yet') }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ========================================
       SHARE BUTTON (Viewers Only - Not Creator)
       ======================================== #}
    {% if not session.user_id or session.user_id != invitation.user_id %}
    <div class="share-section">
        <button class="btn btn-primary" onclick="openShareModal()">
            <i class="fas fa-share-alt me-2"></i>Share Invitation
        </button>
    </div>
    {% endif %}
</div>

{# ========================================
   SHARE MODAL
   ======================================== #}
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px; border: 1px solid rgba(0,0,0,0.1);">
            <div class="modal-header" style="background: #D4AF37; color: white; border-radius: 16px 16px 0 0;">
                <h5 class="modal-title">
                    <i class="fas fa-share-alt me-2"></i>Share This Invitation
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 2rem; background: #f8f9fa;">
                <!-- Share Link -->
                <div class="mb-4">
                    <label class="form-label fw-bold">Share Link:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="shareUrlInput" 
                               value="{{ request.url_root }}invitation/{{ invitation.share_url }}" readonly>
                        <button class="btn btn-outline-primary" onclick="copyShareUrl(event)">
                            <i class="fas fa-copy"></i> Copy Link
                        </button>
                    </div>
                </div>
                
                <!-- Download Button -->
                <div class="mb-4">
                    <button class="btn btn-primary w-100" onclick="downloadInvitation()" style="background: linear-gradient(135deg, #C9A961 0%, #B39750 100%); border: none; padding: 12px; font-weight: 600;">
                        <i class="fas fa-download me-2"></i> Download Invitation as PDF
                    </button>
                </div>

                <!-- Social Share Buttons -->
                <div class="social-share-buttons">
                    <h6 class="mb-3">Share on Social Media:</h6>
                    <div class="d-flex gap-2 justify-content-center flex-wrap">
                        <a href="https://wa.me/?text={{ invitation.title }} - {{ request.url }}" target="_blank" 
                           class="btn btn-success btn-sm" onclick="trackShare('whatsapp')">
                            <i class="fab fa-whatsapp me-1"></i> WhatsApp
                        </a>
                        <a href="https://t.me/share/url?url={{ request.url }}&text={{ invitation.title }}" target="_blank" 
                           class="btn btn-info btn-sm" onclick="trackShare('telegram')">
                            <i class="fab fa-telegram me-1"></i> Telegram
                        </a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url }}" target="_blank" 
                           class="btn btn-primary btn-sm" onclick="trackShare('facebook')">
                            <i class="fab fa-facebook me-1"></i> Facebook
                        </a>
                        <a href="https://twitter.com/intent/tweet?text={{ invitation.title }}&url={{ request.url }}" target="_blank" 
                           class="btn btn-dark btn-sm" onclick="trackShare('twitter')">
                            <i class="fab fa-x-twitter me-1"></i> X
                        </a>
                        <a href="mailto:?subject={{ invitation.title }}&body={{ request.url }}" 
                           class="btn btn-secondary btn-sm" onclick="trackShare('email')">
                            <i class="fas fa-envelope me-1"></i> Email
                        </a>
                    </div>
                </div>
                
                <!-- QR Code -->
                <div class="qr-code-section mt-4 text-center">
                    <h6 class="mb-3 fw-bold">QR Code - Scan to View Invitation:</h6>
                    <div id="qrcode" style="display: inline-block !important; padding: 1.5rem; background: white; 
                                            border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); 
                                            border: 3px solid #D4AF37; min-height: 250px; min-width: 250px;"></div>
                    <p class="mt-3 text-muted" style="font-size: 14px;">
                        <i class="fas fa-mobile-alt me-1"></i>Scan this code with your phone camera to open the invitation
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

{# ========================================
   SCRIPTS
   ======================================== #}
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
// ==================== GLOBAL VARIABLES ====================
const invitationUrl = window.location.href;
const invitationId = {{ invitation.id }};
const shareUrl = "{{ request.url_root }}invitation/{{ invitation.share_url }}";

// ==================== UTILITY FUNCTIONS ====================
function showToast(message, type = 'info') {
    const bgColors = {
        success: '#28a745',
        warning: '#ffc107',
        error: '#dc3545',
        info: '#17a2b8'
    };
    
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 9999;
        background: ${bgColors[type]}; color: white;
        padding: 1rem 1.5rem; border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        max-width: 300px; font-weight: 500;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.remove(), 3000);
}

function formatWishTime(dateString) {
    if (!dateString) return 'Just now';
    
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// ==================== SHARE FUNCTIONS ====================
function openShareModal() {
    const modal = document.getElementById('shareModal');
    if (modal) {
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Generate QR code when modal is shown
        modal.addEventListener('shown.bs.modal', generateQRCode, { once: true });
    }
}

function copyShareUrl(event) {
    const input = document.getElementById('shareUrlInput');
    const btn = event.target.closest('button');
    
    // Try modern clipboard API first
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(input.value)
            .then(() => {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.classList.add('btn-success');
                
                showToast('Link copied to clipboard!', 'success');
                trackShare('copy');
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('btn-success');
                }, 2000);
            })
            .catch(() => {
                // Fallback to old method
                fallbackCopyText(input, btn);
            });
    } else {
        // Fallback for older browsers
        fallbackCopyText(input, btn);
    }
}

function fallbackCopyText(input, btn) {
    input.select();
    input.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            btn.classList.add('btn-success');
            
            showToast('Link copied to clipboard!', 'success');
            trackShare('copy');
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('btn-success');
            }, 2000);
        } else {
            showToast('Failed to copy link. Please copy manually.', 'error');
        }
    } catch (err) {
        showToast('Failed to copy link. Please copy manually.', 'error');
    }
}

function downloadInvitation() {
    // Create a canvas and capture the invitation card
    const invitationCard = document.querySelector('.template-container') || document.querySelector('.invitation-card');
    
    if (!invitationCard) {
        showToast('Unable to find invitation content. Please try again.', 'error');
        return;
    }
    
    // Use html2canvas library if available, otherwise use print
    if (typeof html2canvas !== 'undefined') {
        html2canvas(invitationCard, {
            backgroundColor: '#ffffff',
            scale: 2,
            useCORS: true,
            logging: false
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = '{{ invitation.title|default("invitation")|replace(" ", "_") }}.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast('Invitation downloaded successfully!', 'success');
            trackShare('download');
        }).catch(err => {
            console.error('Download failed:', err);
            // Fallback to print
            window.print();
        });
    } else {
        // Fallback: Open print dialog
        window.print();
        showToast('Opening print dialog. You can save as PDF.', 'info');
        trackShare('download');
    }
}

function trackShare(method) {
    fetch('/api/track-share', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            invitation_id: invitationId,
            share_method: method,
            url: invitationUrl
        })
    }).catch(err => console.error('Share tracking failed:', err));
}

function generateQRCode() {
    const container = document.getElementById('qrcode');
    if (container && typeof QRCode !== 'undefined') {
        container.innerHTML = '';
        new QRCode(container, {
            text: shareUrl,
            width: 200,
            height: 200,
            colorDark: "#101357",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
        trackShare('qr');
    }
}

// ==================== LOCATION FUNCTIONS ====================
function openLocation(address) {
    if (address && address.trim()) {
        const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address.trim())}`;
        window.open(url, '_blank');
    }
}

// ==================== WISHES FUNCTIONS ====================
function addWishToDisplay(wish) {
    const container = document.getElementById('wishesContainer');
    const noWishes = document.getElementById('noWishes');
    
    const wishCard = document.createElement('div');
    wishCard.className = 'wish-card';
    wishCard.innerHTML = `
        <div class="d-flex align-items-start">
            <div class="me-3">
                <i class="fas fa-user-circle fa-2x text-primary"></i>
            </div>
            <div class="flex-grow-1">
                <h6 class="mb-1"><strong>${wish.name}</strong></h6>
                <p class="mb-1">${wish.message}</p>
                <small class="text-muted">${formatWishTime(wish.created_at)}</small>
            </div>
        </div>
    `;
    
    container.insertBefore(wishCard, container.firstChild);
    if (noWishes) noWishes.style.display = 'none';
    
    wishCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
    // Wish Form Handler
    const wishForm = document.getElementById('wishForm');
    if (wishForm) {
        wishForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('wishName').value.trim(),
                message: document.getElementById('wishMessage').value.trim()
            };
            
            if (!formData.name || !formData.message) {
                showToast('Please fill in both name and message', 'warning');
                return;
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
            submitBtn.disabled = true;
            
            fetch('/add-wish/{{ invitation.share_url }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    addWishToDisplay(data.wish);
                    wishForm.reset();
                    showToast(data.message, 'success');
                } else {
                    showToast(data.message || 'Failed to send wish', 'warning');
                }
            })
            .catch(() => showToast('Failed to send wish', 'error'))
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
    }
});

// ==================== GOOGLE CALENDAR INTEGRATION ====================
function addToGoogleCalendar() {
    // Get event details
    const title = "{{ invitation.title|replace("'", "\\'") }}";
    const description = "{{ invitation.description|replace("'", "\\'")|default('') }}";
    const location = "{{ invitation.venue_address|replace("'", "\\'")|default('') }}";
    
    // Parse event date and time
    const eventDate = "{{ invitation.event_date }}";
    const eventTime = "{{ invitation.event_time|default('10:00') }}";
    
    // Convert to Google Calendar format (YYYYMMDDTHHMMSS)
    let startDateTime = '';
    let endDateTime = '';
    
    if (eventDate) {
        // Parse the date
        const dateObj = new Date(eventDate);
        
        // Parse time or use default
        let [hours, minutes] = eventTime.split(':');
        if (!hours) hours = '10';
        if (!minutes) minutes = '00';
        
        // Set start time
        dateObj.setHours(parseInt(hours), parseInt(minutes), 0);
        
        // Format: YYYYMMDDTHHMMSSZ
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        const hour = String(dateObj.getHours()).padStart(2, '0');
        const minute = String(dateObj.getMinutes()).padStart(2, '0');
        
        startDateTime = `${year}${month}${day}T${hour}${minute}00`;
        
        // End time (2 hours later)
        dateObj.setHours(dateObj.getHours() + 2);
        const endYear = dateObj.getFullYear();
        const endMonth = String(dateObj.getMonth() + 1).padStart(2, '0');
        const endDay = String(dateObj.getDate()).padStart(2, '0');
        const endHour = String(dateObj.getHours()).padStart(2, '0');
        const endMinute = String(dateObj.getMinutes()).padStart(2, '0');
        
        endDateTime = `${endYear}${endMonth}${endDay}T${endHour}${endMinute}00`;
    }
    
    // Build Google Calendar URL
    const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDateTime}/${endDateTime}&details=${encodeURIComponent(description)}&location=${encodeURIComponent(location)}`;
    
    // Open in new tab
    window.open(googleCalendarUrl, '_blank');
    
    // Show confirmation
    showToast('‚úÖ Event added to your calendar!', 'success');
}

// ==================== BLESSING POPUP ====================
function showBlessingPopup() {
    // Create modal HTML
    const modal = document.createElement('div');
    modal.id = 'blessingModal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    `;
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #6F4E37 0%, #D4AF37 100%); 
                    padding: 40px; 
                    border-radius: 20px; 
                    max-width: 500px; 
                    width: 90%; 
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    text-align: center;
                    position: relative;
                    animation: slideIn 0.4s ease;">
            <button onclick="closeBlessingPopup()" 
                    style="position: absolute; 
                           top: 15px; 
                           right: 15px; 
                           background: rgba(255,255,255,0.2); 
                           border: none; 
                           width: 35px; 
                           height: 35px; 
                           border-radius: 50%; 
                           cursor: pointer; 
                           font-size: 20px; 
                           color: white;
                           transition: all 0.3s;"
                    onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                √ó
            </button>
            
            <div style="font-size: 60px; margin-bottom: 20px;">üôè</div>
            
            <h2 style="color: white; font-size: 28px; font-weight: 700; margin-bottom: 15px;">
                We Understand
            </h2>
            
            <p style="color: rgba(255,255,255,0.95); font-size: 18px; line-height: 1.6; margin-bottom: 25px;">
                Though you can't join us in person, your blessings mean the world to us.
            </p>
            
            <div style="background: rgba(255,255,255,0.95); 
                        padding: 20px; 
                        border-radius: 15px; 
                        margin-bottom: 25px;">
                <p style="color: white; font-size: 20px; font-weight: 600; margin: 0; font-style: italic;">
                    "Bless us with your wishes"
                </p>
            </div>
            
            <button onclick="scrollToWishes()" 
                    style="background: white; 
                           color: #6F4E37; 
                           border: none; 
                           padding: 15px 35px; 
                           border-radius: 25px; 
                           font-size: 16px; 
                           font-weight: 600; 
                           cursor: pointer; 
                           box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                           transition: all 0.3s;"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'">
                <i class="fas fa-heart" style="margin-right: 8px;"></i>
                Send Your Blessings
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add animation styles
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
}

function closeBlessingPopup() {
    const modal = document.getElementById('blessingModal');
    if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => modal.remove(), 300);
    }
}

function scrollToWishes() {
    closeBlessingPopup();
    // Scroll to wishes section
    const wishesSection = document.querySelector('.wishes-section-content');
    if (wishesSection) {
        wishesSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Focus on the name input
        setTimeout(() => {
            const nameInput = document.getElementById('wishName');
            if (nameInput) {
                nameInput.focus();
            }
        }, 500);
    }
}
</script>

<style>
@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}
</style>

{% endblock %}

