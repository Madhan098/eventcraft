{% extends "base.html" %}

{% block title %}{{ invitation.title }} - EventCraft Pro{% endblock %}

{% block content %}
<style>
    .template-container {
        min-height: 100vh;
        background: #f8f9fa;
    }

    .template-not-found {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 15px;
        margin: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .template-not-found h1 {
        color: #6c757d;
        margin-bottom: 1rem;
    }

    .template-not-found p {
        color: #868e96;
        font-size: 1.1rem;
    }

    .fallback-invitation {
        background: white;
        border-radius: 15px;
        padding: 3rem;
        margin: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        text-align: center;
    }

    .fallback-invitation h1 {
        color: #2c3e50;
        margin-bottom: 1rem;
        font-size: 2.5rem;
    }

    .fallback-invitation .event-date {
        font-size: 1.5rem;
        color: #e74c3c;
        margin: 1rem 0;
        font-weight: bold;
    }

    .fallback-invitation .event-details {
        margin: 2rem 0;
        padding: 2rem;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .fallback-invitation .contact-info {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid #e9ecef;
    }
</style>

<div class="template-container">
    {% if invitation.template_name %}
        {# Render the appropriate template based on template_name #}
        {% if invitation.template_name == 'wedding_elegant' or invitation.template_name == 'wedding_elegant_modern' %}
            {% include 'invitation/templates/wedding_elegant_modern.html' %}
        {% elif invitation.template_name == 'birthday_fun_colorful' %}
            {# Birthday Fun Colorful Template #}
            <section class="hero-section" style="background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%); min-height: 100vh; display: flex; align-items: center; text-align: center; color: white;">
                <div class="container">
                    <h1 style="font-size: 4rem; margin-bottom: 2rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                        üéâ {{ event_data.eventTitle }}
                    </h1>
                    <p style="font-size: 1.5rem; margin-bottom: 2rem;">
                        {{ event_data.eventDescription or 'Join us for a fun celebration!' }}
                    </p>
                    <div class="birthday-info" style="background: rgba(255,255,255,0.2); padding: 2rem; border-radius: 20px; backdrop-filter: blur(10px);">
                        <h3 style="margin-bottom: 1rem;">üéÇ {{ event_data.birthdayPerson or 'Birthday Person' }}</h3>
                        <p style="font-size: 1.3rem; margin-bottom: 1rem;">Turning {{ event_data.age or 'Age' }}!</p>
                        <p style="font-size: 1.2rem;">üìÖ {{ event_data.eventDate }}</p>
                        <p style="font-size: 1.2rem;">‚è∞ {{ event_data.startTime or 'Time TBD' }}</p>
                    </div>
                </div>
            </section>

        {% elif invitation.template_name == 'wedding_hindu_traditional' %}
            {# Hindu Traditional Template #}
            <section class="hero-section" style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); min-height: 100vh; display: flex; align-items: center; text-align: center; color: white;">
                <div class="container">
                    <div class="religion-icon" style="font-size: 4rem; margin-bottom: 2rem;">
                        üïâÔ∏è
                    </div>
                    <h1 style="font-size: 3.5rem; margin-bottom: 2rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                        {{ event_data.familyName }}
                    </h1>
                    <p style="font-size: 1.3rem; margin-bottom: 2rem;">
                        {{ event_data.eventDescription or 'Traditional Hindu Wedding Ceremony' }}
                    </p>
                    <div class="date-info" style="background: rgba(255,255,255,0.2); padding: 2rem; border-radius: 20px; backdrop-filter: blur(10px);">
                        <h3 style="margin-bottom: 1rem;">üìÖ {{ event_data.eventDate }}</h3>
                        <p style="font-size: 1.2rem;">Muhurtham: {{ event_data.timeData.muhurthamTime or 'TBD' }}</p>
                        <p style="font-size: 1.2rem;">Reception: {{ event_data.timeData.receptionTime or 'TBD' }}</p>
                    </div>
                </div>
            </section>

        {% else %}
            {# Generic template or fallback #}
            <div class="template-not-found">
                <h1>üéâ {{ invitation.title or 'Event Invitation' }}</h1>
                <p>Template "{{ invitation.template_name }}" is being prepared. Showing enhanced invitation.</p>
            </div>

            <div class="fallback-invitation">
                <h1>{{ invitation.title or 'Event Invitation' }}</h1>
                {% if invitation.description %}
                <p class="lead">{{ invitation.description }}</p>
                {% endif %}

                {% if invitation.event_date %}
                <div class="event-date">
                    <i class="fas fa-calendar-alt me-2"></i>
                    {{ invitation.event_date.strftime('%B %d, %Y') }}
                </div>
                {% endif %}

                <div class="event-details">
                    <h3>Event Details</h3>
                    {% if invitation.event_type == 'wedding' %}
                        {% if invitation.bride_name %}
                        <p><strong>Bride:</strong> {{ invitation.bride_name }}</p>
                        {% endif %}
                        {% if invitation.groom_name %}
                        <p><strong>Groom:</strong> {{ invitation.groom_name }}</p>
                        {% endif %}
                        {% if invitation.muhurtham_time %}
                        <p><strong>Muhurtham:</strong> {{ invitation.muhurtham_time }}</p>
                        {% endif %}
                        {% if invitation.reception_time %}
                        <p><strong>Reception:</strong> {{ invitation.reception_time }}</p>
                        {% endif %}
                    {% elif invitation.event_type == 'birthday' %}
                        {% if invitation.birthday_person %}
                        <p><strong>Celebrating:</strong> {{ invitation.birthday_person }}</p>
                        {% endif %}
                        {% if invitation.age %}
                        <p><strong>Age:</strong> {{ invitation.age }}</p>
                        {% endif %}
                        {% if invitation.start_time %}
                        <p><strong>Start Time:</strong> {{ invitation.start_time }}</p>
                        {% endif %}
                        {% if invitation.dinner_time %}
                        <p><strong>Dinner:</strong> {{ invitation.dinner_time }}</p>
                        {% endif %}
                    {% elif invitation.event_type == 'babyshower' %}
                        {% if invitation.mother_name %}
                        <p><strong>Mother:</strong> {{ invitation.mother_name }}</p>
                        {% endif %}
                        {% if invitation.father_name %}
                        <p><strong>Father:</strong> {{ invitation.father_name }}</p>
                        {% endif %}
                        {% if invitation.babyshower_start_time %}
                        <p><strong>Start:</strong> {{ invitation.babyshower_start_time }}</p>
                        {% endif %}
                        {% if invitation.babyshower_end_time %}
                        <p><strong>End:</strong> {{ invitation.babyshower_end_time }}</p>
                        {% endif %}
                    {% elif invitation.event_type == 'graduation' %}
                        {% if invitation.graduate_name %}
                        <p><strong>Graduate:</strong> {{ invitation.graduate_name }}</p>
                        {% endif %}
                        {% if invitation.degree %}
                        <p><strong>Degree:</strong> {{ invitation.degree }}</p>
                        {% endif %}
                        {% if invitation.school %}
                        <p><strong>School:</strong> {{ invitation.school }}</p>
                        {% endif %}
                        {% if invitation.major %}
                        <p><strong>Major:</strong> {{ invitation.major }}</p>
                        {% endif %}
                    {% elif invitation.event_type == 'anniversary' %}
                        {% if invitation.couple_names %}
                        <p><strong>Couple:</strong> {{ invitation.couple_names }}</p>
                        {% endif %}
                        {% if invitation.marriage_years %}
                        <p><strong>Years:</strong> {{ invitation.marriage_years }}</p>
                        {% endif %}
                        {% if invitation.anniversary_dinner_time %}
                        <p><strong>Dinner:</strong> {{ invitation.anniversary_dinner_time }}</p>
                        {% endif %}
                        {% if invitation.party_time %}
                        <p><strong>Party:</strong> {{ invitation.party_time }}</p>
                        {% endif %}
                    {% elif invitation.event_type == 'retirement' %}
                        {% if invitation.honoree_name %}
                        <p><strong>Honoree:</strong> {{ invitation.honoree_name }}</p>
                        {% endif %}
                        {% if invitation.position %}
                        <p><strong>Position:</strong> {{ invitation.position }}</p>
                        {% endif %}
                        {% if invitation.company %}
                        <p><strong>Company:</strong> {{ invitation.company }}</p>
                        {% endif %}
                        {% if invitation.start_year %}
                        <p><strong>Started:</strong> {{ invitation.start_year }}</p>
                        {% endif %}
                    {% endif %}
                </div>

                {% if invitation.venue_address %}
                <div class="venue-info">
                    <h4><i class="fas fa-map-marker-alt me-2"></i>Venue</h4>
                    <p>{{ invitation.venue_address }}</p>
                </div>
                {% endif %}

                <div class="contact-info">
                    {% if invitation.host_name %}
                    <p><strong>Host:</strong> {{ invitation.host_name }}</p>
                    {% endif %}
                    {% if invitation.contact_phone %}
                    <p><strong>Phone:</strong> {{ invitation.contact_phone }}</p>
                    {% endif %}
                    {% if invitation.contact_email %}
                    <p><strong>Email:</strong> {{ invitation.contact_email }}</p>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    {% else %}
        {# No template specified, show fallback #}
        <div class="fallback-invitation">
            <h1>{{ invitation.title or 'Event Invitation' }}</h1>
            {% if invitation.description %}
            <p class="lead">{{ invitation.description }}</p>
            {% endif %}

            {% if invitation.event_date %}
            <div class="event-date">
                <i class="fas fa-calendar-alt me-2"></i>
                {{ invitation.event_date.strftime('%B %d, %Y') }}
            </div>
            {% endif %}

            <div class="event-details">
                <h3>Event Details</h3>
                <p><strong>Type:</strong> {{ invitation.event_type|title if invitation.event_type else 'General Event' }}</p>
            </div>

            {% if invitation.venue_address %}
            <div class="venue-info">
                <h4><i class="fas fa-map-marker-alt me-2"></i>Venue</h4>
                <p>{{ invitation.venue_address }}</p>
            </div>
            {% endif %}

            <div class="contact-info">
                {% if invitation.host_name %}
                <p><strong>Host:</strong> {{ invitation.host_name }}</p>
                {% endif %}
                {% if invitation.contact_phone %}
                <p><strong>Phone:</strong> {{ invitation.contact_phone }}</p>
                {% endif %}
                {% if invitation.contact_email %}
                <p><strong>Email:</strong> {{ invitation.contact_email }}</p>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<!-- Share Button (Floating) -->
<div class="share-floating-btn" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
    <button class="btn btn-primary btn-lg rounded-circle" data-bs-toggle="modal" data-bs-target="#shareModal" style="width: 60px; height: 60px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
        <i class="fas fa-share-alt fa-lg"></i>
    </button>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                <h5 class="modal-title" id="shareModalLabel">
                    <i class="fas fa-share-alt me-2"></i>Share This Invitation
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 2rem;">
                <div class="share-preview mb-4" style="text-align: center;">
                    <div class="invitation-preview" style="background: #f8f9fa; padding: 1.5rem; border-radius: 15px; margin-bottom: 1rem;">
                        <h6 style="color: #2c3e50; margin-bottom: 0.5rem;">{{ invitation.title or 'Event Invitation' }}</h6>
                        <p style="color: #6c757d; margin: 0; font-size: 0.9rem;">{{ invitation.event_date.strftime('%B %d, %Y') if invitation.event_date else 'Date TBD' }}</p>
                    </div>
                </div>

                <div class="share-options">
                    <label class="form-label" style="font-weight: 600; color: #2c3e50;">Share Link:</label>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="shareUrlInput" value="{{ request.url }}" readonly style="background: #f8f9fa; border: 2px solid #e9ecef;">
                        <button class="btn btn-outline-primary" type="button" onclick="copyShareUrl()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>

                    <div class="social-share-buttons">
                        <h6 style="margin-bottom: 1rem; color: #2c3e50;">Share on Social Media:</h6>
                        <div class="d-flex gap-2 justify-content-center flex-wrap">
                            <a href="https://wa.me/?text={{ invitation.title or 'Event Invitation' }} - {{ request.url }}" target="_blank" class="btn btn-success btn-sm">
                                <i class="fab fa-whatsapp me-1"></i> WhatsApp
                            </a>
                            <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url }}" target="_blank" class="btn btn-primary btn-sm">
                                <i class="fab fa-facebook me-1"></i> Facebook
                            </a>
                            <a href="https://twitter.com/intent/tweet?text={{ invitation.title or 'Event Invitation' }}&url={{ request.url }}" target="_blank" class="btn btn-info btn-sm">
                                <i class="fab fa-twitter me-1"></i> Twitter
                            </a>
                            <a href="mailto:?subject={{ invitation.title or 'Event Invitation' }}&body=You're invited! {{ request.url }}" class="btn btn-secondary btn-sm">
                                <i class="fas fa-envelope me-1"></i> Email
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border: none; padding: 1rem 2rem;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadInvitation()">
                    <i class="fas fa-download me-2"></i>Download Image
                </button>
            </div>
        </div>
    </div>
</div>


<script>
function copyShareUrl() {
    const shareUrl = document.getElementById('shareUrlInput').value;
    navigator.clipboard.writeText(shareUrl).then(function() {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');

        // Show toast notification
        showToast('Link copied to clipboard!', 'success');

        setTimeout(function() {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    }).catch(function(err) {
        console.error('Could not copy text: ', err);
        showToast('Failed to copy link', 'error');
    });
}

function downloadInvitation() {
    // Create a canvas element to capture the invitation
    html2canvas(document.querySelector('.template-container')).then(canvas => {
        const link = document.createElement('a');
        link.download = '{{ invitation.title|replace(" ", "_") or "invitation" }}.png';
        link.href = canvas.toDataURL();
        link.click();
    });
}

function showToast(message, type) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    // Add to body
    document.body.appendChild(toast);

    // Show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    // Remove from DOM after hiding
    toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
    });
}
</script>

<!-- Add html2canvas library for downloading -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
{% endblock %}