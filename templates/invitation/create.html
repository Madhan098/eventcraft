{% extends "base.html" %}

{% block title %}Create Invitation - EventCraft Pro{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* Progress Bar - Exact Match from Images */
    .progress-bar-container {
        max-width: 1000px;
        margin: 0 auto 40px;
        padding: 40px 20px 0;
    }

    .progress-bar {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        position: relative;
        width: 100%;
        padding: 0 20px;
    }

    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        position: relative;
        z-index: 2;
        margin-bottom: 0;
    }

    .progress-step::after {
        content: '';
        position: absolute;
        top: 20px;
        left: calc(50% + 20px);
        width: calc(100% - 40px);
        height: 3px;
        background: #E5E5E5;
        z-index: 1;
    }

    .progress-step:last-child::after {
        display: none;
    }

    .progress-step.completed::after {
        background: linear-gradient(90deg, var(--reddish-brown-dark) 0%, var(--golden-yellow) 100%);
    }

    .progress-step.active::after {
        background: linear-gradient(90deg, var(--reddish-brown-dark) 0%, var(--golden-yellow) 100%);
    }

    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 8px;
        position: relative;
        z-index: 2;
        transition: all 0.3s ease;
    }

    .progress-step.completed .step-circle {
        background: var(--reddish-brown-dark);
        color: white;
    }

    .progress-step.active .step-circle {
        background: var(--golden-yellow);
        color: white;
    }

    .progress-step.pending .step-circle {
        background: #E5E5E5;
        color: #999;
    }

    .step-label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-dark);
        text-align: center;
    }

    .progress-step.active .step-label {
        color: var(--reddish-brown-dark);
        font-weight: 600;
    }

    /* Page Container */
    .create-page-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 20px;
        background: var(--bg-cream);
        min-height: 100vh;
    }

    /* Page Title */
    .page-title {
        text-align: center;
        margin-bottom: 50px;
    }

    .page-title h1 {
        font-size: 48px;
        font-weight: 700;
        margin-bottom: 10px;
        line-height: 1.2;
    }

    .page-title h1 .title-normal {
        color: var(--reddish-brown-dark);
    }

    .page-title h1 .title-gradient {
        background: linear-gradient(135deg, var(--reddish-brown-dark) 0%, var(--golden-yellow) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .page-title p {
        font-size: 18px;
        color: var(--text-gray);
    }

    /* Theme Selection Page */
    .theme-selection-page {
        display: none;
    }

    .theme-selection-page.active {
        display: block;
    }

    .theme-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 30px;
        max-width: 1000px;
        margin: 0 auto;
    }

    .theme-card {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        border: 3px solid transparent;
    }

    .theme-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 16px 40px rgba(160, 120, 120, 0.2);
    }

    .theme-card.selected {
        border-color: var(--reddish-brown-dark);
    }

    .theme-card.selected::before {
        content: '✓';
        position: absolute;
        top: 12px;
        right: 12px;
        width: 28px;
        height: 28px;
        background: var(--reddish-brown-dark);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
        z-index: 3;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .theme-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .theme-title {
        padding: 20px;
        text-align: center;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
    }

    /* Details Form with Live Preview */
    .details-form-page {
        display: none;
    }

    .details-form-page.active {
        display: block;
    }

    .form-preview-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
        max-width: 1200px;
        margin: 0 auto;
    }

    /* Form Section */
    .form-section-card {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    .form-label.required::after {
        content: ' *';
        color: var(--reddish-brown-dark);
    }

    .form-input,
    .form-textarea {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #E5E5E5;
        border-radius: 12px;
        font-size: 15px;
        transition: all 0.3s ease;
        font-family: 'Inter', sans-serif;
    }

    .form-input:focus,
    .form-textarea:focus {
        outline: none;
        border-color: var(--reddish-brown-dark);
        box-shadow: 0 0 0 4px rgba(160, 120, 120, 0.1);
    }

    .form-textarea {
        resize: vertical;
        min-height: 120px;
    }

    .input-with-icon {
        position: relative;
    }

    .input-with-icon i {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-gray);
        pointer-events: none;
    }

    /* Live Preview Section */
    .live-preview-card {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        position: sticky;
        top: 40px;
        height: fit-content;
        max-height: calc(100vh - 80px);
        overflow-y: auto;
    }

    .preview-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 24px;
        text-align: center;
        padding-bottom: 16px;
        border-bottom: 2px solid #E5E5E5;
    }

    .preview-content {
        text-align: center;
        min-height: 400px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .invitation-preview {
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
        background: linear-gradient(135deg, #FFF5F0 0%, #FFFFFF 100%);
        border-radius: 16px;
        padding: 40px 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        border: 2px solid rgba(160, 120, 120, 0.1);
    }

    .preview-icon {
        font-size: 64px;
        margin-bottom: 20px;
        display: block;
    }

    .preview-event-name {
        font-size: 28px;
        font-weight: 700;
        color: var(--reddish-brown-dark);
        margin-bottom: 20px;
        font-family: 'Playfair Display', serif;
        line-height: 1.2;
    }

    .preview-date-time {
        font-size: 16px;
        color: var(--text-gray);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .preview-venue {
        font-size: 16px;
        color: var(--text-gray);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-align: center;
    }

    .preview-hosted {
        font-size: 14px;
        color: var(--text-gray);
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(160, 120, 120, 0.2);
    }

    .preview-message {
        font-size: 15px;
        color: var(--text-dark);
        line-height: 1.6;
        margin-top: 20px;
        font-style: italic;
    }

    .preview-placeholder {
        font-size: 14px;
        color: var(--text-gray);
        line-height: 1.6;
        padding: 40px 20px;
    }

    /* Event-Specific Fields */
    .event-specific-fields {
        margin-top: 30px;
        padding-top: 30px;
        border-top: 2px solid #E5E5E5;
    }

    .section-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--reddish-brown-dark);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--golden-yellow);
    }

    /* Image Preview Styles */
    .image-preview {
        margin-top: 12px;
        display: none;
    }

    .image-preview img {
        width: 100%;
        max-width: 200px;
        height: auto;
        border-radius: 12px;
        border: 2px solid #E5E5E5;
        margin-top: 8px;
    }

    .gallery-preview {
        margin-top: 12px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
    }

    .gallery-preview img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #E5E5E5;
    }

    select.form-input {
        cursor: pointer;
    }

    /* Navigation Buttons */
    .form-navigation {
        display: flex;
        justify-content: space-between;
        max-width: 1200px;
        margin: 40px auto 0;
        padding: 0 20px;
    }

    .btn-back,
    .btn-continue,
    .btn-preview {
        padding: 14px 32px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        transition: all 0.3s ease;
        display: inline-flex;
            align-items: center;
        gap: 8px;
        border: 2px solid;
        text-decoration: none;
        cursor: pointer;
        background: white;
    }

    .btn-back {
        color: var(--reddish-brown-dark);
        border-color: var(--reddish-brown-dark);
    }

    .btn-back:hover {
        background: #F8F8F8;
        transform: translateY(-2px);
    }

    .btn-continue,
    .btn-preview {
        background: linear-gradient(135deg, var(--reddish-brown-dark) 0%, var(--golden-yellow) 100%);
        color: white;
        border: none;
    }

    .btn-continue:hover,
    .btn-preview:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(160, 120, 120, 0.3);
    }

    .btn-continue:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* Responsive */
    @media (max-width: 968px) {
        .form-preview-container {
            grid-template-columns: 1fr;
        }

        .live-preview-card {
            position: static;
            margin-top: 40px;
        }

        .theme-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 640px) {
        .theme-grid {
            grid-template-columns: 1fr;
        }

        .progress-bar {
            flex-direction: row;
            flex-wrap: nowrap;
            padding: 0 10px;
        }

        .progress-step {
            margin-bottom: 0;
        }

        .progress-step::after {
            left: calc(50% + 15px);
            width: calc(100% - 30px);
        }

        .page-title h1 {
            font-size: 36px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="create-page-container">
    <!-- Progress Bar - Exact Match from Images -->
    <div class="progress-bar-container">
        <div class="progress-bar">
            <div class="progress-step completed" data-step="1">
                <div class="step-circle">✓</div>
                <div class="step-label">Occasion</div>
    </div>
            <div class="progress-step {% if selected_template %}completed{% else %}active{% endif %}" data-step="2">
                <div class="step-circle">{% if selected_template %}✓{% else %}2{% endif %}</div>
                <div class="step-label">Theme</div>
    </div>
            <div class="progress-step {% if selected_template %}active{% else %}pending{% endif %}" data-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">Details</div>
    </div>
            <div class="progress-step pending" data-step="4">
                <div class="step-circle">4</div>
                <div class="step-label">Preview</div>
        </div>
            </div>
        </div>
        
    <!-- Theme Selection Page -->
    {% if not selected_template %}
    <div class="theme-selection-page active" id="themeSelectionPage">
        <div class="page-title">
            <h1>
                <span class="title-normal">Pick Your </span>
                <span class="title-gradient">Perfect Theme</span>
            </h1>
            <p>Select a design that speaks to your style</p>
    </div>

        <div class="theme-grid">
            {% if templates %}
                {% for template in templates[:6] %}
                {% set template_name_slug = template.name|replace(' ', '_')|lower %}
                {% set template_img = template.preview_image if template.preview_image else '/static/images/templateselection/naming cermony.jpg' %}
                {% if template_img and not template_img.startswith('http') and not template_img.startswith('/') %}
                    {% set template_img = '/static/images/' + template_img %}
                {% elif template_img and template_img.startswith('/images/') %}
                    {% set template_img = template_img.replace('/images/', '/static/images/') %}
                {% endif %}
                {% set template_color = template.color_scheme if template.color_scheme else 'A07878' %}
                {% set template_name_encoded = template.name|replace(' ', '+') %}
                <div class="theme-card" data-theme="{{ template_name_slug }}" onclick="selectTheme('{{ template_name_slug }}', '{{ template.id }}', this)">
                    <img src="{{ template_img }}" 
                         alt="{{ template.name }}" 
                         class="theme-image" 
                         loading="lazy"
                         decoding="async"
                         onerror="this.src='https://via.placeholder.com/300x200/{{ template_color }}/FFFFFF?text={{ template_name_encoded }}'">
                    <div class="theme-title">{{ template.name }}</div>
        </div>
                {% endfor %}
            {% else %}
                <!-- Default Theme Options if no templates in database -->
                <div class="theme-card" data-theme="modern_minimal" onclick="selectTheme('modern_minimal', '', this)">
                    <img src="/static/images/templateselection/naming cermony.jpg" alt="Modern Minimal" class="theme-image" onerror="this.src='https://via.placeholder.com/300x200?text=Modern+Minimal'">
                    <div class="theme-title">Modern Minimal</div>
        </div>

                <div class="theme-card" data-theme="floral_luxury" onclick="selectTheme('floral_luxury', '', this)">
                    <img src="/static/images/templateselection/partytemplates.jpg" alt="Floral Luxury" class="theme-image" onerror="this.src='https://via.placeholder.com/300x200?text=Floral+Luxury'">
                    <div class="theme-title">Floral Luxury</div>
    </div>

                <div class="theme-card" data-theme="royal_gold" onclick="selectTheme('royal_gold', '', this)">
                    <img src="/static/images/templateselection/traditionalgettogether.jpg" alt="Royal Gold" class="theme-image" onerror="this.src='https://via.placeholder.com/300x200?text=Royal+Gold'">
                    <div class="theme-title">Royal Gold</div>
                </div>

                <div class="theme-card" data-theme="watercolor_dreams" onclick="selectTheme('watercolor_dreams', '', this)">
                    <img src="/static/images/templateselection/naming cermony.jpg" alt="Watercolor Dreams" class="theme-image" onerror="this.src='https://via.placeholder.com/300x200?text=Watercolor+Dreams'">
                    <div class="theme-title">Watercolor Dreams</div>
                    </div>

                <div class="theme-card" data-theme="dark_chic" onclick="selectTheme('dark_chic', '', this)">
                    <img src="/static/images/templateselection/partytemplates.jpg" alt="Dark Chic" class="theme-image" onerror="this.src='https://via.placeholder.com/300x200?text=Dark+Chic'">
                    <div class="theme-title">Dark Chic</div>
                </div>

                <div class="theme-card" data-theme="festive_traditional" onclick="selectTheme('festive_traditional', '', this)">
                    <img src="/static/images/templateselection/traditionalgettogether.jpg" alt="Festive Traditional" class="theme-image" onerror="this.src='https://via.placeholder.com/300x200?text=Festive+Traditional'">
                    <div class="theme-title">Festive Traditional</div>
                </div>
                {% endif %}
                </div>

        <div class="form-navigation">
            <a href="{{ url_for('templates') }}" class="btn-back">
                <i class="fas fa-arrow-left"></i> Back
            </a>
            <button class="btn-continue" id="continueToDetails" disabled onclick="continueToDetails()">
                Continue <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
    {% endif %}

    <!-- Details Form Page -->
    <div class="details-form-page {% if selected_template %}active{% endif %}" id="detailsFormPage">
        <div class="page-title">
            <h1>
                <span class="title-normal">Add Your </span>
                <span class="title-gradient">Special Details</span>
            </h1>
            <p>Watch your invitation come to life</p>
                </div>

        <div class="form-preview-container">
            <!-- Form Section -->
            <div class="form-section-card">
                <form id="invitationForm" method="POST" action="{{ url_for('create_invitation') }}" enctype="multipart/form-data">
                    <input type="hidden" name="selectedTemplate" value="{{ selected_template }}" id="selectedTemplate">
                    
                        <div class="form-group">
                        <label class="form-label required">Event Name</label>
                        <input type="text" class="form-input" id="eventName" name="eventTitle" 
                               placeholder="e.g., Sarah & James or Emma's Sweet 16"
                               value="{% if current_user and selected_template %}{{ current_user.name }}'s Birthday{% endif %}">
                </div>

                        <div class="form-group">
                        <label class="form-label required">Event Date</label>
                        <div class="input-with-icon">
                            <input type="date" class="form-input" id="eventDate" name="eventDate">
                            <i class="fas fa-calendar"></i>
                    </div>
                </div>

                        <div class="form-group">
                        <label class="form-label">Event Time</label>
                        <div class="input-with-icon">
                            <input type="time" class="form-input" id="eventTime" name="eventTime">
                            <i class="fas fa-clock"></i>
                    </div>
                </div>

                        <div class="form-group">
                        <label class="form-label">Venue Name</label>
                        <input type="text" class="form-input" id="venueName" name="venueName" 
                               placeholder="e.g., Garden Estate">
                </div>

                        <div class="form-group">
                        <label class="form-label">Venue Address</label>
                        <input type="text" class="form-input" id="venueAddress" name="venueAddress" 
                               placeholder="e.g., 123 Main St, City, State">
                </div>

                        <div class="form-group">
                        <label class="form-label">Hosted By</label>
                        <input type="text" class="form-input" id="hostedBy" name="hostName" 
                               placeholder="e.g., The Smith Family"
                               value="{{ current_user.name if current_user else '' }}">
        </div>

                    <div class="form-group">
                        <label class="form-label">RSVP Contact</label>
                        <input type="text" class="form-input" id="rsvpContact" name="contactEmail" 
                               placeholder="e.g., email@example.com or (555) 123-4567"
                               value="{{ current_user.email if current_user else '' }}">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Personal Message</label>
                        <textarea class="form-textarea" id="personalMessage" name="eventDescription" 
                                  rows="4" placeholder="Add a heartfelt message to your guests..."></textarea>
                    </div>

                    <!-- Language & Font Style -->
                    <div class="form-group">
                        <label class="form-label">Language</label>
                        <select class="form-input" id="language" name="language">
                            <option value="en">English</option>
                            <option value="hi">Hindi (हिन्दी)</option>
                            <option value="ar">Arabic (العربية)</option>
                            <option value="ur">Urdu (اردو)</option>
                            <option value="te">Telugu (తెలుగు)</option>
                            <option value="ta">Tamil (தமிழ்)</option>
                            <option value="kn">Kannada (ಕನ್ನಡ)</option>
                            <option value="ml">Malayalam (മലയാളം)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Font Style</label>
                        <select class="form-input" id="fontStyle" name="fontStyle">
                            <option value="Inter, sans-serif">Inter (Modern)</option>
                            <option value="Playfair Display, serif">Playfair Display (Elegant)</option>
                            <option value="Georgia, serif">Georgia (Classic)</option>
                            <option value="Brush Script MT, cursive">Brush Script (Fun)</option>
                            <option value="Montserrat, sans-serif">Montserrat (Clean)</option>
                            <option value="Amiri, serif">Amiri (Traditional)</option>
                            <option value="Lora, serif">Lora (Sophisticated)</option>
                            <option value="Times New Roman, serif">Times New Roman (Formal)</option>
                        </select>
                    </div>

                    <!-- Main Image Upload -->
                    <div class="form-group">
                        <label class="form-label">Main Image</label>
                        <input type="file" class="form-input" id="mainImage" name="mainImage" accept="image/*" onchange="previewImage(this, 'mainImagePreview')">
                        <div id="mainImagePreview" class="image-preview"></div>
                    </div>

                    <!-- Event-Specific Fields (Conditional) -->
                    <div id="weddingFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Wedding Details</h4>
                        <div class="form-group">
                            <label class="form-label">Bride Name</label>
                            <input type="text" class="form-input" id="brideName" name="brideName" placeholder="e.g., Sarah">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Groom Name</label>
                            <input type="text" class="form-input" id="groomName" name="groomName" placeholder="e.g., James">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bride Image</label>
                            <input type="file" class="form-input" id="brideImage" name="brideImage" accept="image/*" onchange="previewImage(this, 'brideImagePreview')">
                            <div id="brideImagePreview" class="image-preview"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Groom Image</label>
                            <input type="file" class="form-input" id="groomImage" name="groomImage" accept="image/*" onchange="previewImage(this, 'groomImagePreview')">
                            <div id="groomImagePreview" class="image-preview"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Muhurtham Time</label>
                            <input type="text" class="form-input" id="muhurthamTime" name="muhurthamTime" placeholder="e.g., 10:30 AM">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Reception Time</label>
                            <input type="text" class="form-input" id="receptionTime" name="receptionTime" placeholder="e.g., 7:00 PM">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Love Story (Optional)</label>
                            <textarea class="form-textarea" id="loveStory" name="loveStory" rows="3" placeholder="Share your beautiful love story..."></textarea>
                        </div>
                    </div>

                    <div id="birthdayFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Birthday Details</h4>
                        <div class="form-group">
                            <label class="form-label">Birthday Person Name</label>
                            <input type="text" class="form-input" id="birthdayPerson" name="birthdayPerson" placeholder="e.g., Emma">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Age</label>
                            <input type="text" class="form-input" id="age" name="age" placeholder="e.g., 16">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Birthday Person Image</label>
                            <input type="file" class="form-input" id="birthdayImage" name="birthdayImage" accept="image/*" onchange="previewImage(this, 'birthdayImagePreview')">
                            <div id="birthdayImagePreview" class="image-preview"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Party Start Time</label>
                            <input type="text" class="form-input" id="startTime" name="startTime" placeholder="e.g., 5:00 PM">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dinner Time</label>
                            <input type="text" class="form-input" id="dinnerTime" name="dinnerTime" placeholder="e.g., 8:00 PM">
                        </div>
                    </div>

                    <div id="anniversaryFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Anniversary Details</h4>
                        <div class="form-group">
                            <label class="form-label">Couple Names</label>
                            <input type="text" class="form-input" id="coupleNames" name="coupleNames" placeholder="e.g., Sarah & James">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Marriage Years</label>
                            <input type="text" class="form-input" id="marriageYears" name="marriageYears" placeholder="e.g., 25">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Couple Image</label>
                            <input type="file" class="form-input" id="coupleImage" name="coupleImage" accept="image/*" onchange="previewImage(this, 'coupleImagePreview')">
                            <div id="coupleImagePreview" class="image-preview"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Anniversary Dinner Time</label>
                            <input type="text" class="form-input" id="anniversaryDinnerTime" name="anniversaryDinnerTime" placeholder="e.g., 7:00 PM">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Party Time</label>
                            <input type="text" class="form-input" id="partyTime" name="partyTime" placeholder="e.g., 9:00 PM">
                        </div>
                    </div>

                    <div id="babyshowerFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Baby Shower Details</h4>
                        <div class="form-group">
                            <label class="form-label">Mother Name</label>
                            <input type="text" class="form-input" id="motherName" name="motherName" placeholder="e.g., Sarah">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Father Name</label>
                            <input type="text" class="form-input" id="fatherName" name="fatherName" placeholder="e.g., James">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Baby Shower Start Time</label>
                            <input type="text" class="form-input" id="babyshowerStartTime" name="babyshowerStartTime" placeholder="e.g., 2:00 PM">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Baby Shower End Time</label>
                            <input type="text" class="form-input" id="babyshowerEndTime" name="babyshowerEndTime" placeholder="e.g., 6:00 PM">
                        </div>
                    </div>

                    <div id="graduationFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Graduation Details</h4>
                        <div class="form-group">
                            <label class="form-label">Graduate Name</label>
                            <input type="text" class="form-input" id="graduateName" name="graduateName" placeholder="e.g., Alex">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Degree</label>
                            <input type="text" class="form-input" id="degree" name="degree" placeholder="e.g., Bachelor of Science">
                        </div>
                        <div class="form-group">
                            <label class="form-label">School/University</label>
                            <input type="text" class="form-input" id="school" name="school" placeholder="e.g., University Name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Major/Field</label>
                            <input type="text" class="form-input" id="major" name="major" placeholder="e.g., Computer Science">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Graduate Image</label>
                            <input type="file" class="form-input" id="graduateImage" name="graduateImage" accept="image/*" onchange="previewImage(this, 'graduateImagePreview')">
                            <div id="graduateImagePreview" class="image-preview"></div>
                        </div>
                    </div>

                    <div id="retirementFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Retirement Details</h4>
                        <div class="form-group">
                            <label class="form-label">Honoree Name</label>
                            <input type="text" class="form-input" id="honoreeName" name="honoreeName" placeholder="e.g., John Smith">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Position</label>
                            <input type="text" class="form-input" id="position" name="position" placeholder="e.g., Senior Manager">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company</label>
                            <input type="text" class="form-input" id="company" name="company" placeholder="e.g., ABC Corporation">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Year</label>
                            <input type="text" class="form-input" id="startYear" name="startYear" placeholder="e.g., 1995">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Honoree Image</label>
                            <input type="file" class="form-input" id="honoreeImage" name="honoreeImage" accept="image/*" onchange="previewImage(this, 'honoreeImagePreview')">
                            <div id="honoreeImagePreview" class="image-preview"></div>
                        </div>
                    </div>

                    <!-- Gallery Images -->
                    <div class="form-group">
                        <label class="form-label">Gallery Images (Multiple)</label>
                        <input type="file" class="form-input" id="galleryImages" name="galleryImages" accept="image/*" multiple onchange="previewMultipleImages(this, 'galleryPreview')">
                        <div id="galleryPreview" class="gallery-preview"></div>
                    </div>
                </form>
                    </div>

            <!-- Live Preview Section -->
            <div class="live-preview-card">
                <div class="preview-title">Live Preview</div>
                <div class="preview-content">
                    <div class="invitation-preview" id="invitationPreviewCard">
                        <div class="preview-icon" id="previewIcon">🎂</div>
                        <div class="preview-event-name" id="previewEventName">
                            Your Event Name
                        </div>
                        <div class="preview-date-time" id="previewDate" style="display: none;">
                            <i class="fas fa-calendar"></i>
                            <span id="previewDateText"></span>
                        </div>
                        <div class="preview-date-time" id="previewTime" style="display: none;">
                            <i class="fas fa-clock"></i>
                            <span id="previewTimeText"></span>
                        </div>
                        <div class="preview-venue" id="previewVenue" style="display: none;">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="previewVenueText"></span>
                        </div>
                        <div class="preview-hosted" id="previewHosted" style="display: none;">
                            <i class="fas fa-user"></i> Hosted by <span id="previewHostedText"></span>
                        </div>
                        <div class="preview-message" id="previewMessage" style="display: none;">
                            <span id="previewMessageText"></span>
                        </div>
                        <div class="preview-placeholder" id="previewPlaceholder">
                            Start filling the form to see your invitation preview
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-navigation">
            <button class="btn-back" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <button class="btn-preview" onclick="submitForm()">
                Preview <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
</div>

<script>
    let selectedThemeValue = '{{ selected_template or "" }}';

    // Optimized: Live Preview Updates - Debounced for better performance
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Live Preview Updates - Optimized with debouncing
        document.addEventListener('DOMContentLoaded', function() {
        const eventNameInput = document.getElementById('eventName');
        const previewEventName = document.getElementById('previewEventName');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const previewIcon = document.getElementById('previewIcon');

        // Get all form inputs for preview
        const eventDateInput = document.getElementById('eventDate');
        const eventTimeInput = document.getElementById('eventTime');
        const venueNameInput = document.getElementById('venueName');
        const venueAddressInput = document.getElementById('venueAddress');
        const hostedByInput = document.getElementById('hostedBy');
        const personalMessageInput = document.getElementById('personalMessage');
        
        const previewDate = document.getElementById('previewDate');
        const previewDateText = document.getElementById('previewDateText');
        const previewTime = document.getElementById('previewTime');
        const previewTimeText = document.getElementById('previewTimeText');
        const previewVenue = document.getElementById('previewVenue');
        const previewVenueText = document.getElementById('previewVenueText');
        const previewHosted = document.getElementById('previewHosted');
        const previewHostedText = document.getElementById('previewHostedText');
        const previewMessage = document.getElementById('previewMessage');
        const previewMessageText = document.getElementById('previewMessageText');

        // Optimized update preview with debouncing (300ms delay)
        const debouncedUpdatePreview = debounce(function() {
            const eventName = eventNameInput ? eventNameInput.value.trim() : '';
            const eventDate = eventDateInput ? eventDateInput.value : '';
            const eventTime = eventTimeInput ? eventTimeInput.value : '';
            const venueName = venueNameInput ? venueNameInput.value.trim() : '';
            const venueAddress = venueAddressInput ? venueAddressInput.value.trim() : '';
            const hostedBy = hostedByInput ? hostedByInput.value.trim() : '';
            const personalMessage = personalMessageInput ? personalMessageInput.value.trim() : '';
            
            let hasContent = false;
            
            if (eventName) {
                previewEventName.textContent = eventName;
                previewPlaceholder.style.display = 'none';
                hasContent = true;
                
                // Update icon based on event type
                const eventType = eventName.toLowerCase();
                if (eventType.includes('wedding') || eventType.includes('marriage')) {
                    previewIcon.textContent = '💍';
                } else if (eventType.includes('birthday') || eventType.includes('bday')) {
                    previewIcon.textContent = '🎂';
                } else if (eventType.includes('anniversary')) {
                    previewIcon.textContent = '💑';
                } else if (eventType.includes('graduation')) {
                    previewIcon.textContent = '🎓';
                } else if (eventType.includes('baby')) {
                    previewIcon.textContent = '👶';
                } else if (eventType.includes('retirement')) {
                    previewIcon.textContent = '🎉';
                } else {
                    previewIcon.textContent = '🎊';
                }
            } else {
                previewEventName.textContent = 'Your Event Name';
                previewIcon.textContent = '🎂';
            }
            
            // Update date
            if (eventDate) {
                const date = new Date(eventDate);
                const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                previewDateText.textContent = formattedDate;
                previewDate.style.display = 'flex';
                hasContent = true;
            } else {
                previewDate.style.display = 'none';
            }
            
            // Update time
            if (eventTime) {
                const time = eventTime.split(':');
                const hours = parseInt(time[0]);
                const minutes = time[1];
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                previewTimeText.textContent = `${displayHours}:${minutes} ${ampm}`;
                previewTime.style.display = 'flex';
                hasContent = true;
            } else {
                previewTime.style.display = 'none';
            }
            
            // Update venue
            const venueFull = [venueName, venueAddress].filter(v => v).join(', ');
            if (venueFull) {
                previewVenueText.textContent = venueFull;
                previewVenue.style.display = 'flex';
                hasContent = true;
            } else {
                previewVenue.style.display = 'none';
            }
            
            // Update hosted by
            if (hostedBy) {
                previewHostedText.textContent = hostedBy;
                previewHosted.style.display = 'block';
                hasContent = true;
            } else {
                previewHosted.style.display = 'none';
            }
            
            // Update message
            if (personalMessage) {
                previewMessageText.textContent = personalMessage;
                previewMessage.style.display = 'block';
                hasContent = true;
            } else {
                previewMessage.style.display = 'none';
            }
            
            // Show/hide placeholder
            if (!hasContent) {
                previewPlaceholder.style.display = 'block';
            } else {
                previewPlaceholder.style.display = 'none';
            }
        }, 300);

        // Update preview as user types - Event Name (optimized with debouncing)
        if (eventNameInput) {
            eventNameInput.addEventListener('input', debouncedUpdatePreview);
            eventNameInput.addEventListener('change', debouncedUpdatePreview);
            
            // Initialize preview with current value immediately
            debouncedUpdatePreview();
        }

        // Update preview for all form fields
        const allInputs = document.querySelectorAll('#invitationForm input, #invitationForm textarea, #invitationForm select');
        allInputs.forEach(input => {
            input.addEventListener('input', debouncedUpdatePreview);
            input.addEventListener('change', debouncedUpdatePreview);
        });

        // Show/hide event-specific fields based on event type
        function showEventSpecificFields(eventType) {
            // Hide all event-specific fields first
            document.querySelectorAll('.event-specific-fields').forEach(field => {
                field.style.display = 'none';
            });

            // Show relevant fields based on event type
            const eventTypeMap = {
                'wedding': 'weddingFields',
                'birthday': 'birthdayFields',
                'anniversary': 'anniversaryFields',
                'babyshower': 'babyshowerFields',
                'graduation': 'graduationFields',
                'retirement': 'retirementFields'
            };

            const fieldId = eventTypeMap[eventType];
            if (fieldId) {
                const fieldElement = document.getElementById(fieldId);
                if (fieldElement) {
                    fieldElement.style.display = 'block';
                }
            }
        }

        // Initialize event-specific fields based on current event type
        const currentEventType = '{{ event_type or "" }}';
        if (currentEventType) {
            showEventSpecificFields(currentEventType);
        }

        // Update default text based on event type
        function setDefaultTexts(eventType) {
            const eventNameInput = document.getElementById('eventName');
            const personalMessageInput = document.getElementById('personalMessage');
            
            if (!eventNameInput || !personalMessageInput) return;

            const defaultTexts = {
                'wedding': {
                    eventName: eventNameInput.value || 'We request the pleasure of your company at our wedding',
                    message: personalMessageInput.value || 'Join us as we celebrate the beginning of our new journey together. Your presence would make our special day even more meaningful.'
                },
                'birthday': {
                    eventName: eventNameInput.value || 'You\'re invited to celebrate!',
                    message: personalMessageInput.value || 'Join us for a celebration filled with joy, laughter, and wonderful memories. Your presence will make this birthday truly special!'
                },
                'anniversary': {
                    eventName: eventNameInput.value || 'Join us in celebrating our anniversary',
                    message: personalMessageInput.value || 'We\'re celebrating another year of love, laughter, and cherished memories. Your presence would make our celebration complete.'
                },
                'babyshower': {
                    eventName: eventNameInput.value || 'Showering our little one with love',
                    message: personalMessageInput.value || 'Join us as we celebrate the upcoming arrival of our little bundle of joy. Your love and blessings are warmly welcome!'
                },
                'graduation': {
                    eventName: eventNameInput.value || 'Celebrating a milestone achievement',
                    message: personalMessageInput.value || 'Join us in celebrating this incredible milestone. Your presence would mean the world to us on this special day!'
                },
                'retirement': {
                    eventName: eventNameInput.value || 'Celebrating a remarkable career',
                    message: personalMessageInput.value || 'Join us in honoring years of dedication and celebrating the beginning of a new chapter. Your presence would be greatly appreciated!'
                }
            };

            const defaults = defaultTexts[eventType];
            if (defaults && !eventNameInput.value) {
                eventNameInput.value = defaults.eventName;
            }
            if (defaults && !personalMessageInput.value) {
                personalMessageInput.value = defaults.message;
                debouncedUpdatePreview();
            }
        }

        // Set default texts on page load
        if (currentEventType) {
            setDefaultTexts(currentEventType);
        }
            
        // Theme Selection
        window.selectTheme = function(themeId, templateId, element) {
            // Remove previous selection
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Mark selected
            element.classList.add('selected');
            selectedThemeValue = themeId;
            
            // Update hidden input with template ID or name
            const templateInput = document.getElementById('selectedTemplate');
            if (templateInput) {
                templateInput.value = templateId || themeId;
            }
            
            // Enable continue button
            const continueBtn = document.getElementById('continueToDetails');
            if (continueBtn) {
                continueBtn.disabled = false;
                continueBtn.style.opacity = '1';
                continueBtn.style.cursor = 'pointer';
            }
        };

        // Continue to Details
        window.continueToDetails = function() {
            if (!selectedThemeValue) {
                alert('Please select a theme first');
                return;
            }

            document.getElementById('themeSelectionPage').classList.remove('active');
            document.getElementById('detailsFormPage').classList.add('active');
            
            // Update progress bar
            updateProgressBar(3);
        };

        // Update Progress Bar
        function updateProgressBar(step) {
            document.querySelectorAll('.progress-step').forEach((stepEl, index) => {
                const stepNum = index + 1;
                if (stepNum < step) {
                    stepEl.classList.remove('active', 'pending');
                    stepEl.classList.add('completed');
                    const circle = stepEl.querySelector('.step-circle');
                    if (circle) {
                        circle.textContent = '✓';
                    }
                } else if (stepNum === step) {
                    stepEl.classList.remove('completed', 'pending');
                    stepEl.classList.add('active');
                    const circle = stepEl.querySelector('.step-circle');
                    if (circle && !circle.textContent.includes('✓')) {
                        circle.textContent = stepNum;
                    }
                } else {
                    stepEl.classList.remove('active', 'completed');
                    stepEl.classList.add('pending');
                    const circle = stepEl.querySelector('.step-circle');
                    if (circle && !circle.textContent.includes('✓')) {
                        circle.textContent = stepNum;
                    }
                }
            });
        }

        // Form submission
        window.submitForm = function() {
            document.getElementById('invitationForm').submit();
        };

        window.goBack = function() {
            const themePage = document.getElementById('themeSelectionPage');
            if (themePage && !themePage.classList.contains('hidden')) {
                themePage.classList.add('active');
                document.getElementById('detailsFormPage').classList.remove('active');
                updateProgressBar(2);
            } else {
                window.history.back();
            }
        };
        });

        // Image preview functions
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = '<img src="' + e.target.result + '" alt="Preview">';
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.innerHTML = '';
                preview.style.display = 'none';
            }
        }

        function previewMultipleImages(input, previewId) {
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';
            
            if (input.files && input.files.length > 0) {
                Array.from(input.files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = 'Gallery Image ' + (index + 1);
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
                preview.style.display = 'grid';
            } else {
                preview.style.display = 'none';
            }
        }
    </script>
{% endblock %}
