{% extends "base.html" %}

{% block title %}Create Invitation - EventCraft Pro{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Montserrat:wght@400;600;700&family=Great+Vibes&family=Cinzel:wght@400;600;700&family=Anton&family=Dancing+Script:wght@400;700&family=Noto+Sans+Telugu:wght@400;600;700&family=Noto+Sans_Devanagari:wght@400;600;700&family=Noto+Sans+Kannada:wght@400;600;700&family=Noto+Sans+Tamil:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    /* Progress Bar */
    .progress-bar-container {
        max-width: 1000px;
        margin: 0 auto 40px;
        padding: 40px 20px 0;
    }

    .progress-bar {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        position: relative;
        width: 100%;
        padding: 0 20px;
    }

    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        position: relative;
        z-index: 2;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .progress-step:hover {
        transform: translateY(-2px);
    }
    
    .progress-step.pending {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .progress-step::after {
        content: '';
        position: absolute;
        top: 20px;
        left: calc(50% + 20px);
        width: calc(100% - 40px);
        height: 3px;
        background: #E5E5E5;
        z-index: 1;
    }

    .progress-step:last-child::after {
        display: none;
    }

    .progress-step.completed::after,
    .progress-step.active::after {
        background: linear-gradient(90deg, #6F4E37 0%, #D4AF37 100%);
    }

    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 8px;
        position: relative;
        z-index: 2;
        transition: all 0.3s ease;
    }

    .progress-step.completed .step-circle {
        background: #6F4E37;
        color: white;
    }

    .progress-step.active .step-circle {
        background: #D4AF37;
        color: white;
    }

    .progress-step.pending .step-circle {
        background: #E5E5E5;
        color: #999;
    }

    .step-label {
        font-size: 14px;
        font-weight: 500;
        color: #666;
        text-align: center;
    }

    .progress-step.completed .step-label,
    .progress-step.active .step-label {
        color: #6F4E37;
        font-weight: 600;
    }

    /* Page Container */
    .create-page-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Theme Selection Page */
    .theme-selection-page {
        display: none;
    }

    .theme-selection-page.active {
        display: block;
    }

    .page-title {
        text-align: center;
        margin-bottom: 40px;
    }

    .page-title h1 {
        font-size: 42px;
        font-weight: 700;
        margin-bottom: 12px;
        color: #3E2723;
    }

    .page-title .title-normal {
        color: #3E2723;
    }

    .page-title .title-gradient {
        background: linear-gradient(135deg, #6F4E37 0%, #D4AF37 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .page-title p {
        font-size: 18px;
        color: #666;
    }

    .theme-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 24px;
        margin-bottom: 40px;
    }

    .theme-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 2px solid transparent;
    }

    .theme-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .theme-card.selected {
        border-color: #D4AF37;
        box-shadow: 0 8px 24px rgba(212, 175, 55, 0.3);
    }

    .theme-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .theme-title {
        padding: 16px;
        font-weight: 600;
        color: #3E2723;
        text-align: center;
    }

    .form-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 40px;
    }

    .btn-back, .btn-continue {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        border: none;
    }

    .btn-back {
        background: #F5F5F5;
        color: #666;
    }

    .btn-back:hover {
        background: #E0E0E0;
    }

    .btn-continue {
        background: linear-gradient(135deg, #6F4E37 0%, #D4AF37 100%);
        color: white;
    }

    .btn-continue:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-continue:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(111, 78, 55, 0.3);
    }

    /* Details Form Page */
    .details-form-page {
        display: none;
    }

    .details-form-page.active {
        display: block;
    }

    .form-preview-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
        margin-top: 40px;
    }

    @media (max-width: 1024px) {
        .form-preview-container {
            grid-template-columns: 1fr;
        }
    }

    .form-section-card, .live-preview-card {
        background: white;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #3E2723;
    }

    .form-label.required::after {
        content: ' *';
        color: #D32F2F;
    }

    .form-input, .form-select, .form-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #E0E0E0;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
        font-family: inherit;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: #D4AF37;
        box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
    }

    .form-textarea {
        min-height: 100px;
        resize: vertical;
    }

    .image-upload-group {
        margin-bottom: 24px;
    }

    .image-preview {
        margin-top: 12px;
        display: none;
    }

    .image-preview img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .rsvp-contact-fields {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    @media (max-width: 768px) {
        .rsvp-contact-fields {
            grid-template-columns: 1fr;
        }
    }

    .event-specific-fields {
        display: none;
    }

    .preview-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 24px;
        color: #3E2723;
        text-align: center;
    }

    .invitation-preview {
        width: 100%;
        background: linear-gradient(135deg, #FFF5F0 0%, #FFFFFF 100%);
        border-radius: 16px;
        padding: 40px 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        min-height: 600px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        position: relative;
        overflow: hidden;
    }

    .template-background-image {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
        object-position: center !important;
        z-index: 1 !important;
        opacity: 0.95 !important;
        pointer-events: none !important;
        border-radius: 16px !important;
        display: block !important;
        visibility: visible !important;
    }

    .template-background-image[src]:not([src=""]) {
        display: block !important;
        visibility: visible !important;
        opacity: 0.95 !important;
    }

    .template-background-image.loaded {
        display: block !important;
        visibility: visible !important;
        opacity: 0.95 !important;
        z-index: 1 !important;
    }

    .invitation-preview > *:not(.template-background-image) {
        position: relative !important;
        z-index: 2 !important;
        color: #FFFFFF;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }

    .preview-icon {
        font-size: 64px;
        margin-bottom: 10px;
        filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.8));
    }

    .preview-event-name {
        font-size: 28px;
        font-weight: 700;
        color: #FFFFFF;
        text-align: center;
        margin-bottom: 20px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8), 0 0 10px rgba(0, 0, 0, 0.5);
        background: rgba(0, 0, 0, 0.3);
        padding: 10px 20px;
        border-radius: 10px;
    }

    .preview-details {
        text-align: center;
        color: #FFFFFF;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8), 0 0 8px rgba(0, 0, 0, 0.5);
        background: rgba(0, 0, 0, 0.25);
        padding: 8px 15px;
        border-radius: 8px;
        display: inline-block;
    }

    .btn-submit {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #6F4E37 0%, #D4AF37 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 24px;
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(111, 78, 55, 0.3);
    }

    .btn-submit:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="create-page-container">
    <!-- Progress Bar -->
    <div class="progress-bar-container">
        <div class="progress-bar">
            <div class="progress-step {% if not selected_template and not show_details %}active{% elif selected_template or show_details %}completed{% endif %}" onclick="navigateToStep(1)">
                <div class="step-circle">1</div>
                <div class="step-label">Select Theme</div>
            </div>
            <div class="progress-step {% if selected_template or show_details %}active{% endif %}">
                <div class="step-circle">2</div>
                <div class="step-label">Add Details</div>
            </div>
            <div class="progress-step pending">
                <div class="step-circle">3</div>
                <div class="step-label">Review</div>
            </div>
        </div>
    </div>

    <!-- Theme Selection Page -->
    {% if not selected_template and not show_details %}
    <div class="theme-selection-page active" id="themeSelectionPage">
        <div class="page-title">
            <h1>
                <span class="title-normal">Choose Your </span>
                <span class="title-gradient">Theme</span>
            </h1>
            <p>Select a design that speaks to your style</p>
        </div>

        <div class="theme-grid">
            {% if templates %}
                {% for template in templates %}
                {% if template.preview_image %}
                {% set template_img = template.preview_image %}
                <div class="theme-card" data-template-id="{{ template.id }}" data-template-image="{{ template_img }}" onclick="selectTheme('{{ template.id }}', this)">
                    <img src="{{ template_img }}" alt="{{ template.name }}" class="theme-image">
                    <div class="theme-title">{{ template.name }}</div>
                </div>
                {% endif %}
                {% endfor %}
            {% endif %}
        </div>

        <div class="form-navigation">
            <a href="{{ url_for('templates') }}" class="btn-back">
                <i class="fas fa-arrow-left"></i> Back
            </a>
            <button class="btn-continue" id="continueToDetails" disabled onclick="continueToDetails()">
                Continue <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Details Form Page -->
    <div class="details-form-page {% if selected_template or show_details %}active{% endif %}" id="detailsFormPage">
        <div class="page-title">
            <h1>
                <span class="title-normal">Add Your </span>
                <span class="title-gradient">Special Details</span>
            </h1>
            <p>Watch your invitation come to life</p>
        </div>

        <div class="form-preview-container">
            <!-- Form Section -->
            <div class="form-section-card">
                <form id="invitationForm" method="POST" action="{{ url_for('create_invitation_post') }}" enctype="multipart/form-data">
                    <input type="hidden" name="templateId" value="{% if template_id %}{{ template_id }}{% endif %}" id="templateIdInput">
                    <input type="hidden" name="templateImageUrl" value="" id="templateImageUrlInput">
                    <input type="hidden" name="eventType" value="{{ event_type }}" id="eventTypeInput">
                    <input type="hidden" name="autoColorTheme" value="" id="autoColorTheme">
                    
                    <div class="form-group">
                        <label class="form-label required" for="eventName">Event Name</label>
                        <input type="text" class="form-input" id="eventName" name="eventTitle" 
                               placeholder="e.g., Sarah & James Wedding"
                               value="{% if current_user and event_type %}{{ current_user.name }}'s {{ event_type.title() }}{% endif %}">
                    </div>

                    <div class="form-group">
                        <label class="form-label required" for="eventDate">Event Date</label>
                        <input type="date" class="form-input" id="eventDate" name="eventDate">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="eventTime">Event Time</label>
                        <input type="time" class="form-input" id="eventTime" name="eventTime">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="venueAddress">Venue Address</label>
                        <textarea class="form-textarea" id="venueAddress" name="venueAddress" placeholder="Enter venue address"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="hostedBy">Hosted By</label>
                        <input type="text" class="form-input" id="hostedBy" name="hostedBy" placeholder="e.g., The Smith Family">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="personalMessage">Personal Message</label>
                        <textarea class="form-textarea" id="personalMessage" name="personalMessage" placeholder="Add a personal message"></textarea>
                    </div>

                    <!-- Wedding Specific Fields -->
                    <div class="event-specific-fields" id="weddingFields">
                        <div class="form-group">
                            <label class="form-label" for="brideName">Bride Name</label>
                            <input type="text" class="form-input" id="brideName" name="brideName" placeholder="Bride's name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="groomName">Groom Name</label>
                            <input type="text" class="form-input" id="groomName" name="groomName" placeholder="Groom's name">
                        </div>
                        <div class="image-upload-group">
                            <label class="form-label" for="brideImage">Bride Photo</label>
                            <input type="file" class="form-input" id="brideImage" name="brideImage" accept="image/*" onchange="previewImage(this, 'brideImagePreview')">
                            <div class="image-preview" id="brideImagePreview"></div>
                        </div>
                        <div class="image-upload-group">
                            <label class="form-label" for="groomImage">Groom Photo</label>
                            <input type="file" class="form-input" id="groomImage" name="groomImage" accept="image/*" onchange="previewImage(this, 'groomImagePreview')">
                            <div class="image-preview" id="groomImagePreview"></div>
                        </div>
                    </div>

                    <!-- Main Image Upload -->
                    <div class="image-upload-group">
                        <label class="form-label" for="mainImage">Cover Image</label>
                        <input type="file" class="form-input" id="mainImage" name="mainImage" accept="image/*" onchange="previewImage(this, 'mainImagePreview')">
                        <div class="image-preview" id="mainImagePreview"></div>
                    </div>

                    <!-- Gallery Images -->
                    <div class="image-upload-group">
                        <label class="form-label" for="galleryImages">Gallery Images</label>
                        <input type="file" class="form-input" id="galleryImages" name="galleryImages" accept="image/*" multiple onchange="previewGalleryImages(this)">
                        <div class="image-preview" id="galleryImagesPreview"></div>
                    </div>

                    <!-- RSVP Contact -->
                    <div class="form-group">
                        <label class="form-label">RSVP Contact</label>
                        <div class="rsvp-contact-fields">
                            <div class="form-group">
                                <label class="form-label" for="rsvpMobile">Mobile Number</label>
                                <input type="tel" class="form-input" id="rsvpMobile" name="rsvpMobile" placeholder="+1234567890">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="rsvpEmail">Email Address</label>
                                <input type="email" class="form-input" id="rsvpEmail" name="rsvpEmail" placeholder="rsvp@example.com">
                            </div>
                        </div>
                    </div>

                    <!-- Language Selection -->
                    <div class="form-group">
                        <label class="form-label" for="language">Language</label>
                        <select class="form-select" id="language" name="language">
                            <option value="english">English</option>
                            <option value="telugu">Telugu</option>
                            <option value="hindi">Hindi</option>
                            <option value="kannada">Kannada</option>
                            <option value="tamil">Tamil</option>
                        </select>
                    </div>

                    <!-- Font Style -->
                    <div class="form-group">
                        <label class="form-label" for="fontStyle">Font Style</label>
                        <select class="form-select" id="fontStyle" name="fontStyle">
                            <option value="'Inter', sans-serif">Inter</option>
                            <option value="'Playfair Display', serif">Playfair Display</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="'Dancing Script', cursive">Dancing Script</option>
                            <option value="'Great Vibes', cursive">Great Vibes</option>
                            <option value="'Cinzel', serif">Cinzel</option>
                        </select>
                    </div>

                    <button type="submit" class="btn-submit" id="submitBtn">
                        <i class="fas fa-check"></i> Create Invitation
                    </button>
                </form>
            </div>

            <!-- Live Preview -->
            <div class="live-preview-card">
                <div class="preview-title">Live Preview</div>
                <div class="invitation-preview" id="invitationPreview">
                    <!-- Template Background Image -->
                    <img class="template-background-image" 
                         id="templateBackgroundImage"
                         alt="Template Design"
                         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; opacity: 0.95; pointer-events: none; border-radius: 16px;">
                    
                    <!-- Main Image -->
                    <div id="previewMainImage" style="display: none; margin-bottom: 15px; text-align: center;">
                        <img id="previewMainImageImg" style="max-width: 100%; max-height: 200px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" alt="Main Image">
                    </div>
                    
                    <div class="preview-icon" id="previewIcon">
                        {% if event_type == 'birthday' %}üéÇ
                        {% elif event_type == 'wedding' %}üíç
                        {% elif event_type == 'anniversary' %}üíë
                        {% elif event_type == 'babyshower' %}üë∂
                        {% else %}üéâ{% endif %}
                    </div>
                    
                    <div class="preview-event-name" id="previewEventName">
                        {% if current_user and event_type %}
                            {{ current_user.name }}'s {{ event_type.title() }}
                        {% else %}
                            Your Event Name
                        {% endif %}
                    </div>
                    
                    <!-- Bride and Groom (for weddings) -->
                    <div id="previewWeddingSection" style="display: none; margin: 20px 0; text-align: center;">
                        <div id="previewBrideName" style="display: none; font-size: 20px; font-weight: 600; margin-bottom: 10px;"></div>
                        <div id="previewBrideImageDiv" style="display: none; margin-bottom: 20px;">
                            <img id="previewBrideImageImg" style="max-width: 150px; max-height: 150px; border-radius: 50%; border: 3px solid #D4AF37; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" alt="Bride">
                        </div>
                        <div id="previewGroomName" style="display: none; font-size: 20px; font-weight: 600; margin-bottom: 10px;"></div>
                        <div id="previewGroomImageDiv" style="display: none;">
                            <img id="previewGroomImageImg" style="max-width: 150px; max-height: 150px; border-radius: 50%; border: 3px solid #D4AF37; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" alt="Groom">
                        </div>
                    </div>
                    
                    <div class="preview-details" id="previewDate"></div>
                    <div class="preview-details" id="previewTime"></div>
                    <div class="preview-details" id="previewVenue"></div>
                    <div class="preview-details" id="previewHostedBy"></div>
                    <div class="preview-details" id="previewMessage" style="font-style: italic; margin-top: 20px;"></div>
                    
                    <!-- Gallery Preview -->
                    <div id="livePreviewGallery" style="display: none; margin-top: 20px; width: 100%;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <!-- Gallery images will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Global variables
let selectedTemplateId = null;
let selectedTemplateImage = null;

// Event type from server - FIXED: Proper string handling
{% if event_type -%}
var currentEventType = {{ event_type|tojson|safe }}.toLowerCase();
{%- else -%}
var currentEventType = '';
{%- endif %}

// Icon mapping
const eventIcons = {
    'birthday': 'üéÇ',
    'wedding': 'üíç',
    'anniversary': 'üíë',
    'babyshower': 'üë∂',
    'graduation': 'üéì',
    'retirement': 'üéâ'
};

// Theme selection
window.selectTheme = function(templateId, element) {
    document.querySelectorAll('.theme-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    element.classList.add('selected');
    selectedTemplateId = templateId;
    
    const templateImage = element.getAttribute('data-template-image');
    if (templateImage) {
        let imagePath = templateImage;
        if (imagePath && !imagePath.startsWith('http')) {
            if (imagePath.startsWith('/static/images/')) {
                imagePath = imagePath.replace('/static/images/', '/images/');
            } else if (imagePath.includes('templatesimages') && !imagePath.startsWith('/')) {
                imagePath = '/images/' + imagePath;
            }
        }
        
        selectedTemplateImage = imagePath;
        sessionStorage.setItem('selectedTemplateId', templateId);
        sessionStorage.setItem('selectedTemplateImage', imagePath);
        
        console.log('‚úÖ Theme selected:', {id: templateId, image: imagePath});
    }
    
    const continueBtn = document.getElementById('continueToDetails');
    if (continueBtn) {
        continueBtn.disabled = false;
    }
};

// Continue to details
window.continueToDetails = function() {
    if (!selectedTemplateId) {
        alert('Please select a theme first');
        return;
    }
    
    document.getElementById('themeSelectionPage').classList.remove('active');
    document.getElementById('detailsFormPage').classList.add('active');
    
    // Apply template background immediately
    applyTemplateBackground();
};

// Apply template background - FIXED
function applyTemplateBackground() {
    const preview = document.getElementById('invitationPreview');
    const backgroundImage = document.getElementById('templateBackgroundImage');
    
    if (!preview || !backgroundImage) {
        console.warn('Preview or background image element not found');
        return;
    }
    
    if (selectedTemplateImage) {
        console.log('üé® Applying template background:', selectedTemplateImage);
        
        backgroundImage.src = selectedTemplateImage;
        backgroundImage.style.display = 'block';
        backgroundImage.style.visibility = 'visible';
        backgroundImage.style.opacity = '0.95';
        backgroundImage.classList.add('loaded');
        
        backgroundImage.onload = function() {
            console.log('‚úÖ Template image loaded successfully');
            this.style.display = 'block';
            this.style.visibility = 'visible';
            this.style.opacity = '0.95';
        };
        
        backgroundImage.onerror = function() {
            console.error('‚ùå Failed to load template image:', selectedTemplateImage);
        };
    }
}

// Image preview
window.previewImage = function(input, previewId) {
    const preview = document.getElementById(previewId);
    if (!preview) return;
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = '<img src="' + e.target.result + '" alt="Preview">';
            preview.style.display = 'block';
            
            // Update live preview
            if (input.id === 'mainImage') {
                updateLivePreviewImages(input.id, e.target.result);
                extractColorsFromImage(e.target.result);
            } else if (input.id === 'brideImage') {
                updateLivePreviewImages(input.id, e.target.result);
            } else if (input.id === 'groomImage') {
                updateLivePreviewImages(input.id, e.target.result);
            }
        };
        reader.readAsDataURL(input.files[0]);
    } else {
        preview.innerHTML = '';
        preview.style.display = 'none';
    }
};

// Gallery images preview
function previewGalleryImages(input) {
    const preview = document.getElementById('galleryImagesPreview');
    if (!preview) return;
    
    preview.innerHTML = '';
    preview.style.display = 'grid';
    preview.style.gridTemplateColumns = 'repeat(3, 1fr)';
    preview.style.gap = '10px';
    
    Array.from(input.files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.width = '100%';
            img.style.borderRadius = '8px';
            preview.appendChild(img);
        };
        reader.readAsDataURL(file);
    });
}

// Update live preview images
function updateLivePreviewImages(inputId, imageSrc) {
    if (inputId === 'mainImage') {
        const previewMainImage = document.getElementById('previewMainImage');
        const previewMainImageImg = document.getElementById('previewMainImageImg');
        if (previewMainImage && previewMainImageImg) {
            previewMainImageImg.src = imageSrc;
            previewMainImage.style.display = 'block';
        }
    } else if (inputId === 'brideImage') {
        const previewBrideImageDiv = document.getElementById('previewBrideImageDiv');
        const previewBrideImageImg = document.getElementById('previewBrideImageImg');
        if (previewBrideImageDiv && previewBrideImageImg) {
            previewBrideImageImg.src = imageSrc;
            previewBrideImageDiv.style.display = 'block';
        }
    } else if (inputId === 'groomImage') {
        const previewGroomImageDiv = document.getElementById('previewGroomImageDiv');
        const previewGroomImageImg = document.getElementById('previewGroomImageImg');
        if (previewGroomImageDiv && previewGroomImageImg) {
            previewGroomImageImg.src = imageSrc;
            previewGroomImageDiv.style.display = 'block';
        }
    }
}

// Extract colors from image for auto theme
function extractColorsFromImage(imageSrc) {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = this.width;
        canvas.height = this.height;
        ctx.drawImage(this, 0, 0);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        
        let r = 0, g = 0, b = 0;
        let count = 0;
        
        for (let i = 0; i < data.length; i += 16) {
            r += data[i];
            g += data[i + 1];
            b += data[i + 2];
            count++;
        }
        
        r = Math.floor(r / count);
        g = Math.floor(g / count);
        b = Math.floor(b / count);
        
        const primaryHex = '#' + [r, g, b].map(x => {
            const hex = x.toString(16);
            return hex.length === 1 ? '0' + hex : hex;
        }).join('');
        
        const secondaryHex = '#' + [Math.min(255, r + 30), Math.min(255, g + 30), Math.min(255, b + 30)].map(x => {
            const hex = x.toString(16);
            return hex.length === 1 ? '0' + hex : hex;
        }).join('');
        
        document.getElementById('autoColorTheme').value = JSON.stringify({
            primary: primaryHex,
            secondary: secondaryHex
        });
    };
    img.src = imageSrc;
}

// Update preview
function updatePreview() {
    const eventName = document.getElementById('eventName').value;
    const eventDate = document.getElementById('eventDate').value;
    const eventTime = document.getElementById('eventTime').value;
    const venueAddress = document.getElementById('venueAddress').value;
    const hostedBy = document.getElementById('hostedBy').value;
    const personalMessage = document.getElementById('personalMessage').value;
    
    const previewEventName = document.getElementById('previewEventName');
    const previewDate = document.getElementById('previewDate');
    const previewTime = document.getElementById('previewTime');
    const previewVenue = document.getElementById('previewVenue');
    const previewHostedBy = document.getElementById('previewHostedBy');
    const previewMessage = document.getElementById('previewMessage');
    
    if (previewEventName) previewEventName.textContent = eventName || 'Your Event Name';
    if (previewDate) previewDate.textContent = eventDate ? 'Date: ' + new Date(eventDate).toLocaleDateString() : '';
    if (previewTime) previewTime.textContent = eventTime ? 'Time: ' + eventTime : '';
    if (previewVenue) previewVenue.textContent = venueAddress ? 'Venue: ' + venueAddress : '';
    if (previewHostedBy) previewHostedBy.textContent = hostedBy ? 'Hosted by: ' + hostedBy : '';
    if (previewMessage) previewMessage.textContent = personalMessage || '';
    
    // Update bride and groom names
    const brideNameEl = document.getElementById('brideName');
    const brideName = brideNameEl ? brideNameEl.value.trim() : '';
    const groomNameEl = document.getElementById('groomName');
    const groomName = groomNameEl ? groomNameEl.value.trim() : '';
    
    const previewBrideName = document.getElementById('previewBrideName');
    const previewGroomName = document.getElementById('previewGroomName');
    const previewWeddingSection = document.getElementById('previewWeddingSection');
    
    if (brideName || groomName) {
        if (previewBrideName && brideName) {
            previewBrideName.textContent = brideName;
            previewBrideName.style.display = 'block';
        }
        if (previewGroomName && groomName) {
            previewGroomName.textContent = groomName;
            previewGroomName.style.display = 'block';
        }
        if (previewWeddingSection) {
            previewWeddingSection.style.display = 'block';
        }
    }
    
    // Apply font style
    const fontStyleEl = document.getElementById('fontStyle');
    const fontStyle = fontStyleEl ? fontStyleEl.value : null;
    const previewContainer = document.getElementById('invitationPreview');
    if (fontStyle && previewContainer) {
        previewContainer.style.fontFamily = fontStyle;
    }
    
    // Apply template background
    applyTemplateBackground();
}

// Show event-specific fields
function showEventSpecificFields() {
    document.querySelectorAll('.event-specific-fields').forEach(el => {
        el.style.display = 'none';
    });
    
    const fieldMap = {
        'wedding': 'weddingFields'
    };
    
    const fieldId = fieldMap[currentEventType];
    if (fieldId) {
        const field = document.getElementById(fieldId);
        if (field) field.style.display = 'block';
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Page loaded, initializing...');
    showEventSpecificFields();
    
    // Check if template was passed from URL - FIXED
    {% if template_id and templates %}
    const urlTemplateId = '{{ template_id }}';
    console.log('üîç Checking URL template ID:', urlTemplateId);
    {% for template in templates %}
    if ('{{ template.id }}' === urlTemplateId) {
        selectedTemplateId = '{{ template.id }}';
        {% if template.preview_image %}
        {% set template_img = template.preview_image %}
        {% if template_img and not template_img.startswith('http') %}
        {%- if template_img.startswith('/images/') -%}
        {%- set template_img = template_img -%}
        {%- elif template_img.startswith('/static/images/') -%}
        {%- set template_img = template_img.replace('/static/images/', '/images/') -%}
        {%- elif 'templatesimages' in template_img -%}
        {%-  if not template_img.startswith('/') -%}
        {%-  set template_img = '/images/' + template_img -%}
        {%-  endif -%}
        {%- elif not template_img.startswith('/') -%}
        {%- set template_img = '/images/templatesimages/' + template_img -%}
        {%- endif %}
        {% endif %}
        selectedTemplateImage = {{ template_img|tojson|safe }};
        {% else %}
        selectedTemplateImage = '';
        {% endif %}
        
        console.log('‚úÖ Template from URL:', {id: selectedTemplateId, image: selectedTemplateImage});
        
        // Set form inputs
        const templateIdInput = document.getElementById('templateIdInput');
        const templateImageUrlInput = document.getElementById('templateImageUrlInput');
        if (templateIdInput && selectedTemplateId) {
            templateIdInput.value = selectedTemplateId;
        }
        if (templateImageUrlInput && selectedTemplateImage) {
            templateImageUrlInput.value = selectedTemplateImage;
        }
        
        // Apply template immediately with retries
        if (selectedTemplateImage) {
            setTimeout(() => applyTemplateBackground(), 100);
            setTimeout(() => applyTemplateBackground(), 500);
        }
    }
    {% endfor %}
    {% endif %}
    
    // Check sessionStorage
    const storedId = sessionStorage.getItem('selectedTemplateId');
    const storedImage = sessionStorage.getItem('selectedTemplateImage');
    
    if (storedId && storedImage) {
        selectedTemplateId = storedId;
        let imagePath = storedImage;
        if (imagePath && !imagePath.startsWith('http')) {
            if (imagePath.startsWith('/static/images/')) {
                imagePath = imagePath.replace('/static/images/', '/images/');
            }
        }
        selectedTemplateImage = imagePath;
        sessionStorage.removeItem('selectedTemplateId');
        sessionStorage.removeItem('selectedTemplateImage');
        
        console.log('‚úÖ Template from storage:', {id: selectedTemplateId, image: selectedTemplateImage});
        
        if (selectedTemplateImage) {
            applyTemplateBackground();
        }
    }
    
    // Attach event listeners
    const inputs = ['eventName', 'eventDate', 'eventTime', 'venueAddress', 'hostedBy', 'personalMessage', 'fontStyle', 'language', 'brideName', 'groomName'];
    inputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', updatePreview);
            input.addEventListener('change', updatePreview);
        }
    });
    
    // Initial preview update
    updatePreview();
    
    console.log('‚úÖ Initialization complete');
});
</script>
{% endblock %}