{% extends "base.html" %}

{% block title %}Create Invitation - EventCraft Pro{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* Progress Bar - Exact Match from Images */
    .progress-bar-container {
        max-width: 1000px;
        margin: 0 auto 40px;
        padding: 40px 20px 0;
        background: transparent !important;
    }

    .progress-bar {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        position: relative;
        width: 100%;
        padding: 0 20px;
        background: transparent !important;
    }

    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        position: relative;
        z-index: 2;
        margin-bottom: 0;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .progress-step:hover {
        transform: translateY(-3px);
    }
    
    .progress-step.clickable-step:hover .step-circle {
        transform: scale(1.1);
        transition: transform 0.3s ease;
    }
    
    .progress-step.pending {
        cursor: not-allowed;
        opacity: 1 !important;
    }
    
    .progress-step.pending:hover {
        transform: none;
    }

    .progress-step::after {
        content: '';
        position: absolute;
        top: 20px;
        left: calc(50% + 20px);
        width: 0;
        height: 3px;
        background: #E5E5E5;
        z-index: 1;
        visibility: visible !important;
        opacity: 1 !important;
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1), background 0.6s ease;
        transform-origin: left center;
    }

    .progress-step:last-child::after {
        display: none;
    }

    .progress-step.completed::after {
        background: linear-gradient(90deg, var(--reddish-brown-dark) 0%, var(--golden-yellow) 100%);
        width: calc(100% - 40px) !important;
        animation: progressLinePulse 2s ease-in-out infinite;
    }

    .progress-step.active::after {
        background: linear-gradient(90deg, var(--reddish-brown-dark) 0%, var(--golden-yellow) 100%);
        width: calc(100% - 40px) !important;
        animation: progressLinePulse 2s ease-in-out infinite 0.8s;
    }
    
    /* Progress line fill animation - animates from 0 to full width */
    @keyframes progressLineFill {
        0% {
            width: 0 !important;
            opacity: 0.3;
        }
        50% {
            opacity: 0.7;
        }
        100% {
            width: calc(100% - 40px) !important;
            opacity: 1;
        }
    }
    
    /* Subtle pulse animation for completed/active lines */
    @keyframes progressLinePulse {
        0%, 100% {
            opacity: 1;
            transform: scaleY(1);
        }
        50% {
            opacity: 0.85;
            transform: scaleY(1.15);
        }
    }
    
    /* Class to trigger line fill animation */
    .progress-step.animating-line::after {
        animation: progressLineFill 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    .progress-step.animating-line.completed::after {
        animation: progressLineFill 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards, progressLinePulse 2s ease-in-out infinite 0.8s;
    }
    
    .progress-step.animating-line.active::after {
        animation: progressLineFill 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards, progressLinePulse 2s ease-in-out infinite 0.8s;
    }

    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex !important;
        align-items: center;
        justify-content: center;
        font-weight: 700 !important;
        font-size: 16px !important;
        margin-bottom: 8px;
        position: relative;
        z-index: 2;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        visibility: visible !important;
        opacity: 1 !important;
        border: 2px solid transparent;
        transform: scale(1);
    }
    
    /* Pulse animation for active step */
    .progress-step.active .step-circle {
        animation: pulseActive 2s ease-in-out infinite;
    }
    
    @keyframes pulseActive {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 0 0 8px rgba(212, 175, 55, 0);
        }
    }

    .progress-step.completed .step-circle {
        background: var(--reddish-brown-dark) !important;
        color: #FFFFFF !important;
        border-color: var(--reddish-brown-dark) !important;
        animation: checkmarkAppear 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    }
    
    /* Checkmark animation */
    @keyframes checkmarkAppear {
        0% {
            transform: scale(0) rotate(-180deg);
            opacity: 0;
        }
        50% {
            transform: scale(1.2) rotate(10deg);
        }
        100% {
            transform: scale(1) rotate(0deg);
            opacity: 1;
        }
    }

    /* Active step appear animation */
    @keyframes activeStepAppear {
        0% {
            transform: scale(0.8);
            opacity: 0.7;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    .progress-step.active .step-circle {
        background: var(--golden-yellow) !important;
        color: var(--reddish-brown-dark) !important;
        border-color: var(--golden-yellow) !important;
        font-weight: 700 !important;
    }

    .progress-step.pending .step-circle {
        background: #FFFFFF !important;
        color: var(--reddish-brown-dark) !important;
        border: 2px solid var(--reddish-brown-dark) !important;
        font-weight: 700 !important;
        transition: all 0.4s ease;
    }
    
    /* Step transition animation */
    .progress-step {
        animation: stepFadeIn 0.5s ease forwards;
    }
    
    @keyframes stepFadeIn {
        0% {
            opacity: 0;
            transform: translateY(-10px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .step-label {
        font-size: 14px !important;
        font-weight: 500 !important;
        color: var(--reddish-brown-dark) !important;
        text-align: center;
        visibility: visible !important;
        opacity: 1 !important;
        display: block !important;
        margin-top: 4px;
    }

    .progress-step.active .step-label {
        color: var(--reddish-brown-dark) !important;
        font-weight: 600 !important;
    }

    .progress-step.completed .step-label {
        color: var(--reddish-brown-dark) !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .progress-step.pending .step-label {
        color: var(--reddish-brown-dark) !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* Page Container */
    .create-page-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 20px 60px;
        background: var(--bg-cream);
        min-height: 100vh;
    }
    
    /* Smooth page transitions */
    .theme-selection-page,
    .details-form-page {
        animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Page Title */
    .page-title {
        text-align: center;
        margin-bottom: 48px;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
        padding: 0 20px;
    }

    .page-title h1 {
        font-size: 42px;
        font-weight: 700;
        margin-bottom: 12px;
        line-height: 1.2;
        letter-spacing: -0.02em;
        visibility: visible !important;
        opacity: 1 !important;
        display: block !important;
    }

    .page-title h1 .title-normal {
        color: var(--reddish-brown-dark) !important;
        visibility: visible !important;
        opacity: 1 !important;
        display: inline-block !important;
        -webkit-text-fill-color: var(--reddish-brown-dark) !important;
        background: none !important;
        -webkit-background-clip: unset !important;
        background-clip: unset !important;
    }

    .page-title h1 .title-gradient {
        color: var(--reddish-brown-dark) !important;
        visibility: visible !important;
        opacity: 1 !important;
        display: inline-block !important;
        -webkit-text-fill-color: var(--reddish-brown-dark) !important;
        background: none !important;
        -webkit-background-clip: unset !important;
        background-clip: unset !important;
    }

    /* Gradient text effect - only applies when supported, with fallback */
    @supports (-webkit-background-clip: text) or (background-clip: text) {
    .page-title h1 .title-gradient {
        background: linear-gradient(135deg, var(--reddish-brown-dark) 0%, var(--golden-yellow) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
            color: var(--reddish-brown-dark); /* Fallback */
        }
    }

    .page-title p {
        font-size: 16px !important;
        color: var(--reddish-brown-dark) !important;
        font-weight: 400 !important;
        visibility: visible !important;
        opacity: 1 !important;
        display: block !important;
    }

    /* Theme Selection Page */
    .theme-selection-page {
        display: none;
    }

    .theme-selection-page.active {
        display: block;
    }

    .theme-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 24px;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px 40px;
        min-height: 400px;
    }

    .theme-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        border: 2px solid transparent;
        display: flex;
        flex-direction: column;
    }

    .theme-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(160, 120, 120, 0.15);
        border-color: rgba(160, 120, 120, 0.2);
    }

    .theme-card.selected {
        border-color: var(--reddish-brown-dark);
        box-shadow: 0 8px 24px rgba(160, 120, 120, 0.25);
        transform: translateY(-2px);
    }

    .theme-card.selected:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(160, 120, 120, 0.3);
    }

    .theme-card.selected::after {
        content: 'âœ“';
        position: absolute;
        top: 10px;
        right: 10px;
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, var(--reddish-brown-dark) 0%, var(--golden-yellow) 100%);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
        z-index: 10;
        box-shadow: 0 4px 12px rgba(160, 120, 120, 0.4);
        animation: scaleIn 0.2s ease;
    }

    @keyframes scaleIn {
        from {
            transform: scale(0);
        }
        to {
            transform: scale(1);
        }
    }

    .theme-image {
        width: 100%;
        height: 240px;
        object-fit: cover;
        display: block;
        transition: transform 0.3s ease;
    }

    .theme-card:hover .theme-image {
        transform: scale(1.05);
    }

    .theme-title {
        padding: 16px 20px;
        text-align: center;
        font-size: 16px;
        font-weight: 600;
        color: var(--text-dark);
        background: #FAFAFA;
        border-top: 1px solid #F0F0F0;
    }

    .theme-card.selected .theme-title {
        background: rgba(160, 120, 120, 0.05);
        color: var(--reddish-brown-dark);
        font-weight: 700;
    }

    /* Details Form with Live Preview */
    .details-form-page {
        display: none;
    }

    .details-form-page.active {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Ensure preview is always visible when details page is active */
    .details-form-page.active .live-preview-card,
    .details-form-page.active .preview-content,
    .details-form-page.active .invitation-preview {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .form-preview-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 32px;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        animation: fadeIn 0.6s ease-out 0.3s both;
    }

    /* Form Section - White background for readability */
    .form-section-card {
        background: rgba(255, 255, 255, 0.95) !important;
        backdrop-filter: blur(10px) !important;
        -webkit-backdrop-filter: blur(10px) !important;
        border-radius: 20px;
        padding: 32px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(240, 240, 240, 0.8);
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
        letter-spacing: -0.01em;
    }

    .form-label.required::after {
        content: ' *';
        color: var(--reddish-brown-dark);
    }

    .form-input,
    .form-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1.5px solid #E5E5E5;
        border-radius: 10px;
        font-size: 15px;
        transition: all 0.2s ease;
        font-family: 'Inter', sans-serif;
        background: rgba(255, 255, 255, 0.9) !important;
        backdrop-filter: blur(5px) !important;
        -webkit-backdrop-filter: blur(5px) !important;
    }

    .form-input:hover,
    .form-textarea:hover {
        border-color: rgba(160, 120, 120, 0.3);
        background: rgba(255, 255, 255, 1) !important;
    }

    .form-input:focus,
    .form-textarea:focus {
        outline: none;
        border-color: var(--reddish-brown-dark);
        background: rgba(255, 255, 255, 1) !important;
        box-shadow: 0 0 0 3px rgba(160, 120, 120, 0.08);
    }
    
    /* White background when input has value */
    .form-input:not(:placeholder-shown),
    .form-textarea:not(:placeholder-shown) {
        background: rgba(255, 255, 255, 1) !important;
    }
    
    /* Form group with content gets white background */
    .form-group.has-content {
        background: rgba(255, 255, 255, 0.7) !important;
        backdrop-filter: blur(5px) !important;
        -webkit-backdrop-filter: blur(5px) !important;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 16px;
    }

    .form-textarea {
        resize: vertical;
        min-height: 120px;
    }

    .input-with-icon {
        position: relative;
    }

    .input-with-icon i {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-gray);
        pointer-events: none;
    }

    /* Live Preview Section - Enhanced Visibility - Always Visible */
    .live-preview-card {
        background: rgba(255, 255, 255, 0.98) !important;
        backdrop-filter: blur(10px) !important;
        -webkit-backdrop-filter: blur(10px) !important;
        border-radius: 20px;
        padding: 32px;
        display: flex !important;
        flex-direction: column;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important;
        border: 2px solid rgba(111, 78, 55, 0.2) !important;
        position: sticky;
        top: 20px;
        height: fit-content;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
        z-index: 10;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .preview-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-dark) !important;
        margin-bottom: 24px;
        text-align: center;
        padding-bottom: 16px;
        border-bottom: 2px solid rgba(111, 78, 55, 0.3);
        letter-spacing: -0.02em;
        visibility: visible !important;
        opacity: 1 !important;
        background: rgba(255, 255, 255, 0.9);
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .preview-content {
        text-align: center;
        min-height: 400px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        padding: 20px;
        position: relative;
        z-index: 10 !important;
        overflow-y: auto !important;
        max-height: calc(80vh - 100px) !important;
        padding-right: 10px;
        background: rgba(255, 255, 255, 0.95) !important;
        border-radius: 12px;
    }

    .invitation-preview {
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
        /* Empty by default - no background until template is selected */
        background: #ffffff;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 16px;
        padding: 40px 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        border: 2px solid rgba(160, 120, 120, 0.1);
        position: relative;
        min-height: 600px;
        display: flex !important;
        flex-direction: column;
        justify-content: flex-start;
        overflow: visible;
        /* Ensure template background is visible */
        z-index: 0;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* Template background - CRITICAL: Override the background shorthand from .invitation-preview */
    .invitation-preview.template-bg {
        /* CRITICAL: Use CSS variable for background-image - JavaScript will set this */
        background-image: var(--template-bg-image-url, none) !important;
        background-color: transparent !important;
        background-size: cover !important;
        background-position: center !important;
        background-repeat: no-repeat !important;
        position: relative;
        z-index: 0;
    }
    
    /* Ensure inline background-image is visible - this selector has higher specificity */
    .invitation-preview.template-bg[style*="background-image"] {
        /* Inline styles should override, but ensure supporting properties are set */
        background-size: cover !important;
        background-position: center !important;
        background-repeat: no-repeat !important;
        /* Don't set background-image here - let inline style handle it */
    }

    /* Template background - Remove default gradient and show template design */
    .invitation-preview.wedding-bg {
        background-image: url('/images/templatesimages/wedding.png') !important;
        background-size: cover !important;
        background-position: center !important;
        background-repeat: no-repeat !important;
        background-color: transparent !important;
        position: relative;
    }
    
    /* Duplicate rule removed - handled by the rule above */
    
    /* Ensure template background image is visible when set via inline style */
    .invitation-preview.template-bg[style*="background-image"] {
        /* Inline styles have highest priority, so this should work */
        background-size: cover !important;
        background-position: center !important;
        background-repeat: no-repeat !important;
    }
    
    .invitation-preview.wedding-bg {
        background-image: url('/images/templatesimages/wedding.png') !important;
        background-size: cover !important;
        background-position: center !important;
        background-repeat: no-repeat !important;
    }
    
    /* Template image overlay - DISABLED - template image is applied directly as background-image */
    .invitation-preview.template-bg::after {
        display: none !important;
    }
    
    /* Decorative overlay removed - image.png file was deleted */
    /* .invitation-preview.wedding-bg::after and .invitation-preview:not(.template-bg):not(.wedding-bg)::after 
       have been removed since image.png no longer exists */

    /* Default gradient background - only shows when no template is selected */
    .invitation-preview::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #FFF5F0 0%, #FFFFFF 100%);
        z-index: 0;
        pointer-events: none;
        border-radius: 16px;
    }

    /* Remove default gradient background when template is active (template design shows instead) */
    .invitation-preview.wedding-bg::before,
    .invitation-preview.template-bg::before {
        display: none !important;
    }
    
    /* CRITICAL: Ensure template-bg background image is not overridden by ::before or ::after */
    .invitation-preview.template-bg::before,
    .invitation-preview.template-bg::after {
        display: none !important;
        content: none !important;
        background: none !important;
        background-image: none !important;
    }

    /* Ensure all preview content is above background and overlay */
    /* User-uploaded images should be above background but below text */
    #previewMainImageContainer,
    #previewBrideGroomContainer,
    #previewBirthdayImageContainer,
    #previewCoupleImageContainer,
    #previewGraduateImageContainer,
    #previewHonoreeImageContainer {
        position: relative !important;
        z-index: 15 !important;
        margin: 10px 0;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: 100% !important;
    }
    
    /* All text content should be above the overlay AND uploaded images */
    /* Note: .preview-content styles are defined above */
    
    /* Scrollbar styling for preview content */
    .preview-content::-webkit-scrollbar {
        width: 8px;
    }
    
    .preview-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .preview-content::-webkit-scrollbar-thumb {
        background: #6F4E37;
        border-radius: 10px;
    }
    
    .preview-content::-webkit-scrollbar-thumb:hover {
        background: #5a3d2a;
    }
    
    .preview-event-name,
    .preview-date-time,
    .preview-venue,
    .preview-hosted,
    .preview-message,
    .preview-icon,
    .preview-bride-groom,
    .preview-birthday-person,
    .preview-couple-names,
    .preview-mother-father,
    .preview-graduate {
        position: relative;
        z-index: 15 !important;
        /* Ensure text is always visible */
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Uploaded images themselves should have high z-index */
    #previewMainImage,
    #previewBrideImage,
    #previewGroomImage,
    #previewBirthdayImage,
    #previewCoupleImage,
    #previewGraduateImage,
    #previewHonoreeImage {
        position: relative !important;
        z-index: 15 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: 100% !important;
        max-width: 100% !important;
        height: auto !important;
        object-fit: cover !important;
    }
    
    /* Ensure all preview content is above background */
    .invitation-preview > * {
        position: relative;
        z-index: 10;
    }

    .preview-icon {
        font-size: 64px;
        margin-bottom: 20px;
        display: none !important; /* Hidden by default - only show when no template background or when needed */
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        visibility: hidden;
        opacity: 0;
    }
    
    /* Only show icon when there's no template background */
    .invitation-preview:not(.template-bg):not(.wedding-bg) .preview-icon {
        display: block !important;
        visibility: visible;
        opacity: 1;
    }

    .preview-event-name {
        font-size: 28px;
        font-weight: 700;
        color: var(--reddish-brown-dark);
        margin-bottom: 20px;
        font-family: 'Playfair Display', serif;
        line-height: 1.2;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        background: transparent !important;
        padding: 0 !important;
        border-radius: 0 !important;
        display: none !important; /* Hidden by default - only show when event name is entered */
        visibility: hidden;
        opacity: 0;
    }

    .invitation-preview.wedding-bg .preview-event-name,
    .invitation-preview.template-bg .preview-event-name {
        color: #fff !important;
        background: transparent !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7) !important;
    }

    .preview-date-time {
        font-size: 16px;
        color: var(--text-gray) !important;
        margin-bottom: 12px;
        display: flex !important;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        background: transparent !important;
        padding: 0 !important;
        border-radius: 0 !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .invitation-preview.wedding-bg .preview-date-time,
    .invitation-preview.template-bg .preview-date-time {
        color: #fff !important;
        background: transparent !important;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7) !important;
    }

    .preview-venue {
        font-size: 16px;
        color: var(--text-gray) !important;
        margin-bottom: 12px;
        display: flex !important;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-align: center;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        background: transparent !important;
        padding: 0 !important;
        border-radius: 0 !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .invitation-preview.wedding-bg .preview-venue,
    .invitation-preview.template-bg .preview-venue {
        color: #fff !important;
        background: transparent !important;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7) !important;
    }

    .preview-hosted {
        font-size: 14px;
        color: var(--text-gray) !important;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(160, 120, 120, 0.2);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        background: transparent !important;
        padding: 20px 0 0 0 !important;
        border-radius: 0 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .invitation-preview.wedding-bg .preview-hosted,
    .invitation-preview.template-bg .preview-hosted {
        color: #fff !important;
        background: transparent !important;
        border-top: 1px solid rgba(255, 255, 255, 0.3);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7) !important;
    }

    .preview-message {
        font-size: 15px;
        color: var(--text-dark) !important;
        line-height: 1.6;
        margin-top: 20px;
        font-style: italic;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        background: transparent !important;
        padding: 0 !important;
        border-radius: 0 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .invitation-preview.wedding-bg .preview-message,
    .invitation-preview.template-bg .preview-message {
        color: #fff !important;
        background: transparent !important;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7) !important;
    }
    
    /* Event-Specific Preview Fields */
    .preview-bride-groom,
    .preview-birthday-person,
    .preview-couple-names,
    .preview-mother-father,
    .preview-graduate {
        font-size: 20px;
        font-weight: 600;
        color: var(--reddish-brown-dark);
        margin-bottom: 15px;
        text-align: center;
        text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.8);
        background: transparent !important;
        padding: 0 !important;
        border-radius: 0 !important;
        display: block;
        position: relative;
        z-index: 10 !important;
    }
    
    .invitation-preview.wedding-bg .preview-bride-groom,
    .invitation-preview.template-bg .preview-bride-groom,
    .invitation-preview.wedding-bg .preview-birthday-person,
    .invitation-preview.template-bg .preview-birthday-person,
    .invitation-preview.wedding-bg .preview-couple-names,
    .invitation-preview.template-bg .preview-couple-names,
    .invitation-preview.wedding-bg .preview-mother-father,
    .invitation-preview.template-bg .preview-mother-father,
    .invitation-preview.wedding-bg .preview-graduate,
    .invitation-preview.template-bg .preview-graduate {
        color: #fff;
        background: transparent !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    /* Preview Images Overlay */
    .preview-images-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin: 20px 0;
        flex-wrap: wrap;
    }

    .preview-image-overlay {
        width: 80px !important;
        height: 80px !important;
        border-radius: 50% !important;
        object-fit: cover !important;
        border: 3px solid rgba(255, 255, 255, 0.9) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        z-index: 15 !important;
        position: relative !important;
    }

    .preview-main-image {
        width: 100% !important;
        max-height: 200px !important;
        object-fit: cover !important;
        border-radius: 12px !important;
        margin-bottom: 20px !important;
        border: 2px solid rgba(255, 255, 255, 0.9) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        display: block !important;
        z-index: 15 !important;
        position: relative !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    #previewMainImageContainer {
        position: relative !important;
        z-index: 15 !important;
        width: 100% !important;
        margin-bottom: 20px !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .preview-placeholder {
        font-size: 14px;
        color: var(--text-gray) !important;
        line-height: 1.6;
        padding: 40px 20px;
        text-align: center;
        visibility: visible !important;
        opacity: 1 !important;
        display: block !important;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        border: 2px dashed rgba(111, 78, 55, 0.3);
    }

    /* Event-Specific Fields */
    .event-specific-fields {
        margin-top: 30px;
        padding-top: 30px;
        border-top: 2px solid #E5E5E5;
    }

    .section-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--reddish-brown-dark);
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--golden-yellow);
        letter-spacing: -0.01em;
    }

    /* Image Preview Styles */
    .image-preview {
        margin-top: 12px;
        display: none;
    }

    .image-preview img {
        width: 100%;
        max-width: 200px;
        height: auto;
        border-radius: 12px;
        border: 2px solid #E5E5E5;
        margin-top: 8px;
    }

    .gallery-preview {
        margin-top: 12px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
    }

    .gallery-preview img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #E5E5E5;
    }
    
    /* Gallery Preview in Live Preview */
    .preview-gallery {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid rgba(160, 120, 120, 0.2);
        position: relative;
        z-index: 15 !important;
    }
    
    /* Gallery Section inside invitation card */
    #previewGallerySection {
        position: relative !important;
        z-index: 20 !important;
        width: 100% !important;
        margin-top: 30px !important;
        padding-top: 20px !important;
        padding-bottom: 10px !important;
        border-top: 2px solid rgba(160, 120, 120, 0.3) !important;
        display: none; /* Will be set to block by JavaScript when images are uploaded */
    }
    
    #previewGalleryGrid {
        display: grid !important;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)) !important;
        gap: 15px !important;
        width: 100% !important;
        position: relative !important;
        z-index: 25 !important;
        padding: 10px 0 !important;
    }
    
    #previewGalleryGrid img {
        width: 100% !important;
        height: 180px !important;
        object-fit: cover !important;
        border-radius: 10px !important;
        border: 3px solid rgba(255, 255, 255, 0.9) !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 25 !important;
        background: #ffffff !important;
        cursor: pointer !important;
        transition: transform 0.3s ease !important;
    }
    
    #previewGalleryGrid img:hover {
        transform: scale(1.05) !important;
        box-shadow: 0 6px 20px rgba(0,0,0,0.4) !important;
    }
    
    .preview-gallery-title {
        font-size: 1.5rem !important;
        font-weight: 700 !important;
        color: #6F4E37 !important;
        margin-bottom: 20px !important;
        text-align: center !important;
        text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.9) !important;
        background: rgba(255, 255, 255, 0.7) !important;
        padding: 8px 16px !important;
        border-radius: 8px !important;
        display: inline-block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 25 !important;
        width: auto !important;
        margin-left: auto !important;
        margin-right: auto !important;
    }

    .invitation-preview.wedding-bg .preview-gallery-title,
    .invitation-preview.template-bg .preview-gallery-title {
        color: #fff !important;
        background: transparent !important;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7) !important;
    }
    
    .preview-gallery-grid {
        display: grid !important;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)) !important;
        gap: 10px !important;
        margin-top: 10px !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 15 !important;
    }
    
    .preview-gallery-grid img {
        width: 100% !important;
        height: 80px !important;
        object-fit: cover !important;
        border-radius: 8px !important;
        border: 2px solid rgba(255, 255, 255, 0.5) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
        position: relative !important;
        z-index: 15 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    select.form-input {
        cursor: pointer;
    }

    /* Navigation Buttons */
        .form-navigation {
        display: flex;
        justify-content: space-between;
        max-width: 1200px;
        margin: 40px auto 0;
        padding: 0 20px;
    }

    .btn-back,
    .btn-continue,
    .btn-preview {
        padding: 14px 32px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        transition: all 0.3s ease;
        display: inline-flex !important;
            align-items: center;
        gap: 8px;
        border: 2px solid;
        text-decoration: none;
        cursor: pointer;
        background: white;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .btn-back {
        color: var(--reddish-brown-dark);
        border-color: var(--reddish-brown-dark);
    }

    .btn-back:hover {
        background: #F8F8F8;
        transform: translateY(-2px);
    }

    .btn-continue,
    .btn-preview {
        background: linear-gradient(135deg, var(--reddish-brown-dark) 0%, var(--golden-yellow) 100%);
        color: #FFFFFF !important;
        border: none;
        box-shadow: 0 2px 8px rgba(160, 120, 120, 0.2);
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .btn-preview,
    .btn-preview * {
        color: #FFFFFF !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .btn-preview i {
        color: #FFFFFF !important;
        visibility: visible !important;
        opacity: 1 !important;
        display: inline-block !important;
    }

    .btn-continue:hover,
    .btn-preview:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(160, 120, 120, 0.35);
    }

    .btn-continue:not(:disabled) {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 2px 8px rgba(160, 120, 120, 0.2);
        }
        50% {
            box-shadow: 0 4px 16px rgba(160, 120, 120, 0.3);
        }
    }

    .btn-continue:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* Smooth fade-in animation for sections */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
    
    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(30px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    /* Apply animations to sections */
    .form-section-card {
        animation: fadeInUp 0.6s ease-out;
    }
    
    .live-preview-card {
        animation: fadeInUp 0.6s ease-out 0.2s both;
    }
    
    .progress-bar-container {
        animation: fadeIn 0.5s ease-out;
    }
    
    .page-title {
        animation: fadeInUp 0.5s ease-out;
    }
    
    .form-group {
        animation: fadeIn 0.4s ease-out;
        animation-fill-mode: both;
    }
    
    .form-group:nth-child(1) { animation-delay: 0.1s; }
    .form-group:nth-child(2) { animation-delay: 0.15s; }
    .form-group:nth-child(3) { animation-delay: 0.2s; }
    .form-group:nth-child(4) { animation-delay: 0.25s; }
    .form-group:nth-child(5) { animation-delay: 0.3s; }
    .form-group:nth-child(6) { animation-delay: 0.35s; }
    .form-group:nth-child(7) { animation-delay: 0.4s; }
    .form-group:nth-child(8) { animation-delay: 0.45s; }
    
    /* Responsive */
    @media (max-width: 1200px) {
        .form-preview-container {
            grid-template-columns: 1fr;
            gap: 24px;
        }
        
        .live-preview-card {
            position: relative;
            top: 0;
            max-height: none;
        }
    }
    
    @media (max-width: 968px) {
        .form-preview-container {
            grid-template-columns: 1fr;
            gap: 24px;
        }

        .live-preview-card {
            position: static;
            margin-top: 24px;
        }

        .theme-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            padding: 20px 16px;
        }

        .form-section-card,
        .live-preview-card {
            padding: 24px;
        }

        .page-title h1 {
            font-size: 32px;
        }

        .page-title p {
            font-size: 14px;
        }
    }

    @media (max-width: 640px) {
        .theme-grid {
            grid-template-columns: 1fr;
        }

        .progress-bar {
            flex-direction: row;
            flex-wrap: nowrap;
            padding: 0 10px;
        }

        .progress-step {
            margin-bottom: 0;
        }

        .progress-step::after {
            left: calc(50% + 15px);
            width: calc(100% - 30px);
        }

        .page-title h1 {
            font-size: 36px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="create-page-container">
    <!-- Progress Bar - Exact Match from Images -->
    <div class="progress-bar-container">
        <div class="progress-bar">
            <div class="progress-step completed clickable-step" data-step="1" onclick="navigateToStep(1)">
                <div class="step-circle">âœ“</div>
                <div class="step-label">Occasion</div>
    </div>
            <div class="progress-step {% if selected_template %}completed{% else %}active{% endif %} clickable-step" data-step="2" onclick="navigateToStep(2)">
                <div class="step-circle">{% if selected_template %}âœ“{% else %}2{% endif %}</div>
                <div class="step-label">Theme</div>
    </div>
            <div class="progress-step {% if selected_template %}active{% else %}pending{% endif %} {% if selected_template %}clickable-step{% endif %}" data-step="3" {% if selected_template %}onclick="navigateToStep(3)"{% endif %}>
                <div class="step-circle">3</div>
                <div class="step-label">Details</div>
    </div>
            <div class="progress-step pending" data-step="4">
                <div class="step-circle">4</div>
                <div class="step-label">Preview</div>
        </div>
            </div>
    </div>

    <!-- Theme Selection Page -->
    {% if not selected_template and not show_details %}
    <div class="theme-selection-page active" id="themeSelectionPage">
        <div class="page-title">
            <h1>
                <span class="title-normal">Pick Your </span>
                <span class="title-gradient">Perfect Theme</span>
            </h1>
            <p>Select a design that speaks to your style</p>
    </div>

        <div class="theme-grid">
            {% if templates %}
                {% for template in templates %}
                {# Only show templates that have preview images #}
                {% if template.preview_image %}
                {% set template_name_slug = template.name|replace(' ', '_')|lower %}
                {% set template_img_raw = template.preview_image if template.preview_image else '/images/templatesimages/wedding.png' %}
                {% set template_img = template_img_raw if 'placeholder.com' not in template_img_raw and 'via.placeholder' not in template_img_raw else '/images/templatesimages/wedding.png' %}
                {% if template_img and not template_img.startswith('http') %}
                    {% if template_img.startswith('/images/') %}
                        {% set template_img = template_img %}
                    {% elif template_img.startswith('/static/images/') and 'templatesimages' in template_img %}
                        {% set template_img = template_img.replace('/static/images/', '/images/') %}
                    {% elif 'templatesimages' in template_img %}
                        {% if not template_img.startswith('/') %}
                            {% set template_img = '/images/' + template_img %}
    {% else %}
                            {% set template_img = template_img %}
                        {% endif %}
                    {% elif template_img.endswith(('.jpg', '.jpeg', '.png', '.gif')) and not '/' in template_img %}
                        {# Just filename like "wed.jpg" or "birthday.jpg" - always use templatesimages #}
                        {% set template_img = '/images/templatesimages/' + template_img %}
                    {% elif not template_img.startswith('/') %}
                        {# Any relative path should go to templatesimages #}
                        {% set template_img = '/images/templatesimages/' + template_img %}
                    {% endif %}
                    
                    {# ALWAYS convert /static/images/ to /images/ - final normalization #}
                    {% if template_img.startswith('/static/images/') %}
                        {% set template_img = template_img.replace('/static/images/', '/images/') %}
                    {% endif %}
                {% endif %}
                {% set template_color = template.color_scheme if template.color_scheme else 'A07878' %}
                {% set template_name_encoded = template.name|replace(' ', '+') %}
                {% set safe_template_img = template_img if 'placeholder.com' not in template_img and 'via.placeholder' not in template_img else '/images/templatesimages/wedding.png' %}
                <div class="theme-card" data-theme="{{ template_name_slug|e }}" data-template-id="{{ template.id }}" data-template-image="{{ safe_template_img|e }}" data-template-name="{{ template.name|e }}" style="cursor: pointer;">
                    <img src="{{ safe_template_img|e }}" 
                         alt="{{ template.name|e }}" 
                         class="theme-image" 
                         data-src="{{ safe_template_img|e }}"
                         loading="lazy"
                         decoding="async"
                         onerror="if(this.src && (this.src.includes('placeholder.com') || this.src.includes('via.placeholder'))) { console.warn('ðŸš« Placeholder URL in onerror, replacing:', this.src); this.src='/images/templatesimages/wedding.png'; return; } this.onerror=null; this.style.display='block'; this.style.background='#{{ template_color|e }}'; this.style.color='#FFFFFF'; this.style.width='100%'; this.style.height='100%'; this.style.objectFit='cover'; this.alt='{{ template.name|e }}';"
                         onload="if(this.src && (this.src.includes('placeholder.com') || this.src.includes('via.placeholder'))) { console.warn('ðŸš« Placeholder URL in onload, replacing:', this.src); this.src='/images/templatesimages/wedding.png'; }">
                    <div class="theme-title">{{ template.name|e }}</div>
    </div>
    {% endif %}
                {% endfor %}
    {% else %}
                <!-- Default Theme Options if no templates in database -->
                <div class="theme-card" data-theme="modern_minimal" data-template-id="" style="cursor: pointer;">
                    <img src="/static/images/templateselection/naming cermony.jpg" alt="Modern Minimal" class="theme-image" onerror="this.onerror=null; this.style.display='block'; this.style.background='#A07878'; this.style.color='#FFFFFF'; this.style.width='100%'; this.style.height='100%'; this.style.objectFit='cover';">
                    <div class="theme-title">Modern Minimal</div>
    </div>

                <div class="theme-card" data-theme="floral_luxury" data-template-id="" style="cursor: pointer;">
                    <img src="/static/images/templateselection/partytemplates.jpg" alt="Floral Luxury" class="theme-image" onerror="this.onerror=null; this.style.display='block'; this.style.background='#A07878'; this.style.color='#FFFFFF'; this.style.width='100%'; this.style.height='100%'; this.style.objectFit='cover';">
                    <div class="theme-title">Floral Luxury</div>
        </div>

                <div class="theme-card" data-theme="royal_gold" data-template-id="" style="cursor: pointer;">
                    <img src="/static/images/templateselection/traditionalgettogether.jpg" alt="Royal Gold" class="theme-image" onerror="this.onerror=null; this.style.display='block'; this.style.background='#A07878'; this.style.color='#FFFFFF'; this.style.width='100%'; this.style.height='100%'; this.style.objectFit='cover';">
                    <div class="theme-title">Royal Gold</div>
            </div>

                <div class="theme-card" data-theme="watercolor_dreams" data-template-id="" style="cursor: pointer;">
                    <img src="/static/images/templateselection/naming cermony.jpg" alt="Watercolor Dreams" class="theme-image" onerror="this.onerror=null; this.style.display='block'; this.style.background='#A07878'; this.style.color='#FFFFFF'; this.style.width='100%'; this.style.height='100%'; this.style.objectFit='cover';">
                    <div class="theme-title">Watercolor Dreams</div>
            </div>

                <div class="theme-card" data-theme="dark_chic" data-template-id="" style="cursor: pointer;">
                    <img src="/static/images/templateselection/partytemplates.jpg" alt="Dark Chic" class="theme-image" onerror="this.onerror=null; this.style.display='block'; this.style.background='#A07878'; this.style.color='#FFFFFF'; this.style.width='100%'; this.style.height='100%'; this.style.objectFit='cover';">
                    <div class="theme-title">Dark Chic</div>
        </div>
        
                <div class="theme-card" data-theme="festive_traditional" data-template-id="" style="cursor: pointer;">
                    <img src="/static/images/templateselection/traditionalgettogether.jpg" alt="Festive Traditional" class="theme-image" onerror="this.onerror=null; this.style.display='block'; this.style.background='#A07878'; this.style.color='#FFFFFF'; this.style.width='100%'; this.style.height='100%'; this.style.objectFit='cover';">
                    <div class="theme-title">Festive Traditional</div>
        </div>
                {% endif %}
    </div>

        <div class="form-navigation">
            <a href="{{ url_for('templates') }}" class="btn-back">
                <i class="fas fa-arrow-left"></i> Back
            </a>
            <button class="btn-continue" id="continueToDetails" disabled onclick="continueToDetails()">
                Continue <i class="fas fa-arrow-right"></i>
                        </button>
        </div>
        </div>
    {% endif %}

    <!-- Details Form Page -->
    <div class="details-form-page {% if selected_template or show_details %}active{% endif %}" id="detailsFormPage">
        <div class="page-title">
            <h1>
                <span class="title-normal">Add Your </span>
                <span class="title-gradient">Special Details</span>
            </h1>
            <p>Watch your invitation come to life</p>
    </div>

        <div class="form-preview-container">
            <!-- Form Section -->
            <div class="form-section-card">
    <form id="invitationForm" method="POST" action="{{ url_for('create_invitation') }}" enctype="multipart/form-data">
                    <input type="hidden" name="selectedTemplate" value="{{ selected_template|e }}" id="selectedTemplate">
                    <input type="hidden" name="templateId" value="" id="templateIdInput">
                    <input type="hidden" name="templateImageUrl" value="" id="templateImageUrlInput">
                    
                    <div class="form-group">
                        <label class="form-label required" for="eventName">Event Name</label>
                        <input type="text" class="form-input" id="eventName" name="eventTitle" 
                               placeholder="e.g., Sarah & James or Emma's Sweet 16"
                               autocomplete="off"
                               value="{% if current_user and event_type %}{{ current_user.name|e }}'s {% if event_type == 'wedding' %}Wedding{% elif event_type == 'birthday' %}Birthday{% elif event_type == 'anniversary' %}Anniversary{% elif event_type == 'graduation' %}Graduation{% elif event_type == 'babyshower' %}Baby Shower{% elif event_type == 'retirement' %}Retirement{% else %}Event{% endif %}{% endif %}">
                    </div>

                    <div class="form-group">
                        <label class="form-label required" for="eventDate">Event Date</label>
                            <input type="date" class="form-input" id="eventDate" name="eventDate" autocomplete="off">
                </div>

                        <div class="form-group">
                        <label class="form-label" for="eventTime">Event Time</label>
                            <input type="time" class="form-input" id="eventTime" name="eventTime" autocomplete="off">
                </div>

                        <div class="form-group">
                        <label class="form-label" for="venueName">Venue Name</label>
                        <input type="text" class="form-input" id="venueName" name="venueName" 
                               placeholder="e.g., Garden Estate" autocomplete="organization">
                </div>

                <div class="form-group">
                        <label class="form-label" for="venueAddress">Venue Address</label>
                        <input type="text" class="form-input" id="venueAddress" name="venueAddress" 
                               placeholder="e.g., 123 Main St, City, State" autocomplete="street-address">
            </div>

                        <div class="form-group">
                        <label class="form-label" for="hostedBy">Hosted By</label>
                        <input type="text" class="form-input" id="hostedBy" name="hostName" 
                               placeholder="e.g., The Smith Family"
                               autocomplete="name"
                               value="{{ current_user.name if current_user else '' }}">
                </div>

                    <div class="form-group">
                        <label class="form-label" for="rsvpContact">RSVP Contact</label>
                        <input type="text" class="form-input" id="rsvpContact" name="contactEmail" 
                               placeholder="e.g., email@example.com or (555) 123-4567"
                               autocomplete="email"
                               value="{{ current_user.email if current_user else '' }}">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="personalMessage">Personal Message</label>
                        <textarea class="form-textarea" id="personalMessage" name="eventDescription" 
                                  rows="4" placeholder="Add a heartfelt message to your guests..." autocomplete="off"></textarea>
                    </div>

                    <!-- Language & Font Style -->
                    <div class="form-group">
                        <label class="form-label" for="language">Language</label>
                        <select class="form-input" id="language" name="language" autocomplete="language">
                            <option value="en">English</option>
                            <option value="hi">Hindi (à¤¹à¤¿à¤¨à¥à¤¦à¥€)</option>
                            <option value="ar">Arabic (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</option>
                            <option value="ur">Urdu (Ø§Ø±Ø¯Ùˆ)</option>
                            <option value="te">Telugu (à°¤à±†à°²à±à°—à±)</option>
                            <option value="ta">Tamil (à®¤à®®à®¿à®´à¯)</option>
                            <option value="kn">Kannada (à²•à²¨à³à²¨à²¡)</option>
                            <option value="ml">Malayalam (à´®à´²à´¯à´¾à´³à´‚)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="fontStyle">Font Style</label>
                        <select class="form-input" id="fontStyle" name="fontStyle" autocomplete="off">
                            <option value="Inter, sans-serif">Inter (Modern)</option>
                            <option value="Playfair Display, serif">Playfair Display (Elegant)</option>
                            <option value="Georgia, serif">Georgia (Classic)</option>
                            <option value="Brush Script MT, cursive">Brush Script (Fun)</option>
                            <option value="Montserrat, sans-serif">Montserrat (Clean)</option>
                            <option value="Amiri, serif">Amiri (Traditional)</option>
                            <option value="Lora, serif">Lora (Sophisticated)</option>
                            <option value="Times New Roman, serif">Times New Roman (Formal)</option>
                        </select>
            </div>

                    <!-- Main Image Upload -->
                    <div class="form-group">
                        <label class="form-label" for="mainImage">Main Image</label>
                        <input type="file" class="form-input" id="mainImage" name="mainImage" accept="image/*" autocomplete="off" onchange="previewImage(this, 'mainImagePreview')">
                        <div id="mainImagePreview" class="image-preview"></div>
                </div>

                    <!-- Event-Specific Fields (Conditional) -->
                <div id="weddingFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Wedding Details</h4>
                        <div class="form-group">
                            <label class="form-label" for="brideName">Bride Name</label>
                            <input type="text" class="form-input" id="brideName" name="brideName" placeholder="e.g., Sarah" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="groomName">Groom Name</label>
                            <input type="text" class="form-input" id="groomName" name="groomName" placeholder="e.g., James" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="brideImage">Bride Image</label>
                            <input type="file" class="form-input" id="brideImage" name="brideImage" accept="image/*" autocomplete="off" onchange="previewImage(this, 'brideImagePreview')">
                            <div id="brideImagePreview" class="image-preview"></div>
                    </div>
                        <div class="form-group">
                            <label class="form-label" for="groomImage">Groom Image</label>
                            <input type="file" class="form-input" id="groomImage" name="groomImage" accept="image/*" autocomplete="off" onchange="previewImage(this, 'groomImagePreview')">
                            <div id="groomImagePreview" class="image-preview"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="muhurthamTime">Muhurtham Time</label>
                            <input type="text" class="form-input" id="muhurthamTime" name="muhurthamTime" placeholder="e.g., 10:30 AM" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="receptionTime">Reception Time</label>
                            <input type="text" class="form-input" id="receptionTime" name="receptionTime" placeholder="e.g., 7:00 PM" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="loveStory">Love Story (Optional)</label>
                            <textarea class="form-textarea" id="loveStory" name="loveStory" rows="3" placeholder="Share your beautiful love story..." autocomplete="off"></textarea>
                    </div>
                </div>

                <div id="birthdayFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Birthday Details</h4>
                        <div class="form-group">
                            <label class="form-label" for="birthdayPerson">Birthday Person Name</label>
                            <input type="text" class="form-input" id="birthdayPerson" name="birthdayPerson" placeholder="e.g., Emma" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="age">Age</label>
                            <input type="text" class="form-input" id="age" name="age" placeholder="e.g., 16" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="birthdayImage">Birthday Person Image</label>
                            <input type="file" class="form-input" id="birthdayImage" name="birthdayImage" accept="image/*" autocomplete="off" onchange="previewImage(this, 'birthdayImagePreview')">
                            <div id="birthdayImagePreview" class="image-preview"></div>
                    </div>
                        <div class="form-group">
                            <label class="form-label" for="startTime">Party Start Time</label>
                            <input type="text" class="form-input" id="startTime" name="startTime" placeholder="e.g., 5:00 PM" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="dinnerTime">Dinner Time</label>
                            <input type="text" class="form-input" id="dinnerTime" name="dinnerTime" placeholder="e.g., 8:00 PM" autocomplete="off">
                    </div>
                </div>

                    <div id="anniversaryFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Anniversary Details</h4>
                        <div class="form-group">
                            <label class="form-label" for="coupleNames">Couple Names</label>
                            <input type="text" class="form-input" id="coupleNames" name="coupleNames" placeholder="e.g., Sarah & James" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="marriageYears">Marriage Years</label>
                            <input type="text" class="form-input" id="marriageYears" name="marriageYears" placeholder="e.g., 25" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="coupleImage">Couple Image</label>
                            <input type="file" class="form-input" id="coupleImage" name="coupleImage" accept="image/*" autocomplete="off" onchange="previewImage(this, 'coupleImagePreview')">
                            <div id="coupleImagePreview" class="image-preview"></div>
                    </div>
                        <div class="form-group">
                            <label class="form-label" for="anniversaryDinnerTime">Anniversary Dinner Time</label>
                            <input type="text" class="form-input" id="anniversaryDinnerTime" name="anniversaryDinnerTime" placeholder="e.g., 7:00 PM" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="partyTime">Party Time</label>
                            <input type="text" class="form-input" id="partyTime" name="partyTime" placeholder="e.g., 9:00 PM" autocomplete="off">
                        </div>
                    </div>

                    <div id="babyshowerFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Baby Shower Details</h4>
                        <div class="form-group">
                            <label class="form-label" for="motherName">Mother Name</label>
                            <input type="text" class="form-input" id="motherName" name="motherName" placeholder="e.g., Sarah" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="fatherName">Father Name</label>
                            <input type="text" class="form-input" id="fatherName" name="fatherName" placeholder="e.g., James" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="babyshowerStartTime">Baby Shower Start Time</label>
                            <input type="text" class="form-input" id="babyshowerStartTime" name="babyshowerStartTime" placeholder="e.g., 2:00 PM" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="babyshowerEndTime">Baby Shower End Time</label>
                            <input type="text" class="form-input" id="babyshowerEndTime" name="babyshowerEndTime" placeholder="e.g., 6:00 PM" autocomplete="off">
                    </div>
                </div>

                <div id="graduationFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Graduation Details</h4>
                        <div class="form-group">
                            <label class="form-label" for="graduateName">Graduate Name</label>
                            <input type="text" class="form-input" id="graduateName" name="graduateName" placeholder="e.g., Alex" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="degree">Degree</label>
                            <input type="text" class="form-input" id="degree" name="degree" placeholder="e.g., Bachelor of Science" autocomplete="organization-title">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="school">School/University</label>
                            <input type="text" class="form-input" id="school" name="school" placeholder="e.g., University Name" autocomplete="organization">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="major">Major/Field</label>
                            <input type="text" class="form-input" id="major" name="major" placeholder="e.g., Computer Science" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="graduateImage">Graduate Image</label>
                            <input type="file" class="form-input" id="graduateImage" name="graduateImage" accept="image/*" autocomplete="off" onchange="previewImage(this, 'graduateImagePreview')">
                            <div id="graduateImagePreview" class="image-preview"></div>
                    </div>
                </div>

                    <div id="retirementFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Retirement Details</h4>
                        <div class="form-group">
                            <label class="form-label" for="honoreeName">Honoree Name</label>
                            <input type="text" class="form-input" id="honoreeName" name="honoreeName" placeholder="e.g., John Smith" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="position">Position</label>
                            <input type="text" class="form-input" id="position" name="position" placeholder="e.g., Senior Manager" autocomplete="organization-title">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="company">Company</label>
                            <input type="text" class="form-input" id="company" name="company" placeholder="e.g., ABC Corporation" autocomplete="organization">
                    </div>
                        <div class="form-group">
                            <label class="form-label" for="startYear">Start Year</label>
                            <input type="text" class="form-input" id="startYear" name="startYear" placeholder="e.g., 1995" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="honoreeImage">Honoree Image</label>
                            <input type="file" class="form-input" id="honoreeImage" name="honoreeImage" accept="image/*" autocomplete="off" onchange="previewImage(this, 'honoreeImagePreview')">
                            <div id="honoreeImagePreview" class="image-preview"></div>
                    </div>
                </div>

                    <!-- Gallery Images -->
                        <div class="form-group">
                        <label class="form-label" for="galleryImages">Gallery Images (Multiple)</label>
                        <input type="file" class="form-input" id="galleryImages" name="galleryImages" accept="image/*" multiple autocomplete="off" onchange="previewMultipleImages(this, 'galleryPreview')">
                        <div id="galleryPreview" class="gallery-preview"></div>
                        </div>
                </form>
                        </div>

            <!-- Live Preview Section - Always Visible -->
            <div class="live-preview-card" style="display: flex !important; visibility: visible !important; opacity: 1 !important;">
                <div class="preview-title" style="display: block !important; visibility: visible !important; opacity: 1 !important;">Live Preview</div>
                <div class="preview-content" style="display: flex !important; visibility: visible !important; opacity: 1 !important;">
                    <div class="invitation-preview {% if template_id and selected_template_obj and selected_template_obj.preview_image %}template-bg{% endif %}" 
                         id="invitationPreviewCard"
                         style="display: flex !important; visibility: visible !important; opacity: 1 !important;" 
                         {% if template_id and selected_template_obj and selected_template_obj.preview_image %}data-template-image="{{ selected_template_obj.preview_image|e }}"{% endif %}
                         data-selected-template="{{ selected_template|default('')|e }}"
                         data-template-id="{% if template_id %}{{ template_id|int }}{% else %}null{% endif %}"
                         data-event-type="{{ (event_type or '')|e }}"
                         {% if selected_template_obj and selected_template_obj.preview_image %}data-template-image-url="{{ selected_template_obj.preview_image|e }}"{% endif %}>
                        <!-- Main Image Container - At the top of template -->
                        <div id="previewMainImageContainer" style="display: none; position: relative; z-index: 15 !important; width: 100%; margin-bottom: 20px;">
                            <img id="previewMainImage" class="preview-main-image" src="" alt="Main Image" style="display: none;">
                    </div>
                        <div id="previewBrideGroomContainer" class="preview-images-container" style="display: none;">
                            <img id="previewBrideImage" class="preview-image-overlay" src="" alt="Bride" style="display: none;">
                            <img id="previewGroomImage" class="preview-image-overlay" src="" alt="Groom" style="display: none;">
                        </div>
                        <div id="previewBirthdayImageContainer" style="display: none;">
                            <img id="previewBirthdayImage" class="preview-image-overlay" src="" alt="Birthday Person">
                        </div>
                        <div id="previewCoupleImageContainer" style="display: none;">
                            <img id="previewCoupleImage" class="preview-image-overlay" src="" alt="Couple">
                    </div>
                        <div id="previewGraduateImageContainer" style="display: none;">
                            <img id="previewGraduateImage" class="preview-image-overlay" src="" alt="Graduate">
                </div>
                        <div id="previewHonoreeImageContainer" style="display: none;">
                            <img id="previewHonoreeImage" class="preview-image-overlay" src="" alt="Honoree">
            </div>
                        <div class="preview-icon" id="previewIcon" style="display: none;">{% if event_type == 'wedding' %}ðŸ’{% elif event_type == 'birthday' %}ðŸŽ‚{% elif event_type == 'anniversary' %}ðŸ’‘{% elif event_type == 'graduation' %}ðŸŽ“{% elif event_type == 'babyshower' %}ðŸ‘¶{% elif event_type == 'retirement' %}ðŸŽ‰{% else %}ðŸŽŠ{% endif %}</div>
                        <div class="preview-event-name" id="previewEventName" style="display: none;">
                            Your Event Name
        </div>
                        
                        <!-- Event-Specific Preview Fields -->
                        <div class="preview-bride-groom" id="previewBrideGroom" style="display: none;">
                            <span id="previewBrideName"></span> & <span id="previewGroomName"></span>
                        </div>
                        <div class="preview-birthday-person" id="previewBirthdayPerson" style="display: none;">
                            <span id="previewBirthdayPersonName"></span> <span id="previewAge" style="font-weight: bold;"></span>
                        </div>
                        <div class="preview-couple-names" id="previewCoupleNames" style="display: none;">
                            <span id="previewCoupleNamesText"></span>
                        </div>
                        <div class="preview-mother-father" id="previewMotherFather" style="display: none;">
                            <span id="previewMotherName"></span><span id="previewMotherFatherSeparator" style="display: none;"> & </span><span id="previewFatherName"></span>
                        </div>
                        <div class="preview-graduate" id="previewGraduate" style="display: none;">
                            <span id="previewGraduateName"></span> - <span id="previewDegree"></span>
                        </div>
                        
                        <div class="preview-date-time" id="previewDate" style="display: none;">
                            <i class="fas fa-calendar"></i>
                            <span id="previewDateText"></span>
            </div>
                        <div class="preview-date-time" id="previewTime" style="display: none;">
                            <i class="fas fa-clock"></i>
                            <span id="previewTimeText"></span>
                </div>
                        <div class="preview-venue" id="previewVenue" style="display: none;">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="previewVenueText"></span>
                    </div>
                        <div class="preview-hosted" id="previewHosted" style="display: none;">
                            <i class="fas fa-user"></i> Hosted by <span id="previewHostedText"></span>
                    </div>
                        <div class="preview-message" id="previewMessage" style="display: none;">
                            <span id="previewMessageText"></span>
                    </div>
                        
                        <!-- Gallery Images Section - At the bottom of template card -->
                        <div id="previewGallerySection" style="display: none; margin-top: 30px; padding-top: 20px; padding-bottom: 15px; border-top: 2px solid rgba(160, 120, 120, 0.4); position: relative; z-index: 25 !important; width: 100%;">
                            <h3 class="text-center mb-4 preview-gallery-title" style="color: #6F4E37 !important; font-weight: 700; font-size: 1.5rem; position: relative; z-index: 25 !important; visibility: visible !important; opacity: 1 !important; margin-bottom: 20px !important; text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.9); background: rgba(255, 255, 255, 0.7); padding: 8px 16px; border-radius: 8px; display: inline-block;">
                                <i class="fas fa-images me-2"></i>Our Memories
                            </h3>
                            <div class="preview-gallery-grid" id="previewGalleryGrid" style="display: grid !important; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)) !important; gap: 15px !important; position: relative; z-index: 25 !important; visibility: visible !important; opacity: 1 !important; width: 100%; padding: 10px 0;"></div>
                        </div>
                        
                        <div class="preview-placeholder" id="previewPlaceholder" style="display: block !important; visibility: visible !important; opacity: 1 !important;">
                            <i class="fas fa-magic" style="font-size: 32px; color: #6F4E37; margin-bottom: 10px; display: block;"></i>
                            <p style="margin: 0; font-weight: 500; color: #6F4E37;">Start filling the form to see your invitation preview</p>
                            <p style="margin: 10px 0 0 0; font-size: 12px; color: #8B7355;">Your changes will appear here in real-time</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-navigation">
            <button class="btn-back" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <button class="btn-preview" onclick="submitForm()">
                Preview <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
</div>

<script>
    // Get template variables from data attributes to avoid IDE parsing errors with Jinja2
    const invitationPreviewCard = document.getElementById('invitationPreviewCard');
    let selectedThemeValue = invitationPreviewCard ? (invitationPreviewCard.getAttribute('data-selected-template') || '') : '';

    // Global path normalization function - ensures all image paths use /images/ instead of /static/images/
    // CRITICAL: This function also blocks placeholder URLs completely
    function normalizeImagePath(url) {
        if (!url || typeof url !== 'string') return null;
        
        // CRITICAL: Block placeholder URLs FIRST before any processing
        if (url.includes('placeholder.com') || url.includes('via.placeholder') || url.includes('placeholder')) {
            console.warn('ðŸš« Placeholder URL blocked:', url);
            return null; // Return null for placeholder URLs
        }
        
        // Remove query params and fragments
        let cleanUrl = url.split('?')[0].split('#')[0];
        
        // Double-check for placeholder URLs after cleaning
        if (cleanUrl.includes('placeholder.com') || cleanUrl.includes('via.placeholder') || cleanUrl.includes('placeholder')) {
            console.warn('ðŸš« Placeholder URL detected after cleaning:', cleanUrl);
            return null;
        }
        
        // Skip external URLs and data URIs (but still check for placeholders)
        if (cleanUrl.startsWith('http')) {
            // Even for external URLs, block if they're placeholders
            if (cleanUrl.includes('placeholder.com') || cleanUrl.includes('via.placeholder')) {
                console.warn('ðŸš« External placeholder URL blocked:', cleanUrl);
                return null;
            }
            return cleanUrl;
        }
        
        if (cleanUrl.startsWith('data:')) {
            return cleanUrl; // Data URIs are safe
        }
        
        // Convert /static/images/ to /images/
        if (cleanUrl.includes('/static/images/')) {
            cleanUrl = cleanUrl.replace(/\/static\/images\//g, '/images/');
        }
        
        // Handle standalone filenames (like "wed.jpg", "birthday.jpg")
        const commonTemplateFiles = ['wed.jpg', 'birthday.jpg', 'corporateevent.jpg', 'birthdaycolourful.jpg', 'birthdayblackgold.jpg', 'ballonbirthday.jpg', 'grduationgold.jpg', 'GRDUATIONGOLD.jpg'];
        for (const fileName of commonTemplateFiles) {
            if (cleanUrl === fileName || cleanUrl.endsWith('/' + fileName) || cleanUrl.includes('/' + fileName + '?')) {
                cleanUrl = '/images/templatesimages/' + fileName;
                break;
            }
        }
        
        // If it's just a filename without path and it's an image file
        if (!cleanUrl.startsWith('/') && /\.(jpg|jpeg|png|gif)$/i.test(cleanUrl)) {
            cleanUrl = '/images/templatesimages/' + cleanUrl;
        }
        
        // Fix any remaining static paths
        if (cleanUrl.startsWith('/static/')) {
            cleanUrl = cleanUrl.replace('/static/', '/');
        }
        
        // Final check for placeholder URLs
        if (cleanUrl.includes('placeholder.com') || cleanUrl.includes('via.placeholder') || cleanUrl.includes('placeholder')) {
            console.warn('ðŸš« Placeholder URL detected in final check:', cleanUrl);
            return null;
        }
        
        return cleanUrl;
    }
    
    // Runtime protection: Prevent ANY placeholder URLs from being loaded or set
    // This protects against placeholder URLs that might slip through template filtering
    function blockPlaceholderUrls() {
        console.log('ðŸ›¡ï¸ Initializing placeholder URL blocking protection...');
        
        // Monitor all image elements for placeholder URLs
        const images = document.querySelectorAll('img');
        images.forEach(function(img) {
            // Check initial src
            if (img.src && (img.src.includes('placeholder.com') || img.src.includes('via.placeholder'))) {
                console.warn('ðŸš« Blocked placeholder URL in img src:', img.src);
                img.src = '/images/templatesimages/wedding.png'; // Default fallback
            }
            
            // Prevent placeholder URLs from being set dynamically
            const originalSetAttribute = img.setAttribute;
            img.setAttribute = function(name, value) {
                if (name === 'src' && value && (value.includes('placeholder.com') || value.includes('via.placeholder'))) {
                    console.warn('ðŸš« Prevented placeholder URL from being set:', value);
                    value = '/images/templatesimages/wedding.png'; // Default fallback
                }
                return originalSetAttribute.call(this, name, value);
            };
            
            // Also intercept direct src property assignment
            Object.defineProperty(img, 'src', {
                get: function() {
                    return this.getAttribute('src') || '';
                },
                set: function(value) {
                    if (value && (value.includes('placeholder.com') || value.includes('via.placeholder'))) {
                        console.warn('ðŸš« Prevented placeholder URL from being assigned:', value);
                        value = '/images/templatesimages/wedding.png'; // Default fallback
                    }
                    this.setAttribute('src', value);
                }
            });
        });
        
        // Monitor new images added dynamically
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1 && node.tagName === 'IMG') {
                        const img = node;
                        if (img.src && (img.src.includes('placeholder.com') || img.src.includes('via.placeholder'))) {
                            console.warn('ðŸš« Blocked placeholder URL in dynamically added img:', img.src);
                            img.src = '/images/templatesimages/wedding.png';
                        }
                    }
                });
            });
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        // Protect backgroundImage assignments on all elements
        const protectElement = function(element) {
            const originalSetProperty = CSSStyleDeclaration.prototype.setProperty;
            const originalBackgroundImageSetter = Object.getOwnPropertyDescriptor(CSSStyleDeclaration.prototype, 'backgroundImage')?.set;
            
            if (element && element.style) {
                // Override style.backgroundImage setter
                Object.defineProperty(element.style, 'backgroundImage', {
                    set: function(value) {
                        if (value && (value.includes('placeholder.com') || value.includes('via.placeholder') || value.includes('placeholder'))) {
                            console.error('âŒ Blocked placeholder URL in backgroundImage:', value);
                            value = value.replace(/url\([^)]*placeholder[^)]*\)/gi, "url('/images/templatesimages/wedding.png')");
                        }
                        if (originalBackgroundImageSetter) {
                            originalBackgroundImageSetter.call(this, value);
                        } else {
                            this.setProperty('background-image', value);
                        }
                    },
                    get: function() {
                        return this.getPropertyValue('background-image');
                    },
                    configurable: true
                });
            }
        };
        
        // Protect all existing elements
        document.querySelectorAll('*').forEach(protectElement);
        
        // Protect preview card specifically
        const previewCard = document.getElementById('invitationPreviewCard');
        if (previewCard) {
            protectElement(previewCard);
        }
    }
    
    // Run protection immediately and on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', blockPlaceholderUrls);
    } else {
        blockPlaceholderUrls();
    }

    // Optimized: Live Preview Updates - Debounced for better performance
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Function to toggle white background on form groups based on content - Global scope
    window.toggleFormGroupBackground = function() {
        const allInputs = document.querySelectorAll('.form-input, .form-textarea, select.form-input');
        allInputs.forEach(input => {
            const formGroup = input.closest('.form-group');
            if (formGroup) {
                // Check if input has value
                const hasValue = (input.value && input.value.trim() !== '') || 
                                (input.files && input.files.length > 0) ||
                                (input.type === 'file' && input.files && input.files.length > 0);
                
                if (hasValue) {
                    formGroup.classList.add('has-content');
                } else {
                    formGroup.classList.remove('has-content');
                }
            }
        });
    };
    
    // Live Preview Updates - Optimized with debouncing
        document.addEventListener('DOMContentLoaded', function() {
        const eventNameInput = document.getElementById('eventName');
        const previewEventName = document.getElementById('previewEventName');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const previewIcon = document.getElementById('previewIcon');

        // Get all form inputs for preview
        const eventDateInput = document.getElementById('eventDate');
        const eventTimeInput = document.getElementById('eventTime');
        const venueNameInput = document.getElementById('venueName');
        const venueAddressInput = document.getElementById('venueAddress');
        const hostedByInput = document.getElementById('hostedBy');
        const personalMessageInput = document.getElementById('personalMessage');
        
        // Event-specific form inputs
        const brideNameInput = document.getElementById('brideName');
        const groomNameInput = document.getElementById('groomName');
        const birthdayPersonInput = document.getElementById('birthdayPerson');
        const ageInput = document.getElementById('age');
        const coupleNamesInput = document.getElementById('coupleNames');
        const marriageYearsInput = document.getElementById('marriageYears');
        const motherNameInput = document.getElementById('motherName');
        const fatherNameInput = document.getElementById('fatherName');
        const graduateNameInput = document.getElementById('graduateName');
        const degreeInput = document.getElementById('degree');
        const schoolInput = document.getElementById('school');
        const majorInput = document.getElementById('major');
        const muhurthamTimeInput = document.getElementById('muhurthamTime');
        const receptionTimeInput = document.getElementById('receptionTime');
        const startTimeInput = document.getElementById('startTime');
        const dinnerTimeInput = document.getElementById('dinnerTime');
        const babyshowerStartTimeInput = document.getElementById('babyshowerStartTime');
        const babyshowerEndTimeInput = document.getElementById('babyshowerEndTime');
        const anniversaryDinnerTimeInput = document.getElementById('anniversaryDinnerTime');
        const partyTimeInput = document.getElementById('partyTime');
        
        // Preview elements
        const previewDate = document.getElementById('previewDate');
        const previewDateText = document.getElementById('previewDateText');
        const previewTime = document.getElementById('previewTime');
        const previewTimeText = document.getElementById('previewTimeText');
        const previewVenue = document.getElementById('previewVenue');
        const previewVenueText = document.getElementById('previewVenueText');
        const previewHosted = document.getElementById('previewHosted');
        const previewHostedText = document.getElementById('previewHostedText');
        const previewMessage = document.getElementById('previewMessage');
        const previewMessageText = document.getElementById('previewMessageText');
        
        // Event-specific preview elements
        const previewBrideGroom = document.getElementById('previewBrideGroom');
        const previewBrideName = document.getElementById('previewBrideName');
        const previewGroomName = document.getElementById('previewGroomName');
        const previewBirthdayPerson = document.getElementById('previewBirthdayPerson');
        const previewBirthdayPersonName = document.getElementById('previewBirthdayPersonName');
        const previewAge = document.getElementById('previewAge');
        const previewCoupleNames = document.getElementById('previewCoupleNames');
        const previewCoupleNamesText = document.getElementById('previewCoupleNamesText');
        const previewMotherFather = document.getElementById('previewMotherFather');
        const previewMotherName = document.getElementById('previewMotherName');
        const previewFatherName = document.getElementById('previewFatherName');
        const previewGraduate = document.getElementById('previewGraduate');
        const previewGraduateName = document.getElementById('previewGraduateName');
        const previewDegree = document.getElementById('previewDegree');

        // Store selected template info
        let selectedTemplateId = null;
        let selectedTemplateImage = null;
        let selectedTemplateName = null;

        // Function to detect background brightness and adjust text colors
        function adjustTextColorsForBackground(previewCard) {
            if (!previewCard) return;
            
            // Get computed background image
            const bgImage = window.getComputedStyle(previewCard).backgroundImage;
            if (!bgImage || bgImage === 'none' || bgImage === '') {
                // No background image, use default colors
                resetTextColorsToDefault();
                return;
            }
            
            // Extract image URL from background-image CSS
            const urlMatch = bgImage.match(/url\(['"]?([^'"]+)['"]?\)/);
            if (!urlMatch || !urlMatch[1]) {
                resetTextColorsToDefault();
                return;
            }
            
            const imageUrl = urlMatch[1];
            
            // Create an image to analyze brightness
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
                try {
                    // Create canvas to analyze image
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = Math.min(img.width, 100); // Sample size
                    canvas.height = Math.min(img.height, 100);
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Sample pixels from different areas (top, middle, bottom, left, center, right)
                    const samplePoints = [
                        { x: 0, y: 0 }, // Top-left
                        { x: canvas.width / 2, y: 0 }, // Top-center
                        { x: canvas.width - 1, y: 0 }, // Top-right
                        { x: 0, y: canvas.height / 2 }, // Middle-left
                        { x: canvas.width / 2, y: canvas.height / 2 }, // Center
                        { x: canvas.width - 1, y: canvas.height / 2 }, // Middle-right
                        { x: 0, y: canvas.height - 1 }, // Bottom-left
                        { x: canvas.width / 2, y: canvas.height - 1 }, // Bottom-center
                        { x: canvas.width - 1, y: canvas.height - 1 } // Bottom-right
                    ];
                    
                    let totalBrightness = 0;
                    samplePoints.forEach(point => {
                        const pixel = ctx.getImageData(point.x, point.y, 1, 1);
                        const r = pixel.data[0];
                        const g = pixel.data[1];
                        const b = pixel.data[2];
                        // Calculate brightness using relative luminance formula
                        const brightness = (0.299 * r + 0.587 * g + 0.114 * b);
                        totalBrightness += brightness;
                    });
                    
                    const avgBrightness = totalBrightness / samplePoints.length;
                    const isDark = avgBrightness < 128; // Threshold for dark background
                    
                    // Apply text colors based on brightness
                    applyTextColors(isDark);
                    
                } catch (e) {
                    console.warn('Error analyzing background brightness:', e);
                    resetTextColorsToDefault();
                }
            };
            
            img.onerror = function() {
                console.warn('Could not load background image for brightness analysis');
                resetTextColorsToDefault();
            };
            
            img.src = imageUrl;
        }
        
        // Apply text colors based on background brightness
        function applyTextColors(isDark) {
            const textElements = [
                '.preview-event-name',
                '.preview-date-time',
                '.preview-venue',
                '.preview-hosted',
                '.preview-message',
                '.preview-bride-groom',
                '.preview-birthday-person',
                '.preview-couple-names',
                '.preview-mother-father',
                '.preview-graduate',
                '.preview-gallery-title'
            ];
            
            const previewCard = document.getElementById('invitationPreviewCard');
            if (!previewCard) return;
            
            textElements.forEach(selector => {
                const elements = previewCard.querySelectorAll(selector);
                elements.forEach(el => {
                    if (isDark) {
                        // Dark background - use light text with shadow
                        el.style.color = '#FFFFFF';
                        el.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.8), 0 0 8px rgba(0, 0, 0, 0.5)';
                    } else {
                        // Light background - use dark text
                        el.style.color = '#6F4E37';
                        el.style.textShadow = '1px 1px 2px rgba(255, 255, 255, 0.8)';
                    }
                });
            });
        }
        
        // Reset text colors to default
        function resetTextColorsToDefault() {
            const previewCard = document.getElementById('invitationPreviewCard');
            if (!previewCard) return;
            
            const textElements = previewCard.querySelectorAll('.preview-event-name, .preview-date-time, .preview-venue, .preview-hosted, .preview-message, .preview-bride-groom, .preview-birthday-person, .preview-couple-names, .preview-mother-father, .preview-graduate, .preview-gallery-title');
            textElements.forEach(el => {
                el.style.color = '#6F4E37';
                el.style.textShadow = '1px 1px 2px rgba(255, 255, 255, 0.8)';
            });
        }

        // Update preview background based on selected template
        function updatePreviewBackground(templateId, templateImage, templateName) {
            const previewCard = document.getElementById('invitationPreviewCard');
            
            if (!previewCard || !templateImage) {
                console.warn('Preview card or template image not found');
                return;
            }
            
            // Normalize the image path first
            templateImage = normalizeImagePath(templateImage);
            
            // Skip if normalization returned null (placeholder URL) or empty
            if (!templateImage) {
                console.warn('Template image path is invalid (placeholder URL or empty)');
                return;
            }
            
            if (templateId && templateImage) {
                selectedTemplateId = templateId;
                selectedTemplateImage = templateImage;
                selectedTemplateName = templateName;
                
                // Remove all template classes
                previewCard.classList.remove('wedding-bg');
                // Add template-bg class to show template image as overlay
                previewCard.classList.add('template-bg');
                
                // CRITICAL: Don't set background: 'none' as it resets background-image!
                // Only remove the background shorthand, not background-image
                previewCard.style.removeProperty('background');
                previewCard.style.backgroundColor = 'transparent';
                
                // CRITICAL: Block placeholder URLs before setting overlay
                let bgImage = templateImage;
                if (bgImage && (bgImage.includes('placeholder.com') || bgImage.includes('via.placeholder') || bgImage.includes('placeholder'))) {
                    console.error('âŒ Attempted to set placeholder URL as overlay, blocked:', bgImage);
                    bgImage = '/images/templatesimages/wedding.png'; // Default fallback
                }
                
                // Set template image using CSS variable (used by CSS rule)
                const bgImageUrl = `url('${bgImage}')`;
                previewCard.style.setProperty('--template-bg-image-url', bgImageUrl, 'important');
                
                // Also set inline style as fallback
                previewCard.style.setProperty('background-image', bgImageUrl, 'important');
                previewCard.style.backgroundImage = bgImageUrl;
                previewCard.style.backgroundSize = 'cover';
                previewCard.style.backgroundPosition = 'center';
                previewCard.style.backgroundRepeat = 'no-repeat';
                previewCard.style.setProperty('background-size', 'cover', 'important');
                previewCard.style.setProperty('background-position', 'center', 'important');
                
                console.log('ðŸ“ Layer Structure Applied:', {
                    'Layer 1 (z-index 0)': 'Template Design Background',
                    'Layer 2 (z-index 5)': 'User Uploaded Images',
                    'Layer 3 (z-index 10)': 'User Text Content',
                    templateDesign: bgImage
                });
                
                // Ensure background is visible with proper z-index
                previewCard.style.position = 'relative';
                previewCard.style.zIndex = '0';
                
                // Update hidden form fields for save
                const templateIdInput = document.getElementById('templateIdInput');
                const templateImageUrlInput = document.getElementById('templateImageUrlInput');
                if (templateIdInput) templateIdInput.value = templateId || '';
                if (templateImageUrlInput) templateImageUrlInput.value = bgImage || '';
                
                // Hide icon when template background is active (images will show instead)
                const previewIcon = document.getElementById('previewIcon');
                if (previewIcon) {
                    previewIcon.style.display = 'none';
                }
                
                // Log for debugging
                console.log('âœ… Template background applied to live preview:', {
                    templateId: templateId,
                    bgImage: bgImage,
                    templateName: templateName
                });
                
                // Adjust text colors based on background brightness
                setTimeout(() => {
                    adjustTextColorsForBackground(previewCard);
                }, 500); // Wait for background to load
                
                // Ensure all preview content is visible on top of template
                ensurePreviewContentVisible();
                
                // Filter images to show only event-specific ones
                const eventType = previewCard ? (previewCard.getAttribute('data-event-type') || '') : '';
                if (eventType) {
                    showEventSpecificImages(eventType);
                }
                
                // Force re-display of uploaded images on top of new template background
                setTimeout(() => {
                    // Main image
                    const mainImg = document.getElementById('previewMainImage');
                    const mainContainer = document.getElementById('previewMainImageContainer');
                    if (mainImg && mainImg.src && mainImg.src !== '' && mainContainer) {
                        mainContainer.style.display = 'block';
                        mainContainer.style.setProperty('display', 'block', 'important');
                        mainImg.style.display = 'block';
                        mainImg.style.setProperty('display', 'block', 'important');
                        mainImg.style.zIndex = '15';
                        mainImg.style.setProperty('z-index', '15', 'important');
                        mainImg.style.position = 'relative';
                        mainImg.style.visibility = 'visible';
                        mainImg.style.opacity = '1';
                        mainContainer.style.zIndex = '15';
                        mainContainer.style.setProperty('z-index', '15', 'important');
                        mainContainer.style.visibility = 'visible';
                        mainContainer.style.opacity = '1';
                    }
                    
                    // Bride and Groom images
                    const brideImg = document.getElementById('previewBrideImage');
                    const groomImg = document.getElementById('previewGroomImage');
                    const brideGroomContainer = document.getElementById('previewBrideGroomContainer');
                    if (brideGroomContainer) {
                        let shouldShow = false;
                        if (brideImg && brideImg.src && brideImg.src !== '') {
                            brideImg.style.display = 'block';
                            brideImg.style.setProperty('display', 'block', 'important');
                            brideImg.style.zIndex = '15';
                            brideImg.style.setProperty('z-index', '15', 'important');
                            brideImg.style.position = 'relative';
                            brideImg.style.visibility = 'visible';
                            brideImg.style.opacity = '1';
                            shouldShow = true;
                        }
                        if (groomImg && groomImg.src && groomImg.src !== '') {
                            groomImg.style.display = 'block';
                            groomImg.style.setProperty('display', 'block', 'important');
                            groomImg.style.zIndex = '15';
                            groomImg.style.setProperty('z-index', '15', 'important');
                            groomImg.style.position = 'relative';
                            groomImg.style.visibility = 'visible';
                            groomImg.style.opacity = '1';
                            shouldShow = true;
                        }
                        if (shouldShow) {
                            brideGroomContainer.style.display = 'flex';
                            brideGroomContainer.style.setProperty('display', 'flex', 'important');
                            brideGroomContainer.style.zIndex = '15';
                            brideGroomContainer.style.setProperty('z-index', '15', 'important');
                            brideGroomContainer.style.visibility = 'visible';
                            brideGroomContainer.style.opacity = '1';
                        }
                    }
                    
                    // Birthday image
                    const birthdayImg = document.getElementById('previewBirthdayImage');
                    const birthdayContainer = document.getElementById('previewBirthdayImageContainer');
                    if (birthdayImg && birthdayImg.src && birthdayImg.src !== '' && birthdayContainer) {
                        birthdayContainer.style.display = 'block';
                        birthdayContainer.style.setProperty('display', 'block', 'important');
                        birthdayImg.style.display = 'block';
                        birthdayImg.style.setProperty('display', 'block', 'important');
                        birthdayImg.style.zIndex = '15';
                        birthdayImg.style.setProperty('z-index', '15', 'important');
                        birthdayImg.style.position = 'relative';
                        birthdayImg.style.visibility = 'visible';
                        birthdayImg.style.opacity = '1';
                        birthdayContainer.style.zIndex = '15';
                        birthdayContainer.style.setProperty('z-index', '15', 'important');
                        birthdayContainer.style.visibility = 'visible';
                        birthdayContainer.style.opacity = '1';
                    }
                    
                    // Couple image
                    const coupleImg = document.getElementById('previewCoupleImage');
                    const coupleContainer = document.getElementById('previewCoupleImageContainer');
                    if (coupleImg && coupleImg.src && coupleImg.src !== '' && coupleContainer) {
                        coupleContainer.style.display = 'block';
                        coupleContainer.style.setProperty('display', 'block', 'important');
                        coupleImg.style.display = 'block';
                        coupleImg.style.setProperty('display', 'block', 'important');
                        coupleImg.style.zIndex = '15';
                        coupleImg.style.setProperty('z-index', '15', 'important');
                        coupleImg.style.position = 'relative';
                        coupleImg.style.visibility = 'visible';
                        coupleImg.style.opacity = '1';
                        coupleContainer.style.zIndex = '15';
                        coupleContainer.style.setProperty('z-index', '15', 'important');
                        coupleContainer.style.visibility = 'visible';
                        coupleContainer.style.opacity = '1';
                    }
                    
                    // Graduate image
                    const graduateImg = document.getElementById('previewGraduateImage');
                    const graduateContainer = document.getElementById('previewGraduateImageContainer');
                    if (graduateImg && graduateImg.src && graduateImg.src !== '' && graduateContainer) {
                        graduateContainer.style.display = 'block';
                        graduateContainer.style.setProperty('display', 'block', 'important');
                        graduateImg.style.display = 'block';
                        graduateImg.style.setProperty('display', 'block', 'important');
                        graduateImg.style.zIndex = '15';
                        graduateImg.style.setProperty('z-index', '15', 'important');
                        graduateImg.style.position = 'relative';
                        graduateImg.style.visibility = 'visible';
                        graduateImg.style.opacity = '1';
                        graduateContainer.style.zIndex = '15';
                        graduateContainer.style.setProperty('z-index', '15', 'important');
                        graduateContainer.style.visibility = 'visible';
                        graduateContainer.style.opacity = '1';
                    }
                    
                    // Honoree image
                    const honoreeImg = document.getElementById('previewHonoreeImage');
                    const honoreeContainer = document.getElementById('previewHonoreeImageContainer');
                    if (honoreeImg && honoreeImg.src && honoreeImg.src !== '' && honoreeContainer) {
                        honoreeContainer.style.display = 'block';
                        honoreeContainer.style.setProperty('display', 'block', 'important');
                        honoreeImg.style.display = 'block';
                        honoreeImg.style.setProperty('display', 'block', 'important');
                        honoreeImg.style.zIndex = '15';
                        honoreeImg.style.setProperty('z-index', '15', 'important');
                        honoreeImg.style.position = 'relative';
                        honoreeImg.style.visibility = 'visible';
                        honoreeImg.style.opacity = '1';
                        honoreeContainer.style.zIndex = '15';
                        honoreeContainer.style.setProperty('z-index', '15', 'important');
                        honoreeContainer.style.visibility = 'visible';
                        honoreeContainer.style.opacity = '1';
                    }
                    
                    console.log('Ensured all uploaded images remain visible on template background');
                }, 200);
                
                console.log('Template background updated:', bgImage);
            } else {
                // Reset to default - get from data attribute
                const eventTypeAttr = previewCard ? previewCard.getAttribute('data-event-type') : '';
                const currentEventType = (eventTypeAttr || '').toLowerCase();
                previewCard.style.backgroundImage = '';
                
                if (previewCard && currentEventType === 'wedding') {
                    previewCard.classList.add('wedding-bg');
                    previewCard.style.backgroundImage = "url('/images/templatesimages/wedding.png')";
                    previewCard.style.backgroundSize = 'cover';
                    previewCard.style.backgroundPosition = 'center';
                    previewCard.style.backgroundRepeat = 'no-repeat';
                    
                    const previewIcon = document.getElementById('previewIcon');
                    if (previewIcon) {
                        previewIcon.style.display = 'none';
                    }
                } else {
                    previewCard.classList.remove('wedding-bg', 'template-bg');
                    previewCard.style.backgroundImage = '';
                    const previewIcon = document.getElementById('previewIcon');
                    if (previewIcon) {
                        previewIcon.style.display = 'block';
                    }
                }
            }
        }

        // Check sessionStorage for selected template and apply it immediately on page load
        window.addEventListener('load', function() {
            const storedBg = sessionStorage.getItem('selectedTemplateBackground');
            const storedTemplateId = sessionStorage.getItem('selectedTemplateId');
            
            if (storedBg && storedTemplateId) {
                const previewCard = document.getElementById('invitationPreviewCard');
                if (previewCard) {
                    console.log('ðŸ“‹ Applying stored template background from theme selection:', storedBg);
                    
                    // Apply the template background
                    // CRITICAL: Don't set background: 'none' as it resets background-image!
                    previewCard.style.removeProperty('background');
                    // CRITICAL: Final check before applying - block placeholder URLs
                    let safeBg = storedBg;
                    if (safeBg && (safeBg.includes('placeholder.com') || safeBg.includes('via.placeholder') || safeBg.includes('placeholder'))) {
                        console.error('âŒ Placeholder URL detected in storedBg from sessionStorage, using fallback:', safeBg);
                        safeBg = '/images/templatesimages/wedding.png';
                    }
                    
                    previewCard.style.backgroundColor = 'transparent';
                    previewCard.classList.remove('wedding-bg');
                    previewCard.classList.add('template-bg');
                    // Set template image directly as background-image
                    previewCard.style.backgroundImage = `url('${safeBg}')`;
                    previewCard.style.backgroundSize = 'cover';
                    previewCard.style.backgroundPosition = 'center';
                    previewCard.style.backgroundRepeat = 'no-repeat';
                    previewCard.style.setProperty('background-image', `url('${safeBg}')`, 'important');
                    previewCard.style.setProperty('background-size', 'cover', 'important');
                    previewCard.style.setProperty('background-position', 'center', 'important');
                    
                    // Call updatePreviewBackground to ensure everything is set up correctly
                    updatePreviewBackground(storedTemplateId, storedBg, 'Selected Template');
                    
                    // Clear sessionStorage after applying
                    sessionStorage.removeItem('selectedTemplateBackground');
                    sessionStorage.removeItem('selectedTemplateId');
                }
            }
        });

        // Initialize preview background on page load - IMMEDIATELY apply template image
        // Get template variables from data attributes to avoid IDE parsing errors
        const previewCardForInit = document.getElementById('invitationPreviewCard');
        if (previewCardForInit) {
            const templateIdAttr = previewCardForInit.getAttribute('data-template-id');
            const templateNameAttr = previewCardForInit.getAttribute('data-selected-template');
            const templateImageAttr = previewCardForInit.getAttribute('data-template-image-url');
            
            // Template ID from URL - fetch template data
            let templateIdFromUrl = null;
            if (templateIdAttr && templateIdAttr !== 'null') {
                try {
                    templateIdFromUrl = parseInt(templateIdAttr);
                } catch (e) {
                    console.error('Error parsing template_id:', e);
                    templateIdFromUrl = null;
                }
            }
            
            const templateNameFromUrl = templateNameAttr || '';
            const templateImageFromUrl = templateImageAttr || null;
            
            // Apply template image IMMEDIATELY - don't wait for DOM
            function applyTemplateToPreview() {
                const previewCard = document.getElementById('invitationPreviewCard');
                if (!previewCard) {
                    console.log('â³ Preview card not found, retrying...');
                    setTimeout(applyTemplateToPreview, 100);
                    return;
                }
                
                // Get template image URL - check multiple sources
                let cleanUrl = null;
                
                // First, try data attribute from HTML (most reliable)
                const dataTemplateImage = previewCard.getAttribute('data-template-image');
                if (dataTemplateImage) {
                    // data-template-image is already escaped HTML, getAttribute automatically decodes it
                    let imageUrl = dataTemplateImage;
                    cleanUrl = normalizeImagePath(imageUrl);
                    console.log('ðŸ“‹ Found template image from data attribute:', cleanUrl);
                }
                
                // Second, try from server variable
                if (!cleanUrl && templateImageFromUrl && templateImageFromUrl !== '' && templateImageFromUrl !== null) {
                    cleanUrl = normalizeImagePath(templateImageFromUrl);
                    console.log('ðŸ“‹ Found template image from server variable:', cleanUrl);
                }
                
                // Debug: Log what we have
                if (!cleanUrl) {
                    console.log('ðŸ” Template Debug:', {
                        templateIdFromUrl: templateIdFromUrl,
                        templateImageFromUrl: templateImageFromUrl,
                        dataTemplateImage: dataTemplateImage,
                        previewCard: previewCard ? 'found' : 'not found',
                        cleanUrl: cleanUrl
                    });
                }
                
                // Third, try to find from theme cards
                if (!cleanUrl) {
                    const templateCards = document.querySelectorAll('.theme-card');
                    for (let card of templateCards) {
                        const cardId = card.getAttribute('data-template-id');
                        if (cardId && parseInt(cardId) === templateIdFromUrl) {
                            const templateDataImage = card.getAttribute('data-template-image');
                            if (templateDataImage) {
                                cleanUrl = normalizeImagePath(templateDataImage);
                                console.log('ðŸ“‹ Found template image from theme card:', cleanUrl);
                                break;
                            }
                        }
                    }
                }
                
                if (cleanUrl) {
                        // CRITICAL: Final check before applying - block placeholder URLs
                    if (cleanUrl.includes('placeholder.com') || cleanUrl.includes('via.placeholder') || cleanUrl.includes('placeholder')) {
                        console.error('âŒ Placeholder URL detected, using fallback:', cleanUrl);
                            cleanUrl = '/images/templatesimages/wedding.png';
                        }
                        
                    console.log('ðŸŽ¨ Applying template image to preview:', cleanUrl);
                    
                    // Apply template image IMMEDIATELY to preview card
                    previewCard.classList.remove('wedding-bg');
                    previewCard.classList.add('template-bg');
                    
                    // CRITICAL: Remove ALL background-related properties first
                    // The 'background' shorthand can override background-image, so we must remove it completely
                    previewCard.style.removeProperty('background');
                    previewCard.style.removeProperty('background-image');
                    previewCard.style.removeProperty('background-color');
                    previewCard.style.removeProperty('background-size');
                    previewCard.style.removeProperty('background-position');
                    previewCard.style.removeProperty('background-repeat');
                    
                    // Escape single quotes in URL for CSS
                    const escapedUrl = cleanUrl.replace(/'/g, "\\'");
                    const templateImageUrl = `url('${escapedUrl}')`;
                    
                    // CRITICAL: Preload the image first to ensure it's available
                    const preloadImg = new Image();
                    preloadImg.onload = function() {
                        // Image is loaded, verify and re-apply to ensure it's visible
                        previewCard.style.setProperty('background-image', templateImageUrl, 'important');
                        previewCard.style.setProperty('background-size', 'cover', 'important');
                        previewCard.style.setProperty('background-position', 'center', 'important');
                        previewCard.style.setProperty('background-repeat', 'no-repeat', 'important');
                        previewCard.style.setProperty('background-color', 'transparent', 'important');
                        
                        // Also set directly
                        previewCard.style.backgroundImage = templateImageUrl;
                        previewCard.style.backgroundSize = 'cover';
                        previewCard.style.backgroundPosition = 'center';
                        previewCard.style.backgroundRepeat = 'no-repeat';
                        previewCard.style.backgroundColor = 'transparent';
                        
                        // Hide placeholder when template is applied
                        const previewPlaceholder = document.getElementById('previewPlaceholder');
                        if (previewPlaceholder) {
                            previewPlaceholder.style.display = 'none';
                        }
                        
                        // Force a reflow
                        void previewCard.offsetHeight;
                        
                        // Verify it's applied
                        const finalComputed = window.getComputedStyle(previewCard).backgroundImage;
                        console.log('âœ… After image preload - Computed background:', finalComputed);
                        if (finalComputed === 'none' || (!finalComputed.includes(cleanUrl) && !finalComputed.includes(escapedUrl))) {
                            console.error('âŒ Background image still not applied after preload!');
                            console.error('âŒ Inline style backgroundImage:', previewCard.style.backgroundImage);
                            console.error('âŒ Image URL:', cleanUrl);
                            console.error('âŒ Template image URL:', templateImageUrl);
                            console.error('âŒ All computed background properties:', {
                                background: window.getComputedStyle(previewCard).background,
                                backgroundImage: window.getComputedStyle(previewCard).backgroundImage,
                                backgroundSize: window.getComputedStyle(previewCard).backgroundSize,
                                backgroundPosition: window.getComputedStyle(previewCard).backgroundPosition
                            });
                            // Last resort: try using setAttribute to set style
                            const currentStyle = previewCard.getAttribute('style') || '';
                            const newStyle = currentStyle.replace(/background[^;]*;?/g, '').replace(/background-image[^;]*;?/g, '');
                            previewCard.setAttribute('style', newStyle + ` background-image: ${templateImageUrl} !important; background-size: cover !important; background-position: center !important; background-repeat: no-repeat !important;`);
                        } else {
                            console.log('âœ… Template background image successfully applied:', finalComputed);
                        }
                    };
                    preloadImg.onerror = function() {
                        console.error('âŒ Failed to preload template image:', cleanUrl);
                        // Try to apply anyway
                        previewCard.style.setProperty('background-image', templateImageUrl, 'important');
                    };
                    preloadImg.src = cleanUrl;
                    
                    // CRITICAL: Set CSS variable (used by CSS rule with !important)
                    previewCard.style.setProperty('--template-bg-image-url', templateImageUrl, 'important');
                    
                    // CRITICAL: Remove background shorthand first to prevent conflicts
                    previewCard.style.removeProperty('background');
                    
                    // Also set inline style as fallback (though CSS variable should work)
                    previewCard.style.setProperty('background-image', templateImageUrl, 'important');
                        previewCard.style.setProperty('background-size', 'cover', 'important');
                        previewCard.style.setProperty('background-position', 'center', 'important');
                    previewCard.style.setProperty('background-repeat', 'no-repeat', 'important');
                    previewCard.style.setProperty('background-color', 'transparent', 'important');
                    
                    // Also set directly for immediate application
                    previewCard.style.backgroundImage = templateImageUrl;
                    previewCard.style.backgroundSize = 'cover';
                    previewCard.style.backgroundPosition = 'center';
                    previewCard.style.backgroundRepeat = 'no-repeat';
                    previewCard.style.backgroundColor = 'transparent';
                    
                    // Force a reflow to ensure styles are applied
                    void previewCard.offsetHeight;
                    
                    console.log('âœ… Template image applied IMMEDIATELY:', cleanUrl);
                    
                    // Double-check and force again after a micro-delay
                    requestAnimationFrame(function() {
                        previewCard.style.setProperty('background-image', templateImageUrl, 'important');
                        previewCard.style.backgroundImage = templateImageUrl;
                        
                        // Verify after animation frame
                        const computedBg = window.getComputedStyle(previewCard).backgroundImage;
                        console.log('ðŸŽ¨ After requestAnimationFrame - Computed background:', computedBg);
                        if (computedBg !== 'none' && (computedBg.includes(cleanUrl) || computedBg.includes(escapedUrl))) {
                            console.log('âœ… Template background successfully applied!');
                        } else {
                            console.error('âŒ Background still not applied after requestAnimationFrame');
                        }
                    });
                    
                    // Force display
                    previewCard.style.display = 'block';
                    previewCard.style.visibility = 'visible';
                    previewCard.style.opacity = '1';
                    
                    // Verify the image is actually set
                    setTimeout(function() {
                        const computedBg = window.getComputedStyle(previewCard).backgroundImage;
                        const inlineBg = previewCard.style.backgroundImage;
                        
                        console.log('âœ… Template image applied:', cleanUrl);
                        console.log('âœ… Preview card classes:', previewCard.className);
                        console.log('âœ… Inline background-image:', inlineBg);
                        console.log('âœ… Computed background-image:', computedBg);
                        console.log('âœ… Image URL exists:', cleanUrl);
                        
                        // If image still not showing, try one more time with delay
                        if (!computedBg || computedBg === 'none' || (!computedBg.includes(cleanUrl) && !computedBg.includes(escapedUrl))) {
                            console.warn('âš ï¸ Background image not applied, retrying...');
                            previewCard.style.setProperty('background-image', templateImageUrl, 'important');
                            previewCard.style.backgroundImage = templateImageUrl;
                            console.log('ðŸ”„ Retry - Background image:', window.getComputedStyle(previewCard).backgroundImage);
                    }
                    }, 50);
                    
                    // Also update the form fields
                    const templateIdInput = document.getElementById('templateIdInput');
                    const templateImageUrlInput = document.getElementById('templateImageUrlInput');
                    if (templateIdInput) templateIdInput.value = templateIdFromUrl.toString();
                    if (templateImageUrlInput) templateImageUrlInput.value = cleanUrl;
                    
                    // Store globally for form submission
                    window.selectedTemplateId = templateIdFromUrl.toString();
                    window.selectedTemplateImage = cleanUrl;
                    window.selectedTemplateName = templateNameFromUrl;
                    
                    console.log('âœ… Template overlay applied IMMEDIATELY:', cleanUrl);
                    
                    // Test if image actually exists by creating an Image object
                    const testImg = new Image();
                    testImg.onload = function() {
                        console.log('âœ… Template image loaded successfully:', cleanUrl);
                        // Ensure it's still applied after image loads
                        previewCard.style.setProperty('background-image', templateImageUrl, 'important');
                        previewCard.style.backgroundImage = templateImageUrl;
                        
                        // Ensure all preview content is visible on top of template
                        ensurePreviewContentVisible();
                    };
                    testImg.onerror = function() {
                        console.error('âŒ Template image failed to load:', cleanUrl);
                        console.error('âŒ Trying fallback image...');
                        const fallbackUrl = '/images/templatesimages/wedding.png';
                        const fallbackImageUrl = `url('${fallbackUrl}')`;
                        previewCard.style.setProperty('background-image', fallbackImageUrl, 'important');
                        previewCard.style.backgroundImage = fallbackImageUrl;
                        
                        // Ensure all preview content is visible on top of template
                        ensurePreviewContentVisible();
                    };
                    testImg.src = cleanUrl;
                    
                    // Also call updatePreviewBackground to ensure everything is set up
                    updatePreviewBackground(templateIdFromUrl.toString(), cleanUrl, templateNameFromUrl);
                    
                    // Ensure all preview content is visible immediately
                    ensurePreviewContentVisible();
                } else {
                    console.warn('âš ï¸ Template image not found for template ID:', templateIdFromUrl);
                    console.warn('âš ï¸ Debug info:', {
                        templateIdFromUrl: templateIdFromUrl,
                        templateImageFromUrl: templateImageFromUrl,
                        dataTemplateImage: dataTemplateImage,
                        previewCard: previewCard ? 'found' : 'not found'
                    });
                }
            }
            
            // Apply immediately - try multiple times to ensure it works
            // Use requestAnimationFrame to ensure DOM is ready
            function applyTemplateWithRetries() {
                applyTemplateToPreview();
                setTimeout(applyTemplateToPreview, 100);
                setTimeout(applyTemplateToPreview, 300);
                setTimeout(applyTemplateToPreview, 500);
                setTimeout(applyTemplateToPreview, 1000);
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    requestAnimationFrame(applyTemplateWithRetries);
                });
            } else {
                // DOM already loaded, apply immediately
                requestAnimationFrame(applyTemplateWithRetries);
            }
            
            // Also apply on window load as a fallback
            window.addEventListener('load', function() {
                setTimeout(applyTemplateToPreview, 200);
                setTimeout(applyTemplateToPreview, 1000);
                setTimeout(applyTemplateToPreview, 2000);
            });
        } else if (previewCardForInit && templateNameAttr) {
            // Get template ID from data attribute
            const initialTemplateId = (templateNameAttr || '').replace(/\s+/g, '_').toLowerCase();
            // Use the escaped value in template literal
            const templateElement = document.querySelector(`[data-theme="${initialTemplateId}"]`);
            if (templateElement) {
                const templateImg = templateElement.querySelector('.theme-image');
                const templateTitle = templateElement.querySelector('.theme-title');
                const templateDataImage = templateElement.getAttribute('data-template-image');
                
                const imgUrl = templateDataImage || (templateImg ? templateImg.src : null);
                // Safely get template name - textContent is already safe
                const imgName = templateTitle ? templateTitle.textContent : (templateNameAttr || '');
                
                if (imgUrl) {
                    // Normalize the image path
                    let cleanUrl = normalizeImagePath(imgUrl);
                    if (cleanUrl) {
                        updatePreviewBackground(initialTemplateId, cleanUrl, imgName);
                        
                        // Also directly apply to preview card to ensure it's visible
                        const previewCard = document.getElementById('invitationPreviewCard');
                        if (previewCard) {
                            // CRITICAL: Don't set background: 'none' as it resets background-image!
                            previewCard.style.removeProperty('background');
                            previewCard.style.backgroundColor = 'transparent';
                        previewCard.classList.remove('wedding-bg');
                        previewCard.classList.add('template-bg');
                        // Set template image directly as background-image with !important
                        const bgImageUrl = `url('${cleanUrl}')`;
                        previewCard.style.setProperty('background-image', bgImageUrl, 'important');
                        previewCard.style.backgroundImage = bgImageUrl;
                            previewCard.style.backgroundSize = 'cover';
                            previewCard.style.backgroundPosition = 'center';
                            previewCard.style.backgroundRepeat = 'no-repeat';
                            previewCard.style.setProperty('background-size', 'cover', 'important');
                            previewCard.style.setProperty('background-position', 'center', 'important');
                            console.log('Template background applied on page load (selected_template):', cleanUrl);
                        }
                    }
                }
            }
        } else {
            // No template selected - use default background
            updatePreviewBackground();
        }

        // Real-time update preview - No delay for instant feedback
        const instantUpdatePreview = function() {
            const eventName = eventNameInput ? eventNameInput.value.trim() : '';
            const eventDate = eventDateInput ? eventDateInput.value : '';
            const eventTime = eventTimeInput ? eventTimeInput.value : '';
            const venueName = venueNameInput ? venueNameInput.value.trim() : '';
            const venueAddress = venueAddressInput ? venueAddressInput.value.trim() : '';
            const hostedBy = hostedByInput ? hostedByInput.value.trim() : '';
            const personalMessage = personalMessageInput ? personalMessageInput.value.trim() : '';
            
            let hasContent = false;
            
            if (eventName) {
                previewEventName.textContent = eventName;
                previewEventName.style.display = 'inline-block';
                previewPlaceholder.style.display = 'none';
                hasContent = true;
            } else {
                previewEventName.textContent = 'Your Event Name';
                previewEventName.style.display = 'none';
            }
            
            // Update icon based on actual event_type from data attribute (not event name)
            const previewCard = document.getElementById('invitationPreviewCard');
            const eventTypeAttr = previewCard ? previewCard.getAttribute('data-event-type') : '';
            const eventTypeElement = document.getElementById('eventTypeInput');
            const eventTypeFromInput = eventTypeElement ? eventTypeElement.value : '';
            const actualEventType = (eventTypeAttr || eventTypeFromInput || '').toLowerCase().trim();
            
            // Use the updateEventIcon function to set the icon
            updateEventIcon(actualEventType);
            
            // Update date
            if (eventDate) {
                const date = new Date(eventDate);
                const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                previewDateText.textContent = formattedDate;
                previewDate.style.display = 'flex';
                hasContent = true;
            } else {
                previewDate.style.display = 'none';
            }
            
            // Update time
            if (eventTime) {
                const time = eventTime.split(':');
                const hours = parseInt(time[0]);
                const minutes = time[1];
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                previewTimeText.textContent = `${displayHours}:${minutes} ${ampm}`;
                previewTime.style.display = 'flex';
                hasContent = true;
            } else {
                previewTime.style.display = 'none';
            }
            
            // Update venue
            const venueFull = [venueName, venueAddress].filter(v => v).join(', ');
            if (venueFull) {
                previewVenueText.textContent = venueFull;
                previewVenue.style.display = 'flex';
                hasContent = true;
            } else {
                previewVenue.style.display = 'none';
            }
            
            // Update hosted by
            if (hostedBy) {
                previewHostedText.textContent = hostedBy;
                previewHosted.style.display = 'block';
                hasContent = true;
            } else {
                previewHosted.style.display = 'none';
            }
            
            // Update message
            if (personalMessage) {
                previewMessageText.textContent = personalMessage;
                previewMessage.style.display = 'block';
                hasContent = true;
            } else {
                previewMessage.style.display = 'none';
            }
            
            // Update gallery images in live preview - show at end of template
            const galleryImagesInput = document.getElementById('galleryImages');
            const previewGallerySection = document.getElementById('previewGallerySection');
            const previewGalleryGrid = document.getElementById('previewGalleryGrid');
            
            if (galleryImagesInput && galleryImagesInput.files && galleryImagesInput.files.length > 0) {
                if (previewGalleryGrid) {
                    previewGalleryGrid.innerHTML = '';
                    Array.from(galleryImagesInput.files).forEach((file) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.alt = 'Gallery Image';
                            img.style.width = '100%';
                            img.style.height = '180px';
                            img.style.objectFit = 'cover';
                            img.style.borderRadius = '10px';
                            img.style.border = '3px solid rgba(255, 255, 255, 0.9)';
                            img.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
                            img.style.cursor = 'pointer';
                            img.style.transition = 'transform 0.3s ease, box-shadow 0.3s ease';
                            img.style.display = 'block';
                            img.style.visibility = 'visible';
                            img.style.opacity = '1';
                            img.style.position = 'relative';
                            img.style.zIndex = '25';
                            img.style.background = '#ffffff';
                            // Add hover effect
                            img.onmouseenter = function() {
                                this.style.transform = 'scale(1.05)';
                                this.style.boxShadow = '0 6px 20px rgba(0,0,0,0.4)';
                            };
                            img.onmouseleave = function() {
                                this.style.transform = 'scale(1)';
                                this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
                            };
                            previewGalleryGrid.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    });
                }
                if (previewGallerySection) {
                    previewGallerySection.style.display = 'block';
                    previewGallerySection.style.setProperty('display', 'block', 'important');
                    previewGallerySection.style.visibility = 'visible';
                    previewGallerySection.style.opacity = '1';
                    previewGallerySection.style.zIndex = '20';
                    previewGallerySection.style.setProperty('z-index', '20', 'important');
                    previewGallerySection.style.position = 'relative';
                    hasContent = true;
                    console.log('âœ… Gallery section displayed in preview');
                }
                if (previewGalleryGrid) {
                    previewGalleryGrid.style.display = 'grid';
                    previewGalleryGrid.style.setProperty('display', 'grid', 'important');
                    previewGalleryGrid.style.visibility = 'visible';
                    previewGalleryGrid.style.opacity = '1';
                    console.log('âœ… Gallery grid displayed');
                }
            } else {
                if (previewGallerySection) {
                    previewGallerySection.style.display = 'none';
                    previewGallerySection.style.setProperty('display', 'none', 'important');
                }
            }
            
            // Update event-specific fields
            // Wedding fields
            if (brideNameInput && groomNameInput) {
                const brideName = brideNameInput.value.trim();
                const groomName = groomNameInput.value.trim();
                if (brideName || groomName) {
                    if (previewBrideName) previewBrideName.textContent = brideName || '';
                    if (previewGroomName) previewGroomName.textContent = groomName || '';
                    if (previewBrideGroom) {
                        previewBrideGroom.style.display = 'block';
                        hasContent = true;
                    }
                } else {
                    if (previewBrideGroom) previewBrideGroom.style.display = 'none';
                }
            }
            
            // Birthday fields
            if (birthdayPersonInput) {
                const birthdayPerson = birthdayPersonInput.value.trim();
                const age = ageInput ? ageInput.value.trim() : '';
                if (birthdayPerson) {
                    if (previewBirthdayPersonName) previewBirthdayPersonName.textContent = birthdayPerson;
                    if (previewAge && age) previewAge.textContent = `(${age} years old)`;
                    if (previewBirthdayPerson) {
                        previewBirthdayPerson.style.display = 'block';
                        hasContent = true;
                    }
                } else {
                    if (previewBirthdayPerson) previewBirthdayPerson.style.display = 'none';
                }
            }
            
            // Anniversary fields
            if (coupleNamesInput) {
                const coupleNames = coupleNamesInput.value.trim();
                if (coupleNames) {
                    if (previewCoupleNamesText) previewCoupleNamesText.textContent = coupleNames;
                    if (previewCoupleNames) {
                        previewCoupleNames.style.display = 'block';
                        hasContent = true;
                    }
                } else {
                    if (previewCoupleNames) previewCoupleNames.style.display = 'none';
                }
            }
            
            // Baby shower fields - only show if at least one name is provided
            const motherNameInput = document.getElementById('motherName');
            const fatherNameInput = document.getElementById('fatherName');
            if (motherNameInput && fatherNameInput) {
                const motherName = motherNameInput.value.trim();
                const fatherName = fatherNameInput.value.trim();
                const previewMotherName = document.getElementById('previewMotherName');
                const previewFatherName = document.getElementById('previewFatherName');
                const previewMotherFatherSeparator = document.getElementById('previewMotherFatherSeparator');
                const previewMotherFather = document.getElementById('previewMotherFather');
                
                // Only show if at least one name has content
                if (motherName || fatherName) {
                    if (previewMotherName) {
                        previewMotherName.textContent = motherName || '';
                        previewMotherName.style.display = motherName ? 'inline' : 'none';
                    }
                    if (previewFatherName) {
                        previewFatherName.textContent = fatherName || '';
                        previewFatherName.style.display = fatherName ? 'inline' : 'none';
                    }
                    if (previewMotherFatherSeparator) {
                        // Only show separator if both names exist
                        previewMotherFatherSeparator.style.display = (motherName && fatherName) ? 'inline' : 'none';
                    }
                    if (previewMotherFather) {
                        previewMotherFather.style.display = 'block';
                        hasContent = true;
                    }
                } else {
                    if (previewMotherFather) previewMotherFather.style.display = 'none';
                }
            }
            
            // Graduation fields
            if (graduateNameInput) {
                const graduateName = graduateNameInput.value.trim();
                const degree = degreeInput ? degreeInput.value.trim() : '';
                if (graduateName) {
                    if (previewGraduateName) previewGraduateName.textContent = graduateName;
                    if (previewDegree && degree) previewDegree.textContent = degree;
                    if (previewGraduate) {
                        previewGraduate.style.display = 'block';
                        hasContent = true;
                    }
                } else {
                    if (previewGraduate) previewGraduate.style.display = 'none';
                }
            }
            
            // Show/hide placeholder - hide if there's content OR if template is selected
            const previewCardElement = document.getElementById('invitationPreviewCard');
            const hasTemplate = previewCardElement && (previewCardElement.classList.contains('template-bg') || previewCardElement.classList.contains('wedding-bg') || (previewCardElement.style.backgroundImage && previewCardElement.style.backgroundImage !== 'none'));
            
            // Always ensure preview card is visible
            if (previewCardElement) {
                previewCardElement.style.display = 'flex';
                previewCardElement.style.visibility = 'visible';
                previewCardElement.style.opacity = '1';
            }
            
            // Show placeholder only when there's no content and no template
            if (!hasContent && !hasTemplate) {
                if (previewPlaceholder) {
                    previewPlaceholder.style.display = 'block';
                    previewPlaceholder.style.visibility = 'visible';
                    previewPlaceholder.style.opacity = '1';
                }
            } else {
                if (previewPlaceholder) {
                    previewPlaceholder.style.display = 'none';
                }
            }
        };
        
        // Also create a debounced version for less critical updates
        const debouncedUpdatePreview = debounce(instantUpdatePreview, 100);

        // Update preview as user types - Event Name (INSTANT updates)
        if (eventNameInput) {
            eventNameInput.addEventListener('input', instantUpdatePreview);
            eventNameInput.addEventListener('change', instantUpdatePreview);
            eventNameInput.addEventListener('keyup', instantUpdatePreview);
            
            // Initialize preview with current value immediately
            instantUpdatePreview();
        }
        
        // Update preview for critical fields - INSTANT updates
        const criticalFields = ['eventDate', 'eventTime', 'hostedBy', 'personalMessage'];
        criticalFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', instantUpdatePreview);
                field.addEventListener('change', instantUpdatePreview);
                field.addEventListener('keyup', instantUpdatePreview);
            }
        });

        // Update preview for all form fields - Real-time updates
        const allInputs = document.querySelectorAll('#invitationForm input, #invitationForm textarea, #invitationForm select');
        allInputs.forEach(input => {
            // Skip file inputs - they have their own handlers
            if (input.type === 'file') {
                // Add handler for file inputs to toggle background
                input.addEventListener('change', function() {
                    toggleFormGroupBackground();
                });
                return;
            }
            
            // Use instant updates for text inputs, debounced for selects
            if (input.tagName === 'SELECT') {
                input.addEventListener('change', function() {
                    debouncedUpdatePreview();
                    toggleFormGroupBackground();
                });
            } else {
                // Instant updates for text inputs
                input.addEventListener('input', function() {
                    instantUpdatePreview();
                    toggleFormGroupBackground();
                });
                input.addEventListener('keyup', function() {
                    instantUpdatePreview();
                    toggleFormGroupBackground();
                });
                input.addEventListener('change', function() {
                    instantUpdatePreview();
                    toggleFormGroupBackground();
                });
            }
            
            // Update immediately on focus for better UX
            input.addEventListener('focus', function() {
                instantUpdatePreview();
                toggleFormGroupBackground();
            });
            
            // Update on blur to check if value was cleared
            input.addEventListener('blur', function() {
                toggleFormGroupBackground();
            });
        });
        
        console.log(`Connected ${allInputs.length} form fields to live preview`);
        
        // Initialize preview immediately with any existing form values
        instantUpdatePreview();
        
        // Initial check for form groups with content
        toggleFormGroupBackground();
        
        // Also initialize after a short delay to ensure all elements are ready
        setTimeout(function() {
            instantUpdatePreview();
            toggleFormGroupBackground();
        }, 100);

        // Show/hide event-specific fields based on event type
        function showEventSpecificFields(eventType) {
            // Hide all event-specific fields first
            document.querySelectorAll('.event-specific-fields').forEach(field => {
                field.style.display = 'none';
            });

            // Show relevant fields based on event type
            const eventTypeMap = {
                'wedding': 'weddingFields',
                'birthday': 'birthdayFields',
                'anniversary': 'anniversaryFields',
                'babyshower': 'babyshowerFields',
                'graduation': 'graduationFields',
                'retirement': 'retirementFields'
            };

            const fieldId = eventTypeMap[eventType];
            if (fieldId) {
                const fieldElement = document.getElementById(fieldId);
                if (fieldElement) {
                    fieldElement.style.display = 'block';
                }
            }
        }

        // Function to update icon based on event type
        function updateEventIcon(eventType) {
            const previewIcon = document.getElementById('previewIcon');
            if (!previewIcon) return;
            
            const eventTypeLower = (eventType || '').toLowerCase().trim();
            
            // Set icon based on event type
            if (eventTypeLower === 'wedding') {
                previewIcon.textContent = 'ðŸ’';
            } else if (eventTypeLower === 'birthday') {
                previewIcon.textContent = 'ðŸŽ‚';
            } else if (eventTypeLower === 'anniversary') {
                previewIcon.textContent = 'ðŸ’‘';
            } else if (eventTypeLower === 'graduation') {
                previewIcon.textContent = 'ðŸŽ“';
            } else if (eventTypeLower === 'babyshower' || eventTypeLower === 'baby shower') {
                previewIcon.textContent = 'ðŸ‘¶';
            } else if (eventTypeLower === 'retirement') {
                previewIcon.textContent = 'ðŸŽ‰';
            } else {
                // Default icon if event type is not specified
                previewIcon.textContent = 'ðŸŽŠ';
            }
            
            // Keep icon hidden when template background is active (template design has its own icons)
            const previewCard = document.getElementById('invitationPreviewCard');
            if (previewCard && (previewCard.classList.contains('template-bg') || previewCard.classList.contains('wedding-bg'))) {
                previewIcon.style.display = 'none';
            }
        }
        
        // Function to show/hide images based on event type
        function showEventSpecificImages(eventType) {
            const eventTypeLower = (eventType || '').toLowerCase().trim();
            
            // Hide all image containers first
            const imageContainers = {
                'main': document.getElementById('previewMainImageContainer'),
                'brideGroom': document.getElementById('previewBrideGroomContainer'),
                'birthday': document.getElementById('previewBirthdayImageContainer'),
                'couple': document.getElementById('previewCoupleImageContainer'),
                'graduate': document.getElementById('previewGraduateImageContainer'),
                'honoree': document.getElementById('previewHonoreeImageContainer')
            };
            
            // Hide all containers
            Object.values(imageContainers).forEach(container => {
                if (container) {
                    container.style.display = 'none';
                    container.style.setProperty('display', 'none', 'important');
                }
            });
            
            // Show only relevant images based on event type
            if (eventTypeLower === 'wedding') {
                // Wedding: Show bride and groom images
                if (imageContainers.brideGroom) {
                    const brideImg = document.getElementById('previewBrideImage');
                    const groomImg = document.getElementById('previewGroomImage');
                    if (brideImg && brideImg.src && brideImg.src !== '' && !brideImg.src.includes('data:,')) {
                        imageContainers.brideGroom.style.display = 'flex';
                        imageContainers.brideGroom.style.setProperty('display', 'flex', 'important');
                    } else if (groomImg && groomImg.src && groomImg.src !== '' && !groomImg.src.includes('data:,')) {
                        imageContainers.brideGroom.style.display = 'flex';
                        imageContainers.brideGroom.style.setProperty('display', 'flex', 'important');
                    }
                }
            } else if (eventTypeLower === 'birthday') {
                // Birthday: Show only birthday image
                if (imageContainers.birthday) {
                    const birthdayImg = document.getElementById('previewBirthdayImage');
                    if (birthdayImg && birthdayImg.src && birthdayImg.src !== '' && !birthdayImg.src.includes('data:,')) {
                        imageContainers.birthday.style.display = 'block';
                        imageContainers.birthday.style.setProperty('display', 'block', 'important');
                    }
                }
            } else if (eventTypeLower === 'anniversary') {
                // Anniversary: Show couple image
                if (imageContainers.couple) {
                    const coupleImg = document.getElementById('previewCoupleImage');
                    if (coupleImg && coupleImg.src && coupleImg.src !== '' && !coupleImg.src.includes('data:,')) {
                        imageContainers.couple.style.display = 'block';
                        imageContainers.couple.style.setProperty('display', 'block', 'important');
                    }
                }
            } else if (eventTypeLower === 'graduation') {
                // Graduation: Show graduate image
                if (imageContainers.graduate) {
                    const graduateImg = document.getElementById('previewGraduateImage');
                    if (graduateImg && graduateImg.src && graduateImg.src !== '' && !graduateImg.src.includes('data:,')) {
                        imageContainers.graduate.style.display = 'block';
                        imageContainers.graduate.style.setProperty('display', 'block', 'important');
                    }
                }
            } else if (eventTypeLower === 'retirement') {
                // Retirement: Show honoree image
                if (imageContainers.honoree) {
                    const honoreeImg = document.getElementById('previewHonoreeImage');
                    if (honoreeImg && honoreeImg.src && honoreeImg.src !== '' && !honoreeImg.src.includes('data:,')) {
                        imageContainers.honoree.style.display = 'block';
                        imageContainers.honoree.style.setProperty('display', 'block', 'important');
                    }
                }
            }
            
            // Main image can be shown for all event types if uploaded
            if (imageContainers.main) {
                const mainImg = document.getElementById('previewMainImage');
                if (mainImg && mainImg.src && mainImg.src !== '' && !mainImg.src.includes('data:,')) {
                    imageContainers.main.style.display = 'block';
                    imageContainers.main.style.setProperty('display', 'block', 'important');
                }
            }
        }

        // Initialize event-specific fields based on current event type
        // Get event type from data attribute to avoid IDE parsing errors
        const eventTypeElement = document.getElementById('invitationPreviewCard');
        const currentEventType = eventTypeElement ? (eventTypeElement.getAttribute('data-event-type') || '') : '';
        if (currentEventType) {
            // Show only relevant images for this event type
            showEventSpecificImages(currentEventType);
            showEventSpecificFields(currentEventType);
            updateEventIcon(currentEventType); // Update icon on page load
        }

        // Update default text based on event type
        function setDefaultTexts(eventType) {
            const eventNameInput = document.getElementById('eventName');
            const personalMessageInput = document.getElementById('personalMessage');
            const hostedByInput = document.getElementById('hostedBy');
            
            if (!eventNameInput || !personalMessageInput) return;

            // Get user name from hostedBy input (which is pre-filled with current_user.name)
            // If hostedBy is empty, try to get from the input's default value attribute
            let userName = '';
            if (hostedByInput) {
                userName = hostedByInput.value ? hostedByInput.value.trim() : '';
                // If empty, try to get from the value attribute (server-rendered)
                if (!userName && hostedByInput.getAttribute('value')) {
                    userName = hostedByInput.getAttribute('value').trim();
                }
            }
            
            // Map event types to display names
            const eventTypeNames = {
                'wedding': 'Wedding',
                'birthday': 'Birthday',
                'anniversary': 'Anniversary',
                'graduation': 'Graduation',
                'babyshower': 'Baby Shower',
                'retirement': 'Retirement'
            };
            
            const eventTypeName = eventTypeNames[eventType] || 'Event';

            const defaultTexts = {
                'wedding': {
                    eventName: eventNameInput.value || (userName ? `${userName}'s Wedding` : 'We request the pleasure of your company at our wedding'),
                    message: personalMessageInput.value || 'Join us as we celebrate the beginning of our new journey together. Your presence would make our special day even more meaningful.'
                },
                'birthday': {
                    eventName: eventNameInput.value || (userName ? `${userName}'s Birthday` : 'You\'re invited to celebrate!'),
                    message: personalMessageInput.value || 'Join us for a celebration filled with joy, laughter, and wonderful memories. Your presence will make this birthday truly special!'
                },
                'anniversary': {
                    eventName: eventNameInput.value || (userName ? `${userName}'s Anniversary` : 'Join us in celebrating our anniversary'),
                    message: personalMessageInput.value || 'We\'re celebrating another year of love, laughter, and cherished memories. Your presence would make our celebration complete.'
                },
                'babyshower': {
                    eventName: eventNameInput.value || (userName ? `${userName}'s Baby Shower` : 'Showering our little one with love'),
                    message: personalMessageInput.value || 'Join us as we celebrate the upcoming arrival of our little bundle of joy. Your love and blessings are warmly welcome!'
                },
                'graduation': {
                    eventName: eventNameInput.value || (userName ? `${userName}'s Graduation` : 'Celebrating a milestone achievement'),
                    message: personalMessageInput.value || 'Join us in celebrating this incredible milestone. Your presence would mean the world to us on this special day!'
                },
                'retirement': {
                    eventName: eventNameInput.value || (userName ? `${userName}'s Retirement` : 'Celebrating a remarkable career'),
                    message: personalMessageInput.value || 'Join us in honoring years of dedication and celebrating the beginning of a new chapter. Your presence would be greatly appreciated!'
                }
            };

            const defaults = defaultTexts[eventType];
            if (defaults && !eventNameInput.value) {
                eventNameInput.value = defaults.eventName;
                // Trigger input event to update preview
                instantUpdatePreview();
            }
            if (defaults && !personalMessageInput.value) {
                personalMessageInput.value = defaults.message;
                debouncedUpdatePreview();
            }
        }

        // Set default texts on page load
        if (currentEventType) {
            setDefaultTexts(currentEventType);
        }
            
        // Theme Selection - Enhanced with better feedback
        window.selectTheme = function(themeId, templateId, element) {
            // Remove previous selection
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Mark selected with smooth animation
            element.classList.add('selected');
            selectedThemeValue = templateId || themeId;
            
                // Store template ID and image for form submission
            window.selectedTemplateId = templateId;
            
            // Update hidden form fields immediately
            const templateIdInput = document.getElementById('templateIdInput');
            const templateImageUrlInput = document.getElementById('templateImageUrlInput');
            
            // Get template image and name from the selected card
            const templateImg = element.querySelector('.theme-image');
            const templateTitle = element.querySelector('.theme-title');
            
            // Get the image source - prioritize data-template-image attribute
            let templateImageUrl = null;
            
            // First, try data-template-image attribute (most reliable)
            const templateDataImage = element.getAttribute('data-template-image');
            if (templateDataImage) {
                templateImageUrl = templateDataImage;
            }
            
            // If not found, try from img element
            if (!templateImageUrl && templateImg) {
                templateImageUrl = templateImg.getAttribute('data-src') || templateImg.src;
            }
            
            // Normalize the image path using the global function
            if (templateImageUrl) {
                templateImageUrl = normalizeImagePath(templateImageUrl);
                
                // Skip if normalization returned null (placeholder/invalid URL)
                if (!templateImageUrl) {
                    console.warn('Invalid template image URL (placeholder), skipping:', templateImg?.src || templateDataImage);
                    return;
                }
            }
            
            // Safely get template name - textContent is already safe, but ensure fallback is properly escaped
            const templateName = templateTitle ? templateTitle.textContent : (themeId || '');
            
            // Detect event type from template name and update icon
            const templateNameLower = templateName.toLowerCase();
            let detectedEventType = '';
            if (templateNameLower.includes('wedding') || templateNameLower.includes('marriage')) {
                detectedEventType = 'wedding';
            } else if (templateNameLower.includes('birthday') || templateNameLower.includes('bday')) {
                detectedEventType = 'birthday';
            } else if (templateNameLower.includes('anniversary')) {
                detectedEventType = 'anniversary';
            } else if (templateNameLower.includes('graduation')) {
                detectedEventType = 'graduation';
            } else if (templateNameLower.includes('baby') || templateNameLower.includes('shower')) {
                detectedEventType = 'babyshower';
            } else if (templateNameLower.includes('retirement')) {
                detectedEventType = 'retirement';
            }
            
            // Update icon based on detected event type
            if (detectedEventType) {
                updateEventIcon(detectedEventType);
                // Also update the data-event-type attribute on preview card
                const previewCard = document.getElementById('invitationPreviewCard');
                if (previewCard) {
                    previewCard.setAttribute('data-event-type', detectedEventType);
                }
                // Update the hidden event type input
                const eventTypeInput = document.getElementById('eventTypeInput');
                if (eventTypeInput) {
                    eventTypeInput.value = detectedEventType;
                }
                // Update default event name text based on detected event type
                setDefaultTexts(detectedEventType);
                // Filter images to show only event-specific ones
                showEventSpecificImages(detectedEventType);
            }
            
            // Update preview background with selected template immediately
            // Apply template image as background in live preview
            // CRITICAL: Double-check for placeholder URLs after normalization
            if (templateImageUrl && !templateImageUrl.includes('placeholder') && !templateImageUrl.includes('via.placeholder')) {
                // Normalize the URL using the global function (this also filters placeholders)
                let cleanUrl = normalizeImagePath(templateImageUrl);
                
                // Final safety check - if normalization returned null or still has placeholder, skip
                if (!cleanUrl || cleanUrl.includes('placeholder') || cleanUrl.includes('via.placeholder')) {
                    console.warn('âŒ Placeholder URL detected after normalization, skipping:', templateImageUrl);
                    return;
                }
                
                console.log('âœ… Template selected - Applying background:', templateId, cleanUrl);
                
                // Store template image URL for form submission
                window.selectedTemplateImage = cleanUrl;
                
                // Update hidden form fields immediately
                if (templateIdInput) templateIdInput.value = templateId || '';
                if (templateImageUrlInput) templateImageUrlInput.value = cleanUrl;
                
                // Apply background immediately using updatePreviewBackground function
                updatePreviewBackground(templateId || themeId, cleanUrl, templateName);
                
                // Ensure all preview content is visible on top of template
                ensurePreviewContentVisible();
                
                // Also ensure preview card is updated immediately - even if details page isn't visible yet
                const previewCard = document.getElementById('invitationPreviewCard');
                if (previewCard) {
                    // Apply background immediately so it's ready when user goes to details
                    // Remove default background first
                    // CRITICAL: Don't set background: 'none' as it resets background-image!
                    previewCard.style.removeProperty('background');
                    previewCard.style.backgroundColor = 'transparent';
                    // Remove wedding-bg class and add template-bg to show template overlay
                    previewCard.classList.remove('wedding-bg');
                    previewCard.classList.add('template-bg');
                    // Set template image directly as background-image
                    previewCard.style.backgroundImage = `url('${cleanUrl}')`;
                    previewCard.style.backgroundSize = 'cover';
                    previewCard.style.backgroundPosition = 'center';
                    previewCard.style.backgroundRepeat = 'no-repeat';
                    previewCard.style.setProperty('background-image', `url('${cleanUrl}')`, 'important');
                    previewCard.style.setProperty('background-size', 'cover', 'important');
                    previewCard.style.setProperty('background-position', 'center', 'important');
                    
                    // Hide emoji icon when template background is active
                    const previewIcon = document.getElementById('previewIcon');
                    if (previewIcon) {
                        previewIcon.style.display = 'none';
                    }
                    
                    // Hide placeholder when template is selected
                    const previewPlaceholder = document.getElementById('previewPlaceholder');
                    if (previewPlaceholder) {
                        previewPlaceholder.style.display = 'none';
                    }
                    
                    console.log('âœ… Template overlay applied to preview card IMMEDIATELY:', cleanUrl);
                    
                    // Ensure all preview content is visible on top of template
                    ensurePreviewContentVisible();
                } else {
                    // Preview card doesn't exist yet (user still on theme selection page)
                    // Store the template info so it applies when details page loads
                    console.log('â³ Preview card not found yet - template will apply when details page loads');
                    // CRITICAL: Final check before storing in sessionStorage - block placeholder URLs
                    if (cleanUrl && (cleanUrl.includes('placeholder.com') || cleanUrl.includes('via.placeholder') || cleanUrl.includes('placeholder'))) {
                        console.error('âŒ Placeholder URL blocked from sessionStorage:', cleanUrl);
                        cleanUrl = '/images/templatesimages/wedding.png'; // Default fallback
                    }
                    
                    // Store for later application
                    sessionStorage.setItem('selectedTemplateBackground', cleanUrl);
                    sessionStorage.setItem('selectedTemplateId', templateId || themeId);
                }
            } else {
                console.warn('Template image URL not found or invalid:', templateImageUrl);
                // Still try to show the template even if URL has issues
                if (templateImg && templateImg.src) {
                    let cleanUrl = normalizeImagePath(templateImg.src);
                    if (cleanUrl) {
                        updatePreviewBackground(templateId || themeId, cleanUrl, templateName);
                    }
                }
            }
            
            // Update hidden input with template ID or name
            const templateInput = document.getElementById('selectedTemplate');
            if (templateInput) {
                templateInput.value = templateId || themeId;
            }
            
            // Enable continue button with smooth transition
            const continueBtn = document.getElementById('continueToDetails');
            if (continueBtn) {
                continueBtn.disabled = false;
                continueBtn.style.opacity = '1';
                continueBtn.style.cursor = 'pointer';
                continueBtn.style.transition = 'all 0.3s ease';
            }
            
            // Optional: Scroll to continue button on mobile
            if (window.innerWidth < 968 && continueBtn) {
                setTimeout(() => {
                    continueBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 300);
            }
        };

        // Continue to Details
        window.continueToDetails = function() {
            if (!selectedThemeValue) {
                alert('Please select a theme first');
                return;
            }

            // Ensure template background is applied when moving to details page
            const selectedCard = document.querySelector('.theme-card.selected');
            if (selectedCard) {
                const templateDataImage = selectedCard.getAttribute('data-template-image');
                const templateImg = selectedCard.querySelector('.theme-image');
                const templateTitle = selectedCard.querySelector('.theme-title');
                
                let templateImageUrl = templateDataImage || (templateImg ? templateImg.src : null);
                // Safely get template name - textContent is already safe, but ensure fallback is properly escaped
                const templateName = templateTitle ? templateTitle.textContent : (selectedThemeValue || '');
                
                // Normalize the URL using the global function (this will filter out placeholder URLs)
                if (templateImageUrl) {
                    templateImageUrl = normalizeImagePath(templateImageUrl);
                }
                
                // Skip if normalization returned null (placeholder/invalid URL)
                if (templateImageUrl) {
                    // CRITICAL: Final check before storing in sessionStorage - block placeholder URLs
                    if (templateImageUrl.includes('placeholder.com') || templateImageUrl.includes('via.placeholder') || templateImageUrl.includes('placeholder')) {
                        console.error('âŒ Placeholder URL blocked from sessionStorage in continueToDetails:', templateImageUrl);
                        templateImageUrl = '/images/templatesimages/wedding.png'; // Default fallback
                    }
                    
                    // Store in sessionStorage as backup
                    sessionStorage.setItem('selectedTemplateBackground', templateImageUrl);
                    sessionStorage.setItem('selectedTemplateId', selectedThemeValue);
                }
            }
            
            // Also check sessionStorage for template background (from theme selection)
            if (!templateImageUrl) {
                templateImageUrl = sessionStorage.getItem('selectedTemplateBackground');
                const storedTemplateId = sessionStorage.getItem('selectedTemplateId');
                if (storedTemplateId) {
                    selectedThemeValue = storedTemplateId;
                }
            }
            
            if (templateImageUrl && !templateImageUrl.includes('placeholder')) {
                console.log('ðŸŽ¯ Applying template background when continuing to details:', templateImageUrl);
                updatePreviewBackground(selectedThemeValue, templateImageUrl, templateName || selectedThemeValue);
                
                // Also directly apply to preview card to ensure it's visible
                const previewCard = document.getElementById('invitationPreviewCard');
                if (previewCard) {
                    // Remove default background first
                    // CRITICAL: Don't set background: 'none' as it resets background-image!
                    previewCard.style.removeProperty('background');
                    // CRITICAL: Final check before setting background - block placeholder URLs
                    if (templateImageUrl && (templateImageUrl.includes('placeholder.com') || templateImageUrl.includes('via.placeholder'))) {
                        console.error('âŒ Placeholder URL detected, using fallback instead:', templateImageUrl);
                        templateImageUrl = '/images/templatesimages/wedding.png';
                    }
                    
                    previewCard.style.backgroundColor = 'transparent';
                    previewCard.classList.remove('wedding-bg');
                    previewCard.classList.add('template-bg');
                    // Set template image directly as background-image
                    previewCard.style.backgroundImage = `url('${templateImageUrl}')`;
                    previewCard.style.backgroundSize = 'cover';
                    previewCard.style.backgroundPosition = 'center';
                    previewCard.style.backgroundRepeat = 'no-repeat';
                    previewCard.style.setProperty('background-image', `url('${templateImageUrl}')`, 'important');
                    previewCard.style.setProperty('background-size', 'cover', 'important');
                    previewCard.style.setProperty('background-position', 'center', 'important');
                    
                    console.log('âœ… Template overlay applied directly to preview card');
                }
            }

            document.getElementById('themeSelectionPage').classList.remove('active');
            document.getElementById('detailsFormPage').classList.add('active');
            
            // Update progress bar
            updateProgressBar(3);
        };

        // Update Progress Bar
        function updateProgressBar(step) {
            document.querySelectorAll('.progress-step').forEach((stepEl, index) => {
                const stepNum = index + 1;
                const circle = stepEl.querySelector('.step-circle');
                const label = stepEl.querySelector('.step-label');
                
                // Ensure circle and label are always visible
                if (circle) {
                    circle.style.visibility = 'visible';
                    circle.style.opacity = '1';
                    circle.style.display = 'flex';
                }
                if (label) {
                    label.style.visibility = 'visible';
                    label.style.opacity = '1';
                    label.style.display = 'block';
                    label.style.color = 'var(--reddish-brown-dark)';
                }
                
                // Add animation delay based on step position for sequential animation
                const delay = index * 0.2;
                
                // Reset progress line by temporarily removing classes to reset width
                const wasCompleted = stepEl.classList.contains('completed');
                const wasActive = stepEl.classList.contains('active');
                if (wasCompleted || wasActive) {
                    stepEl.classList.remove('completed', 'active');
                    // Force reflow to reset width
                    void stepEl.offsetWidth;
                }
                
                if (stepNum < step) {
                    // Animate to completed state with checkmark
                    stepEl.classList.remove('active', 'pending', 'animating-line');
                    // Reset line width
                    stepEl.style.setProperty('--line-width', '0');
                    // Force reflow
                    void stepEl.offsetWidth;
                    // Add animating class first, then completed class to trigger line animation
                    setTimeout(() => {
                        stepEl.classList.add('animating-line', 'completed');
                    }, delay * 100);
                    
                    if (circle) {
                        // Reset animation first
                        circle.style.animation = 'none';
                        // Force reflow
                        void circle.offsetWidth;
                        // Animate checkmark appearance
                        setTimeout(() => {
                            circle.textContent = 'âœ“';
                            circle.style.background = 'var(--reddish-brown-dark)';
                            circle.style.color = '#FFFFFF';
                            circle.style.animation = 'checkmarkAppear 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
                        }, delay * 100 + 300);
                    }
                } else if (stepNum === step) {
                    // Animate to active state with pulse
                    stepEl.classList.remove('completed', 'pending', 'animating-line');
                    // Reset line width
                    stepEl.style.setProperty('--line-width', '0');
                    // Force reflow
                    void stepEl.offsetWidth;
                    // Add animating class first, then active class to trigger line animation
                    setTimeout(() => {
                        stepEl.classList.add('animating-line', 'active');
                    }, delay * 100);
                    
                    if (circle) {
                        // Reset animation first
                        circle.style.animation = 'none';
                        // Force reflow
                        void circle.offsetWidth;
                        // Animate active step appearance
                        setTimeout(() => {
                            circle.textContent = stepNum.toString();
                            circle.style.background = 'var(--golden-yellow)';
                            circle.style.color = 'var(--reddish-brown-dark)';
                            circle.style.animation = 'activeStepAppear 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards, pulseActive 2s ease-in-out infinite 0.5s';
                        }, delay * 100 + 300);
                    }
                } else {
                    // Set to pending state (no animation)
                    stepEl.classList.remove('active', 'completed');
                    stepEl.classList.add('pending');
                    
                    if (circle) {
                        circle.textContent = stepNum.toString();
                        circle.style.background = '#FFFFFF';
                        circle.style.color = 'var(--reddish-brown-dark)';
                        circle.style.border = '2px solid var(--reddish-brown-dark)';
                        circle.style.animation = 'none';
                    }
                }
            });
        }
        
        // Ensure all progress bar elements are visible on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Make sure all step circles and labels are visible
            document.querySelectorAll('.step-circle').forEach(circle => {
                circle.style.visibility = 'visible';
                circle.style.opacity = '1';
                circle.style.display = 'flex';
            });
            
            document.querySelectorAll('.step-label').forEach(label => {
                label.style.visibility = 'visible';
                label.style.opacity = '1';
                label.style.display = 'block';
                label.style.color = 'var(--reddish-brown-dark)';
            });
            
            // Ensure progress bar container has no background
            const progressBarContainer = document.querySelector('.progress-bar-container');
            if (progressBarContainer) {
                progressBarContainer.style.background = 'transparent';
            }
            
            const progressBar = document.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.background = 'transparent';
            }
            
            // CRITICAL: Ensure preview card is always visible from the start
            const previewCard = document.getElementById('invitationPreviewCard');
            const livePreviewCard = document.querySelector('.live-preview-card');
            const previewContent = document.querySelector('.preview-content');
            const previewTitle = document.querySelector('.preview-title');
            const previewPlaceholder = document.getElementById('previewPlaceholder');
            
            // Force preview card to be visible
            if (previewCard) {
                previewCard.style.setProperty('display', 'flex', 'important');
                previewCard.style.setProperty('visibility', 'visible', 'important');
                previewCard.style.setProperty('opacity', '1', 'important');
            }
            
            // Force live preview card to be visible
            if (livePreviewCard) {
                livePreviewCard.style.setProperty('display', 'flex', 'important');
                livePreviewCard.style.setProperty('visibility', 'visible', 'important');
                livePreviewCard.style.setProperty('opacity', '1', 'important');
            }
            
            // Force preview content to be visible
            if (previewContent) {
                previewContent.style.setProperty('display', 'flex', 'important');
                previewContent.style.setProperty('visibility', 'visible', 'important');
                previewContent.style.setProperty('opacity', '1', 'important');
            }
            
            // Force preview title to be visible
            if (previewTitle) {
                previewTitle.style.setProperty('display', 'block', 'important');
                previewTitle.style.setProperty('visibility', 'visible', 'important');
                previewTitle.style.setProperty('opacity', '1', 'important');
            }
            
            // Show placeholder if no content yet (but keep preview card visible)
            if (previewPlaceholder) {
                const hasContent = previewCard && (
                    previewCard.querySelector('#previewEventName')?.textContent?.trim() ||
                    previewCard.querySelector('#previewDate')?.style.display !== 'none' ||
                    previewCard.classList.contains('template-bg')
                );
                
                if (!hasContent) {
                    previewPlaceholder.style.setProperty('display', 'block', 'important');
                    previewPlaceholder.style.setProperty('visibility', 'visible', 'important');
                    previewPlaceholder.style.setProperty('opacity', '1', 'important');
                }
            }
            
            // Ensure Preview button text is always visible
            const previewButton = document.querySelector('.btn-preview');
            if (previewButton) {
                previewButton.style.visibility = 'visible';
                previewButton.style.opacity = '1';
                previewButton.style.display = 'inline-flex';
                previewButton.style.color = '#FFFFFF';
                
                // Ensure text content is visible
                const buttonText = previewButton.childNodes;
                buttonText.forEach(node => {
                    if (node.nodeType === 3) { // Text node
                        node.parentElement.style.color = '#FFFFFF';
                    }
                });
                
                // Ensure icon is visible
                const icon = previewButton.querySelector('i');
                if (icon) {
                    icon.style.visibility = 'visible';
                    icon.style.opacity = '1';
                    icon.style.display = 'inline-block';
                    icon.style.color = '#FFFFFF';
                }
            }
        });

        // Navigate to step - Make progress bar clickable
        window.navigateToStep = function(step) {
            const themeSelectionPage = document.getElementById('themeSelectionPage');
            const detailsFormPage = document.getElementById('detailsFormPage');
            
            if (step === 1) {
                // Navigate to templates page (occasion/event selection)
                window.location.href = '/templates';
            } else if (step === 2) {
                // Navigate to theme selection
                if (themeSelectionPage) {
                    themeSelectionPage.classList.add('active');
                    if (detailsFormPage) {
                        detailsFormPage.classList.remove('active');
                    }
                    updateProgressBar(2);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } else if (step === 3) {
                // Navigate to details form (only if template is selected)
                if (selectedThemeValue || window.selectedTemplateId) {
                    if (detailsFormPage) {
                        detailsFormPage.classList.add('active');
                        if (themeSelectionPage) {
                            themeSelectionPage.classList.remove('active');
                        }
                        updateProgressBar(3);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
            } else {
                    alert('Please select a theme first');
                }
            } else if (step === 4) {
                // Navigate to preview (not implemented yet)
                alert('Preview step not available yet');
            }
        };
        
        // Form submission - Capture all form data including template background
        window.submitForm = function() {
            const form = document.getElementById('invitationForm');
            
            // Capture template background info before submission
            const templateIdInput = document.getElementById('templateIdInput');
            const templateImageUrlInput = document.getElementById('templateImageUrlInput');
            
            if (selectedTemplateId && templateIdInput) {
                templateIdInput.value = selectedTemplateId;
            }
            
            if (selectedTemplateImage && templateImageUrlInput) {
                // Clean the URL
                let cleanUrl = selectedTemplateImage.split('?')[0].split('#')[0];
                if (!cleanUrl.startsWith('/images/') && cleanUrl.includes('templatesimages')) {
                    cleanUrl = cleanUrl.replace(/^.*?templatesimages/, '/images/templatesimages');
                }
                templateImageUrlInput.value = cleanUrl;
            }
            
            console.log('Submitting form with template data:', {
                templateId: selectedTemplateId,
                templateImage: selectedTemplateImage
            });
            
            form.submit();
        };

        window.goBack = function() {
            const themePage = document.getElementById('themeSelectionPage');
            if (themePage && !themePage.classList.contains('hidden')) {
                themePage.classList.add('active');
                document.getElementById('detailsFormPage').classList.remove('active');
                updateProgressBar(2);
            } else {
                window.history.back();
            }
        };
        });
        
        // Function to ensure preview content is visible on top of template background
        function ensurePreviewContentVisible() {
            const previewCard = document.getElementById('invitationPreviewCard');
            if (!previewCard) return;
            
            // Ensure all text elements are visible
            const textElements = [
                'previewEventName', 'previewDate', 'previewTime', 'previewVenue',
                'previewHosted', 'previewMessage', 'previewBrideGroom',
                'previewBirthdayPerson', 'previewCoupleNames', 'previewMotherFather',
                'previewGraduate', 'previewIcon'
            ];
            
            textElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.position = 'relative';
                    element.style.zIndex = '15';
                    // Only show if it has content
                    if (element.textContent && element.textContent.trim()) {
                        element.style.display = 'block';
                    }
                    element.style.visibility = 'visible';
                    element.style.opacity = '1';
                }
            });
            
            // Filter images based on event type instead of showing all
            const previewCardForFilter = document.getElementById('invitationPreviewCard');
            const eventTypeForFilter = previewCardForFilter ? (previewCardForFilter.getAttribute('data-event-type') || '') : '';
            if (eventTypeForFilter) {
                showEventSpecificImages(eventTypeForFilter);
            } else {
                // If no event type, show all images (fallback)
                const imageContainers = [
                    'previewMainImageContainer', 'previewBrideGroomContainer',
                    'previewBirthdayImageContainer', 'previewCoupleImageContainer',
                    'previewGraduateImageContainer', 'previewHonoreeImageContainer'
                ];
                
                imageContainers.forEach(id => {
                    const container = document.getElementById(id);
                    if (container) {
                        const images = container.querySelectorAll('img');
                        if (images && images.length > 0) {
                            let hasVisibleImage = false;
                            images.forEach(img => {
                                if (img && img.src && img.src !== '' && !img.src.includes('data:,')) {
                                    hasVisibleImage = true;
                                    container.style.position = 'relative';
                                    container.style.zIndex = '15';
                                    container.style.setProperty('z-index', '15', 'important');
                                    container.style.display = 'block';
                                    container.style.setProperty('display', 'block', 'important');
                                    container.style.visibility = 'visible';
                                    container.style.opacity = '1';
                                    img.style.position = 'relative';
                                    img.style.zIndex = '15';
                                    img.style.setProperty('z-index', '15', 'important');
                                    img.style.display = 'block';
                                    img.style.setProperty('display', 'block', 'important');
                                    img.style.visibility = 'visible';
                                    img.style.opacity = '1';
                                    img.style.width = '100%';
                                    img.style.maxWidth = '100%';
                                    img.style.height = 'auto';
                                    img.style.objectFit = 'cover';
                                }
                            });
                            if (hasVisibleImage) {
                                container.style.display = 'block';
                                container.style.setProperty('display', 'block', 'important');
                            }
                        }
                    }
                });
            }
            
            // Ensure gallery images are visible
            const previewGallerySection = document.getElementById('previewGallerySection');
            const previewGalleryGrid = document.getElementById('previewGalleryGrid');
            if (previewGalleryGrid && previewGallerySection) {
                const galleryImages = previewGalleryGrid.querySelectorAll('img');
                if (galleryImages && galleryImages.length > 0) {
                    previewGallerySection.style.display = 'block';
                    previewGallerySection.style.setProperty('display', 'block', 'important');
                    previewGallerySection.style.visibility = 'visible';
                    previewGallerySection.style.opacity = '1';
                    previewGallerySection.style.zIndex = '20';
                    previewGallerySection.style.setProperty('z-index', '20', 'important');
                    previewGallerySection.style.position = 'relative';
                    previewGalleryGrid.style.display = 'grid';
                    previewGalleryGrid.style.setProperty('display', 'grid', 'important');
                    previewGalleryGrid.style.visibility = 'visible';
                    previewGalleryGrid.style.opacity = '1';
                    galleryImages.forEach(img => {
                        if (img && img.src && img.src !== '') {
                            img.style.display = 'block';
                            img.style.setProperty('display', 'block', 'important');
                            img.style.visibility = 'visible';
                            img.style.opacity = '1';
                            img.style.zIndex = '20';
                            img.style.setProperty('z-index', '20', 'important');
                            img.style.position = 'relative';
                        }
                    });
                    console.log('âœ… Gallery images ensured visible:', galleryImages.length);
                }
            }
            
            console.log('âœ… Preview content visibility ensured');
        }
        
        // Add event delegation for theme card clicks (replaces inline onclick to avoid HTML entity issues)
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(e) {
                const themeCard = e.target.closest('.theme-card');
                if (themeCard) {
                    const templateId = themeCard.getAttribute('data-template-id');
                    const themeId = themeCard.getAttribute('data-theme');
                    if (templateId || themeId) {
                        selectTheme(themeId, templateId, themeCard);
                    }
                }
            });
            
            // Ensure preview content is visible after DOM loads
            setTimeout(ensurePreviewContentVisible, 500);
        });

        // Image preview functions - Must be global for inline onchange handlers
        window.previewImage = function(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                    preview.innerHTML = '<img src="' + e.target.result + '" alt="Preview">';
                preview.style.display = 'block';
                // Toggle form group background when image is selected
                if (typeof toggleFormGroupBackground === 'function') {
                    toggleFormGroupBackground();
                }
                    
                    // Update live preview based on image type
                    const inputId = input.id;
                    const imageSrc = e.target.result;
                    
                    if (inputId === 'mainImage') {
                        const mainImg = document.getElementById('previewMainImage');
                        const mainContainer = document.getElementById('previewMainImageContainer');
                        if (mainImg && mainContainer) {
                            mainImg.src = imageSrc;
                            mainImg.style.display = 'block';
                            mainImg.style.setProperty('display', 'block', 'important');
                            mainImg.style.visibility = 'visible';
                            mainImg.style.opacity = '1';
                            mainImg.style.width = '100%';
                            mainImg.style.maxHeight = '200px';
                            mainImg.style.objectFit = 'cover';
                            mainImg.style.borderRadius = '12px';
                            mainImg.style.marginBottom = '20px';
                            mainImg.style.border = '2px solid rgba(255, 255, 255, 0.9)';
                            mainImg.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
                            mainImg.style.zIndex = '15';
                            mainImg.style.position = 'relative';
                            mainImg.onerror = function() {
                                console.error('Error loading main image');
                                mainImg.style.display = 'none';
                            };
                            mainImg.onload = function() {
                                mainContainer.style.display = 'block';
                                mainContainer.style.setProperty('display', 'block', 'important');
                                mainContainer.style.visibility = 'visible';
                                mainContainer.style.opacity = '1';
                                mainContainer.style.zIndex = '15';
                                mainContainer.style.setProperty('z-index', '15', 'important');
                                // Hide icon when main image is shown
                                const previewIcon = document.getElementById('previewIcon');
                                if (previewIcon) {
                                    previewIcon.style.display = 'none';
                                }
                                console.log('Main image displayed in preview');
                            };
                            // Set z-index and display immediately
                            mainImg.style.zIndex = '15';
                            mainImg.style.setProperty('z-index', '15', 'important');
                            mainImg.style.position = 'relative';
                            mainImg.style.visibility = 'visible';
                            mainImg.style.opacity = '1';
                            mainSection.style.display = 'block';
                            mainSection.style.setProperty('display', 'block', 'important');
                            mainContainer.style.zIndex = '15';
                            mainContainer.style.setProperty('z-index', '15', 'important');
                            mainContainer.style.display = 'block';
                            mainContainer.style.setProperty('display', 'block', 'important');
                            mainContainer.style.visibility = 'visible';
                            mainContainer.style.opacity = '1';
                            mainImg.style.display = 'block';
                            mainImg.style.setProperty('display', 'block', 'important');
                            // Immediate display fallback
                            setTimeout(() => {
                                if (mainImg.src) {
                                    mainSection.style.display = 'block';
                                    mainSection.style.setProperty('display', 'block', 'important');
                                    mainContainer.style.display = 'block';
                                    mainContainer.style.setProperty('display', 'block', 'important');
                                    mainImg.style.display = 'block';
                                    mainImg.style.setProperty('display', 'block', 'important');
                                    mainImg.style.zIndex = '15';
                                    mainImg.style.setProperty('z-index', '15', 'important');
                                    mainImg.style.visibility = 'visible';
                                    mainImg.style.opacity = '1';
                                    mainContainer.style.zIndex = '15';
                                    mainContainer.style.setProperty('z-index', '15', 'important');
                                    mainContainer.style.visibility = 'visible';
                                    mainContainer.style.opacity = '1';
                                }
                            }, 100);
                        }
                    } else if (inputId === 'brideImage') {
                        const brideImg = document.getElementById('previewBrideImage');
                        const brideGroomContainer = document.getElementById('previewBrideGroomContainer');
                        if (brideImg && brideGroomContainer) {
                            brideImg.src = imageSrc;
                            brideImg.style.display = 'block';
                            brideImg.style.setProperty('display', 'block', 'important');
                            brideImg.style.zIndex = '15';
                            brideImg.style.setProperty('z-index', '15', 'important');
                            brideImg.style.position = 'relative';
                            brideImg.style.visibility = 'visible';
                            brideImg.style.opacity = '1';
                            brideGroomContainer.style.display = 'flex';
                            brideGroomContainer.style.setProperty('display', 'flex', 'important');
                            brideGroomContainer.style.zIndex = '15';
                            brideGroomContainer.style.setProperty('z-index', '15', 'important');
                            brideGroomContainer.style.visibility = 'visible';
                            brideGroomContainer.style.opacity = '1';
                            console.log('Bride image displayed in preview');
                        }
                    } else if (inputId === 'groomImage') {
                        const groomImg = document.getElementById('previewGroomImage');
                        const brideGroomContainer = document.getElementById('previewBrideGroomContainer');
                        if (groomImg && brideGroomContainer) {
                            groomImg.src = imageSrc;
                            groomImg.style.display = 'block';
                            groomImg.style.setProperty('display', 'block', 'important');
                            groomImg.style.zIndex = '15';
                            groomImg.style.setProperty('z-index', '15', 'important');
                            groomImg.style.position = 'relative';
                            groomImg.style.visibility = 'visible';
                            groomImg.style.opacity = '1';
                            brideGroomContainer.style.display = 'flex';
                            brideGroomContainer.style.setProperty('display', 'flex', 'important');
                            brideGroomContainer.style.zIndex = '15';
                            brideGroomContainer.style.setProperty('z-index', '15', 'important');
                            brideGroomContainer.style.visibility = 'visible';
                            brideGroomContainer.style.opacity = '1';
                            console.log('Groom image displayed in preview');
                        }
                    } else if (inputId === 'birthdayImage') {
                        const birthdayImg = document.getElementById('previewBirthdayImage');
                        const birthdayContainer = document.getElementById('previewBirthdayImageContainer');
                        if (birthdayImg && birthdayContainer) {
                            birthdayImg.src = imageSrc;
                            birthdayImg.style.display = 'block';
                            birthdayImg.style.setProperty('display', 'block', 'important');
                            birthdayImg.style.zIndex = '15';
                            birthdayImg.style.setProperty('z-index', '15', 'important');
                            birthdayImg.style.position = 'relative';
                            birthdayImg.style.visibility = 'visible';
                            birthdayImg.style.opacity = '1';
                            birthdayContainer.style.display = 'block';
                            birthdayContainer.style.setProperty('display', 'block', 'important');
                            birthdayContainer.style.zIndex = '15';
                            birthdayContainer.style.setProperty('z-index', '15', 'important');
                            birthdayContainer.style.visibility = 'visible';
                            birthdayContainer.style.opacity = '1';
                            console.log('Birthday image displayed in preview');
                        }
                    } else if (inputId === 'coupleImage') {
                        const coupleImg = document.getElementById('previewCoupleImage');
                        const coupleContainer = document.getElementById('previewCoupleImageContainer');
                        if (coupleImg && coupleContainer) {
                            coupleImg.src = imageSrc;
                            coupleImg.style.display = 'block';
                            coupleImg.style.setProperty('display', 'block', 'important');
                            coupleImg.style.zIndex = '15';
                            coupleImg.style.setProperty('z-index', '15', 'important');
                            coupleImg.style.position = 'relative';
                            coupleImg.style.visibility = 'visible';
                            coupleImg.style.opacity = '1';
                            coupleContainer.style.display = 'block';
                            coupleContainer.style.setProperty('display', 'block', 'important');
                            coupleContainer.style.zIndex = '15';
                            coupleContainer.style.setProperty('z-index', '15', 'important');
                            coupleContainer.style.visibility = 'visible';
                            coupleContainer.style.opacity = '1';
                            console.log('Couple image displayed in preview');
                        }
                    } else if (inputId === 'graduateImage') {
                        const graduateImg = document.getElementById('previewGraduateImage');
                        const graduateContainer = document.getElementById('previewGraduateImageContainer');
                        if (graduateImg && graduateContainer) {
                            graduateImg.src = imageSrc;
                            graduateImg.style.display = 'block';
                            graduateImg.style.setProperty('display', 'block', 'important');
                            graduateImg.style.zIndex = '15';
                            graduateImg.style.setProperty('z-index', '15', 'important');
                            graduateImg.style.position = 'relative';
                            graduateImg.style.visibility = 'visible';
                            graduateImg.style.opacity = '1';
                            graduateContainer.style.display = 'block';
                            graduateContainer.style.setProperty('display', 'block', 'important');
                            graduateContainer.style.zIndex = '15';
                            graduateContainer.style.setProperty('z-index', '15', 'important');
                            graduateContainer.style.visibility = 'visible';
                            graduateContainer.style.opacity = '1';
                            console.log('Graduate image displayed in preview');
                        }
                    } else if (inputId === 'honoreeImage') {
                        const honoreeImg = document.getElementById('previewHonoreeImage');
                        const honoreeContainer = document.getElementById('previewHonoreeImageContainer');
                        if (honoreeImg && honoreeContainer) {
                            honoreeImg.src = imageSrc;
                            honoreeImg.style.display = 'block';
                            honoreeImg.style.setProperty('display', 'block', 'important');
                            honoreeImg.style.zIndex = '15';
                            honoreeImg.style.setProperty('z-index', '15', 'important');
                            honoreeImg.style.position = 'relative';
                            honoreeImg.style.visibility = 'visible';
                            honoreeImg.style.opacity = '1';
                            honoreeContainer.style.display = 'block';
                            honoreeContainer.style.setProperty('display', 'block', 'important');
                            honoreeContainer.style.zIndex = '15';
                            honoreeContainer.style.setProperty('z-index', '15', 'important');
                            honoreeContainer.style.visibility = 'visible';
                            honoreeContainer.style.opacity = '1';
                            console.log('Honoree image displayed in preview');
                        }
                    }
                    
                    // After setting image, filter to show only event-specific images
                    const previewCard = document.getElementById('invitationPreviewCard');
                    const eventType = previewCard ? (previewCard.getAttribute('data-event-type') || '') : '';
                    if (eventType) {
                        setTimeout(() => {
                            showEventSpecificImages(eventType);
                        }, 100);
                    }
                };
                reader.readAsDataURL(input.files[0]);
                    } else {
                preview.innerHTML = '';
                preview.style.display = 'none';
                
                // Hide corresponding preview images
                const inputId = input.id;
                if (inputId === 'mainImage') {
                    document.getElementById('previewMainImageContainer').style.display = 'none';
                } else if (inputId === 'brideImage') {
                    document.getElementById('previewBrideImage').style.display = 'none';
                    if (!document.getElementById('previewGroomImage').style.display || 
                        document.getElementById('previewGroomImage').style.display === 'none') {
                        document.getElementById('previewBrideGroomContainer').style.display = 'none';
                    }
                } else if (inputId === 'groomImage') {
                    document.getElementById('previewGroomImage').style.display = 'none';
                    if (!document.getElementById('previewBrideImage').style.display || 
                        document.getElementById('previewBrideImage').style.display === 'none') {
                        document.getElementById('previewBrideGroomContainer').style.display = 'none';
                    }
                } else if (inputId === 'birthdayImage') {
                    document.getElementById('previewBirthdayImageContainer').style.display = 'none';
                } else if (inputId === 'coupleImage') {
                    document.getElementById('previewCoupleImageContainer').style.display = 'none';
                } else if (inputId === 'graduateImage') {
                    document.getElementById('previewGraduateImageContainer').style.display = 'none';
                } else if (inputId === 'honoreeImage') {
                    document.getElementById('previewHonoreeImageContainer').style.display = 'none';
                }
            }
        }

        function previewMultipleImages(input, previewId) {
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';
            
            if (input.files && input.files.length > 0) {
                Array.from(input.files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = 'Gallery Image ' + (index + 1);
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
                preview.style.display = 'grid';
                
                // Also update live preview gallery - show at end of template
                const previewGallerySection = document.getElementById('previewGallerySection');
                const previewGalleryGrid = document.getElementById('previewGalleryGrid');
                if (previewGalleryGrid) {
                    previewGalleryGrid.innerHTML = '';
                    Array.from(input.files).forEach((file) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.alt = 'Gallery Image';
                            img.style.width = '100%';
                            img.style.height = '180px';
                            img.style.objectFit = 'cover';
                            img.style.borderRadius = '10px';
                            img.style.border = '3px solid rgba(255, 255, 255, 0.9)';
                            img.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
                            img.style.cursor = 'pointer';
                            img.style.transition = 'transform 0.3s ease, box-shadow 0.3s ease';
                            img.style.display = 'block';
                            img.style.visibility = 'visible';
                            img.style.opacity = '1';
                            img.style.position = 'relative';
                            img.style.zIndex = '25';
                            img.style.background = '#ffffff';
                            // Add hover effect
                            img.onmouseenter = function() {
                                this.style.transform = 'scale(1.05)';
                                this.style.boxShadow = '0 6px 20px rgba(0,0,0,0.4)';
                            };
                            img.onmouseleave = function() {
                                this.style.transform = 'scale(1)';
                                this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
                            };
                            previewGalleryGrid.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    });
                }
                if (previewGallerySection) {
                    previewGallerySection.style.display = 'block';
                    previewGallerySection.style.setProperty('display', 'block', 'important');
                    previewGallerySection.style.visibility = 'visible';
                    previewGallerySection.style.opacity = '1';
                    previewGallerySection.style.zIndex = '20';
                    previewGallerySection.style.setProperty('z-index', '20', 'important');
                    previewGallerySection.style.position = 'relative';
                    console.log('âœ… Gallery section displayed from previewMultipleImages');
                }
                if (previewGalleryGrid) {
                    previewGalleryGrid.style.display = 'grid';
                    previewGalleryGrid.style.setProperty('display', 'grid', 'important');
                    previewGalleryGrid.style.visibility = 'visible';
                    previewGalleryGrid.style.opacity = '1';
                }
                    } else {
                preview.style.display = 'none';
                const previewGallerySection = document.getElementById('previewGallerySection');
                if (previewGallerySection) {
                    previewGallerySection.style.display = 'none';
                    previewGallerySection.style.setProperty('display', 'none', 'important');
                }
                    }
                }
    </script>
{% endblock %}


