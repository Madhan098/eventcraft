{% extends "base.html" %}

{% block title %}Create Invitation - EventCraft Pro{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* Progress Bar - Exact Match from Images */
    .progress-bar-container {
        max-width: 1000px;
        margin: 0 auto 40px;
        padding: 40px 20px 0;
        background: transparent !important;
    }

    .progress-bar {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        position: relative;
        width: 100%;
        padding: 0 20px;
        background: transparent !important;
    }

    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        position: relative;
        z-index: 1;
        margin-bottom: 0;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .progress-step:hover {
        transform: translateY(-3px);
    }
    
    .progress-step.clickable-step:hover .step-circle {
        transform: scale(1.1);
        transition: transform 0.3s ease;
    }
    
    .progress-step.pending {
        cursor: not-allowed;
        opacity: 1 !important;
    }
    
    .progress-step.pending:hover {
        transform: none;
    }

    /* Base connecting line - always visible */
    .progress-step::after {
        content: '';
        position: absolute;
        top: 20px;
        left: calc(50% + 20px);
        width: calc(100% - 40px);
        height: 4px;
        background: #E5E5E5 !important;
        z-index: 0;
        visibility: visible !important;
        opacity: 1 !important;
        display: block !important;
        transition: background 0.6s ease;
        transform-origin: left center;
    }

    .progress-step:last-child::after {
        display: none;
    }

    /* Colored line for completed steps */
    .progress-step.completed::after {
        background: linear-gradient(90deg, #6F4E37 0%, #D4AF37 100%) !important;
        animation: progressLinePulse 2s ease-in-out infinite;
        height: 4px !important;
    }

    /* Colored line for active step */
    .progress-step.active::after {
        background: linear-gradient(90deg, #6F4E37 0%, #D4AF37 100%) !important;
        animation: progressLinePulse 2s ease-in-out infinite 0.8s;
        height: 4px !important;
    }
    
    /* Ensure pending steps show gray line */
    .progress-step.pending::after {
        background: #CCCCCC !important;
        width: calc(100% - 40px) !important;
        height: 4px !important;
    }
    
    /* Progress line fill animation - animates from 0 to full width */
    @keyframes progressLineFill {
        0% {
            width: 0 !important;
            opacity: 0.3;
        }
        50% {
            opacity: 0.7;
        }
        100% {
            width: calc(100% - 40px) !important;
            opacity: 1;
        }
    }
    
    /* Subtle pulse animation for completed/active lines */
    @keyframes progressLinePulse {
        0%, 100% {
            opacity: 1;
            transform: scaleY(1);
        }
        50% {
            opacity: 0.85;
            transform: scaleY(1.15);
        }
    }
    
    /* Class to trigger line fill animation */
    .progress-step.animating-line::after {
        animation: progressLineFill 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    .progress-step.animating-line.completed::after {
        animation: progressLineFill 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards, progressLinePulse 2s ease-in-out infinite 0.8s;
    }
    
    .progress-step.animating-line.active::after {
        animation: progressLineFill 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards, progressLinePulse 2s ease-in-out infinite 0.8s;
    }

    .step-circle {
        width: 40px !important;
        height: 40px !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-weight: 700 !important;
        font-size: 16px !important;
        margin-bottom: 8px !important;
        position: relative !important;
        z-index: 2 !important;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1) !important;
        visibility: visible !important;
        opacity: 1 !important;
        border: 2px solid transparent !important;
        transform: scale(1) !important;
    }
    
    @media (max-width: 768px) {
        .step-circle {
            width: 32px !important;
            height: 32px !important;
            font-size: 14px !important;
        }
    }
    
    @media (max-width: 480px) {
        .step-circle {
            width: 28px !important;
            height: 28px !important;
            font-size: 12px !important;
        }
    }
    
    /* Pulse animation for active step */
    .progress-step.active .step-circle {
        animation: pulseActive 2s ease-in-out infinite;
    }
    
    @keyframes pulseActive {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 0 0 8px rgba(212, 175, 55, 0);
        }
    }

    .progress-step.completed .step-circle {
        background: var(--reddish-brown-dark) !important;
        color: #FFFFFF !important;
        border-color: var(--reddish-brown-dark) !important;
        animation: checkmarkAppear 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    }
    
    /* Checkmark animation */
    @keyframes checkmarkAppear {
        0% {
            transform: scale(0) rotate(-180deg);
            opacity: 0;
        }
        50% {
            transform: scale(1.2) rotate(10deg);
        }
        100% {
            transform: scale(1) rotate(0deg);
            opacity: 1;
        }
    }

    /* Active step appear animation */
    @keyframes activeStepAppear {
        0% {
            transform: scale(0.8);
            opacity: 0.7;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    .progress-step.active .step-circle {
        background: var(--golden-yellow) !important;
        color: var(--reddish-brown-dark) !important;
        border-color: var(--golden-yellow) !important;
        font-weight: 700 !important;
    }

    .progress-step.pending .step-circle {
        background: #FFFFFF !important;
        color: var(--reddish-brown-dark) !important;
        border: 2px solid var(--reddish-brown-dark) !important;
        font-weight: 700 !important;
        transition: all 0.4s ease;
    }
    
    /* Step transition animation */
    .progress-step {
        animation: stepFadeIn 0.5s ease forwards;
    }
    
    @keyframes stepFadeIn {
        0% {
            opacity: 0;
            transform: translateY(-10px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .step-label {
        font-size: 14px !important;
        font-weight: 500 !important;
        color: var(--reddish-brown-dark) !important;
        text-align: center !important;
        visibility: visible !important;
        opacity: 1 !important;
        display: block !important;
        margin-top: 4px !important;
    }
    
    @media (max-width: 768px) {
        .step-label {
            font-size: 11px !important;
            margin-top: 4px !important;
        }
    }
    
    @media (max-width: 480px) {
        .step-label {
            font-size: 10px !important;
            margin-top: 3px !important;
        }
    }

    .progress-step.active .step-label {
        color: var(--reddish-brown-dark) !important;
        font-weight: 600 !important;
    }

    .progress-step.completed .step-label {
        color: var(--reddish-brown-dark) !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .progress-step.pending .step-label {
        color: var(--reddish-brown-dark) !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* Page Container - Professional & Mobile Responsive */
    .create-page-container {
        max-width: 1400px !important;
        margin: 0 auto !important;
        padding: 40px 20px 60px !important;
        background: linear-gradient(180deg, #FFF5F0 0%, #FFFFFF 50%, #F8F9FA 100%) !important;
        min-height: 100vh !important;
        width: 100% !important;
        overflow-x: hidden !important;
        box-sizing: border-box !important;
    }
    
    @media (max-width: 768px) {
        .create-page-container {
            padding: 20px 15px 40px !important;
        }
    }
    
    @media (max-width: 480px) {
        .create-page-container {
            padding: 15px 10px 30px !important;
        }
    }
    
    /* Smooth page transitions */
    .theme-selection-page,
    .details-form-page {
        animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Page Title */
    .page-title {
        text-align: center;
        margin-bottom: 48px;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
        padding: 0 20px;
    }

    .page-title h1 {
        font-size: 42px;
        font-weight: 700;
        margin-bottom: 12px;
        line-height: 1.2;
        letter-spacing: -0.02em;
        visibility: visible !important;
        opacity: 1 !important;
        display: block !important;
    }

    .page-title h1 .title-normal {
        color: var(--reddish-brown-dark) !important;
        visibility: visible !important;
        opacity: 1 !important;
        display: inline-block !important;
        -webkit-text-fill-color: var(--reddish-brown-dark) !important;
        background: none !important;
        -webkit-background-clip: unset !important;
        background-clip: unset !important;
    }

    .page-title h1 .title-gradient {
        color: var(--reddish-brown-dark) !important;
        visibility: visible !important;
        opacity: 1 !important;
        display: inline-block !important;
        -webkit-text-fill-color: var(--reddish-brown-dark) !important;
        background: none !important;
        -webkit-background-clip: unset !important;
        background-clip: unset !important;
    }

    /* Gradient text effect - only applies when supported, with fallback */
    @supports (-webkit-background-clip: text) or (background-clip: text) {
    .page-title h1 .title-gradient {
        background: linear-gradient(135deg, var(--reddish-brown-dark) 0%, var(--golden-yellow) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
            color: var(--reddish-brown-dark); /* Fallback */
        }
    }

    .page-title p {
        font-size: 16px !important;
        color: var(--reddish-brown-dark) !important;
        font-weight: 400 !important;
        visibility: visible !important;
        opacity: 1 !important;
        display: block !important;
    }

    /* Theme Selection Page */
    .theme-selection-page {
        display: none;
    }

    .theme-selection-page.active {
        display: block;
    }

    .theme-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 24px;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px 40px;
        min-height: 400px;
    }

    .theme-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        border: 2px solid transparent;
        display: flex;
        flex-direction: column;
    }

    .theme-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(160, 120, 120, 0.15);
        border-color: rgba(160, 120, 120, 0.2);
    }

    .theme-card.selected {
        border-color: var(--reddish-brown-dark);
        box-shadow: 0 8px 24px rgba(160, 120, 120, 0.25);
        transform: translateY(-2px);
    }

    .theme-card.selected:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(160, 120, 120, 0.3);
    }

    .theme-card.selected::after {
        content: 'âœ“';
        position: absolute;
        top: 10px;
        right: 10px;
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, var(--reddish-brown-dark) 0%, var(--golden-yellow) 100%);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
        z-index: 10;
        box-shadow: 0 4px 12px rgba(160, 120, 120, 0.4);
        animation: scaleIn 0.2s ease;
    }

    @keyframes scaleIn {
        from {
            transform: scale(0);
        }
        to {
            transform: scale(1);
        }
    }

    .theme-image {
        width: 100%;
        height: 240px;
        object-fit: cover;
        display: block;
        transition: transform 0.3s ease;
    }

    .theme-card:hover .theme-image {
        transform: scale(1.05);
    }

    .theme-title {
        padding: 16px 20px;
        text-align: center;
        font-size: 16px;
        font-weight: 600;
        color: var(--text-dark);
        background: #FAFAFA;
        border-top: 1px solid #F0F0F0;
    }

    .theme-card.selected .theme-title {
        background: rgba(160, 120, 120, 0.05);
        color: var(--reddish-brown-dark);
        font-weight: 700;
    }

    /* Details Form with Live Preview */
    .details-form-page {
        display: none;
    }

    .details-form-page.active {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Ensure preview is always visible when details page is active */
    .details-form-page.active .live-preview-card,
    .details-form-page.active .preview-content,
    .details-form-page.active .invitation-preview {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* Two-Column Editor Layout - Equal Heights & Widths */
    .editor-container {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 0 !important;
        height: 100vh !important; /* Changed to use full viewport height */
        min-height: 100vh !important; /* Changed to use full viewport height */
        max-width: 100vw !important;
        width: 100vw !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: visible !important;
        background: #f5f5f5 !important;
        position: relative !important;
        box-sizing: border-box !important;
        align-items: stretch !important; /* Ensure both columns have same height */
    }
    
    /* Force preview section to be visible and scrollable - ENHANCED FOR CLARITY */
    .editor-preview-section {
        display: flex !important;
        flex-direction: column !important;
        visibility: visible !important;
        opacity: 1 !important;
        height: 100% !important;
        min-height: 100% !important;
        max-height: none !important; /* Changed from calc(100vh - 100px) to allow full content */
        overflow-y: auto !important;
        overflow-x: visible !important; /* Changed from hidden to visible */
        position: relative !important;
        background: #f8f9fa !important;
        padding: 10px !important; /* Reduced from 20px for more space */
        /* Ensure preview is clear and visible at all zoom levels */
        transform-origin: top center !important;
        -webkit-transform-origin: top center !important;
        /* Smooth scaling on zoom */
        transition: transform 0.1s ease !important;
        /* Ensure content is never cut off */
        clip: none !important;
        clip-path: none !important;
    }
    
    /* Left Sidebar - Hidden */
    .editor-sidebar {
        display: none !important;
        visibility: hidden !important;
    }
    
    .sidebar-tabs {
        display: flex;
        flex-direction: column;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sidebar-tab {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .sidebar-tab:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }
    
    .sidebar-tab.active {
        background: rgba(255, 255, 255, 0.15);
        border-left-color: #667eea;
        color: white;
    }
    
    .sidebar-tab i {
        width: 24px;
        margin-right: 12px;
        font-size: 18px;
    }
    
    .sidebar-tab span {
        font-size: 14px;
        font-weight: 500;
    }
    
    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }
    
    .sidebar-panel {
        display: none !important;
    }
    
    .sidebar-panel.active {
        display: block !important;
    }
    
    /* Center - Form Section - Equal Height with Preview */
    .editor-form-section {
        background: #ffffff !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        padding: 30px !important;
        border-right: 1px solid #e0e0e0 !important;
        height: 100% !important;
        min-height: 100% !important;
        max-height: 100% !important;
        box-sizing: border-box !important;
        display: flex !important;
        flex-direction: column !important;
        position: relative !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .form-preview-container {
        display: block;
        max-width: 100%;
        margin: 0;
        padding: 0;
        animation: fadeIn 0.6s ease-out 0.3s both;
    }

    /* Form Section - White background for readability */
    .form-section-card {
        background: rgba(255, 255, 255, 0.95) !important;
        backdrop-filter: blur(10px) !important;
        -webkit-backdrop-filter: blur(10px) !important;
        border-radius: 20px;
        padding: 32px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(240, 240, 240, 0.8);
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
        letter-spacing: -0.01em;
    }

    .form-label.required::after {
        content: ' *';
        color: var(--reddish-brown-dark);
    }

    .form-input,
    .form-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1.5px solid #E5E5E5;
        border-radius: 10px;
        font-size: 15px;
        transition: all 0.2s ease;
        font-family: 'Inter', sans-serif;
        background: rgba(255, 255, 255, 0.9) !important;
        backdrop-filter: blur(5px) !important;
        -webkit-backdrop-filter: blur(5px) !important;
    }

    .form-input:hover,
    .form-textarea:hover {
        border-color: rgba(160, 120, 120, 0.3);
        background: rgba(255, 255, 255, 1) !important;
    }

    .form-input:focus,
    .form-textarea:focus {
        outline: none;
        border-color: var(--reddish-brown-dark);
        background: rgba(255, 255, 255, 1) !important;
        box-shadow: 0 0 0 3px rgba(160, 120, 120, 0.08);
    }
    
    /* White background when input has value */
    .form-input:not(:placeholder-shown),
    .form-textarea:not(:placeholder-shown) {
        background: rgba(255, 255, 255, 1) !important;
    }
    
    /* Form group with content gets white background */
    .form-group.has-content {
        background: rgba(255, 255, 255, 0.7) !important;
        backdrop-filter: blur(5px) !important;
        -webkit-backdrop-filter: blur(5px) !important;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 16px;
    }

    .form-textarea {
        resize: vertical;
        min-height: 120px;
    }

    .input-with-icon {
        position: relative;
    }

    .input-with-icon i {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-gray);
        pointer-events: none;
    }

    /* Right - Live Preview Section - SCROLLABLE FOR CLEAR VIEW */
    .editor-preview-section {
        background: #f8f9fa !important;
        overflow-y: auto !important;
        overflow-x: visible !important; /* Changed from hidden to visible */
        padding: 10px !important; /* Reduced from 20px for more space */
        display: flex !important;
        flex-direction: column !important;
        position: relative !important;
        height: 100% !important;
        min-height: 100% !important;
        max-height: none !important; /* Changed from calc(100vh - 100px) to allow full content */
        box-sizing: border-box !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: 100% !important;
        flex: 1 1 auto !important; /* Equal width with form section */
        z-index: 1 !important; /* Ensure it's above other elements */
        /* Smooth scrolling */
        scroll-behavior: smooth !important;
        /* Ensure content is never cut off */
        clip: none !important;
        clip-path: none !important;
    }
    
    /* Custom scrollbar for preview section */
    .editor-preview-section::-webkit-scrollbar {
        width: 12px;
    }
    
    .editor-preview-section::-webkit-scrollbar-track {
        background: #f5f5f5;
        border-radius: 10px;
    }
    
    .editor-preview-section::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 10px;
        border: 2px solid #f5f5f5;
    }
    
    .editor-preview-section::-webkit-scrollbar-thumb:hover {
        background: #5568d3;
    }
    
    /* Ensure preview is fully visible and clear - ENHANCED FOR ZOOM CLARITY */
    .editor-preview-section .live-preview-card {
        min-height: auto !important;
        height: auto !important;
        max-height: none !important;
        overflow-y: visible !important;
        overflow-x: visible !important;
        display: flex !important;
        flex-direction: column !important;
        visibility: visible !important;
        opacity: 1 !important;
        background: #ffffff !important;
        border-radius: 16px !important;
        padding: 20px !important; /* Increased from 15px for better visibility at 100% zoom */
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
        margin-bottom: 10px !important; /* Reduced margin */
        width: 100% !important;
        position: relative !important;
        z-index: 10 !important;
        margin-top: 5px !important; /* Reduced margin */
        /* Enhanced visibility and clarity */
        border: 2px solid rgba(111, 78, 55, 0.15) !important;
        /* Ensure content scales properly on zoom */
        transform-origin: top center !important;
        -webkit-transform-origin: top center !important;
        /* Better contrast for readability */
        color: #2c3e50 !important;
    }
    
    .editor-preview-section .invitation-preview {
        min-height: auto !important;
        height: auto !important;
        max-height: none !important;
        display: flex !important;
        flex-direction: column !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: 100% !important;
        position: relative !important;
        overflow: visible !important;
        /* Enhanced clarity and zoom support */
        transform-origin: top center !important;
        -webkit-transform-origin: top center !important;
        /* Ensure text is readable at all zoom levels */
        -webkit-font-smoothing: antialiased !important;
        -moz-osx-font-smoothing: grayscale !important;
        text-rendering: optimizeLegibility !important;
        /* Better contrast */
        background: transparent !important;
    }
    
    .editor-preview-section .preview-content {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: 100% !important;
        position: relative !important;
        /* Enhanced clarity for zoom */
        transform-origin: top center !important;
        -webkit-transform-origin: top center !important;
        /* Ensure all content is visible */
        overflow: visible !important;
        min-height: auto !important;
        height: auto !important;
    }
    
    .preview-header {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        margin-bottom: 20px !important;
        padding-bottom: 15px !important;
        border-bottom: 2px solid #e0e0e0 !important;
        visibility: visible !important;
        opacity: 1 !important;
        background: white !important;
        padding: 15px 20px !important;
        border-radius: 8px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    }
    
    .preview-title {
        font-size: 18px;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
    }
    
    .view-toggle-buttons {
        display: flex;
        gap: 10px;
    }
    
    .view-toggle-btn {
        padding: 8px 16px;
        border: 2px solid #667eea;
        background: white;
        color: #667eea;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .view-toggle-btn:hover {
        background: #667eea;
        color: white;
    }
    
    .view-toggle-btn.active {
        background: #667eea;
        color: white;
    }
    
    /* Live Preview Card */
    .live-preview-card {
        background: rgba(255, 255, 255, 0.98) !important;
        backdrop-filter: blur(10px) !important;
        -webkit-backdrop-filter: blur(10px) !important;
        border-radius: 16px;
        padding: 15px !important; /* Reduced from 24px for more content space */
        display: flex !important;
        flex-direction: column;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important;
        border: 2px solid rgba(111, 78, 55, 0.2) !important;
        height: auto !important;
        max-height: none !important;
        overflow-y: visible !important;
        overflow-x: visible !important;
        z-index: 10;
        visibility: visible !important;
        opacity: 1 !important;
        margin-bottom: 10px !important; /* Reduced margin */
    }
    
    /* Desktop View - ENHANCED VISIBILITY - FULLY VISIBLE - FILLS ENTIRE PREVIEW */
    .preview-desktop-view {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: 100% !important;
        max-width: 100% !important;
        height: auto !important;
        min-height: 100% !important;
        overflow: visible !important;
        position: relative !important;
    }
    
    .preview-desktop-view .invitation-preview {
        max-width: 100% !important;
        width: 100% !important;
        margin: 0 auto !important;
        min-height: auto !important;
        height: auto !important; /* Ensure height fits content */
        max-height: none !important; /* Remove max-height to prevent cutting */
        display: flex !important;
        flex-direction: column !important;
        visibility: visible !important;
        opacity: 1 !important;
        overflow: visible !important;
        position: relative !important;
        padding: 25px !important; /* Increased from 20px for better visibility at 100% zoom */
        /* Enhanced clarity and zoom support */
        transform-origin: top center !important;
        -webkit-transform-origin: top center !important;
        /* Better text rendering at all zoom levels */
        -webkit-font-smoothing: antialiased !important;
        -moz-osx-font-smoothing: grayscale !important;
        text-rendering: optimizeLegibility !important;
        /* Ensure content is always visible */
        zoom: 1 !important;
        -webkit-text-size-adjust: 100% !important;
        -moz-text-size-adjust: 100% !important;
        text-size-adjust: 100% !important;
        /* Ensure content is never cut off */
        clip: none !important;
        clip-path: none !important;
    }
    
    .preview-desktop-view .live-preview-card {
        width: 100% !important;
        max-width: 100% !important;
        height: auto !important;
        min-height: auto !important;
    }
    
    .preview-desktop-view .preview-content {
        width: 100% !important;
        max-width: 100% !important;
        height: auto !important;
    }
    
    /* Mobile View - ENHANCED VISIBILITY - PROPER MOBILE DISPLAY */
    .preview-mobile-view {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
        height: auto !important;
        overflow: visible !important;
        position: relative !important;
    }
    
    .preview-mobile-view.active {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: 100% !important;
        max-width: 100% !important;
        height: auto !important;
        overflow: visible !important;
        position: relative !important;
    }
    
    .preview-mobile-view .invitation-preview {
        max-width: 400px !important;
        width: 100% !important;
        margin: 0 auto !important;
        min-height: auto !important;
        display: flex !important;
        flex-direction: column !important;
        visibility: visible !important;
        opacity: 1 !important;
        transform: scale(0.85) !important;
        transform-origin: top center !important;
        padding: 15px !important;
        position: relative !important;
        z-index: 10 !important;
    }
    
    .preview-mobile-view .live-preview-card {
        width: 100% !important;
        max-width: 100% !important;
        height: auto !important;
        min-height: auto !important;
        padding: 20px !important;
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 10 !important;
    }
    
    .preview-mobile-view .preview-content {
        width: 100% !important;
        max-width: 100% !important;
        height: auto !important;
    }
    
    .preview-desktop-view.hidden {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }

    .preview-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-dark) !important;
        margin-bottom: 24px;
        text-align: center;
        padding-bottom: 16px;
        border-bottom: 2px solid rgba(111, 78, 55, 0.3);
        letter-spacing: -0.02em;
        visibility: visible !important;
        opacity: 1 !important;
        background: rgba(255, 255, 255, 0.9);
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .preview-content {
        text-align: center;
        min-height: auto !important;
        height: auto !important;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        padding: 15px !important; /* Increased from 10px for better visibility at 100% zoom */
        position: relative;
        z-index: 10 !important;
        overflow-y: visible !important;
        overflow-x: visible !important;
        max-height: none !important;
        padding-right: 10px !important; /* Increased from 5px */
        background: transparent !important;
        border-radius: 12px;
        /* Enhanced clarity and zoom support */
        transform-origin: top center !important;
        -webkit-transform-origin: top center !important;
        /* Better text rendering */
        -webkit-font-smoothing: antialiased !important;
        -moz-osx-font-smoothing: grayscale !important;
        text-rendering: optimizeLegibility !important;
        /* Ensure content scales properly */
        zoom: 1 !important;
    }
    
    /* Remove white background when template is active so template shows through */
    .invitation-preview.template-bg .preview-content,
    .invitation-preview.wedding-bg .preview-content {
        background: transparent !important;
        max-height: none !important;
        height: auto !important;
        overflow: visible !important;
    }
    
    /* Ensure preview is visible even on theme selection page - CRITICAL */
    .theme-selection-page.active ~ .details-form-page .live-preview-card,
    .theme-selection-page.active .live-preview-card,
    .live-preview-card {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* CRITICAL: Make preview visible on theme selection page too */
    .theme-selection-page.active + .details-form-page .live-preview-card,
    .details-form-page .live-preview-card {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Ensure preview content is always visible */
    .preview-content {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Ensure invitation preview card is always visible */
    #invitationPreviewCard {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        min-height: auto !important;
        height: auto !important;
        width: 100% !important;
        background-size: 100% 100% !important;
        background-position: center center !important;
        position: relative !important;
    }
    
    /* CRITICAL: Ensure template background is visible - override any conflicting styles */
    .invitation-preview.template-bg {
        background-image: var(--template-bg-image-url, none) !important;
        background-size: 100% 100% !important;
        background-position: center center !important;
        background-repeat: no-repeat !important;
        background-attachment: scroll !important;
        background-color: transparent !important;
        height: auto !important;
        min-height: auto !important;
    }
    
    /* CRITICAL: Inline styles should always win */
    .invitation-preview.template-bg[style*="background-image"] {
        background-size: 100% 100% !important;
        background-position: center center !important;
        background-repeat: no-repeat !important;
        background-attachment: scroll !important;
        background-color: transparent !important;
        height: auto !important;
        min-height: auto !important;
    }

    .invitation-preview {
        width: 100%;
        max-width: 100% !important; /* Changed from 500px to 100% for larger preview */
        margin: 0 auto;
        /* Empty by default - no background until template is selected */
        background: #ffffff;
        background-size: cover !important;
        background-position: center center !important;
        background-repeat: no-repeat !important;
        background-attachment: local !important;
        border-radius: 16px;
        padding: 30px 25px !important; /* Increased padding for better visibility at 100% zoom */
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        border: 2px solid rgba(160, 120, 120, 0.1);
        position: relative;
        min-height: auto;
        height: auto;
        max-height: none !important; /* Ensure no height restriction */
        width: 100%;
        display: flex !important;
        flex-direction: column;
        justify-content: flex-start;
        overflow: visible !important; /* Ensure overflow is visible */
        /* Ensure template background is visible */
        z-index: 0;
        visibility: visible !important;
        opacity: 1 !important;
        /* Enhanced clarity and zoom support */
        transform-origin: top center !important;
        -webkit-transform-origin: top center !important;
        /* Better text rendering at all zoom levels */
        -webkit-font-smoothing: antialiased !important;
        -moz-osx-font-smoothing: grayscale !important;
        text-rendering: optimizeLegibility !important;
        /* Ensure content scales properly */
        zoom: 1 !important;
        /* Ensure content is never cut off */
        clip: none !important;
        clip-path: none !important;
    }

    /* Template background - CRITICAL: Override the background shorthand from .invitation-preview */
    .invitation-preview.template-bg {
        /* CRITICAL: Use CSS variable for background-image - JavaScript will set this */
        background-image: var(--template-bg-image-url, none) !important;
        background-color: transparent !important;
        background-size: 100% 100% !important;
        background-position: center center !important;
        background-repeat: no-repeat !important;
        background-attachment: scroll !important;
        background-clip: border-box !important;
        position: relative;
        z-index: 0;
        min-height: auto !important;
        height: auto !important;
        width: 100% !important;
        /* Ensure background covers entire card including padding */
        background-origin: padding-box !important;
        /* DO NOT use background shorthand here - it will override background-image */
    }
    
    /* Ensure inline background-image is visible - this selector has higher specificity */
    .invitation-preview.template-bg[style*="background-image"] {
        /* Inline styles should override, but ensure supporting properties are set */
        background-size: 100% 100% !important;
        background-position: center center !important;
        background-repeat: no-repeat !important;
        background-attachment: scroll !important;
        background-clip: border-box !important;
        background-origin: padding-box !important;
        height: auto !important;
        min-height: auto !important;
        width: 100% !important;
        /* Don't set background-image here - let inline style handle it */
    }

    /* Template background - Remove default gradient and show template design */
    .invitation-preview.wedding-bg {
        background-image: url('/images/templatesimages/wedding.png') !important;
        background-size: cover !important;
        background-position: center !important;
        background-repeat: no-repeat !important;
        background-color: transparent !important;
        position: relative;
    }
    
    /* Duplicate rule removed - handled by the rule above */
    
    /* Ensure template background image is visible when set via inline style */
    .invitation-preview.template-bg[style*="background-image"] {
        /* Inline styles have highest priority, so this should work */
        background-size: cover !important;
        background-position: center !important;
        background-repeat: no-repeat !important;
    }
    
    .invitation-preview.wedding-bg {
        background-image: url('/images/templatesimages/wedding.png') !important;
        background-size: cover !important;
        background-position: center !important;
        background-repeat: no-repeat !important;
    }
    
    /* Template image overlay - DISABLED - template image is applied directly as background-image */
    .invitation-preview.template-bg::after {
        display: none !important;
    }
    
    /* Decorative overlay removed - image.png file was deleted */
    /* .invitation-preview.wedding-bg::after and .invitation-preview:not(.template-bg):not(.wedding-bg)::after 
       have been removed since image.png no longer exists */

    /* Default gradient background - only shows when no template is selected */
    .invitation-preview::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #FFF5F0 0%, #FFFFFF 100%);
        z-index: 0;
        pointer-events: none;
        border-radius: 16px;
    }

    /* Remove default gradient background when template is active (template design shows instead) */
    .invitation-preview.wedding-bg::before,
    .invitation-preview.template-bg::before {
        display: none !important;
    }
    
    /* CRITICAL: Ensure template-bg background image is not overridden by ::before */
    .invitation-preview.template-bg::before {
        display: none !important;
        content: none !important;
        background: none !important;
        background-image: none !important;
    }
    
    /* Make Templates Look Like Real Designs - Not Just Backgrounds */
    .invitation-preview.template-bg {
        background-size: 100% 100% !important;
        background-position: center center !important;
        background-repeat: no-repeat !important;
        background-attachment: scroll !important;
        position: relative !important;
        overflow: visible !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important;
        border-radius: 16px !important;
        padding: 0 !important;
        margin: 0 !important;
    }
    
    /* Add subtle depth effect to make it look like a real printed invitation */
    .invitation-preview.template-bg::after {
        content: '' !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, rgba(0,0,0,0.02) 50%, rgba(255,255,255,0.02) 100%) !important;
        pointer-events: none !important;
        z-index: 1 !important;
        display: block !important;
        border-radius: 16px !important;
        box-shadow: inset 0 0 50px rgba(0,0,0,0.05) !important;
    }
    
    /* Ensure template background blends naturally and looks real */
    .invitation-preview.template-bg {
        mix-blend-mode: normal !important;
        filter: brightness(1) contrast(1.02) saturate(1.01) !important;
    }
    
    /* Content should be above template background */
    .invitation-preview.template-bg > * {
        position: relative !important;
        z-index: 10 !important;
    }

    /* Ensure all preview content is above background and overlay */
    /* User-uploaded images should be above background but below text */
    #previewMainImageContainer,
    #previewBrideGroomContainer,
    #previewBirthdayImageContainer,
    #previewCoupleImageContainer,
    #previewGraduateImageContainer,
    #previewHonoreeImageContainer {
        position: relative !important;
        z-index: 15 !important;
        margin: 10px 0;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: 100% !important;
    }
    
    /* All text content should be above the overlay AND uploaded images */
    /* Note: .preview-content styles are defined above */
    
    /* Scrollbar styling for preview content */
    .preview-content::-webkit-scrollbar {
        width: 8px;
    }
    
    .preview-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .preview-content::-webkit-scrollbar-thumb {
        background: #6F4E37;
        border-radius: 10px;
    }
    
    .preview-content::-webkit-scrollbar-thumb:hover {
        background: #5a3d2a;
    }
    
    /* Enhanced preview text clarity for all zoom levels - ENSURE CLEAR VISIBILITY */
    .preview-event-name,
    .preview-date-time,
    .preview-venue,
    .preview-hosted,
    .preview-message,
    .preview-icon,
    .preview-bride-groom,
    .preview-birthday-person,
    .preview-couple-names,
    .preview-mother-father,
    .preview-graduate {
        position: relative;
        z-index: 15 !important;
        /* Ensure text is always visible */
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        /* Enhanced clarity and zoom support */
        transform-origin: center center !important;
        -webkit-transform-origin: center center !important;
        /* Better text rendering at all zoom levels */
        -webkit-font-smoothing: antialiased !important;
        -moz-osx-font-smoothing: grayscale !important;
        text-rendering: optimizeLegibility !important;
        /* Ensure text scales properly on zoom */
        -webkit-text-size-adjust: 100% !important;
        -moz-text-size-adjust: 100% !important;
        text-size-adjust: 100% !important;
    }
    
    /* Uploaded images themselves should have high z-index */
    #previewMainImage,
    #previewBrideImage,
    #previewGroomImage,
    #previewBirthdayImage,
    #previewCoupleImage,
    #previewGraduateImage,
    #previewHonoreeImage {
        position: relative !important;
        z-index: 15 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: 100% !important;
        max-width: 100% !important;
        height: auto !important;
        object-fit: cover !important;
    }
    
    /* Ensure all preview content is above background */
    .invitation-preview > * {
        position: relative;
        z-index: 10;
    }

    .preview-icon {
        font-size: 64px;
        margin-bottom: 20px;
        display: none !important; /* Hidden by default - only show when no template background or when needed */
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        visibility: hidden;
        opacity: 0;
    }
    
    /* Only show icon when there's no template background */
    .invitation-preview:not(.template-bg):not(.wedding-bg) .preview-icon {
        display: block !important;
        visibility: visible;
        opacity: 1;
    }

    .preview-event-name {
        font-size: 32px !important; /* Increased from 28px for better visibility at 100% zoom */
        font-weight: 700;
        color: var(--reddish-brown-dark);
        margin-bottom: 20px;
        font-family: 'Playfair Display', serif;
        display: block !important;
        visibility: visible !important;
        opacity: 1;
        line-height: 1.2;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        background: transparent !important;
        padding: 0 !important;
        border-radius: 0 !important;
        /* Enhanced clarity for zoom */
        -webkit-font-smoothing: antialiased !important;
        -moz-osx-font-smoothing: grayscale !important;
        text-rendering: optimizeLegibility !important;
        /* Ensure text scales properly */
        -webkit-text-size-adjust: 100% !important;
        -moz-text-size-adjust: 100% !important;
        text-size-adjust: 100% !important;
    }

    /* Adaptive Text Overlay - Based on Template Background */
    .invitation-preview.template-bg .preview-event-name {
        position: relative;
        z-index: 20 !important;
        color: #fff !important;
        background: rgba(0, 0, 0, 0.6) !important;
        backdrop-filter: blur(8px) !important;
        -webkit-backdrop-filter: blur(8px) !important;
        padding: 16px 24px !important;
        border-radius: 12px !important;
        text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.9) !important;
        display: inline-block !important;
        margin: 0 auto 20px auto !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
    }
    
    .invitation-preview.wedding-bg .preview-event-name {
        color: #fff !important;
        background: rgba(0, 0, 0, 0.5) !important;
        backdrop-filter: blur(4px) !important;
        -webkit-backdrop-filter: blur(4px) !important;
        padding: 12px 20px !important;
        border-radius: 8px !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7) !important;
        display: inline-block !important;
        margin: 0 auto 20px auto !important;
    }
    
    /* Text Overlay for All Text Elements on Templates */
    .invitation-preview.template-bg .preview-date-time,
    .invitation-preview.template-bg .preview-venue,
    .invitation-preview.template-bg .preview-hosted,
    .invitation-preview.template-bg .preview-message {
        position: relative;
        z-index: 20 !important;
        background: rgba(0, 0, 0, 0.5) !important;
        backdrop-filter: blur(6px) !important;
        -webkit-backdrop-filter: blur(6px) !important;
        padding: 10px 16px !important;
        border-radius: 8px !important;
        color: #fff !important;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8) !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3) !important;
        border: 1px solid rgba(255, 255, 255, 0.15) !important;
        margin: 8px 0 !important;
    }

    .preview-date-time {
        font-size: 18px !important; /* Increased from 16px for better visibility at 100% zoom */
        color: var(--text-gray) !important;
        margin-bottom: 12px;
        display: flex !important;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        background: transparent !important;
        padding: 0 !important;
        border-radius: 0 !important;
        visibility: visible !important;
        opacity: 1 !important;
        font-weight: 600 !important; /* Added for better readability */
    }

    .invitation-preview.wedding-bg .preview-date-time,
    .invitation-preview.template-bg .preview-date-time {
        color: #fff !important;
        background: rgba(0, 0, 0, 0.5) !important;
        backdrop-filter: blur(4px) !important;
        -webkit-backdrop-filter: blur(4px) !important;
        padding: 8px 16px !important;
        border-radius: 6px !important;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7) !important;
        display: inline-flex !important;
        margin: 0 auto 12px auto !important;
    }

    .preview-venue {
        font-size: 18px !important; /* Increased from 16px for better visibility at 100% zoom */
        color: var(--text-gray) !important;
        margin-bottom: 12px;
        display: flex !important;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-align: center;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        background: transparent !important;
        padding: 0 !important;
        border-radius: 0 !important;
        visibility: visible !important;
        opacity: 1 !important;
        font-weight: 600 !important; /* Added for better readability */
    }

    .invitation-preview.wedding-bg .preview-venue,
    .invitation-preview.template-bg .preview-venue {
        color: #fff !important;
        background: rgba(0, 0, 0, 0.5) !important;
        backdrop-filter: blur(4px) !important;
        -webkit-backdrop-filter: blur(4px) !important;
        padding: 8px 16px !important;
        border-radius: 6px !important;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7) !important;
        display: inline-flex !important;
        margin: 0 auto 12px auto !important;
    }

    .preview-hosted {
        font-size: 16px !important; /* Increased from 14px for better visibility at 100% zoom */
        color: var(--text-gray) !important;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(160, 120, 120, 0.2);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        background: transparent !important;
        padding: 20px 0 0 0 !important;
        border-radius: 0 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        font-weight: 600 !important; /* Added for better readability */
    }

    .invitation-preview.wedding-bg .preview-hosted,
    .invitation-preview.template-bg .preview-hosted {
        color: #fff !important;
        background: rgba(0, 0, 0, 0.5) !important;
        backdrop-filter: blur(4px) !important;
        -webkit-backdrop-filter: blur(4px) !important;
        padding: 12px 16px !important;
        border-radius: 6px !important;
        border-top: 1px solid rgba(255, 255, 255, 0.3) !important;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7) !important;
        display: inline-block !important;
        margin: 20px auto 0 auto !important;
    }

    .preview-message {
        font-size: 17px !important; /* Increased from 15px for better visibility at 100% zoom */
        color: var(--text-dark) !important;
        line-height: 1.6;
        margin-top: 20px;
        font-style: italic;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        background: transparent !important;
        padding: 0 !important;
        border-radius: 0 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        font-weight: 500 !important; /* Added for better readability */
    }

    .invitation-preview.wedding-bg .preview-message,
    .invitation-preview.template-bg .preview-message {
        color: #fff !important;
        background: rgba(0, 0, 0, 0.5) !important;
        backdrop-filter: blur(4px) !important;
        -webkit-backdrop-filter: blur(4px) !important;
        padding: 12px 16px !important;
        border-radius: 6px !important;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7) !important;
        display: inline-block !important;
        margin: 20px auto 0 auto !important;
    }
    
    /* Event-Specific Preview Fields */
    .preview-bride-groom,
    .preview-birthday-person,
    .preview-couple-names,
    .preview-mother-father,
    .preview-graduate {
        font-size: 22px !important; /* Increased from 20px for better visibility at 100% zoom */
        font-weight: 600;
        color: var(--reddish-brown-dark);
        margin-bottom: 15px;
        text-align: center;
        text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.8);
        background: transparent !important;
        padding: 0 !important;
        border-radius: 0 !important;
        display: block;
        position: relative;
        z-index: 10 !important;
    }
    
    .invitation-preview.wedding-bg .preview-bride-groom,
    .invitation-preview.template-bg .preview-bride-groom,
    .invitation-preview.wedding-bg .preview-birthday-person,
    .invitation-preview.template-bg .preview-birthday-person,
    .invitation-preview.wedding-bg .preview-couple-names,
    .invitation-preview.template-bg .preview-couple-names,
    .invitation-preview.wedding-bg .preview-mother-father,
    .invitation-preview.template-bg .preview-mother-father,
    .invitation-preview.wedding-bg .preview-graduate,
    .invitation-preview.template-bg .preview-graduate {
        color: #fff !important;
        background: rgba(0, 0, 0, 0.5) !important;
        backdrop-filter: blur(4px) !important;
        -webkit-backdrop-filter: blur(4px) !important;
        padding: 10px 18px !important;
        border-radius: 6px !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5) !important;
        display: inline-block !important;
        margin: 0 auto 15px auto !important;
    }

    /* Preview Images Overlay */
    .preview-images-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin: 20px 0;
        flex-wrap: wrap;
    }

    /* Image Shapes - Dynamic Shape Masks */
    .preview-image-overlay {
        width: 120px !important;
        height: 120px !important;
        object-fit: cover !important;
        border: 4px solid rgba(255, 255, 255, 0.95) !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4) !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        z-index: 15 !important;
        position: relative !important;
        transition: all 0.3s ease !important;
    }
    
    /* Circle Shape */
    .preview-image-overlay.shape-circle {
        border-radius: 50% !important;
    }
    
    /* Square Shape */
    .preview-image-overlay.shape-square {
        border-radius: 0 !important;
    }
    
    /* Hexagon Shape */
    .preview-image-overlay.shape-hexagon {
        border-radius: 0 !important;
        clip-path: polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%) !important;
        -webkit-clip-path: polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%) !important;
    }
    
    /* Diamond Shape */
    .preview-image-overlay.shape-diamond {
        border-radius: 0 !important;
        clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%) !important;
        -webkit-clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%) !important;
        transform: rotate(45deg) !important;
    }
    
    .preview-image-overlay.shape-diamond img {
        transform: rotate(-45deg) !important;
    }
    
    /* Heart Shape */
    .preview-image-overlay.shape-heart {
        border-radius: 0 !important;
        clip-path: path('M12,21.35l-1.45-1.32C5.4,15.36,2,12.28,2,8.5 C2,5.42,4.42,3,7.5,3c1.74,0,3.41,0.81,4.5,2.09C13.09,3.81,14.76,3,16.5,3 C19.58,3,22,5.42,22,8.5c0,3.78-3.4,6.86-8.55,11.54L12,21.35z') !important;
        -webkit-clip-path: path('M12,21.35l-1.45-1.32C5.4,15.36,2,12.28,2,8.5 C2,5.42,4.42,3,7.5,3c1.74,0,3.41,0.81,4.5,2.09C13.09,3.81,14.76,3,16.5,3 C19.58,3,22,5.42,22,8.5c0,3.78-3.4,6.86-8.55,11.54L12,21.35z') !important;
    }
    
    /* Star Shape */
    .preview-image-overlay.shape-star {
        border-radius: 0 !important;
        clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%) !important;
        -webkit-clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%) !important;
    }
    
    /* Rounded Square */
    .preview-image-overlay.shape-rounded {
        border-radius: 20px !important;
    }
    
    /* Oval Shape */
    .preview-image-overlay.shape-oval {
        border-radius: 50% 50% 50% 50% / 60% 60% 40% 40% !important;
    }
    
    /* Hover Effect for Shaped Images */
    .preview-image-overlay:hover {
        transform: scale(1.1) !important;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5) !important;
        z-index: 16 !important;
    }

    .preview-main-image {
        width: 100% !important;
        max-height: 200px !important;
        object-fit: cover !important;
        border-radius: 12px !important;
        margin-bottom: 20px !important;
        border: 2px solid rgba(255, 255, 255, 0.9) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        display: block !important;
        z-index: 15 !important;
        position: relative !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    #previewMainImageContainer {
        position: relative !important;
        z-index: 15 !important;
        width: 100% !important;
        margin-bottom: 20px !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
    }
    
    /* Image Shape Formats */
    #previewMainImage.image-shape-square {
        border-radius: 0 !important;
        width: 200px !important;
        height: 200px !important;
        object-fit: cover !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        max-width: 200px !important;
        max-height: 200px !important;
        min-width: 200px !important;
        min-height: 200px !important;
    }
    
    #previewMainImage.image-shape-circle {
        border-radius: 50% !important;
        width: 200px !important;
        height: 200px !important;
        object-fit: cover !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        max-width: 200px !important;
        max-height: 200px !important;
        min-width: 200px !important;
        min-height: 200px !important;
    }
    
    #previewMainImage.image-shape-rounded {
        border-radius: 12px !important;
        width: 200px !important;
        height: 200px !important;
        object-fit: cover !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        max-width: 200px !important;
        max-height: 200px !important;
        min-width: 200px !important;
        min-height: 200px !important;
    }
    
    #previewMainImage.image-shape-rounded-lg {
        border-radius: 24px !important;
        width: 200px !important;
        height: 200px !important;
        object-fit: cover !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        max-width: 200px !important;
        max-height: 200px !important;
        min-width: 200px !important;
        min-height: 200px !important;
    }
    
    /* Baby Shower Specific Layout - Image center above name */
    .invitation-preview[data-event-type="babyshower"] .preview-content,
    .invitation-preview[data-event-type="baby shower"] .preview-content {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: flex-start !important;
    }
    
    .invitation-preview[data-event-type="babyshower"] #previewMainImageContainer,
    .invitation-preview[data-event-type="baby shower"] #previewMainImageContainer {
        order: -2 !important;
        margin-bottom: 20px !important;
        margin-top: 0 !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        width: 100% !important;
        position: relative !important;
    }
    
    .invitation-preview[data-event-type="babyshower"] #previewMainImage,
    .invitation-preview[data-event-type="baby shower"] #previewMainImage {
        margin: 0 auto !important;
        display: block !important;
    }
    
    .invitation-preview[data-event-type="babyshower"] .preview-event-name,
    .invitation-preview[data-event-type="baby shower"] .preview-event-name {
        order: -1 !important;
        margin-top: 0 !important;
        margin-bottom: 20px !important;
        text-align: center !important;
        width: 100% !important;
    }
    
    /* Ensure gallery stays at bottom for all event types */
    #previewGallerySection {
        order: 999 !important;
        margin-top: 30px !important;
    }

    .preview-placeholder {
        font-size: 14px;
        color: var(--text-gray) !important;
        line-height: 1.6;
        padding: 40px 20px;
        text-align: center;
        visibility: hidden !important;
        opacity: 0 !important;
        display: none !important;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        border: 2px dashed rgba(111, 78, 55, 0.3);
        position: absolute !important;
        pointer-events: none !important;
    }

    /* Event-Specific Fields */
    .event-specific-fields {
        margin-top: 30px;
        padding-top: 30px;
        border-top: 2px solid #E5E5E5;
    }

    .section-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--reddish-brown-dark);
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--golden-yellow);
        letter-spacing: -0.01em;
    }

    /* Image Preview Styles */
    .image-preview {
        margin-top: 12px;
        display: none;
    }

    .image-preview img {
        width: 100%;
        max-width: 200px;
        height: auto;
        border-radius: 12px;
        border: 2px solid #E5E5E5;
        margin-top: 8px;
    }

    .gallery-preview {
        margin-top: 12px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
    }

    .gallery-preview img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #E5E5E5;
    }
    
    /* Gallery Preview in Live Preview */
    .preview-gallery {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid rgba(160, 120, 120, 0.2);
        position: relative;
        z-index: 15 !important;
    }
    
    /* Gallery Section inside invitation card */
    #previewGallerySection {
        position: relative !important;
        z-index: 30 !important;
        width: 100% !important;
        margin-top: 30px !important;
        padding-top: 20px !important;
        padding-bottom: 10px !important;
        border-top: 2px solid rgba(160, 120, 120, 0.3) !important;
        display: none; /* Will be set to block by JavaScript when images are uploaded */
        background: transparent !important;
    }
    
    #previewGalleryGrid {
        display: grid !important;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)) !important;
        gap: 15px !important;
        width: 100% !important;
        position: relative !important;
        z-index: 30 !important;
        padding: 10px 0 !important;
        background: transparent !important;
    }
    
    #previewGalleryGrid img {
        width: 100% !important;
        height: 180px !important;
        object-fit: cover !important;
        border-radius: 10px !important;
        border: 3px solid rgba(255, 255, 255, 0.9) !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 30 !important;
        background: #ffffff !important;
        cursor: pointer !important;
        transition: transform 0.3s ease !important;
    }
    
    #previewGalleryGrid img:hover {
        transform: scale(1.05) !important;
        box-shadow: 0 6px 20px rgba(0,0,0,0.4) !important;
    }
    
    .preview-gallery-title {
        font-size: 1.5rem !important;
        font-weight: 700 !important;
        color: #6F4E37 !important;
        margin-bottom: 20px !important;
        text-align: center !important;
        text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.9) !important;
        background: rgba(255, 255, 255, 0.7) !important;
        padding: 8px 16px !important;
        border-radius: 8px !important;
        display: inline-block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 30 !important;
        width: auto !important;
        margin-left: auto !important;
        margin-right: auto !important;
    }

    .invitation-preview.wedding-bg .preview-gallery-title,
    .invitation-preview.template-bg .preview-gallery-title {
        color: #fff !important;
        background: rgba(0, 0, 0, 0.5) !important;
        backdrop-filter: blur(4px) !important;
        -webkit-backdrop-filter: blur(4px) !important;
        padding: 10px 18px !important;
        border-radius: 6px !important;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7) !important;
        display: inline-block !important;
        margin: 0 auto 15px auto !important;
    }
    
    .preview-gallery-grid {
        display: grid !important;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)) !important;
        gap: 10px !important;
        margin-top: 10px !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 30 !important;
        background: transparent !important;
        width: 100% !important;
    }
    
    .preview-gallery-grid img {
        width: 100% !important;
        height: 80px !important;
        object-fit: cover !important;
        border-radius: 8px !important;
        border: 2px solid rgba(255, 255, 255, 0.5) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
        position: relative !important;
        z-index: 30 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        background: #ffffff !important;
    }

    select.form-input {
        cursor: pointer;
    }

    /* Navigation Buttons - Professional & Mobile Responsive */
    .form-navigation {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        max-width: 1200px !important;
        margin: 40px auto 0 !important;
        padding: 20px !important;
        background: rgba(255, 255, 255, 0.95) !important;
        backdrop-filter: blur(10px) !important;
        -webkit-backdrop-filter: blur(10px) !important;
        border-radius: 16px !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15) !important;
        border: 2px solid rgba(111, 78, 55, 0.2) !important;
        position: relative !important;
        z-index: 50 !important;
        visibility: visible !important;
        opacity: 1 !important;
        gap: 15px !important;
    }
    
    @media (max-width: 768px) {
        .form-navigation {
            flex-direction: column !important;
            gap: 12px !important;
            padding: 15px !important;
            margin: 20px auto 0 !important;
        }
        
        .btn-back,
        .btn-continue,
        .btn-preview {
            width: 100% !important;
            justify-content: center !important;
        }
    }
    
    @media (max-width: 480px) {
        .form-navigation {
            padding: 12px !important;
            margin: 15px auto 0 !important;
        }
    }

    .btn-back,
    .btn-continue,
    .btn-preview {
        padding: 14px 32px !important;
        border-radius: 12px !important;
        font-weight: 600 !important;
        font-size: 16px !important;
        transition: all 0.3s ease !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 8px !important;
        border: 2px solid !important;
        text-decoration: none !important;
        cursor: pointer !important;
        background: white !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 100 !important;
        min-height: 44px !important; /* Touch target */
        touch-action: manipulation !important;
    }
    
    @media (max-width: 768px) {
        .btn-back,
        .btn-continue,
        .btn-preview {
            padding: 12px 24px !important;
            font-size: 16px !important;
            min-height: 48px !important;
        }
    }
    
    @media (max-width: 480px) {
        .btn-back,
        .btn-continue,
        .btn-preview {
            padding: 12px 20px !important;
            font-size: 15px !important;
        }
    }

    .btn-back {
        color: var(--reddish-brown-dark);
        border-color: var(--reddish-brown-dark);
    }

    .btn-back:hover {
        background: #F8F8F8;
        transform: translateY(-2px);
    }

    .btn-continue,
    .btn-preview {
        background: linear-gradient(135deg, #6F4E37 0%, #D4AF37 100%) !important;
        color: #FFFFFF !important;
        border: 3px solid #FFFFFF !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(111, 78, 55, 0.5) !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 100 !important;
        backdrop-filter: blur(5px) !important;
        -webkit-backdrop-filter: blur(5px) !important;
    }
    
    .btn-preview,
    .btn-preview * {
        color: #FFFFFF !important;
        visibility: visible !important;
        opacity: 1 !important;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5) !important;
    }
    
    .btn-preview i {
        color: #FFFFFF !important;
        visibility: visible !important;
        opacity: 1 !important;
        display: inline-block !important;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5) !important;
    }

    .btn-continue:hover,
    .btn-preview:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.5), 0 0 30px rgba(111, 78, 55, 0.6) !important;
        background: linear-gradient(135deg, #5a3d2a 0%, #B8941F 100%) !important;
    }

    .btn-continue:not(:disabled) {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 2px 8px rgba(160, 120, 120, 0.2);
        }
        50% {
            box-shadow: 0 4px 16px rgba(160, 120, 120, 0.3);
        }
    }

    .btn-continue:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* Smooth fade-in animation for sections */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
    
    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(30px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    /* Apply animations to sections */
    .form-section-card {
        animation: fadeInUp 0.6s ease-out;
    }
    
    .live-preview-card {
        animation: fadeInUp 0.6s ease-out 0.2s both;
    }
    
    .progress-bar-container {
        animation: fadeIn 0.5s ease-out;
    }
    
    .page-title {
        animation: fadeInUp 0.5s ease-out;
    }
    
    .form-group {
        animation: fadeIn 0.4s ease-out;
        animation-fill-mode: both;
    }
    
    .form-group:nth-child(1) { animation-delay: 0.1s; }
    .form-group:nth-child(2) { animation-delay: 0.15s; }
    .form-group:nth-child(3) { animation-delay: 0.2s; }
    .form-group:nth-child(4) { animation-delay: 0.25s; }
    .form-group:nth-child(5) { animation-delay: 0.3s; }
    .form-group:nth-child(6) { animation-delay: 0.35s; }
    .form-group:nth-child(7) { animation-delay: 0.4s; }
    .form-group:nth-child(8) { animation-delay: 0.45s; }

    /* Professional Mobile Responsive Design */
    @media (max-width: 1400px) {
        .editor-container {
            grid-template-columns: 1fr 1fr !important;
        }
    }
    
    @media (max-width: 1200px) {
        .editor-container {
            grid-template-columns: 1fr 1fr !important;
        }
    }
    
    /* Tablet and Mobile - Stack Layout */
    @media (max-width: 992px) {
        .editor-container {
            grid-template-columns: 1fr !important;
            height: auto !important;
            min-height: auto !important;
            gap: 20px !important;
            padding: 15px !important;
            align-items: stretch !important;
        }
        
        .editor-sidebar {
            display: none !important;
        }
        
        .editor-form-section {
            border-right: none !important;
            padding: 20px 15px !important;
            border-radius: 12px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            margin-bottom: 20px !important;
            height: auto !important;
            min-height: auto !important;
            max-height: none !important;
        }
        
        .editor-preview-section {
            border-top: 1px solid #e0e0e0 !important;
            padding: 15px !important;
            border-radius: 12px !important;
            background: #f8f9fa !important;
            height: auto !important;
            min-height: auto !important;
            max-height: none !important;
        }
        
        .preview-header {
            flex-direction: column !important;
            gap: 15px !important;
            align-items: stretch !important;
        }
        
        .view-toggle-buttons {
            width: 100% !important;
            justify-content: center !important;
        }
        
        .view-toggle-btn {
            flex: 1 !important;
            padding: 12px !important;
        }
    }
    
    /* Mobile Phones */
    @media (max-width: 768px) {
        .editor-container {
            padding: 10px !important;
            gap: 15px !important;
        }
        
        .editor-form-section {
            padding: 15px 10px !important;
        }
        
        .editor-preview-section {
            padding: 10px !important;
        }
        
        .live-preview-card {
            padding: 15px !important;
            min-height: 500px !important;
        }
        
        .form-group {
            margin-bottom: 20px !important;
        }
        
        .form-label {
            font-size: 14px !important;
            margin-bottom: 8px !important;
        }
        
        .form-input,
        .form-textarea,
        .form-select {
            font-size: 16px !important; /* Prevents zoom on iOS */
            padding: 12px 14px !important;
            min-height: 44px !important; /* Touch target size */
        }
        
        .btn {
            min-height: 44px !important;
            padding: 12px 20px !important;
            font-size: 16px !important;
            touch-action: manipulation !important;
        }
        
        .preview-header {
            padding: 12px 15px !important;
        }
        
        .preview-title {
            font-size: 16px !important;
        }
    }
    
    /* Small Mobile Phones */
    @media (max-width: 480px) {
        .editor-container {
            padding: 8px !important;
            gap: 12px !important;
        }
        
        .editor-form-section {
            padding: 12px 8px !important;
        }
        
        .editor-preview-section {
            padding: 8px !important;
        }
        
        .live-preview-card {
            padding: 12px !important;
            min-height: 450px !important;
            border-radius: 12px !important;
        }
        
        .form-input,
        .form-textarea,
        .form-select {
            font-size: 16px !important;
            padding: 10px 12px !important;
        }
        
        .btn {
            padding: 10px 16px !important;
            font-size: 14px !important;
        }
        
        .preview-header {
            padding: 10px 12px !important;
        }
        
        .view-toggle-btn {
            padding: 10px !important;
            font-size: 13px !important;
        }
    }
    
    /* Landscape Mobile */
    @media (max-width: 992px) and (orientation: landscape) {
        .editor-container {
            height: auto !important;
            min-height: 100vh !important;
        }
        
        .live-preview-card {
            min-height: 400px !important;
        }
    }
    
    /* Ensure buttons text is always visible */
    .style-filter-btn,
    .template-select-btn {
        color: white !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
    }
    
    .style-filter-btn *,
    .template-select-btn * {
        color: white !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    @media (max-width: 968px) {
        .form-preview-container {
            grid-template-columns: 1fr;
            gap: 24px;
        }

        .live-preview-card {
            position: static;
            margin-top: 24px;
        }

        .theme-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            padding: 20px 16px;
        }

        .form-section-card,
        .live-preview-card {
            padding: 24px;
        }

        .page-title h1 {
            font-size: 32px;
        }

        .page-title p {
            font-size: 14px;
        }
    }

    @media (max-width: 640px) {
        .theme-grid {
            grid-template-columns: 1fr;
        }

        .progress-bar {
            flex-direction: row;
            flex-wrap: nowrap;
            padding: 0 10px;
        }

        .progress-step {
            margin-bottom: 0;
        }

        .progress-step::after {
            left: calc(50% + 15px);
            width: calc(100% - 30px) !important;
        }

        .page-title h1 {
            font-size: 36px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="create-page-container">
    <!-- Progress Bar - Exact Match from Images -->
    <div class="progress-bar-container">
        <div class="progress-bar">
            <div class="progress-step completed clickable-step" data-step="1" onclick="navigateToStep(1)">
                <div class="step-circle">âœ“</div>
                <div class="step-label">Occasion</div>
    </div>
            <div class="progress-step {% if selected_template %}completed{% else %}active{% endif %} clickable-step" data-step="2" onclick="navigateToStep(2)">
                <div class="step-circle">{% if selected_template %}âœ“{% else %}2{% endif %}</div>
                <div class="step-label">Theme</div>
    </div>
            <div class="progress-step {% if selected_template %}active{% else %}pending{% endif %} {% if selected_template %}clickable-step{% endif %}" data-step="3" {% if selected_template %}onclick="navigateToStep(3)"{% endif %}>
                <div class="step-circle">3</div>
                <div class="step-label">Details</div>
    </div>
            <div class="progress-step pending" data-step="4">
                <div class="step-circle">4</div>
                <div class="step-label">Preview</div>
        </div>
            </div>
    </div>

    <!-- Theme Selection Page -->
    {% if not selected_template and not show_details %}
    <div class="theme-selection-page active" id="themeSelectionPage">
        <div class="page-title">
            <h1>
                <span class="title-normal">Pick Your </span>
                <span class="title-gradient">Perfect Theme</span>
            </h1>
            <p>Select a design that speaks to your style</p>
    </div>

        <div class="theme-dropdown-container" style="max-width: 600px; margin: 40px auto; padding: 0 20px;">
            <div class="form-group">
                <label class="form-label" for="themeSelect" style="font-size: 18px; font-weight: 600; margin-bottom: 16px; display: block;">Select Theme</label>
                <select class="form-input" id="themeSelect" name="themeSelect" style="width: 100%; padding: 14px 16px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; cursor: pointer;" onchange="handleThemeSelection(this)">
                    <option value="">-- Choose a theme --</option>
                    {% if all_templates %}
                        {% set current_event_type = '' %}
                        {% for template in all_templates %}
                            {% if template.preview_image %}
                                {% if template.event_type != current_event_type %}
                                    {% if current_event_type != '' %}
                                        </optgroup>
                                    {% endif %}
                                    {% set current_event_type = template.event_type %}
                                    <optgroup label="{{ template.event_type|title }}">
                                {% endif %}
                                {% set template_name_slug = template.name|replace(' ', '_')|lower %}
                                {% set template_img_raw = template.preview_image if template.preview_image else '/images/templatesimages/wedding.png' %}
                                {% set template_img = template_img_raw if 'placeholder.com' not in template_img_raw and 'via.placeholder' not in template_img_raw else '/images/templatesimages/wedding.png' %}
                                {% if template_img and not template_img.startswith('http') %}
                                    {% if template_img.startswith('/images/') %}
                                        {% set template_img = template_img %}
                                    {% elif template_img.startswith('/static/images/') and 'templatesimages' in template_img %}
                                        {% set template_img = template_img.replace('/static/images/', '/images/') %}
                                    {% elif 'templatesimages' in template_img %}
                                        {% if not template_img.startswith('/') %}
                                            {% set template_img = '/images/' + template_img %}
                                        {% else %}
                                            {% set template_img = template_img %}
                                        {% endif %}
                                    {% elif template_img.endswith(('.jpg', '.jpeg', '.png', '.gif')) and not '/' in template_img %}
                                        {% set template_img = '/images/templatesimages/' + template_img %}
                                    {% elif not template_img.startswith('/') %}
                                        {% set template_img = '/images/templatesimages/' + template_img %}
                                    {% endif %}
                                    {% if template_img.startswith('/static/images/') %}
                                        {% set template_img = template_img.replace('/static/images/', '/images/') %}
                                    {% endif %}
                                {% endif %}
                                {% set safe_template_img = template_img if 'placeholder.com' not in template_img and 'via.placeholder' not in template_img else '/images/templatesimages/wedding.png' %}
                                <option value="{{ template.id }}" 
                                        data-template-image="{{ safe_template_img|e }}" 
                                        data-template-name="{{ template.name|e }}"
                                        data-event-type="{{ template.event_type|e }}">
                                    {{ template.name|e }}
                                </option>
                            {% endif %}
                        {% endfor %}
                        {% if current_event_type != '' %}
                            </optgroup>
                        {% endif %}
                    {% endif %}
                </select>
            </div>
            <div id="selectedThemePreview" style="margin-top: 20px; display: none; text-align: center;">
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <img id="themePreviewImage" src="" alt="Theme Preview" style="max-width: 100%; max-height: 300px; border-radius: 8px; margin-bottom: 12px;">
                    <p id="themePreviewName" style="font-weight: 600; color: #6F4E37; margin: 0;"></p>
                </div>
            </div>
        </div>

        <div class="form-navigation">
            <a href="{{ url_for('templates') }}" class="btn-back">
                <i class="fas fa-arrow-left"></i> Back
            </a>
            <button class="btn-continue" id="continueToDetails" disabled onclick="continueToDetails()">
                Continue <i class="fas fa-arrow-right"></i>
                        </button>
        </div>
        </div>
    {% endif %}

    <!-- Details Form Page -->
    <div class="details-form-page {% if selected_template or show_details %}active{% endif %}" id="detailsFormPage">
        <div class="page-title" style="padding: 20px 30px; background: white; border-bottom: 2px solid #e0e0e0;">
            <h1 style="margin: 0; font-size: 24px;">
                <span class="title-normal">Add Your </span>
                <span class="title-gradient">Special Details</span>
            </h1>
            <p style="margin: 5px 0 0 0; color: #666;">Watch your invitation come to life</p>
    </div>

        <!-- Two-Column Editor Layout (Sidebar Removed) -->
        <div class="editor-container">
            <!-- Left Sidebar - Hidden -->
            <div class="editor-sidebar" style="display: none !important; visibility: hidden !important;">
                <div class="sidebar-tabs" style="display: none;">
                    <!-- Sidebar tabs hidden - only Templates shown for now -->
                </div>
                
                <div class="sidebar-content">
                    <!-- Templates Panel -->
                    <div class="sidebar-panel active" id="templates-panel" style="display: block !important;">
                        <h3 style="color: white !important; font-size: 18px !important; margin-bottom: 20px; font-weight: 700 !important; text-align: center; padding-bottom: 15px; border-bottom: 2px solid rgba(255,255,255,0.2); visibility: visible !important; opacity: 1 !important;">
                            <i class="fas fa-palette" style="margin-right: 8px; color: white !important; visibility: visible !important;"></i>
                            <span style="color: white !important; visibility: visible !important; opacity: 1 !important;">Templates</span>
                        </h3>
                        
                        <!-- Search Bar -->
                        <input type="text" placeholder="Search templates..." style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.15); color: white !important; margin-bottom: 15px; font-size: 13px; visibility: visible !important; opacity: 1 !important;" id="templateSearch">
                        <style>
                            #templateSearch::placeholder {
                                color: rgba(255,255,255,0.7) !important;
                                opacity: 1 !important;
                            }
                        </style>
                        
                        <!-- Style Filter Buttons -->
                        <div class="style-filter-buttons" style="margin-bottom: 20px;">
                            <label style="color: white !important; font-size: 13px !important; display: block; margin-bottom: 10px; font-weight: 600 !important; visibility: visible !important; opacity: 1 !important;">Filter by Style:</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <button class="style-filter-btn active" data-style="all" style="padding: 8px 14px; background: rgba(102, 126, 234, 0.8) !important; color: white !important; border: none !important; border-radius: 6px; font-size: 12px !important; cursor: pointer; font-weight: 600 !important; transition: all 0.3s; white-space: nowrap;">All</button>
                                <button class="style-filter-btn" data-style="elegant" style="padding: 8px 14px; background: rgba(255,255,255,0.15) !important; color: white !important; border: 1px solid rgba(255,255,255,0.2) !important; border-radius: 6px; font-size: 12px !important; cursor: pointer; transition: all 0.3s; white-space: nowrap; font-weight: 500 !important;">Elegant</button>
                                <button class="style-filter-btn" data-style="classic" style="padding: 8px 14px; background: rgba(255,255,255,0.15) !important; color: white !important; border: 1px solid rgba(255,255,255,0.2) !important; border-radius: 6px; font-size: 12px !important; cursor: pointer; transition: all 0.3s; white-space: nowrap; font-weight: 500 !important;">Classic</button>
                                <button class="style-filter-btn" data-style="professional" style="padding: 8px 14px; background: rgba(255,255,255,0.15) !important; color: white !important; border: 1px solid rgba(255,255,255,0.2) !important; border-radius: 6px; font-size: 12px !important; cursor: pointer; transition: all 0.3s; white-space: nowrap; font-weight: 500 !important;">Professional</button>
                                <button class="style-filter-btn" data-style="normal" style="padding: 8px 14px; background: rgba(255,255,255,0.15) !important; color: white !important; border: 1px solid rgba(255,255,255,0.2) !important; border-radius: 6px; font-size: 12px !important; cursor: pointer; transition: all 0.3s; white-space: nowrap; font-weight: 500 !important;">Normal</button>
                                <button class="style-filter-btn" data-style="modern" style="padding: 8px 14px; background: rgba(255,255,255,0.15) !important; color: white !important; border: 1px solid rgba(255,255,255,0.2) !important; border-radius: 6px; font-size: 12px !important; cursor: pointer; transition: all 0.3s; white-space: nowrap; font-weight: 500 !important;">Modern</button>
                                <button class="style-filter-btn" data-style="traditional" style="padding: 8px 14px; background: rgba(255,255,255,0.15) !important; color: white !important; border: 1px solid rgba(255,255,255,0.2) !important; border-radius: 6px; font-size: 12px !important; cursor: pointer; transition: all 0.3s; white-space: nowrap; font-weight: 500 !important;">Traditional</button>
                                <button class="style-filter-btn" data-style="royal" style="padding: 8px 14px; background: rgba(255,255,255,0.15) !important; color: white !important; border: 1px solid rgba(255,255,255,0.2) !important; border-radius: 6px; font-size: 12px !important; cursor: pointer; transition: all 0.3s; white-space: nowrap; font-weight: 500 !important;">Royal</button>
                                <button class="style-filter-btn" data-style="minimal" style="padding: 8px 14px; background: rgba(255,255,255,0.15) !important; color: white !important; border: 1px solid rgba(255,255,255,0.2) !important; border-radius: 6px; font-size: 12px !important; cursor: pointer; transition: all 0.3s; white-space: nowrap; font-weight: 500 !important;">Minimal</button>
                                <button class="style-filter-btn" data-style="vintage" style="padding: 8px 14px; background: rgba(255,255,255,0.15) !important; color: white !important; border: 1px solid rgba(255,255,255,0.2) !important; border-radius: 6px; font-size: 12px !important; cursor: pointer; transition: all 0.3s; white-space: nowrap; font-weight: 500 !important;">Vintage</button>
                                <button class="style-filter-btn" data-style="contemporary" style="padding: 8px 14px; background: rgba(255,255,255,0.15) !important; color: white !important; border: 1px solid rgba(255,255,255,0.2) !important; border-radius: 6px; font-size: 12px !important; cursor: pointer; transition: all 0.3s; white-space: nowrap; font-weight: 500 !important;">Contemporary</button>
                            </div>
                        </div>
                        <div class="template-list" style="display: grid; grid-template-columns: 1fr; gap: 10px; max-height: calc(100vh - 450px); overflow-y: auto; padding-right: 5px;">
                            {% if all_templates %}
                                {% for template in all_templates %}
                                    {% if template.preview_image and 'placeholder.com' not in template.preview_image and 'via.placeholder' not in template.preview_image %}
                                        {% set template_img = template.preview_image if template.preview_image.startswith('/') else '/images/templatesimages/' + template.preview_image %}
                                        <div class="template-item" 
                                             data-template-id="{{ template.id }}"
                                             data-event-type="{{ template.event_type|lower }}"
                                             data-style="{{ template.style|lower if template.style else 'normal' }}"
                                             data-template-name="{{ template.name|e }}"
                                             data-template-image="{{ template_img|e }}"
                                             style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 10px; transition: all 0.3s; border: 2px solid transparent; margin-bottom: 12px;">
                                            <img src="{{ template_img }}" 
                                                 alt="{{ template.name }}" 
                                                 style="width: 100%; height: 140px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;"
                                                 onerror="this.src='/images/templatesimages/wedding.png';">
                                            <div style="color: white; font-size: 12px; font-weight: 600; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center;">{{ template.name }}</div>
                                            <div style="display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; margin-bottom: 10px;">
                                                <span style="background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 4px; font-size: 10px; color: rgba(255,255,255,0.9);">{{ template.event_type|title }}</span>
                                                {% if template.style %}
                                                <span style="background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 4px; font-size: 10px; color: rgba(255,255,255,0.9);">{{ template.style|title }}</span>
                                                {% else %}
                                                <span style="background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 4px; font-size: 10px; color: rgba(255,255,255,0.9);">Normal</span>
                                                {% endif %}
                                            </div>
                                            <button class="template-select-btn" 
                                                    data-template-id="{{ template.id }}"
                                                    data-template-name="{{ template.name|e }}"
                                                    data-template-image="{{ template_img|e }}"
                                                    data-event-type="{{ template.event_type|lower }}"
                                                    style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; color: white !important; border: none !important; border-radius: 8px; font-size: 13px !important; font-weight: 600 !important; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); display: flex !important; align-items: center !important; justify-content: center !important;"
                                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.5)';"
                                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)';">
                                                <i class="fas fa-check-circle" style="margin-right: 6px; color: white !important; visibility: visible !important; opacity: 1 !important; display: inline-block !important;"></i>
                                                <span style="color: white !important; visibility: visible !important; opacity: 1 !important; display: inline-block !important;">Select</span>
                                            </button>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <div style="text-align: center; color: rgba(255,255,255,0.6); padding: 20px; font-size: 12px;">No templates available</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Elements Panel (Stickers & Icons) -->
                    <div class="sidebar-panel" id="elements-panel">
                        <h3 style="color: white; font-size: 16px; margin-bottom: 15px; font-weight: 600;">Elements</h3>
                        <div class="elements-tabs" style="display: flex; gap: 8px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                            <button class="element-tab-btn active" data-element-type="stickers" style="flex: 1; padding: 8px; background: rgba(255,255,255,0.2); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">Stickers</button>
                            <button class="element-tab-btn" data-element-type="icons" style="flex: 1; padding: 8px; background: rgba(255,255,255,0.1); border: none; border-radius: 6px; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 12px;">Icons</button>
                            <button class="element-tab-btn" data-element-type="shapes" style="flex: 1; padding: 8px; background: rgba(255,255,255,0.1); border: none; border-radius: 6px; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 12px;">Shapes</button>
                        </div>
                        <div class="elements-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-height: calc(100vh - 400px); overflow-y: auto;">
                            <div class="element-item" draggable="true" data-element="heart" style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center; cursor: grab; transition: all 0.2s;">
                                <i class="fas fa-heart" style="font-size: 24px; color: #ff6b9d;"></i>
                            </div>
                            <div class="element-item" draggable="true" data-element="star" style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center; cursor: grab;">
                                <i class="fas fa-star" style="font-size: 24px; color: #ffd700;"></i>
                            </div>
                            <div class="element-item" draggable="true" data-element="gift" style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center; cursor: grab;">
                                <i class="fas fa-gift" style="font-size: 24px; color: #4ecdc4;"></i>
                            </div>
                            <div class="element-item" draggable="true" data-element="balloon" style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center; cursor: grab;">
                                <i class="fas fa-birthday-cake" style="font-size: 24px; color: #ff6b6b;"></i>
                            </div>
                            <div class="element-item" draggable="true" data-element="flower" style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center; cursor: grab;">
                                <i class="fas fa-flower" style="font-size: 24px; color: #ff9ff3;"></i>
                            </div>
                            <div class="element-item" draggable="true" data-element="music" style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center; cursor: grab;">
                                <i class="fas fa-music" style="font-size: 24px; color: #667eea;"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Images Panel -->
                    <div class="sidebar-panel" id="images-panel">
                        <h3 style="color: white; font-size: 16px; margin-bottom: 15px; font-weight: 600;">Images</h3>
                        <button class="upload-image-btn" style="width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 15px;">
                            <i class="fas fa-upload"></i> Upload Image
                        </button>
                        
                        <!-- Shape Selection -->
                        <div style="margin-bottom: 15px;">
                            <label style="color: white; font-size: 12px; display: block; margin-bottom: 8px; font-weight: 600;">Select Shape:</label>
                            <div class="shape-selector" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                <button class="shape-btn active" data-shape="circle" style="padding: 12px; background: rgba(255,255,255,0.2); border: 2px solid rgba(102, 126, 234, 0.8); border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                    <i class="fas fa-circle" style="font-size: 20px; color: white;"></i>
                                </button>
                                <button class="shape-btn" data-shape="square" style="padding: 12px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                    <i class="fas fa-square" style="font-size: 20px; color: white;"></i>
                                </button>
                                <button class="shape-btn" data-shape="hexagon" style="padding: 12px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                    <i class="fas fa-hexagon" style="font-size: 20px; color: white;"></i>
                                </button>
                                <button class="shape-btn" data-shape="diamond" style="padding: 12px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                    <i class="fas fa-gem" style="font-size: 20px; color: white;"></i>
                                </button>
                                <button class="shape-btn" data-shape="heart" style="padding: 12px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                    <i class="fas fa-heart" style="font-size: 20px; color: white;"></i>
                                </button>
                                <button class="shape-btn" data-shape="star" style="padding: 12px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                    <i class="fas fa-star" style="font-size: 20px; color: white;"></i>
                                </button>
                                <button class="shape-btn" data-shape="rounded" style="padding: 12px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                    <i class="fas fa-square-full" style="font-size: 20px; color: white; border-radius: 4px;"></i>
                                </button>
                                <button class="shape-btn" data-shape="oval" style="padding: 12px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                    <i class="fas fa-ellipse" style="font-size: 20px; color: white;"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="uploaded-images-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: calc(100vh - 500px); overflow-y: auto;">
                        </div>
                    </div>
                    
                    <!-- Background Panel -->
                    <div class="sidebar-panel" id="background-panel">
                        <h3 style="color: white; font-size: 16px; margin-bottom: 15px; font-weight: 600;">Background</h3>
                        <div class="background-options">
                            <div class="bg-option" style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 10px; cursor: pointer;">
                                <label style="color: white; font-size: 12px; display: block; margin-bottom: 5px;">Color</label>
                                <input type="color" value="#ffffff" style="width: 100%; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                            </div>
                            <div class="bg-option" style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 10px;">
                                <label style="color: white; font-size: 12px; display: block; margin-bottom: 5px;">Gradient</label>
                                <select style="width: 100%; padding: 8px; border-radius: 6px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.2);">
                                    <option value="">Select Gradient</option>
                                    <option value="gradient1">Sunset</option>
                                    <option value="gradient2">Ocean</option>
                                    <option value="gradient3">Purple Dream</option>
                                </select>
                            </div>
                            <div class="bg-option" style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                <label style="color: white; font-size: 12px; display: block; margin-bottom: 5px;">Upload Image</label>
                                <button style="width: 100%; padding: 8px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer;">
                                    <i class="fas fa-image"></i> Choose Image
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Text Panel -->
                    <div class="sidebar-panel" id="text-panel">
                        <h3 style="color: white; font-size: 16px; margin-bottom: 15px; font-weight: 600;">Text</h3>
                        <div class="text-options">
                            <div style="margin-bottom: 15px;">
                                <label style="color: white; font-size: 12px; display: block; margin-bottom: 5px;">Font Family</label>
                                <select id="textFontFamily" style="width: 100%; padding: 8px; border-radius: 6px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.2); font-size: 12px;">
                                    <option value="Inter, sans-serif">Inter</option>
                                    <option value="Playfair Display, serif">Playfair Display</option>
                                    <option value="Georgia, serif">Georgia</option>
                                    <option value="Brush Script MT, cursive">Brush Script</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="color: white; font-size: 12px; display: block; margin-bottom: 5px;">Font Size</label>
                                <input type="range" min="12" max="72" value="16" id="textFontSize" style="width: 100%;">
                                <span id="fontSizeValue" style="color: white; font-size: 12px;">16px</span>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="color: white; font-size: 12px; display: block; margin-bottom: 5px;">Text Color</label>
                                <input type="color" value="#2c3e50" id="textColor" style="width: 100%; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                            </div>
                            <div>
                                <label style="color: white; font-size: 12px; display: block; margin-bottom: 5px;">Text Style</label>
                                <div style="display: flex; gap: 8px;">
                                    <button class="text-style-btn" data-style="bold" style="flex: 1; padding: 8px; background: rgba(255,255,255,0.2); border: none; border-radius: 6px; color: white; cursor: pointer;">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button class="text-style-btn" data-style="italic" style="flex: 1; padding: 8px; background: rgba(255,255,255,0.2); border: none; border-radius: 6px; color: white; cursor: pointer;">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button class="text-style-btn" data-style="underline" style="flex: 1; padding: 8px; background: rgba(255,255,255,0.2); border: none; border-radius: 6px; color: white; cursor: pointer;">
                                        <i class="fas fa-underline"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Uploads Panel -->
                    <div class="sidebar-panel" id="uploads-panel">
                        <h3 style="color: white; font-size: 16px; margin-bottom: 15px; font-weight: 600;">Uploads</h3>
                        <div class="upload-section" style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; border: 2px dashed rgba(255,255,255,0.3); text-align: center; margin-bottom: 15px;">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: rgba(255,255,255,0.6); margin-bottom: 10px; display: block;"></i>
                            <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin: 0;">Drag & drop files here</p>
                            <p style="color: rgba(255,255,255,0.6); font-size: 11px; margin: 5px 0 0 0;">or click to browse</p>
                            <input type="file" multiple accept="image/*" style="display: none;" id="sidebarFileUpload">
                        </div>
                        <div class="uploaded-files-list" style="max-height: calc(100vh - 400px); overflow-y: auto;">
                        </div>
                    </div>
                    
                    <!-- Tools Panel -->
                    <div class="sidebar-panel" id="tools-panel">
                        <h3 style="color: white; font-size: 16px; margin-bottom: 15px; font-weight: 600;">Tools</h3>
                        <div class="tools-list">
                            <button class="tool-btn" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer; margin-bottom: 10px; text-align: left;">
                                <i class="fas fa-undo"></i> Undo
                            </button>
                            <button class="tool-btn" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer; margin-bottom: 10px; text-align: left;">
                                <i class="fas fa-redo"></i> Redo
                            </button>
                            <button class="tool-btn" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer; margin-bottom: 10px; text-align: left;">
                                <i class="fas fa-copy"></i> Duplicate
                            </button>
                            <button class="tool-btn" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer; margin-bottom: 10px; text-align: left;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            <button class="tool-btn" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer; text-align: left;">
                                <i class="fas fa-align-center"></i> Align
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Center - Form Section -->
            <div class="editor-form-section">
        <div class="form-preview-container">
            <!-- Form Section -->
            <div class="form-section-card">
    <form id="invitationForm" method="POST" action="{{ url_for('create_invitation') }}" enctype="multipart/form-data">
                    <input type="hidden" name="selectedTemplate" value="{{ selected_template|e }}" id="selectedTemplate">
                    <input type="hidden" name="templateId" value="" id="templateIdInput">
                    <input type="hidden" name="templateImageUrl" value="" id="templateImageUrlInput">
                    
                    <div class="form-group">
                        <label class="form-label required" for="eventName">Event Name</label>
                        <input type="text" class="form-input" id="eventName" name="eventTitle" 
                               placeholder="e.g., Sarah & James or Emma's Sweet 16"
                               autocomplete="off"
                               data-default-name="{% if current_user %}{{ current_user.name|e }}{% endif %}"
                               data-event-type="{{ event_type }}"
                               value="{% if current_user and event_type and current_user.name %}{{ current_user.name|e }}'s {% if event_type == 'wedding' %}Wedding{% elif event_type == 'birthday' %}Birthday{% elif event_type == 'anniversary' %}Anniversary{% elif event_type == 'graduation' %}Graduation{% elif event_type == 'babyshower' %}Baby Shower{% elif event_type == 'retirement' %}Retirement{% else %}Event{% endif %}{% endif %}">
                    </div>

                    <div class="form-group">
                        <label class="form-label required" for="eventDate">Event Date</label>
                            <input type="date" class="form-input" id="eventDate" name="eventDate" autocomplete="off" placeholder="YYYY-MM-DD or DD-MM-YYYY">
                            <small class="form-text text-muted" style="display: block; margin-top: 5px; font-size: 0.85rem;">You can type the date in YYYY-MM-DD or DD-MM-YYYY format</small>
                </div>

                        <div class="form-group">
                        <label class="form-label" for="eventTime">Event Time</label>
                            <input type="time" class="form-input" id="eventTime" name="eventTime" autocomplete="off">
                </div>

                        <div class="form-group">
                        <label class="form-label" for="venueName">Venue Name</label>
                        <input type="text" class="form-input" id="venueName" name="venueName" 
                               placeholder="e.g., Garden Estate" autocomplete="organization">
                </div>

                <div class="form-group">
                        <label class="form-label" for="venueAddress">Venue Address</label>
                        <input type="text" class="form-input" id="venueAddress" name="venueAddress" 
                               placeholder="e.g., 123 Main St, City, State" autocomplete="street-address">
            </div>

                        <div class="form-group">
                        <label class="form-label" for="hostedBy">Hosted By</label>
                        <input type="text" class="form-input" id="hostedBy" name="hostName" 
                               placeholder="e.g., The Smith Family"
                               autocomplete="name"
                               value="{{ current_user.name if current_user else '' }}">
                </div>

                    <div class="form-group">
                        <label class="form-label" for="rsvpContact">RSVP Contact</label>
                        <input type="text" class="form-input" id="rsvpContact" name="contactEmail" 
                               placeholder="e.g., email@example.com or (555) 123-4567"
                               autocomplete="email"
                               value="{{ current_user.email if current_user else '' }}">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="personalMessage">Personal Message</label>
                        <textarea class="form-textarea" id="personalMessage" name="eventDescription" 
                                  rows="4" placeholder="Add a heartfelt message to your guests..." autocomplete="off"></textarea>
                    </div>

                    <!-- Language & Font Style -->
                    <div class="form-group">
                        <label class="form-label" for="language">Language</label>
                        <select class="form-input" id="language" name="language" autocomplete="language">
                            <option value="en">English</option>
                            <option value="hi">Hindi (à¤¹à¤¿à¤¨à¥à¤¦à¥€)</option>
                            <option value="te">Telugu (à°¤à±†à°²à±à°—à±)</option>
                            <option value="ta">Tamil (à®¤à®®à®¿à®´à¯)</option>
                            <option value="kn">Kannada (à²•à²¨à³à²¨à²¡)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="fontStyle">Font Style</label>
                        <select class="form-input" id="fontStyle" name="fontStyle" autocomplete="off" onchange="updateFontPreview(this)">
                            <option value="Inter, sans-serif" style="font-family: Inter, sans-serif;">Inter (Modern)</option>
                            <option value="Playfair Display, serif" style="font-family: 'Playfair Display', serif;">Playfair Display (Elegant)</option>
                            <option value="Georgia, serif" style="font-family: Georgia, serif;">Georgia (Classic)</option>
                            <option value="Brush Script MT, cursive" style="font-family: 'Brush Script MT', cursive;">Brush Script (Fun)</option>
                            <option value="Montserrat, sans-serif" style="font-family: Montserrat, sans-serif;">Montserrat (Clean)</option>
                            <option value="Amiri, serif" style="font-family: Amiri, serif;">Amiri (Traditional)</option>
                            <option value="Lora, serif" style="font-family: Lora, serif;">Lora (Sophisticated)</option>
                            <option value="Times New Roman, serif" style="font-family: 'Times New Roman', serif;">Times New Roman (Formal)</option>
                        </select>
                        <div id="fontPreview" style="margin-top: 8px; padding: 12px; background: #f8f9fa; border-radius: 6px; font-size: 18px; min-height: 40px; display: flex; align-items: center; border: 1px solid #e0e0e0;">
                            <span style="font-family: Inter, sans-serif;">Preview: The quick brown fox jumps over the lazy dog</span>
                        </div>
            </div>

                    <!-- Emotional Features Section -->
                    <div class="form-group" style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-radius: 12px; border: 2px solid #667eea30;">
                        <h4 style="margin-bottom: 20px; color: #667eea; font-size: 1.3rem;">
                            âœ¨ Make It Emotional
                        </h4>
                        <p style="margin-bottom: 20px; color: #4a5568; font-size: 0.95rem;">
                            Transform your invitation from standard to unforgettable with these emotional features
                        </p>
                        
                        <!-- Personal Messages Toggle -->
                        <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <h5 style="margin: 0; color: #2d3748; font-size: 1.1rem;">ðŸ’Œ Personal Messages for Each Guest</h5>
                                    <p style="margin: 5px 0 0 0; color: #718096; font-size: 0.9rem;">Every guest receives a unique message addressing them by name</p>
                                </div>
                                <label style="position: relative; display: inline-block; width: 50px; height: 26px;">
                                    <input type="checkbox" name="enablePersonalMessages" value="true" style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e0; border-radius: 26px; transition: 0.3s;">
                                        <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.3s;"></span>
                                    </span>
                                </label>
                            </div>
                            <div id="personalMessagePreview" style="display: none; margin-top: 15px; padding: 15px; background: #f7fafc; border-radius: 6px; border-left: 4px solid #667eea;">
                                <p style="margin: 0; font-size: 0.85rem; color: #4a5568; font-weight: 600; margin-bottom: 8px;">Preview:</p>
                                <p style="margin: 0; font-size: 0.9rem; color: #2d3748;"><strong>Sarah,</strong></p>
                                <p style="margin: 5px 0; font-size: 0.9rem; color: #2d3748;">You've been part of my journey since day one, and now I can't imagine this moment without you here.</p>
                                <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #2d3748; font-weight: 600;">Please say you'll be there.</p>
                                <p style="margin: 10px 0 0 0; font-size: 0.8rem; color: #667eea;">âœ¨ Each guest gets a completely different message</p>
                            </div>
                        </div>
                        
                        <!-- Countdown Toggle -->
                        <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <h5 style="margin: 0; color: #2d3748; font-size: 1.1rem;">â³ Anticipation Countdown</h5>
                                    <p style="margin: 5px 0 0 0; color: #718096; font-size: 0.9rem;">Live countdown timer that builds excitement</p>
                                </div>
                                <label style="position: relative; display: inline-block; width: 50px; height: 26px;">
                                    <input type="checkbox" name="enableCountdown" value="true" checked style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #667eea; border-radius: 26px; transition: 0.3s;">
                                        <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 27px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.3s;"></span>
                                    </span>
                                </label>
                            </div>
                            <div style="margin-top: 10px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" name="countdownMysteryMode" value="true" style="margin-right: 8px;">
                                    <span style="font-size: 0.9rem; color: #4a5568;">Mystery Mode (guests must unlock to see details)</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Voice Message Recording -->
                        <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-radius: 8px; border: 2px solid #667eea30;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <h5 style="margin: 0; color: #2d3748; font-size: 1.1rem;">ðŸŽ¤ Personal Voice Message</h5>
                                    <p style="margin: 5px 0 0 0; color: #718096; font-size: 0.9rem;">Record a 15-second voice note to add emotion and warmth to your invitation</p>
                                    <p style="margin: 5px 0 0 0; color: #667eea; font-size: 0.85rem; font-weight: 600;">âœ¨ Recommended: Let guests hear your voice!</p>
                                </div>
                            </div>
                            
                            <div id="voice-recorder-section" style="margin-top: 15px;">
                                <div id="voice-recording-controls" style="text-align: center;">
                                    <button type="button" id="voice-record-start-btn" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                                        <span>ðŸŽ¤</span> Start Recording (15 sec)
                                    </button>
                                    <div id="voice-timer-display" style="margin-top: 10px; font-size: 1.2rem; font-weight: 600; color: #667eea; display: none;">
                                        <span id="voice-timer">00:00</span> / 00:15
                                    </div>
                                    <button type="button" id="voice-record-stop-btn" style="padding: 12px 24px; background: #e53e3e; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px; display: none;">
                                        â¹ Stop Recording
                                    </button>
                                </div>
                                
                                <div id="voice-playback-section" style="display: none; margin-top: 15px; text-align: center;">
                                    <audio id="voice-audio-preview" controls style="width: 100%; margin-bottom: 10px;"></audio>
                                    <div style="display: flex; gap: 10px; justify-content: center;">
                                        <button type="button" id="voice-rerecord-btn" style="padding: 10px 20px; background: #718096; color: white; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer;">
                                            ðŸ”„ Re-record
                                        </button>
                                        <button type="button" id="voice-remove-btn" style="padding: 10px 20px; background: #e53e3e; color: white; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer;">
                                            âŒ Remove
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <input type="hidden" id="voiceMessageBlob" name="voiceMessageBlob">
                        </div>
                        
                        <!-- Memories Section Info -->
                        <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; align-items: center;">
                                <div style="flex: 1;">
                                    <h5 style="margin: 0; color: #2d3748; font-size: 1.1rem;">ðŸ“¸ Memories Section</h5>
                                    <p style="margin: 5px 0 0 0; color: #718096; font-size: 0.9rem;">Guests can upload photos and share memories (Always Enabled)</p>
                                </div>
                                <span style="padding: 6px 12px; background: #48bb78; color: white; border-radius: 6px; font-size: 0.85rem; font-weight: 600;">Always On</span>
                            </div>
                        </div>
                    </div>

                    <!-- Main Image Upload -->
                    <div class="form-group">
                        <label class="form-label" for="mainImage">Main Image</label>
                        <input type="file" class="form-input" id="mainImage" name="mainImage" accept="image/*" autocomplete="off" onchange="previewImage(this, 'mainImagePreview')">
                        <div id="mainImagePreview" class="image-preview"></div>
                    </div>
                    
                    <!-- Image Shape Format Selector -->
                    <div class="form-group" id="imageShapeFormatGroup" style="display: none;">
                        <label class="form-label" for="imageShapeFormat">Image Shape Format</label>
                        <select class="form-input" id="imageShapeFormat" name="imageShapeFormat" autocomplete="off" onchange="applyImageShapeFormat()">
                            <option value="square">Square</option>
                            <option value="circle">Circle</option>
                            <option value="rounded">Rounded</option>
                            <option value="rounded-lg">Rounded Large</option>
                        </select>
                        <small class="form-text text-muted" style="display: block; margin-top: 5px; font-size: 0.85rem;">Choose how the image should be displayed</small>
                    </div>

                    <!-- Event-Specific Fields (Conditional) -->
                <div id="weddingFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Wedding Details</h4>
                        <div class="form-group">
                            <label class="form-label" for="brideName">Bride Name</label>
                            <input type="text" class="form-input" id="brideName" name="brideName" placeholder="e.g., Sarah" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="groomName">Groom Name</label>
                            <input type="text" class="form-input" id="groomName" name="groomName" placeholder="e.g., James" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="brideImage">Bride Image</label>
                            <input type="file" class="form-input" id="brideImage" name="brideImage" accept="image/*" autocomplete="off" onchange="previewImage(this, 'brideImagePreview')">
                            <div id="brideImagePreview" class="image-preview"></div>
                    </div>
                        <div class="form-group">
                            <label class="form-label" for="groomImage">Groom Image</label>
                            <input type="file" class="form-input" id="groomImage" name="groomImage" accept="image/*" autocomplete="off" onchange="previewImage(this, 'groomImagePreview')">
                            <div id="groomImagePreview" class="image-preview"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="muhurthamTime">Muhurtham Time</label>
                            <input type="text" class="form-input" id="muhurthamTime" name="muhurthamTime" placeholder="e.g., 10:30 AM" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="receptionTime">Reception Time</label>
                            <input type="text" class="form-input" id="receptionTime" name="receptionTime" placeholder="e.g., 7:00 PM" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="loveStory">Love Story (Optional)</label>
                            <textarea class="form-textarea" id="loveStory" name="loveStory" rows="3" placeholder="Share your beautiful love story..." autocomplete="off"></textarea>
                    </div>
                </div>

                <div id="birthdayFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Birthday Details</h4>
                        <div class="form-group">
                            <label class="form-label" for="birthdayPerson">Birthday Person Name</label>
                            <input type="text" class="form-input" id="birthdayPerson" name="birthdayPerson" placeholder="e.g., Emma" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="age">Age</label>
                            <input type="text" class="form-input" id="age" name="age" placeholder="e.g., 16" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="birthdayImage">Birthday Person Image</label>
                            <input type="file" class="form-input" id="birthdayImage" name="birthdayImage" accept="image/*" autocomplete="off" onchange="previewImage(this, 'birthdayImagePreview')">
                            <div id="birthdayImagePreview" class="image-preview"></div>
                    </div>
                        <div class="form-group">
                            <label class="form-label" for="startTime">Party Start Time</label>
                            <input type="text" class="form-input" id="startTime" name="startTime" placeholder="e.g., 5:00 PM" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="dinnerTime">Dinner Time</label>
                            <input type="text" class="form-input" id="dinnerTime" name="dinnerTime" placeholder="e.g., 8:00 PM" autocomplete="off">
                    </div>
                </div>

                    <div id="anniversaryFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Anniversary Details</h4>
                        <div class="form-group">
                            <label class="form-label" for="coupleNames">Couple Names</label>
                            <input type="text" class="form-input" id="coupleNames" name="coupleNames" placeholder="e.g., Sarah & James" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="marriageYears">Marriage Years</label>
                            <input type="text" class="form-input" id="marriageYears" name="marriageYears" placeholder="e.g., 25" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="coupleImage">Couple Image</label>
                            <input type="file" class="form-input" id="coupleImage" name="coupleImage" accept="image/*" autocomplete="off" onchange="previewImage(this, 'coupleImagePreview')">
                            <div id="coupleImagePreview" class="image-preview"></div>
                    </div>
                        <div class="form-group">
                            <label class="form-label" for="anniversaryDinnerTime">Anniversary Dinner Time</label>
                            <input type="text" class="form-input" id="anniversaryDinnerTime" name="anniversaryDinnerTime" placeholder="e.g., 7:00 PM" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="partyTime">Party Time</label>
                            <input type="text" class="form-input" id="partyTime" name="partyTime" placeholder="e.g., 9:00 PM" autocomplete="off">
                        </div>
                    </div>

                    <div id="babyshowerFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Baby Shower Details</h4>
                        <div class="form-group">
                            <label class="form-label" for="motherName">Mother Name</label>
                            <input type="text" class="form-input" id="motherName" name="motherName" placeholder="e.g., Sarah" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="fatherName">Father Name</label>
                            <input type="text" class="form-input" id="fatherName" name="fatherName" placeholder="e.g., James" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="babyshowerStartTime">Baby Shower Start Time</label>
                            <input type="text" class="form-input" id="babyshowerStartTime" name="babyshowerStartTime" placeholder="e.g., 2:00 PM" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="babyshowerEndTime">Baby Shower End Time</label>
                            <input type="text" class="form-input" id="babyshowerEndTime" name="babyshowerEndTime" placeholder="e.g., 6:00 PM" autocomplete="off">
                    </div>
                </div>

                <div id="graduationFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Graduation Details</h4>
                        <div class="form-group">
                            <label class="form-label" for="graduateName">Graduate Name</label>
                            <input type="text" class="form-input" id="graduateName" name="graduateName" placeholder="e.g., Alex" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="degree">Degree</label>
                            <input type="text" class="form-input" id="degree" name="degree" placeholder="e.g., Bachelor of Science" autocomplete="organization-title">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="school">School/University</label>
                            <input type="text" class="form-input" id="school" name="school" placeholder="e.g., University Name" autocomplete="organization">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="major">Major/Field</label>
                            <input type="text" class="form-input" id="major" name="major" placeholder="e.g., Computer Science" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="graduateImage">Graduate Image</label>
                            <input type="file" class="form-input" id="graduateImage" name="graduateImage" accept="image/*" autocomplete="off" onchange="previewImage(this, 'graduateImagePreview')">
                            <div id="graduateImagePreview" class="image-preview"></div>
                    </div>
                </div>

                    <div id="retirementFields" class="event-specific-fields" style="display: none;">
                        <h4 class="section-title">Retirement Details</h4>
                        <div class="form-group">
                            <label class="form-label" for="honoreeName">Honoree Name</label>
                            <input type="text" class="form-input" id="honoreeName" name="honoreeName" placeholder="e.g., John Smith" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="position">Position</label>
                            <input type="text" class="form-input" id="position" name="position" placeholder="e.g., Senior Manager" autocomplete="organization-title">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="company">Company</label>
                            <input type="text" class="form-input" id="company" name="company" placeholder="e.g., ABC Corporation" autocomplete="organization">
                    </div>
                        <div class="form-group">
                            <label class="form-label" for="startYear">Start Year</label>
                            <input type="text" class="form-input" id="startYear" name="startYear" placeholder="e.g., 1995" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="honoreeImage">Honoree Image</label>
                            <input type="file" class="form-input" id="honoreeImage" name="honoreeImage" accept="image/*" autocomplete="off" onchange="previewImage(this, 'honoreeImagePreview')">
                            <div id="honoreeImagePreview" class="image-preview"></div>
                    </div>
                </div>

                    <!-- Gallery Images -->
                        <div class="form-group">
                        <label class="form-label" for="galleryImages">Gallery Images (Multiple)</label>
                        <input type="file" class="form-input" id="galleryImages" name="galleryImages" accept="image/*" multiple autocomplete="off" onchange="previewMultipleImages(this, 'galleryPreview')">
                        <div id="galleryPreview" class="gallery-preview"></div>
                        </div>
                </form>
                    </div>
                </div>
                        </div>

            <!-- Right - Live Preview Section -->
            <div class="editor-preview-section">
                <div class="preview-header" style="position: sticky !important; top: 0 !important; background: #f8f9fa !important; z-index: 100 !important; padding: 15px 0 !important; margin-bottom: 10px !important; border-bottom: 2px solid #e0e0e0 !important;">
                    <h3 class="preview-title">Live Preview</h3>
                    <div class="view-toggle-buttons">
                        <button class="view-toggle-btn active" data-view="desktop" id="desktopViewBtn">
                            <i class="fas fa-desktop"></i> Desktop
                        </button>
                        <button class="view-toggle-btn" data-view="mobile" id="mobileViewBtn">
                            <i class="fas fa-mobile-alt"></i> Mobile
                        </button>
                    </div>
                </div>
                
                <!-- Desktop Preview View - SCROLLABLE -->
                <div class="preview-desktop-view" id="desktopPreviewView" style="display: block !important; visibility: visible !important; opacity: 1 !important; width: 100% !important; max-width: 100% !important; height: auto !important; overflow-y: visible !important; overflow-x: hidden !important; position: relative !important; padding: 10px 0 !important;">
                    <div class="live-preview-card" style="display: flex !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 10 !important; background: rgba(255, 255, 255, 0.98) !important; border-radius: 16px !important; padding: 24px !important; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important; min-height: auto !important; width: 100% !important; max-width: 100% !important; margin: 0 !important; overflow-y: visible !important; overflow-x: visible !important;">
                        <div class="preview-content" style="display: flex !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 10 !important; width: 100% !important; max-width: 100% !important; height: auto !important; overflow: visible !important;">
                    <div class="invitation-preview {% if template_id and selected_template_obj and selected_template_obj.preview_image %}template-bg{% endif %}" 
                         id="invitationPreviewCard"
                         style="display: flex !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 0 !important; min-height: auto !important; height: auto !important; width: 100% !important; background-size: 100% 100% !important; background-position: center center !important; background-repeat: no-repeat !important;" 
                         {% if template_id and selected_template_obj and selected_template_obj.preview_image %}data-template-image="{{ selected_template_obj.preview_image|e }}"{% endif %}
                         data-selected-template="{{ selected_template|default('')|e }}"
                         data-template-id="{% if template_id %}{{ template_id|int }}{% else %}{% endif %}"
                         data-event-type="{{ (event_type or '')|e }}"
                         {% if selected_template_obj and selected_template_obj.preview_image %}data-template-image-url="{{ selected_template_obj.preview_image|e }}"{% endif %}>
                        <!-- Main Image Container - At the top of template -->
                        <div id="previewMainImageContainer" style="display: none; position: relative; z-index: 15 !important; width: 100%; margin-bottom: 20px; display: flex !important; justify-content: center !important; align-items: center !important;">
                            <img id="previewMainImage" class="preview-main-image" src="" alt="Main Image" style="display: none;">
                    </div>
                        <div id="previewBrideGroomContainer" class="preview-images-container" style="display: none;">
                            <img id="previewBrideImage" class="preview-image-overlay" src="" alt="Bride" style="display: none;">
                            <img id="previewGroomImage" class="preview-image-overlay" src="" alt="Groom" style="display: none;">
                        </div>
                        <div id="previewBirthdayImageContainer" style="display: none;">
                            <img id="previewBirthdayImage" class="preview-image-overlay" src="" alt="Birthday Person">
                        </div>
                        <div id="previewCoupleImageContainer" style="display: none;">
                            <img id="previewCoupleImage" class="preview-image-overlay" src="" alt="Couple">
                    </div>
                        <div id="previewGraduateImageContainer" style="display: none;">
                            <img id="previewGraduateImage" class="preview-image-overlay" src="" alt="Graduate">
                </div>
                        <div id="previewHonoreeImageContainer" style="display: none;">
                            <img id="previewHonoreeImage" class="preview-image-overlay" src="" alt="Honoree">
            </div>
                        <div class="preview-icon" id="previewIcon" style="display: none;">{% if event_type == 'wedding' %}ðŸ’{% elif event_type == 'birthday' %}ðŸŽ‚{% elif event_type == 'anniversary' %}ðŸ’‘{% elif event_type == 'graduation' %}ðŸŽ“{% elif event_type == 'babyshower' %}ðŸ‘¶{% elif event_type == 'retirement' %}ðŸŽ‰{% else %}ðŸŽŠ{% endif %}</div>
                        <div class="preview-event-name" id="previewEventName" style="display: block;">
                            Your Event Name
                        </div>
                        
                        <!-- Event-Specific Preview Fields -->
                        <div class="preview-bride-groom" id="previewBrideGroom" style="display: none;">
                            <span id="previewBrideName"></span> & <span id="previewGroomName"></span>
                        </div>
                        <div class="preview-birthday-person" id="previewBirthdayPerson" style="display: none;">
                            <span id="previewBirthdayPersonName"></span> <span id="previewAge" style="font-weight: bold;"></span>
                        </div>
                        <div class="preview-couple-names" id="previewCoupleNames" style="display: none;">
                            <span id="previewCoupleNamesText"></span>
                        </div>
                        <div class="preview-mother-father" id="previewMotherFather" style="display: none;">
                            <span id="previewMotherName"></span><span id="previewMotherFatherSeparator" style="display: none;"> & </span><span id="previewFatherName"></span>
                        </div>
                        <div class="preview-graduate" id="previewGraduate" style="display: none;">
                            <span id="previewGraduateName"></span> - <span id="previewDegree"></span>
                        </div>
                        
                        <div class="preview-date-time" id="previewDate" style="display: none;">
                            <i class="fas fa-calendar"></i>
                            <span id="previewDateText"></span>
            </div>
                        <div class="preview-date-time" id="previewTime" style="display: none;">
                            <i class="fas fa-clock"></i>
                            <span id="previewTimeText"></span>
                </div>
                        <div class="preview-venue" id="previewVenue" style="display: none;">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="previewVenueText"></span>
                    </div>
                        <div class="preview-hosted" id="previewHosted" style="display: none;">
                            <i class="fas fa-user"></i> <span id="previewHostedLabel">Hosted by</span> <span id="previewHostedText"></span>
                    </div>
                        <div class="preview-message" id="previewMessage" style="display: none;">
                            <span id="previewMessageText"></span>
                    </div>
                        
                        <!-- Gallery Images Section - At the bottom of template card -->
                        <div id="previewGallerySection" style="display: none; margin-top: 30px; padding-top: 20px; padding-bottom: 15px; border-top: 2px solid rgba(160, 120, 120, 0.4); position: relative; z-index: 25 !important; width: 100%;">
                            <h3 class="text-center mb-4 preview-gallery-title" style="color: #6F4E37 !important; font-weight: 700; font-size: 1.5rem; position: relative; z-index: 25 !important; visibility: visible !important; opacity: 1 !important; margin-bottom: 20px !important; text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.9); background: rgba(255, 255, 255, 0.7); padding: 8px 16px; border-radius: 8px; display: inline-block;">
                                <i class="fas fa-images me-2"></i><span id="previewGalleryTitleText">Our Memories</span>
                            </h3>
                            <div class="preview-gallery-grid" id="previewGalleryGrid" style="display: grid !important; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)) !important; gap: 15px !important; position: relative; z-index: 25 !important; visibility: visible !important; opacity: 1 !important; width: 100%; padding: 10px 0;"></div>
                        </div>
                        
                        <div class="preview-placeholder" id="previewPlaceholder" style="display: none !important; visibility: hidden !important; opacity: 0 !important; position: absolute !important; pointer-events: none !important;">
                            <i class="fas fa-magic" style="font-size: 32px; color: #6F4E37; margin-bottom: 10px; display: block;"></i>
                            <p style="margin: 0; font-weight: 500; color: #6F4E37;">Start filling the form to see your invitation preview</p>
                            <p style="margin: 10px 0 0 0; font-size: 12px; color: #8B7355;">Your changes will appear here in real-time</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-navigation" style="display: flex !important; visibility: visible !important; opacity: 1 !important;">
            <button class="btn-back" onclick="goBack()" style="visibility: visible !important; opacity: 1 !important; display: inline-flex !important; position: relative !important; z-index: 100 !important;">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <button class="btn-preview" onclick="submitForm()" style="visibility: visible !important; opacity: 1 !important; display: inline-flex !important; background: linear-gradient(135deg, #6F4E37 0%, #D4AF37 100%) !important; color: #FFFFFF !important; border: 3px solid #FFFFFF !important; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(111, 78, 55, 0.5) !important; position: relative !important; z-index: 100 !important;">
                Preview <i class="fas fa-arrow-right" style="color: #FFFFFF !important; visibility: visible !important; opacity: 1 !important;"></i>
                </button>
            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile Preview View - SCROLLABLE -->
                <div class="preview-mobile-view" id="mobilePreviewView">
                    <div class="live-preview-card" style="display: flex !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 10 !important; background: rgba(255, 255, 255, 0.98) !important; border-radius: 16px !important; padding: 24px !important; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important; width: 100% !important; max-width: 100% !important; margin: 10px 0 !important; overflow-y: visible !important;">
                        <div class="preview-content" style="display: flex !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 10 !important; width: 100% !important; max-width: 100% !important; height: auto !important; overflow: visible !important; flex-direction: column !important; align-items: center !important;">
                            <div class="invitation-preview {% if template_id and selected_template_obj and selected_template_obj.preview_image %}template-bg{% endif %}" 
                                 id="invitationPreviewCardMobile"
                                 style="display: flex !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 0 !important; min-height: auto !important; height: auto !important; max-width: 400px !important; width: 100% !important; margin: 0 auto !important; background-size: 100% 100% !important; background-position: center center !important; transform: scale(0.85) !important; transform-origin: top center !important;" 
                                 {% if template_id and selected_template_obj and selected_template_obj.preview_image %}data-template-image="{{ selected_template_obj.preview_image|e }}"{% endif %}
                                 data-selected-template="{{ selected_template|default('')|e }}"
                                 data-template-id="{% if template_id %}{{ template_id|int }}{% else %}{% endif %}"
                                 data-event-type="{{ (event_type or '')|e }}"
                                 {% if selected_template_obj and selected_template_obj.preview_image %}data-template-image-url="{{ selected_template_obj.preview_image|e }}"{% endif %}>
                                <!-- Mobile preview content will be synced from desktop preview -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
</div>

<script>
    // Error handler to catch syntax errors - Enhanced
    window.addEventListener('error', function(e) {
        if (e.message && (e.message.includes('missing )') || e.message.includes('SyntaxError'))) {
            console.error('=== SYNTAX ERROR DETECTED ===');
            console.error('Message:', e.message);
            console.error('File:', e.filename);
            console.error('Line:', e.lineno);
            console.error('Column:', e.colno);
            if (e.error && e.error.stack) {
                console.error('Stack:', e.error.stack);
            }
        }
    }, true);
    
    // Get template variables from data attributes to avoid IDE parsing errors with Jinja2
    const invitationPreviewCard = document.getElementById('invitationPreviewCard');
    let selectedThemeValue = invitationPreviewCard ? (invitationPreviewCard.getAttribute('data-selected-template') || '') : '';

    // Global path normalization function - ensures all image paths use /images/ instead of /static/images/
    // CRITICAL: This function also blocks placeholder URLs completely
    function normalizeImagePath(url) {
        if (!url || typeof url !== 'string') return null;
        
        // CRITICAL: Block placeholder URLs FIRST before any processing
        if (url.includes('placeholder.com') || url.includes('via.placeholder') || url.includes('placeholder')) {
            console.warn('ðŸš« Placeholder URL blocked:', url);
            return null; // Return null for placeholder URLs
        }
        
        // Remove query params and fragments
        let cleanUrl = url.split('?')[0].split('#')[0];
        
        // Double-check for placeholder URLs after cleaning
        if (cleanUrl.includes('placeholder.com') || cleanUrl.includes('via.placeholder') || cleanUrl.includes('placeholder')) {
            console.warn('ðŸš« Placeholder URL detected after cleaning:', cleanUrl);
            return null;
        }
        
        // Skip external URLs and data URIs (but still check for placeholders)
        if (cleanUrl.startsWith('http')) {
            // Even for external URLs, block if they're placeholders
            if (cleanUrl.includes('placeholder.com') || cleanUrl.includes('via.placeholder')) {
                console.warn('ðŸš« External placeholder URL blocked:', cleanUrl);
                return null;
            }
            return cleanUrl;
        }
        
        if (cleanUrl.startsWith('data:')) {
            return cleanUrl; // Data URIs are safe
        }
        
        // Convert /static/images/ to /images/
        if (cleanUrl.includes('/static/images/')) {
            cleanUrl = cleanUrl.replace(/\/static\/images\//g, '/images/');
        }
        
        // Handle standalone filenames (like "wed.jpg", "birthday.jpg")
        const commonTemplateFiles = ['wed.jpg', 'birthday.jpg', 'corporateevent.jpg', 'birthdaycolourful.jpg', 'birthdayblackgold.jpg', 'ballonbirthday.jpg', 'grduationgold.jpg', 'GRDUATIONGOLD.jpg'];
        for (const fileName of commonTemplateFiles) {
            if (cleanUrl === fileName || cleanUrl.endsWith('/' + fileName) || cleanUrl.includes('/' + fileName + '?')) {
                cleanUrl = '/images/templatesimages/' + fileName;
                break;
            }
        }
        
        // If it's just a filename without path and it's an image file
        if (!cleanUrl.startsWith('/') && /\.(jpg|jpeg|png|gif)$/i.test(cleanUrl)) {
            cleanUrl = '/images/templatesimages/' + cleanUrl;
        }
        
        // Fix any remaining static paths
        if (cleanUrl.startsWith('/static/')) {
            cleanUrl = cleanUrl.replace('/static/', '/');
        }
        
        // Final check for placeholder URLs
        if (cleanUrl.includes('placeholder.com') || cleanUrl.includes('via.placeholder') || cleanUrl.includes('placeholder')) {
            console.warn('ðŸš« Placeholder URL detected in final check:', cleanUrl);
            return null;
        }
        
        return cleanUrl;
    }
    
    // Runtime protection: Prevent ANY placeholder URLs from being loaded or set
    // This protects against placeholder URLs that might slip through template filtering
    function blockPlaceholderUrls() {
        console.log('ðŸ›¡ï¸ Initializing placeholder URL blocking protection...');
        
        // Monitor all image elements for placeholder URLs
        const images = document.querySelectorAll('img');
        images.forEach(function(img) {
            // Check initial src
            if (img.src && (img.src.includes('placeholder.com') || img.src.includes('via.placeholder'))) {
                console.warn('ðŸš« Blocked placeholder URL in img src:', img.src);
                img.src = '/images/templatesimages/wedding.png'; // Default fallback
            }
            
            // Prevent placeholder URLs from being set dynamically
            const originalSetAttribute = img.setAttribute;
            img.setAttribute = function(name, value) {
                if (name === 'src' && value && (value.includes('placeholder.com') || value.includes('via.placeholder'))) {
                    console.warn('ðŸš« Prevented placeholder URL from being set:', value);
                    value = '/images/templatesimages/wedding.png'; // Default fallback
                }
                return originalSetAttribute.call(this, name, value);
            };
            
            // Also intercept direct src property assignment
            Object.defineProperty(img, 'src', {
                get: function() {
                    return this.getAttribute('src') || '';
                },
                set: function(value) {
                    if (value && (value.includes('placeholder.com') || value.includes('via.placeholder'))) {
                        console.warn('ðŸš« Prevented placeholder URL from being assigned:', value);
                        value = '/images/templatesimages/wedding.png'; // Default fallback
                    }
                    this.setAttribute('src', value);
                }
            });
        });
        
        // Monitor new images added dynamically
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1 && node.tagName === 'IMG') {
                        const img = node;
                        if (img.src && (img.src.includes('placeholder.com') || img.src.includes('via.placeholder'))) {
                            console.warn('ðŸš« Blocked placeholder URL in dynamically added img:', img.src);
                            img.src = '/images/templatesimages/wedding.png';
                        }
                    }
                });
            });
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        // Protect backgroundImage assignments on all elements
        const protectElement = function(element) {
            const originalSetProperty = CSSStyleDeclaration.prototype.setProperty;
            const originalBackgroundImageSetter = Object.getOwnPropertyDescriptor(CSSStyleDeclaration.prototype, 'backgroundImage')?.set;
            
            if (element && element.style) {
                // Override style.backgroundImage setter
                Object.defineProperty(element.style, 'backgroundImage', {
                    set: function(value) {
                        if (value && (value.includes('placeholder.com') || value.includes('via.placeholder') || value.includes('placeholder'))) {
                            console.error('âŒ Blocked placeholder URL in backgroundImage:', value);
                            value = value.replace(/url\([^)]*placeholder[^)]*\)/gi, "url('/images/templatesimages/wedding.png')");
                        }
                        if (originalBackgroundImageSetter) {
                            originalBackgroundImageSetter.call(this, value);
                        } else {
                            this.setProperty('background-image', value);
                        }
                    },
                    get: function() {
                        return this.getPropertyValue('background-image');
                    },
                    configurable: true
                });
            }
        };
        
        // Protect all existing elements
        document.querySelectorAll('*').forEach(protectElement);
        
        // Protect preview card specifically
        const previewCard = document.getElementById('invitationPreviewCard');
        if (previewCard) {
            protectElement(previewCard);
        }
    }
    
    // Run protection immediately and on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', blockPlaceholderUrls);
    } else {
        blockPlaceholderUrls();
    }

    // Optimized: Live Preview Updates - Debounced for better performance
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Function to show/hide images based on event type - Define early to avoid timing issues
    window.showEventSpecificImages = function(eventType) {
        const eventTypeLower = (eventType || '').toLowerCase().trim();
        
        // Hide all image containers first
        const imageContainers = {
            'main': document.getElementById('previewMainImageContainer'),
            'brideGroom': document.getElementById('previewBrideGroomContainer'),
            'birthday': document.getElementById('previewBirthdayImageContainer'),
            'couple': document.getElementById('previewCoupleImageContainer'),
            'graduate': document.getElementById('previewGraduateImageContainer'),
            'honoree': document.getElementById('previewHonoreeImageContainer')
        };
        
        // Hide all containers
        Object.values(imageContainers).forEach(container => {
            if (container) {
                container.style.display = 'none';
                container.style.setProperty('display', 'none', 'important');
            }
        });
        
        // Show only relevant images based on event type
        if (eventTypeLower === 'wedding') {
            // Wedding: Show bride and groom images
            if (imageContainers.brideGroom) {
                const brideImg = document.getElementById('previewBrideImage');
                const groomImg = document.getElementById('previewGroomImage');
                if (brideImg && brideImg.src && brideImg.src !== '' && !brideImg.src.includes('data:,')) {
                    imageContainers.brideGroom.style.display = 'flex';
                    imageContainers.brideGroom.style.setProperty('display', 'flex', 'important');
                } else if (groomImg && groomImg.src && groomImg.src !== '' && !groomImg.src.includes('data:,')) {
                    imageContainers.brideGroom.style.display = 'flex';
                    imageContainers.brideGroom.style.setProperty('display', 'flex', 'important');
                }
            }
        } else if (eventTypeLower === 'birthday') {
            // Birthday: Show only birthday image
            if (imageContainers.birthday) {
                const birthdayImg = document.getElementById('previewBirthdayImage');
                if (birthdayImg && birthdayImg.src && birthdayImg.src !== '' && !birthdayImg.src.includes('data:,')) {
                    imageContainers.birthday.style.display = 'block';
                    imageContainers.birthday.style.setProperty('display', 'block', 'important');
                }
            }
        } else if (eventTypeLower === 'anniversary') {
            // Anniversary: Show couple image
            if (imageContainers.couple) {
                const coupleImg = document.getElementById('previewCoupleImage');
                if (coupleImg && coupleImg.src && coupleImg.src !== '' && !coupleImg.src.includes('data:,')) {
                    imageContainers.couple.style.display = 'block';
                    imageContainers.couple.style.setProperty('display', 'block', 'important');
                }
            }
        } else if (eventTypeLower === 'graduation') {
            // Graduation: Show graduate image
            if (imageContainers.graduate) {
                const graduateImg = document.getElementById('previewGraduateImage');
                if (graduateImg && graduateImg.src && graduateImg.src !== '' && !graduateImg.src.includes('data:,')) {
                    imageContainers.graduate.style.display = 'block';
                    imageContainers.graduate.style.setProperty('display', 'block', 'important');
                }
            }
        } else if (eventTypeLower === 'babyshower' || eventTypeLower === 'baby shower') {
            // Baby Shower: Show ONLY main image (baby photo), NOT bride/groom
            if (imageContainers.main) {
                const mainImg = document.getElementById('previewMainImage');
                if (mainImg && mainImg.src && mainImg.src !== '' && !mainImg.src.includes('data:,')) {
                    imageContainers.main.style.display = 'block';
                    imageContainers.main.style.setProperty('display', 'block', 'important');
                    imageContainers.main.style.visibility = 'visible';
                    imageContainers.main.style.opacity = '1';
                }
            }
            // Explicitly hide bride/groom for baby shower
            if (imageContainers.brideGroom) {
                imageContainers.brideGroom.style.display = 'none';
                imageContainers.brideGroom.style.setProperty('display', 'none', 'important');
                imageContainers.brideGroom.style.visibility = 'hidden';
                imageContainers.brideGroom.style.opacity = '0';
            }
        } else if (eventTypeLower === 'retirement') {
            // Retirement: Show honoree image
            if (imageContainers.honoree) {
                const honoreeImg = document.getElementById('previewHonoreeImage');
                if (honoreeImg && honoreeImg.src && honoreeImg.src !== '' && !honoreeImg.src.includes('data:,')) {
                    imageContainers.honoree.style.display = 'block';
                    imageContainers.honoree.style.setProperty('display', 'block', 'important');
                }
            }
        }
        
        // Main image: Only show for baby shower (other event types have specific images)
        if (eventTypeLower === 'babyshower' || eventTypeLower === 'baby shower') {
            // Already handled above for baby shower
        } else if (imageContainers.main) {
            // For other event types, hide main image if they have specific images
            const mainImg = document.getElementById('previewMainImage');
            if (mainImg) {
                imageContainers.main.style.display = 'none';
                imageContainers.main.style.setProperty('display', 'none', 'important');
            }
        }
    };

    // Function to toggle white background on form groups based on content - Global scope
    window.toggleFormGroupBackground = function() {
        const allInputs = document.querySelectorAll('.form-input, .form-textarea, select.form-input');
        allInputs.forEach(input => {
            const formGroup = input.closest('.form-group');
            if (formGroup) {
                // Check if input has value
                const hasValue = (input.value && input.value.trim() !== '') || 
                                (input.files && input.files.length > 0) ||
                                (input.type === 'file' && input.files && input.files.length > 0);
                
                if (hasValue) {
                    formGroup.classList.add('has-content');
                } else {
                    formGroup.classList.remove('has-content');
                }
            }
        });
    };

    // Function to hide placeholder immediately when any field has content - DEFINED EARLY
    function hidePlaceholderIfContent() {
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        if (!previewPlaceholder) return;
        
        // Check all form inputs for content
        const eventName = document.getElementById('eventName')?.value.trim();
        const eventDate = document.getElementById('eventDate')?.value;
        const eventTime = document.getElementById('eventTime')?.value;
        const venueName = document.getElementById('venueName')?.value.trim();
        const venueAddress = document.getElementById('venueAddress')?.value.trim();
        const hostedBy = document.getElementById('hostedBy')?.value.trim();
        const personalMessage = document.getElementById('personalMessage')?.value.trim();
        const mainImage = document.getElementById('mainImage')?.files.length > 0;
        
        // Check event-specific fields
        const brideName = document.getElementById('brideName')?.value.trim();
        const groomName = document.getElementById('groomName')?.value.trim();
        const birthdayPerson = document.getElementById('birthdayPerson')?.value.trim();
        const coupleNames = document.getElementById('coupleNames')?.value.trim();
        const motherName = document.getElementById('motherName')?.value.trim();
        const fatherName = document.getElementById('fatherName')?.value.trim();
        const graduateName = document.getElementById('graduateName')?.value.trim();
        const honoreeName = document.getElementById('honoreeName')?.value.trim();
        
        const hasAnyContent = eventName || eventDate || eventTime || venueName || venueAddress || 
                              hostedBy || personalMessage || mainImage || brideName || groomName ||
                              birthdayPerson || coupleNames || motherName || fatherName ||
                              graduateName || honoreeName;
        
        if (hasAnyContent) {
            // Use setProperty with !important to override inline styles
            previewPlaceholder.style.setProperty('display', 'none', 'important');
            previewPlaceholder.style.setProperty('visibility', 'hidden', 'important');
            previewPlaceholder.style.setProperty('opacity', '0', 'important');
        }
    }
    
    // Make function globally available
    window.hidePlaceholderIfContent = hidePlaceholderIfContent;

    // Live Preview Updates - Optimized with debouncing
        document.addEventListener('DOMContentLoaded', function() {
        // Hide placeholder immediately if there's any content in form fields
        hidePlaceholderIfContent();
        
        const eventNameInput = document.getElementById('eventName');
        const previewEventName = document.getElementById('previewEventName');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const previewIcon = document.getElementById('previewIcon');

        // Get all form inputs for preview
        const eventDateInput = document.getElementById('eventDate');
        const eventTimeInput = document.getElementById('eventTime');
        
        // Fix date input to accept manual typing in multiple formats
        if (eventDateInput) {
            // Hide placeholder when date is entered
            eventDateInput.addEventListener('input', function(e) {
                if (typeof hidePlaceholderIfContent === 'function') {
                    hidePlaceholderIfContent();
                }
            });
            // Allow manual typing and format conversion
            eventDateInput.addEventListener('input', function(e) {
                let value = e.target.value;
                // If user types DD-MM-YYYY or DD/MM/YYYY, convert to YYYY-MM-DD
                if (value.match(/^\d{2}[-\/]\d{2}[-\/]\d{4}$/)) {
                    const parts = value.split(/[-\/]/);
                    if (parts.length === 3) {
                        const day = parts[0];
                        const month = parts[1];
                        const year = parts[2];
                        // Validate date
                        const date = new Date(year, month - 1, day);
                        if (date.getDate() == day && date.getMonth() == month - 1 && date.getFullYear() == year) {
                            e.target.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                        }
                    }
                }
            });
        }
        
        const venueNameInput = document.getElementById('venueName');
        const venueAddressInput = document.getElementById('venueAddress');
        const hostedByInput = document.getElementById('hostedBy');
        const personalMessageInput = document.getElementById('personalMessage');
        
        // Event-specific form inputs
        const brideNameInput = document.getElementById('brideName');
        const groomNameInput = document.getElementById('groomName');
        const birthdayPersonInput = document.getElementById('birthdayPerson');
        const ageInput = document.getElementById('age');
        const coupleNamesInput = document.getElementById('coupleNames');
        const marriageYearsInput = document.getElementById('marriageYears');
        const motherNameInput = document.getElementById('motherName');
        const fatherNameInput = document.getElementById('fatherName');
        const graduateNameInput = document.getElementById('graduateName');
        const degreeInput = document.getElementById('degree');
        const schoolInput = document.getElementById('school');
        const majorInput = document.getElementById('major');
        const muhurthamTimeInput = document.getElementById('muhurthamTime');
        const receptionTimeInput = document.getElementById('receptionTime');
        const startTimeInput = document.getElementById('startTime');
        const dinnerTimeInput = document.getElementById('dinnerTime');
        const babyshowerStartTimeInput = document.getElementById('babyshowerStartTime');
        const babyshowerEndTimeInput = document.getElementById('babyshowerEndTime');
        const anniversaryDinnerTimeInput = document.getElementById('anniversaryDinnerTime');
        const partyTimeInput = document.getElementById('partyTime');
        
        // Preview elements
        const previewDate = document.getElementById('previewDate');
        const previewDateText = document.getElementById('previewDateText');
        const previewTime = document.getElementById('previewTime');
        const previewTimeText = document.getElementById('previewTimeText');
        const previewVenue = document.getElementById('previewVenue');
        const previewVenueText = document.getElementById('previewVenueText');
        const previewHosted = document.getElementById('previewHosted');
        const previewHostedText = document.getElementById('previewHostedText');
        const previewMessage = document.getElementById('previewMessage');
        const previewMessageText = document.getElementById('previewMessageText');
        
        // Event-specific preview elements
        const previewBrideGroom = document.getElementById('previewBrideGroom');
        const previewBrideName = document.getElementById('previewBrideName');
        const previewGroomName = document.getElementById('previewGroomName');
        const previewBirthdayPerson = document.getElementById('previewBirthdayPerson');
        const previewBirthdayPersonName = document.getElementById('previewBirthdayPersonName');
        const previewAge = document.getElementById('previewAge');
        const previewCoupleNames = document.getElementById('previewCoupleNames');
        const previewCoupleNamesText = document.getElementById('previewCoupleNamesText');
        const previewMotherFather = document.getElementById('previewMotherFather');
        const previewMotherName = document.getElementById('previewMotherName');
        const previewFatherName = document.getElementById('previewFatherName');
        const previewGraduate = document.getElementById('previewGraduate');
        const previewGraduateName = document.getElementById('previewGraduateName');
        const previewDegree = document.getElementById('previewDegree');

        // Store selected template info
        let selectedTemplateId = null;
        let selectedTemplateImage = null;
        let selectedTemplateName = null;

        // Function to detect background brightness and adjust text colors
        function adjustTextColorsForBackground(previewCard) {
            if (!previewCard) return;
            
            // Get computed background image
            const bgImage = window.getComputedStyle(previewCard).backgroundImage;
            if (!bgImage || bgImage === 'none' || bgImage === '') {
                // No background image, use default colors
                resetTextColorsToDefault();
                return;
            }
            
            // Extract image URL from background-image CSS
            const urlMatch = bgImage.match(/url\(['"]?([^'"]+)['"]?\)/);
            if (!urlMatch || !urlMatch[1]) {
                resetTextColorsToDefault();
                return;
            }
            
            const imageUrl = urlMatch[1];
            
            // Create an image to analyze brightness
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
                try {
                    // Create canvas to analyze image
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    canvas.width = Math.min(img.width, 100); // Sample size
                    canvas.height = Math.min(img.height, 100);
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Sample pixels from different areas (top, middle, bottom, left, center, right)
                    const samplePoints = [
                        { x: 0, y: 0 }, // Top-left
                        { x: canvas.width / 2, y: 0 }, // Top-center
                        { x: canvas.width - 1, y: 0 }, // Top-right
                        { x: 0, y: canvas.height / 2 }, // Middle-left
                        { x: canvas.width / 2, y: canvas.height / 2 }, // Center
                        { x: canvas.width - 1, y: canvas.height / 2 }, // Middle-right
                        { x: 0, y: canvas.height - 1 }, // Bottom-left
                        { x: canvas.width / 2, y: canvas.height - 1 }, // Bottom-center
                        { x: canvas.width - 1, y: canvas.height - 1 } // Bottom-right
                    ];
                    
                    let totalBrightness = 0;
                    samplePoints.forEach(point => {
                        try {
                            const pixel = ctx.getImageData(Math.floor(point.x), Math.floor(point.y), 1, 1);
                        const r = pixel.data[0];
                        const g = pixel.data[1];
                        const b = pixel.data[2];
                        // Calculate brightness using relative luminance formula
                        const brightness = (0.299 * r + 0.587 * g + 0.114 * b);
                        totalBrightness += brightness;
                        } catch (e) {
                            console.warn('Error sampling pixel:', e);
                        }
                    });
                    
                    const avgBrightness = totalBrightness / samplePoints.length;
                    const isDark = avgBrightness < 128; // Threshold for dark background
                    
                    // Apply text colors based on brightness
                    applyTextColors(isDark);
                    
                } catch (e) {
                    console.warn('Error analyzing background brightness:', e);
                    resetTextColorsToDefault();
                }
            };
            
            img.onerror = function() {
                console.warn('Could not load background image for brightness analysis');
                resetTextColorsToDefault();
            };
            
            img.src = imageUrl;
        }
        
        // Apply text colors based on background brightness
        function applyTextColors(isDark) {
            const textElements = [
                '.preview-event-name',
                '.preview-date-time',
                '.preview-venue',
                '.preview-hosted',
                '.preview-message',
                '.preview-bride-groom',
                '.preview-birthday-person',
                '.preview-couple-names',
                '.preview-mother-father',
                '.preview-graduate',
                '.preview-gallery-title'
            ];
            
            const previewCard = document.getElementById('invitationPreviewCard');
            if (!previewCard) return;
            
            textElements.forEach(selector => {
                const elements = previewCard.querySelectorAll(selector);
                elements.forEach(el => {
                    if (isDark) {
                        // Dark background - use light text with shadow
                        el.style.color = '#FFFFFF';
                        el.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.8), 0 0 8px rgba(0, 0, 0, 0.5)';
                    } else {
                        // Light background - use dark text
                        el.style.color = '#6F4E37';
                        el.style.textShadow = '1px 1px 2px rgba(255, 255, 255, 0.8)';
                    }
                });
            });
        }
        
        // Reset text colors to default
        function resetTextColorsToDefault() {
            const previewCard = document.getElementById('invitationPreviewCard');
            if (!previewCard) return;
            
            const textElements = previewCard.querySelectorAll('.preview-event-name, .preview-date-time, .preview-venue, .preview-hosted, .preview-message, .preview-bride-groom, .preview-birthday-person, .preview-couple-names, .preview-mother-father, .preview-graduate, .preview-gallery-title');
            textElements.forEach(el => {
                el.style.color = '#6F4E37';
                el.style.textShadow = '1px 1px 2px rgba(255, 255, 255, 0.8)';
            });
        }

        // Update preview background based on selected template
        function updatePreviewBackground(templateId, templateImage, templateName) {
            const previewCard = document.getElementById('invitationPreviewCard');
            
            if (!previewCard || !templateImage) {
                console.warn('Preview card or template image not found');
                return;
            }
            
            // Normalize the image path first
            templateImage = normalizeImagePath(templateImage);
            
            // Skip if normalization returned null (placeholder URL) or empty
            if (!templateImage) {
                console.warn('Template image path is invalid (placeholder URL or empty)');
                return;
            }
            
            if (templateId && templateImage) {
                selectedTemplateId = templateId;
                selectedTemplateImage = templateImage;
                selectedTemplateName = templateName;
                
                // Remove all template classes
                previewCard.classList.remove('wedding-bg');
                // Add template-bg class to show template image as overlay
                previewCard.classList.add('template-bg');
                
                // CRITICAL: Don't set background: 'none' as it resets background-image!
                // Only remove the background shorthand, not background-image
                previewCard.style.removeProperty('background');
                previewCard.style.backgroundColor = 'transparent';
                
                // CRITICAL: Block placeholder URLs before setting overlay
                let bgImage = templateImage;
                if (bgImage && (bgImage.includes('placeholder.com') || bgImage.includes('via.placeholder') || bgImage.includes('placeholder'))) {
                    console.error('âŒ Attempted to set placeholder URL as overlay, blocked:', bgImage);
                    bgImage = '/images/templatesimages/wedding.png'; // Default fallback
                }
                
                // Set template image using CSS variable (used by CSS rule)
                const bgImageUrl = `url('${bgImage}')`;
                previewCard.style.setProperty('--template-bg-image-url', bgImageUrl, 'important');
                
                // Also set inline style as fallback - Use 100% 100% to fill entire card
                previewCard.style.setProperty('background-image', bgImageUrl, 'important');
                previewCard.style.backgroundImage = bgImageUrl;
                previewCard.style.backgroundSize = '100% 100%';
                previewCard.style.backgroundPosition = 'center center';
                previewCard.style.backgroundRepeat = 'no-repeat';
                previewCard.style.backgroundAttachment = 'scroll';
                previewCard.style.setProperty('background-size', '100% 100%', 'important');
                previewCard.style.setProperty('background-position', 'center center', 'important');
                previewCard.style.setProperty('background-attachment', 'scroll', 'important');
                previewCard.style.setProperty('height', 'auto', 'important');
                previewCard.style.height = 'auto';
                
                console.log('ðŸ“ Layer Structure Applied:', {
                    'Layer 1 (z-index 0)': 'Template Design Background',
                    'Layer 2 (z-index 5)': 'User Uploaded Images',
                    'Layer 3 (z-index 10)': 'User Text Content',
                    templateDesign: bgImage
                });
                
                // Ensure background is visible with proper z-index
                previewCard.style.position = 'relative';
                previewCard.style.zIndex = '0';
                
                // Update hidden form fields for save
                const templateIdInput = document.getElementById('templateIdInput');
                const templateImageUrlInput = document.getElementById('templateImageUrlInput');
                if (templateIdInput) templateIdInput.value = templateId || '';
                if (templateImageUrlInput) templateImageUrlInput.value = bgImage || '';
                
                // Hide icon when template background is active (images will show instead)
                const previewIcon = document.getElementById('previewIcon');
                if (previewIcon) {
                    previewIcon.style.display = 'none';
                }
                
                // Log for debugging
                console.log('âœ… Template background applied to live preview:', {
                    templateId: templateId,
                    bgImage: bgImage,
                    templateName: templateName
                });
                
                // Adjust text colors based on background brightness
                setTimeout(() => {
                    adjustTextColorsForBackground(previewCard);
                }, 500); // Wait for background to load
                
                // Ensure all preview content is visible on top of template
                ensurePreviewContentVisible();
                
                // Filter images to show only event-specific ones
                const eventType = previewCard ? (previewCard.getAttribute('data-event-type') || '') : '';
                if (eventType) {
                // Call function if available (should always be available now)
                if (typeof window.showEventSpecificImages === 'function') {
                    window.showEventSpecificImages(eventType);
                }
                }
                
                // Force re-display of uploaded images on top of new template background
                setTimeout(() => {
                    // Main image
                    const mainImg = document.getElementById('previewMainImage');
                    const mainContainer = document.getElementById('previewMainImageContainer');
                    if (mainImg && mainImg.src && mainImg.src !== '' && mainContainer) {
                        mainContainer.style.display = 'block';
                        mainContainer.style.setProperty('display', 'block', 'important');
                        mainImg.style.display = 'block';
                        mainImg.style.setProperty('display', 'block', 'important');
                        mainImg.style.zIndex = '15';
                        mainImg.style.setProperty('z-index', '15', 'important');
                        mainImg.style.position = 'relative';
                        mainImg.style.visibility = 'visible';
                        mainImg.style.opacity = '1';
                        mainContainer.style.zIndex = '15';
                        mainContainer.style.setProperty('z-index', '15', 'important');
                        mainContainer.style.visibility = 'visible';
                        mainContainer.style.opacity = '1';
                    }
                    
                    // Bride and Groom images
                    const brideImg = document.getElementById('previewBrideImage');
                    const groomImg = document.getElementById('previewGroomImage');
                    const brideGroomContainer = document.getElementById('previewBrideGroomContainer');
                    if (brideGroomContainer) {
                        let shouldShow = false;
                        if (brideImg && brideImg.src && brideImg.src !== '') {
                            brideImg.style.display = 'block';
                            brideImg.style.setProperty('display', 'block', 'important');
                            brideImg.style.zIndex = '15';
                            brideImg.style.setProperty('z-index', '15', 'important');
                            brideImg.style.position = 'relative';
                            brideImg.style.visibility = 'visible';
                            brideImg.style.opacity = '1';
                            shouldShow = true;
                        }
                        if (groomImg && groomImg.src && groomImg.src !== '') {
                            groomImg.style.display = 'block';
                            groomImg.style.setProperty('display', 'block', 'important');
                            groomImg.style.zIndex = '15';
                            groomImg.style.setProperty('z-index', '15', 'important');
                            groomImg.style.position = 'relative';
                            groomImg.style.visibility = 'visible';
                            groomImg.style.opacity = '1';
                            shouldShow = true;
                        }
                        if (shouldShow) {
                            brideGroomContainer.style.display = 'flex';
                            brideGroomContainer.style.setProperty('display', 'flex', 'important');
                            brideGroomContainer.style.zIndex = '15';
                            brideGroomContainer.style.setProperty('z-index', '15', 'important');
                            brideGroomContainer.style.visibility = 'visible';
                            brideGroomContainer.style.opacity = '1';
                        }
                    }
                    
                    // Birthday image
                    const birthdayImg = document.getElementById('previewBirthdayImage');
                    const birthdayContainer = document.getElementById('previewBirthdayImageContainer');
                    if (birthdayImg && birthdayImg.src && birthdayImg.src !== '' && birthdayContainer) {
                        birthdayContainer.style.display = 'block';
                        birthdayContainer.style.setProperty('display', 'block', 'important');
                        birthdayImg.style.display = 'block';
                        birthdayImg.style.setProperty('display', 'block', 'important');
                        birthdayImg.style.zIndex = '15';
                        birthdayImg.style.setProperty('z-index', '15', 'important');
                        birthdayImg.style.position = 'relative';
                        birthdayImg.style.visibility = 'visible';
                        birthdayImg.style.opacity = '1';
                        birthdayContainer.style.zIndex = '15';
                        birthdayContainer.style.setProperty('z-index', '15', 'important');
                        birthdayContainer.style.visibility = 'visible';
                        birthdayContainer.style.opacity = '1';
                    }
                    
                    // Couple image
                    const coupleImg = document.getElementById('previewCoupleImage');
                    const coupleContainer = document.getElementById('previewCoupleImageContainer');
                    if (coupleImg && coupleImg.src && coupleImg.src !== '' && coupleContainer) {
                        coupleContainer.style.display = 'block';
                        coupleContainer.style.setProperty('display', 'block', 'important');
                        coupleImg.style.display = 'block';
                        coupleImg.style.setProperty('display', 'block', 'important');
                        coupleImg.style.zIndex = '15';
                        coupleImg.style.setProperty('z-index', '15', 'important');
                        coupleImg.style.position = 'relative';
                        coupleImg.style.visibility = 'visible';
                        coupleImg.style.opacity = '1';
                        coupleContainer.style.zIndex = '15';
                        coupleContainer.style.setProperty('z-index', '15', 'important');
                        coupleContainer.style.visibility = 'visible';
                        coupleContainer.style.opacity = '1';
                    }
                    
                    // Graduate image
                    const graduateImg = document.getElementById('previewGraduateImage');
                    const graduateContainer = document.getElementById('previewGraduateImageContainer');
                    if (graduateImg && graduateImg.src && graduateImg.src !== '' && graduateContainer) {
                        graduateContainer.style.display = 'block';
                        graduateContainer.style.setProperty('display', 'block', 'important');
                        graduateImg.style.display = 'block';
                        graduateImg.style.setProperty('display', 'block', 'important');
                        graduateImg.style.zIndex = '15';
                        graduateImg.style.setProperty('z-index', '15', 'important');
                        graduateImg.style.position = 'relative';
                        graduateImg.style.visibility = 'visible';
                        graduateImg.style.opacity = '1';
                        graduateContainer.style.zIndex = '15';
                        graduateContainer.style.setProperty('z-index', '15', 'important');
                        graduateContainer.style.visibility = 'visible';
                        graduateContainer.style.opacity = '1';
                    }
                    
                    // Honoree image
                    const honoreeImg = document.getElementById('previewHonoreeImage');
                    const honoreeContainer = document.getElementById('previewHonoreeImageContainer');
                    if (honoreeImg && honoreeImg.src && honoreeImg.src !== '' && honoreeContainer) {
                        honoreeContainer.style.display = 'block';
                        honoreeContainer.style.setProperty('display', 'block', 'important');
                        honoreeImg.style.display = 'block';
                        honoreeImg.style.setProperty('display', 'block', 'important');
                        honoreeImg.style.zIndex = '15';
                        honoreeImg.style.setProperty('z-index', '15', 'important');
                        honoreeImg.style.position = 'relative';
                        honoreeImg.style.visibility = 'visible';
                        honoreeImg.style.opacity = '1';
                        honoreeContainer.style.zIndex = '15';
                        honoreeContainer.style.setProperty('z-index', '15', 'important');
                        honoreeContainer.style.visibility = 'visible';
                        honoreeContainer.style.opacity = '1';
                    }
                    
                    console.log('Ensured all uploaded images remain visible on template background');
                }, 200);
                
                console.log('Template background updated:', bgImage);
            } else {
                // Reset to default - get from data attribute
                const eventTypeAttr = previewCard ? previewCard.getAttribute('data-event-type') : '';
                const currentEventType = (eventTypeAttr || '').toLowerCase();
                previewCard.style.backgroundImage = '';
                
                if (previewCard && currentEventType === 'wedding') {
                    previewCard.classList.add('wedding-bg');
                    previewCard.style.backgroundImage = "url('/images/templatesimages/wedding.png')";
                    previewCard.style.backgroundSize = '100% 100%';
                    previewCard.style.backgroundPosition = 'center center';
                    previewCard.style.backgroundRepeat = 'no-repeat';
                    previewCard.style.backgroundAttachment = 'scroll';
                    previewCard.style.height = 'auto';
                    
                    const previewIcon = document.getElementById('previewIcon');
                    if (previewIcon) {
                        previewIcon.style.display = 'none';
                    }
                } else {
                    previewCard.classList.remove('wedding-bg', 'template-bg');
                    previewCard.style.backgroundImage = '';
                    const previewIcon = document.getElementById('previewIcon');
                    if (previewIcon) {
                        previewIcon.style.display = 'block';
                    }
                }
            }
        }

        // Check sessionStorage for selected template and apply it immediately on page load
        window.addEventListener('load', function() {
            const storedBg = sessionStorage.getItem('selectedTemplateBackground');
            const storedTemplateId = sessionStorage.getItem('selectedTemplateId');
            
            if (storedBg && storedTemplateId) {
                const previewCard = document.getElementById('invitationPreviewCard');
                if (previewCard) {
                    console.log('ðŸ“‹ Applying stored template background from theme selection:', storedBg);
                    
                    // Apply the template background
                    // CRITICAL: Don't set background: 'none' as it resets background-image!
                    previewCard.style.removeProperty('background');
                    // CRITICAL: Final check before applying - block placeholder URLs
                    let safeBg = storedBg;
                    if (safeBg && (safeBg.includes('placeholder.com') || safeBg.includes('via.placeholder') || safeBg.includes('placeholder'))) {
                        console.error('âŒ Placeholder URL detected in storedBg from sessionStorage, using fallback:', safeBg);
                        safeBg = '/images/templatesimages/wedding.png';
                    }
                    
                    previewCard.style.backgroundColor = 'transparent';
                    previewCard.classList.remove('wedding-bg');
                    previewCard.classList.add('template-bg');
                    // Set template image directly as background-image - Use 100% 100% to fill entire card
                    previewCard.style.backgroundImage = `url('${safeBg}')`;
                    previewCard.style.backgroundSize = '100% 100%';
                    previewCard.style.backgroundPosition = 'center center';
                    previewCard.style.backgroundRepeat = 'no-repeat';
                    previewCard.style.backgroundAttachment = 'scroll';
                    previewCard.style.height = 'auto';
                    previewCard.style.setProperty('background-image', `url('${safeBg}')`, 'important');
                    previewCard.style.setProperty('background-size', '100% 100%', 'important');
                    previewCard.style.setProperty('background-position', 'center center', 'important');
                    previewCard.style.setProperty('background-attachment', 'scroll', 'important');
                    previewCard.style.setProperty('height', 'auto', 'important');
                    
                    // Call updatePreviewBackground to ensure everything is set up correctly
                    updatePreviewBackground(storedTemplateId, storedBg, 'Selected Template');
                    
                    // Clear sessionStorage after applying
                    sessionStorage.removeItem('selectedTemplateBackground');
                    sessionStorage.removeItem('selectedTemplateId');
                }
            }
        });

        // Initialize preview background on page load - IMMEDIATELY apply template image
        // Get template variables from data attributes to avoid IDE parsing errors
        const previewCardForInit = document.getElementById('invitationPreviewCard');
        if (previewCardForInit) {
            const templateIdAttr = previewCardForInit.getAttribute('data-template-id');
            const templateNameAttr = previewCardForInit.getAttribute('data-selected-template');
            const templateImageAttr = previewCardForInit.getAttribute('data-template-image-url');
            
            // Template ID from URL - fetch template data
            let templateIdFromUrl = null;
            if (templateIdAttr && templateIdAttr !== 'null' && templateIdAttr !== '') {
                try {
                    templateIdFromUrl = parseInt(templateIdAttr);
                    if (isNaN(templateIdFromUrl)) {
                        templateIdFromUrl = null;
                    }
                } catch (e) {
                    console.error('Error parsing template_id:', e);
                    templateIdFromUrl = null;
                }
            }
            
            const templateNameFromUrl = templateNameAttr || '';
            const templateImageFromUrl = templateImageAttr || null;
            
            // Apply template image IMMEDIATELY - optimized with limited retries
            let previewRetryCount = 0;
            const MAX_PREVIEW_RETRIES = 3;
            
            function applyTemplateToPreview() {
                const previewCard = document.getElementById('invitationPreviewCard');
                if (!previewCard) {
                    if (previewRetryCount < MAX_PREVIEW_RETRIES) {
                        previewRetryCount++;
                        setTimeout(applyTemplateToPreview, 100);
                    } else {
                        console.warn('Preview card not found after retries');
                    }
                    return;
                }
                previewRetryCount = 0; // Reset on success
                
                // Get template image URL - check multiple sources
                let cleanUrl = null;
                
                // First, try data attribute from HTML (most reliable)
                const dataTemplateImage = previewCard.getAttribute('data-template-image');
                if (dataTemplateImage) {
                    // data-template-image is already escaped HTML, getAttribute automatically decodes it
                    let imageUrl = dataTemplateImage;
                    cleanUrl = normalizeImagePath(imageUrl);
                    console.log('ðŸ“‹ Found template image from data attribute:', cleanUrl);
                }
                
                // Second, try from server variable
                if (!cleanUrl && templateImageFromUrl && templateImageFromUrl !== '' && templateImageFromUrl !== null) {
                    cleanUrl = normalizeImagePath(templateImageFromUrl);
                    console.log('ðŸ“‹ Found template image from server variable:', cleanUrl);
                }
                
                // Debug: Log what we have
                if (!cleanUrl) {
                    console.log('ðŸ” Template Debug:', {
                        templateIdFromUrl: templateIdFromUrl,
                        templateImageFromUrl: templateImageFromUrl,
                        dataTemplateImage: dataTemplateImage,
                        previewCard: previewCard ? 'found' : 'not found',
                        cleanUrl: cleanUrl
                    });
                }
                
                // Third, try to find from theme cards
                if (!cleanUrl) {
                    const templateCards = document.querySelectorAll('.theme-card');
                    for (let card of templateCards) {
                        const cardId = card.getAttribute('data-template-id');
                        if (cardId && parseInt(cardId) === templateIdFromUrl) {
                            const templateDataImage = card.getAttribute('data-template-image');
                            if (templateDataImage) {
                                cleanUrl = normalizeImagePath(templateDataImage);
                                console.log('ðŸ“‹ Found template image from theme card:', cleanUrl);
                                break;
                            }
                        }
                    }
                }
                
                if (cleanUrl) {
                        // CRITICAL: Final check before applying - block placeholder URLs
                    if (cleanUrl.includes('placeholder.com') || cleanUrl.includes('via.placeholder') || cleanUrl.includes('placeholder')) {
                        console.error('âŒ Placeholder URL detected, using fallback:', cleanUrl);
                            cleanUrl = '/images/templatesimages/wedding.png';
                        }
                        
                    console.log('ðŸŽ¨ Applying template image to preview:', cleanUrl);
                    
                    // Apply template image IMMEDIATELY to preview card
                    previewCard.classList.remove('wedding-bg');
                    previewCard.classList.add('template-bg');
                    
                    // CRITICAL: Remove ALL background-related properties first
                    // The 'background' shorthand can override background-image, so we must remove it completely
                    previewCard.style.removeProperty('background');
                    previewCard.style.removeProperty('background-image');
                    previewCard.style.removeProperty('background-color');
                    previewCard.style.removeProperty('background-size');
                    previewCard.style.removeProperty('background-position');
                    previewCard.style.removeProperty('background-repeat');
                    
                    // Escape single quotes in URL for CSS
                    const escapedUrl = cleanUrl.replace(/'/g, "\\'");
                    const templateImageUrl = `url('${escapedUrl}')`;
                    
                    // Optimized: Apply immediately and preload in background - Use 100% 100% to fill entire card
                    previewCard.style.setProperty('background-image', templateImageUrl, 'important');
                    previewCard.style.setProperty('background-size', '100% 100%', 'important');
                    previewCard.style.setProperty('background-position', 'center center', 'important');
                    previewCard.style.setProperty('background-repeat', 'no-repeat', 'important');
                    previewCard.style.setProperty('background-attachment', 'scroll', 'important');
                    previewCard.style.setProperty('background-color', 'transparent', 'important');
                    previewCard.style.setProperty('height', 'auto', 'important');
                    previewCard.style.setProperty('min-height', 'auto', 'important');
                    
                    // Hide placeholder immediately
                    const previewPlaceholder = document.getElementById('previewPlaceholder');
                    if (previewPlaceholder) {
                        previewPlaceholder.style.display = 'none';
                    }
                    
                    // Preload image in background for better performance (non-blocking)
                    const preloadImg = new Image();
                    preloadImg.onload = function() {
                        // Image loaded successfully - ensure it's still applied
                        previewCard.style.setProperty('background-image', templateImageUrl, 'important');
                    };
                    preloadImg.onerror = function() {
                        // Fallback to default image if template image fails
                        const fallbackUrl = '/images/templatesimages/wedding.png';
                        const fallbackImageUrl = `url('${fallbackUrl}')`;
                        previewCard.style.setProperty('background-image', fallbackImageUrl, 'important');
                    };
                    preloadImg.src = cleanUrl;
                    
                    // CRITICAL: Set CSS variable (used by CSS rule with !important)
                    previewCard.style.setProperty('--template-bg-image-url', templateImageUrl, 'important');
                    
                    // CRITICAL: Remove background shorthand first to prevent conflicts
                    previewCard.style.removeProperty('background');
                    
                    // Also set inline style as fallback (though CSS variable should work) - Use 100% 100% to fill entire card
                    previewCard.style.setProperty('background-image', templateImageUrl, 'important');
                    previewCard.style.setProperty('background-size', '100% 100%', 'important');
                    previewCard.style.setProperty('background-position', 'center center', 'important');
                    previewCard.style.setProperty('background-repeat', 'no-repeat', 'important');
                    previewCard.style.setProperty('background-attachment', 'scroll', 'important');
                    previewCard.style.setProperty('background-color', 'transparent', 'important');
                    previewCard.style.setProperty('height', 'auto', 'important');
                    previewCard.style.setProperty('min-height', 'auto', 'important');
                    previewCard.style.setProperty('width', '100%', 'important');
                    
                    // Also set directly for immediate application - Use 100% 100% to fill entire card
                    previewCard.style.backgroundImage = templateImageUrl;
                    previewCard.style.backgroundSize = '100% 100%';
                    previewCard.style.backgroundPosition = 'center center';
                    previewCard.style.backgroundRepeat = 'no-repeat';
                    previewCard.style.backgroundAttachment = 'scroll';
                    previewCard.style.backgroundColor = 'transparent';
                    previewCard.style.height = 'auto';
                    previewCard.style.minHeight = '700px';
                    previewCard.style.width = '100%';
                    
                    // Force a reflow to ensure styles are applied
                    void previewCard.offsetHeight;
                    
                    console.log('âœ… Template image applied IMMEDIATELY:', cleanUrl);
                    
                    // Double-check and force again after a micro-delay
                    requestAnimationFrame(function() {
                        previewCard.style.setProperty('background-image', templateImageUrl, 'important');
                        previewCard.style.backgroundImage = templateImageUrl;
                        
                        // Verify after animation frame - use more lenient check
                        const computedBg = window.getComputedStyle(previewCard).backgroundImage;
                        // Check if background is applied (not 'none') - URL encoding may differ
                        if (computedBg && computedBg !== 'none' && computedBg !== '') {
                            // Background is applied - success (no need to log, already logged above)
                        } else {
                            // Only log as debug, not error - might be timing issue
                            console.debug('ðŸ” Background check after requestAnimationFrame - will retry if needed');
                        }
                    });
                    
                    // Force display
                    previewCard.style.display = 'block';
                    previewCard.style.visibility = 'visible';
                    previewCard.style.opacity = '1';
                    
                    // Verify the image is actually set
                    setTimeout(function() {
                        const computedBg = window.getComputedStyle(previewCard).backgroundImage;
                        const inlineBg = previewCard.style.backgroundImage;
                        
                        console.log('âœ… Template image applied:', cleanUrl);
                        console.log('âœ… Preview card classes:', previewCard.className);
                        console.log('âœ… Inline background-image:', inlineBg);
                        console.log('âœ… Computed background-image:', computedBg);
                        console.log('âœ… Image URL exists:', cleanUrl);
                        
                        // If image still not showing, try one more time with delay
                        // Use more lenient check - just verify background-image is not 'none'
                        const urlEncoded = encodeURIComponent(cleanUrl);
                        const urlDecoded = decodeURIComponent(cleanUrl);
                        const hasBackground = computedBg && computedBg !== 'none' && computedBg !== '';
                        const urlMatches = computedBg && (
                            computedBg.includes(cleanUrl) || 
                            computedBg.includes(escapedUrl) || 
                            computedBg.includes(urlEncoded) ||
                            computedBg.includes(urlDecoded) ||
                            computedBg.toLowerCase().includes(cleanUrl.toLowerCase())
                        );
                        
                        if (!hasBackground || (!urlMatches && computedBg !== 'none')) {
                            // Retry with a more aggressive approach
                            previewCard.style.setProperty('background-image', templateImageUrl, 'important');
                            previewCard.style.backgroundImage = templateImageUrl;
                            // Check again after a short delay
                            setTimeout(() => {
                                const finalBg = window.getComputedStyle(previewCard).backgroundImage;
                                const finalHasBg = finalBg && finalBg !== 'none' && finalBg !== '';
                                // Only warn if it truly failed after multiple retries
                                if (!finalHasBg) {
                                    console.debug('ðŸ” Background image check - may need more time to load. URL:', cleanUrl);
                                }
                            }, 200); // Increased delay for better check
                    }
                    }, 50);
                    
                    // Also update the form fields
                    const templateIdInput = document.getElementById('templateIdInput');
                    const templateImageUrlInput = document.getElementById('templateImageUrlInput');
                    if (templateIdInput && templateIdFromUrl) templateIdInput.value = templateIdFromUrl.toString();
                    if (templateImageUrlInput) templateImageUrlInput.value = cleanUrl;
                    
                    // Store globally for form submission
                    window.selectedTemplateId = templateIdFromUrl ? templateIdFromUrl.toString() : null;
                    window.selectedTemplateImage = cleanUrl;
                    window.selectedTemplateName = templateNameFromUrl;
                    
                    console.log('âœ… Template overlay applied IMMEDIATELY:', cleanUrl);
                    
                    // Test if image actually exists by creating an Image object
                    const testImg = new Image();
                    testImg.onload = function() {
                        console.log('âœ… Template image loaded successfully:', cleanUrl);
                        // Ensure it's still applied after image loads
                        previewCard.style.setProperty('background-image', templateImageUrl, 'important');
                        previewCard.style.backgroundImage = templateImageUrl;
                        
                        // Ensure all preview content is visible on top of template
                        ensurePreviewContentVisible();
                    };
                    testImg.onerror = function() {
                        console.error('âŒ Template image failed to load:', cleanUrl);
                        console.error('âŒ Trying fallback image...');
                        const fallbackUrl = '/images/templatesimages/wedding.png';
                        const fallbackImageUrl = `url('${fallbackUrl}')`;
                        previewCard.style.setProperty('background-image', fallbackImageUrl, 'important');
                        previewCard.style.backgroundImage = fallbackImageUrl;
                        
                        // Ensure all preview content is visible on top of template
                        ensurePreviewContentVisible();
                    };
                    testImg.src = cleanUrl;
                    
                    // Also call updatePreviewBackground to ensure everything is set up
                    if (templateIdFromUrl) {
                    updatePreviewBackground(templateIdFromUrl.toString(), cleanUrl, templateNameFromUrl);
                    } else {
                        updatePreviewBackground(null, cleanUrl, templateNameFromUrl);
                    }
                    
                    // Ensure all preview content is visible immediately
                    ensurePreviewContentVisible();
                } else {
                    console.warn('âš ï¸ Template image not found for template ID:', templateIdFromUrl);
                    console.warn('âš ï¸ Debug info:', {
                        templateIdFromUrl: templateIdFromUrl,
                        templateImageFromUrl: templateImageFromUrl,
                        dataTemplateImage: dataTemplateImage,
                        previewCard: previewCard ? 'found' : 'not found'
                    });
                }
            }
            
            // Apply template immediately - don't wait for DOMContentLoaded if template_id exists
            if (templateIdFromUrl || templateImageFromUrl) {
                // Apply immediately if DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                        applyTemplateToPreview();
                        // Also retry after a short delay
                        setTimeout(applyTemplateToPreview, 100);
                });
            } else {
                // DOM already loaded, apply immediately
                    applyTemplateToPreview();
                    // Also retry after a short delay to ensure it's applied
                    setTimeout(applyTemplateToPreview, 100);
            }
            
            // Also apply on window load as a fallback
            window.addEventListener('load', function() {
                applyTemplateToPreview();
            });
            }
        } else if (previewCardForInit && templateNameAttr) {
            // Get template ID from data attribute
            const initialTemplateId = (templateNameAttr || '').replace(/\s+/g, '_').toLowerCase();
            // Use the escaped value in template literal
            const templateElement = document.querySelector(`[data-theme="${initialTemplateId}"]`);
            if (templateElement) {
                const templateImg = templateElement.querySelector('.theme-image');
                const templateTitle = templateElement.querySelector('.theme-title');
                const templateDataImage = templateElement.getAttribute('data-template-image');
                
                const imgUrl = templateDataImage || (templateImg ? templateImg.src : null);
                // Safely get template name - textContent is already safe
                const imgName = templateTitle ? templateTitle.textContent : (templateNameAttr || '');
                
                if (imgUrl) {
                    // Normalize the image path
                    let cleanUrl = normalizeImagePath(imgUrl);
                    if (cleanUrl) {
                        updatePreviewBackground(initialTemplateId, cleanUrl, imgName);
                        
                        // Also directly apply to preview card to ensure it's visible
                        const previewCard = document.getElementById('invitationPreviewCard');
                        if (previewCard) {
                            // CRITICAL: Don't set background: 'none' as it resets background-image!
                            previewCard.style.removeProperty('background');
                            previewCard.style.backgroundColor = 'transparent';
                        previewCard.classList.remove('wedding-bg');
                        previewCard.classList.add('template-bg');
                        // Set template image directly as background-image with !important
                        const bgImageUrl = `url('${cleanUrl}')`;
                        previewCard.style.setProperty('background-image', bgImageUrl, 'important');
                        previewCard.style.backgroundImage = bgImageUrl;
                        previewCard.style.backgroundSize = '100% 100%';
                        previewCard.style.backgroundPosition = 'center center';
                            previewCard.style.backgroundRepeat = 'no-repeat';
                        previewCard.style.backgroundAttachment = 'scroll';
                        previewCard.style.height = 'auto';
                        previewCard.style.setProperty('background-size', '100% 100%', 'important');
                        previewCard.style.setProperty('background-position', 'center center', 'important');
                        previewCard.style.setProperty('background-attachment', 'scroll', 'important');
                        previewCard.style.setProperty('height', 'auto', 'important');
                            console.log('Template background applied on page load (selected_template):', cleanUrl);
                        }
                    }
                }
            }
        } else {
            // No template selected - use default background
            // updatePreviewBackground(); // Removed - function requires parameters
        }

        // Function to hide all event-specific preview elements - ENHANCED
        function hideAllEventSpecificPreviewElements() {
            // Hide all event-specific text preview elements
            const previewElements = [
                'previewBrideGroom',
                'previewBirthdayPerson',
                'previewCoupleNames',
                'previewMotherFather',
                'previewGraduate'
            ];
            
            previewElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                    element.style.setProperty('display', 'none', 'important');
                    element.style.visibility = 'hidden';
                    element.style.opacity = '0';
                }
            });
            
            // Hide ALL event-specific image containers (including main image)
            const imageContainers = [
                'previewMainImageContainer',
                'previewBrideGroomContainer',
                'previewBirthdayImageContainer',
                'previewCoupleImageContainer',
                'previewGraduateImageContainer',
                'previewHonoreeImageContainer'
            ];
            
            imageContainers.forEach(id => {
                const container = document.getElementById(id);
                if (container) {
                    container.style.display = 'none';
                    container.style.setProperty('display', 'none', 'important');
                    container.style.visibility = 'hidden';
                    container.style.opacity = '0';
                }
            });
            
            // Also hide individual images
            const individualImages = [
                'previewMainImage',
                'previewBrideImage',
                'previewGroomImage',
                'previewBirthdayImage',
                'previewCoupleImage',
                'previewGraduateImage',
                'previewHonoreeImage'
            ];
            
            individualImages.forEach(id => {
                const img = document.getElementById(id);
                if (img) {
                    img.style.display = 'none';
                    img.style.setProperty('display', 'none', 'important');
                    img.style.visibility = 'hidden';
                    img.style.opacity = '0';
                }
            });
        }

        // Real-time update preview - No delay for instant feedback
        const instantUpdatePreview = function() {
            // Get current event type first
            const previewCardForEventType = document.getElementById('invitationPreviewCard');
            const eventTypeAttrValue = previewCardForEventType ? previewCardForEventType.getAttribute('data-event-type') : '';
            const eventTypeInputElement = document.getElementById('eventTypeInput');
            const eventTypeFromInputValue = eventTypeInputElement ? eventTypeInputElement.value : '';
            const currentEventType = (eventTypeAttrValue || eventTypeFromInputValue || '').toLowerCase().trim();
            
            // Get current language for all translations (declared once at the top)
            const currentLanguage = languageSelect ? languageSelect.value : 'en';
            
            // CRITICAL: Hide all event-specific elements first, then show only relevant ones
            hideAllEventSpecificPreviewElements();
            
            const eventName = eventNameInput ? eventNameInput.value.trim() : '';
            const eventDate = eventDateInput ? eventDateInput.value : '';
            const eventTime = eventTimeInput ? eventTimeInput.value : '';
            const venueName = venueNameInput ? venueNameInput.value.trim() : '';
            const venueAddress = venueAddressInput ? venueAddressInput.value.trim() : '';
            const hostedBy = hostedByInput ? hostedByInput.value.trim() : '';
            const personalMessage = personalMessageInput ? personalMessageInput.value.trim() : '';
            
            let hasContent = false;
            
            // Check if ANY form field has content to hide placeholder immediately
            const hasAnyContent = eventName || eventDate || eventTime || venueName || venueAddress || 
                                  hostedBy || personalMessage || 
                                  (brideNameInput && brideNameInput.value.trim()) ||
                                  (groomNameInput && groomNameInput.value.trim()) ||
                                  (birthdayPersonInput && birthdayPersonInput.value.trim()) ||
                                  (coupleNamesInput && coupleNamesInput.value.trim()) ||
                                  (graduateNameInput && graduateNameInput.value.trim()) ||
                                  (document.getElementById('motherName') && document.getElementById('motherName').value.trim()) ||
                                  (document.getElementById('fatherName') && document.getElementById('fatherName').value.trim()) ||
                                  (document.getElementById('mainImage') && document.getElementById('mainImage').files.length > 0);
            
            // Hide placeholder immediately if any content exists
            if (hasAnyContent && previewPlaceholder) {
                previewPlaceholder.style.display = 'none';
                previewPlaceholder.style.visibility = 'hidden';
                previewPlaceholder.style.opacity = '0';
            }
            
            if (eventName) {
                previewEventName.textContent = eventName;
                previewEventName.style.display = 'block';
                previewEventName.style.visibility = 'visible';
                previewEventName.style.opacity = '1';
                hasContent = true;
            } else {
                // Show placeholder text when empty
                previewEventName.textContent = 'Your Event Name';
                previewEventName.style.display = 'block';
                previewEventName.style.visibility = 'visible';
                previewEventName.style.opacity = '0.7';
            }
            
            // Update icon based on actual event_type from data attribute (not event name)
            // Use the already determined currentEventType from above
            updateEventIcon(currentEventType);
            
            // Update date
            if (eventDate) {
                const date = new Date(eventDate);
                const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                previewDateText.textContent = formattedDate;
                previewDate.style.display = 'flex';
                hasContent = true;
            } else {
                previewDate.style.display = 'none';
            }
            
            // Update time
            if (eventTime) {
                const time = eventTime.split(':');
                const hours = parseInt(time[0]);
                const minutes = time[1];
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                previewTimeText.textContent = `${displayHours}:${minutes} ${ampm}`;
                previewTime.style.display = 'flex';
                hasContent = true;
            } else {
                previewTime.style.display = 'none';
            }
            
            // Update venue
            const venueFull = [venueName, venueAddress].filter(v => v).join(', ');
            if (venueFull) {
                previewVenueText.textContent = venueFull;
                previewVenue.style.display = 'flex';
                hasContent = true;
            } else {
                previewVenue.style.display = 'none';
            }
            
            // Update hosted by
            if (hostedBy) {
                const hostedByLabel = translateText('Hosted by', currentLanguage);
                
                // Update both label and text
                const previewCardForQuery = previewCardForEventType || document.getElementById('invitationPreviewCard');
                const hostedByLabelElement = previewCardForQuery ? previewCardForQuery.querySelector('#previewHostedLabel') : null;
                if (hostedByLabelElement) {
                    hostedByLabelElement.textContent = hostedByLabel;
                }
                if (previewHostedText) {
                previewHostedText.textContent = hostedBy;
                }
                if (previewHosted) {
                previewHosted.style.display = 'block';
                }
                hasContent = true;
            } else {
                if (previewHosted) {
                previewHosted.style.display = 'none';
                }
            }
            
            // Update message
            if (personalMessage) {
                previewMessageText.textContent = personalMessage;
                previewMessage.style.display = 'block';
                hasContent = true;
            } else {
                previewMessage.style.display = 'none';
            }
            
            // Update gallery images in live preview - show at end of template
            const galleryImagesInput = document.getElementById('galleryImages');
            const previewGallerySection = document.getElementById('previewGallerySection');
            const previewGalleryGrid = document.getElementById('previewGalleryGrid');
            
            if (galleryImagesInput && galleryImagesInput.files && galleryImagesInput.files.length > 0) {
                if (previewGalleryGrid) {
                    previewGalleryGrid.innerHTML = '';
                    const filesArray = Array.from(galleryImagesInput.files);
                    let firstImageLoaded = false;
                    
                    filesArray.forEach((file, index) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.alt = 'Gallery Image';
                            img.style.width = '100%';
                            img.style.height = '180px';
                            img.style.objectFit = 'cover';
                            img.style.borderRadius = '10px';
                            img.style.border = '3px solid rgba(255, 255, 255, 0.9)';
                            img.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
                            img.style.cursor = 'pointer';
                            img.style.transition = 'transform 0.3s ease, box-shadow 0.3s ease';
                            img.style.display = 'block';
                            img.style.visibility = 'visible';
                            img.style.opacity = '1';
                            img.style.position = 'relative';
                            img.style.zIndex = '25';
                            img.style.background = '#ffffff';
                            // Add hover effect
                            img.onmouseenter = function() {
                                this.style.transform = 'scale(1.05)';
                                this.style.boxShadow = '0 6px 20px rgba(0,0,0,0.4)';
                            };
                            img.onmouseleave = function() {
                                this.style.transform = 'scale(1)';
                                this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
                            };
                            previewGalleryGrid.appendChild(img);
                            
                            // Show gallery section (do NOT replace template background)
                            // Template background should remain - gallery images are just additional content
                            if (index === 0 && !firstImageLoaded) {
                                firstImageLoaded = true;
                                // Gallery images should NOT replace the template background
                                // They should just appear in the gallery grid below the invitation content
                                console.log('âœ… Gallery image added to grid (template background preserved)');
                            }
                        };
                        reader.readAsDataURL(file);
                    });
                }
                if (previewGallerySection) {
                    previewGallerySection.style.display = 'block';
                    previewGallerySection.style.setProperty('display', 'block', 'important');
                    previewGallerySection.style.visibility = 'visible';
                    previewGallerySection.style.opacity = '1';
                    previewGallerySection.style.zIndex = '20';
                    previewGallerySection.style.setProperty('z-index', '20', 'important');
                    previewGallerySection.style.position = 'relative';
                    hasContent = true;
                    console.log('âœ… Gallery section displayed in preview');
                }
                if (previewGalleryGrid) {
                    previewGalleryGrid.style.display = 'grid';
                    previewGalleryGrid.style.setProperty('display', 'grid', 'important');
                    previewGalleryGrid.style.visibility = 'visible';
                    previewGalleryGrid.style.opacity = '1';
                    console.log('âœ… Gallery grid displayed');
                }
            } else {
                if (previewGallerySection) {
                    previewGallerySection.style.display = 'none';
                    previewGallerySection.style.setProperty('display', 'none', 'important');
                }
            }
            
            // Update event-specific fields - ONLY show fields for current event type
            // Wedding fields - only show if event type is wedding
            if (currentEventType === 'wedding' && brideNameInput && groomNameInput) {
                const brideName = brideNameInput.value.trim();
                const groomName = groomNameInput.value.trim();
                if (brideName || groomName) {
                    if (previewBrideName) previewBrideName.textContent = brideName || '';
                    if (previewGroomName) previewGroomName.textContent = groomName || '';
                    if (previewBrideGroom) {
                        // Update with translated separator
                        const separator = translateText(' & ', currentLanguage);
                        previewBrideGroom.innerHTML = `<span id="previewBrideName">${brideName || ''}</span>${separator}<span id="previewGroomName">${groomName || ''}</span>`;
                        previewBrideGroom.style.display = 'block';
                        previewBrideGroom.style.setProperty('display', 'block', 'important');
                        hasContent = true;
                    }
                }
            }
            
            // Birthday fields - only show if event type is birthday
            if (currentEventType === 'birthday' && birthdayPersonInput) {
                const birthdayPerson = birthdayPersonInput.value.trim();
                const age = ageInput ? ageInput.value.trim() : '';
                if (birthdayPerson) {
                    if (previewBirthdayPersonName) previewBirthdayPersonName.textContent = birthdayPerson;
                    if (previewAge && age) {
                        const yearsOldText = translateText('years old', currentLanguage);
                        previewAge.textContent = `(${age} ${yearsOldText})`;
                    }
                    if (previewBirthdayPerson) {
                        previewBirthdayPerson.style.display = 'block';
                        previewBirthdayPerson.style.setProperty('display', 'block', 'important');
                        hasContent = true;
                    }
                }
            }
            
            // Anniversary fields - only show if event type is anniversary
            if (currentEventType === 'anniversary' && coupleNamesInput) {
                const coupleNames = coupleNamesInput.value.trim();
                if (coupleNames) {
                    if (previewCoupleNamesText) {
                        // Replace " & " with translated separator if present
                        const translatedNames = coupleNames.replace(/\s*&\s*/g, translateText(' & ', currentLanguage));
                        previewCoupleNamesText.textContent = translatedNames;
                    }
                    if (previewCoupleNames) {
                        previewCoupleNames.style.display = 'block';
                        previewCoupleNames.style.setProperty('display', 'block', 'important');
                        hasContent = true;
                    }
                }
            }
            
            // Baby shower fields - only show if event type is babyshower
            if (currentEventType === 'babyshower' || currentEventType === 'baby shower') {
            const motherNameInput = document.getElementById('motherName');
            const fatherNameInput = document.getElementById('fatherName');
            if (motherNameInput && fatherNameInput) {
                const motherName = motherNameInput.value.trim();
                const fatherName = fatherNameInput.value.trim();
                const previewMotherName = document.getElementById('previewMotherName');
                const previewFatherName = document.getElementById('previewFatherName');
                const previewMotherFatherSeparator = document.getElementById('previewMotherFatherSeparator');
                const previewMotherFather = document.getElementById('previewMotherFather');
                
                // Only show if at least one name has content
                if (motherName || fatherName) {
                    if (previewMotherName) {
                        previewMotherName.textContent = motherName || '';
                        previewMotherName.style.display = motherName ? 'inline' : 'none';
                    }
                    if (previewFatherName) {
                        previewFatherName.textContent = fatherName || '';
                        previewFatherName.style.display = fatherName ? 'inline' : 'none';
                    }
                    if (previewMotherFatherSeparator) {
                        // Only show separator if both names exist, and translate it
                        const separator = translateText(' & ', currentLanguage);
                        previewMotherFatherSeparator.textContent = separator;
                        previewMotherFatherSeparator.style.display = (motherName && fatherName) ? 'inline' : 'none';
                    }
                    if (previewMotherFather) {
                        previewMotherFather.style.display = 'block';
                            previewMotherFather.style.setProperty('display', 'block', 'important');
                        hasContent = true;
                    }
                    }
                }
            }
            
            // Graduation fields - only show if event type is graduation
            if (currentEventType === 'graduation' && graduateNameInput) {
                const graduateName = graduateNameInput.value.trim();
                const degree = degreeInput ? degreeInput.value.trim() : '';
                if (graduateName) {
                    if (previewGraduateName) previewGraduateName.textContent = graduateName;
                    if (previewDegree && degree) previewDegree.textContent = degree;
                    if (previewGraduate) {
                        // Update with translated separator
                        const separator = translateText(' - ', currentLanguage);
                        previewGraduate.innerHTML = `<span id="previewGraduateName">${graduateName}</span>${separator}<span id="previewDegree">${degree || ''}</span>`;
                        previewGraduate.style.display = 'block';
                        previewGraduate.style.setProperty('display', 'block', 'important');
                        hasContent = true;
                    }
                }
            }
            
            // Retirement fields - only show if event type is retirement
            if (currentEventType === 'retirement') {
                const honoreeNameInput = document.getElementById('honoreeName');
                if (honoreeNameInput) {
                    const honoreeName = honoreeNameInput.value.trim();
                    const previewHonoree = document.getElementById('previewHonoree');
                    if (honoreeName && previewHonoree) {
                        previewHonoree.textContent = honoreeName;
                        previewHonoree.style.display = 'block';
                        previewHonoree.style.setProperty('display', 'block', 'important');
                        hasContent = true;
                }
            }
            }
            
            // CRITICAL: Call showEventSpecificImages to ensure only relevant images are shown for current event type
            if (typeof window.showEventSpecificImages === 'function') {
                window.showEventSpecificImages(currentEventType);
            } else if (typeof showEventSpecificImages === 'function') {
                showEventSpecificImages(currentEventType);
            }
            
            // Show/hide placeholder - hide if there's content OR if template is selected
            const previewCardElement = previewCardForEventType || document.getElementById('invitationPreviewCard');
            const hasTemplate = previewCardElement && (previewCardElement.classList.contains('template-bg') || previewCardElement.classList.contains('wedding-bg') || (previewCardElement.style.backgroundImage && previewCardElement.style.backgroundImage !== 'none'));
            
            // Always ensure preview card is visible
            if (previewCardElement) {
                previewCardElement.style.display = 'flex';
                previewCardElement.style.visibility = 'visible';
                previewCardElement.style.opacity = '1';
            }
            
            // Hide placeholder if there's any content or template - use !important to override inline styles
            if (hasAnyContent || hasContent || hasTemplate) {
                if (previewPlaceholder) {
                    previewPlaceholder.style.setProperty('display', 'none', 'important');
                    previewPlaceholder.style.setProperty('visibility', 'hidden', 'important');
                    previewPlaceholder.style.setProperty('opacity', '0', 'important');
                }
            } else {
                // Only show placeholder if there's truly no content
                if (previewPlaceholder) {
                    previewPlaceholder.style.setProperty('display', 'block', 'important');
                    previewPlaceholder.style.setProperty('visibility', 'visible', 'important');
                    previewPlaceholder.style.setProperty('opacity', '1', 'important');
                }
            }
            
            // Apply current language and font style to preview
            // currentLanguage is already declared at the top of the function
            const currentFontStyle = fontStyleSelect ? fontStyleSelect.value : 'Inter, sans-serif';
            applyLanguageToPreview(currentLanguage);
            applyFontStyleToPreview(currentFontStyle);
            
            // Sync mobile preview if mobile view is active
            const mobileViewBtn = document.getElementById('mobileViewBtn');
            if (mobileViewBtn && mobileViewBtn.classList.contains('active')) {
                syncMobilePreview();
            }
        };
        
        // Also create a debounced version for less critical updates
        const debouncedUpdatePreview = debounce(instantUpdatePreview, 100);

        // Language translations mapping - Only 5 languages: English, Hindi, Telugu, Tamil, Kannada
        const translations = {
            en: {
                'Hosted by': 'Hosted by',
                'Our Memories': 'Our Memories',
                'Date': 'Date',
                'Time': 'Time',
                'Venue': 'Venue',
                'years old': 'years old',
                'years': 'years',
                ' & ': ' & ',
                ' - ': ' - '
            },
            hi: {
                'Hosted by': 'à¤†à¤¯à¥‹à¤œà¤•',
                'Our Memories': 'à¤¹à¤®à¤¾à¤°à¥€ à¤¯à¤¾à¤¦à¥‡à¤‚',
                'Date': 'à¤¤à¤¾à¤°à¥€à¤–',
                'Time': 'à¤¸à¤®à¤¯',
                'Venue': 'à¤¸à¥à¤¥à¤¾à¤¨',
                'years old': 'à¤µà¤°à¥à¤· à¤•à¥€ à¤†à¤¯à¥',
                'years': 'à¤µà¤°à¥à¤·',
                ' & ': ' à¤”à¤° ',
                ' - ': ' - '
            },
            te: {
                'Hosted by': 'à°†à°¤à°¿à°¥à±à°¯à°‚ à°‡à°šà±à°šà°¿à°¨à°µà°¾à°°à±',
                'Our Memories': 'à°®à°¾ à°œà±à°žà°¾à°ªà°•à°¾à°²à±',
                'Date': 'à°¤à±‡à°¦à±€',
                'Time': 'à°¸à°®à°¯à°‚',
                'Venue': 'à°¸à±à°¥à°²à°‚',
                'years old': 'à°¸à°‚à°µà°¤à±à°¸à°°à°¾à°² à°µà°¯à°¸à±à°¸à±',
                'years': 'à°¸à°‚à°µà°¤à±à°¸à°°à°¾à°²à±',
                ' & ': ' à°®à°°à°¿à°¯à± ',
                ' - ': ' - '
            },
            ta: {
                'Hosted by': 'à®†à®¤à®°à®µà®¾à®³à®°à¯',
                'Our Memories': 'à®Žà®™à¯à®•à®³à¯ à®¨à®¿à®©à¯ˆà®µà¯à®•à®³à¯',
                'Date': 'à®¤à¯‡à®¤à®¿',
                'Time': 'à®¨à¯‡à®°à®®à¯',
                'Venue': 'à®‡à®Ÿà®®à¯',
                'years old': 'à®µà®¯à®¤à¯',
                'years': 'à®†à®£à¯à®Ÿà¯à®•à®³à¯',
                ' & ': ' à®®à®±à¯à®±à¯à®®à¯ ',
                ' - ': ' - '
            },
            kn: {
                'Hosted by': 'à²†à²¤à²¿à²¥à³à²¯ à²¨à³€à²¡à²¿à²¦à²µà²°à³',
                'Our Memories': 'à²¨à²®à³à²® à²¨à³†à²¨à²ªà³à²—à²³à³',
                'Date': 'à²¦à²¿à²¨à²¾à²‚à²•',
                'Time': 'à²¸à²®à²¯',
                'Venue': 'à²¸à³à²¥à²³',
                'years old': 'à²µà²°à³à²·à²—à²³ à²µà²¯à²¸à³à²¸à³',
                'years': 'à²µà²°à³à²·à²—à²³à³',
                ' & ': ' à²®à²¤à³à²¤à³ ',
                ' - ': ' - '
            }
        };

        // Function to translate text based on selected language
        function translateText(text, language) {
            if (!text || !language || language === 'en') return text;
            const langTranslations = translations[language] || {};
            return langTranslations[text] || text;
        }

        // Function to apply language to preview - Translates ALL labels and text
        function applyLanguageToPreview(language) {
            const previewCard = document.getElementById('invitationPreviewCard');
            if (!previewCard) return;

            // Update "Hosted by" label
            const hostedByLabelElement = previewCard.querySelector('#previewHostedLabel');
            if (hostedByLabelElement) {
                hostedByLabelElement.textContent = translateText('Hosted by', language);
            }
            
            // Also update the full hosted by element if it exists
            const hostedByElement = previewCard.querySelector('#previewHosted');
            if (hostedByElement) {
                const hostedByText = document.getElementById('hostedBy')?.value || '';
                const hostedByLabel = translateText('Hosted by', language);
                hostedByElement.innerHTML = `<i class="fas fa-user"></i> <span id="previewHostedLabel">${hostedByLabel}</span> <span id="previewHostedText">${hostedByText}</span>`;
            }

            // Update "Our Memories" gallery title
            const galleryTitleText = previewCard.querySelector('#previewGalleryTitleText');
            if (galleryTitleText) {
                const titleText = translateText('Our Memories', language);
                galleryTitleText.textContent = titleText;
            }

            // Update separator text in couple names (if exists)
            const coupleNamesElement = previewCard.querySelector('#previewCoupleNamesText');
            if (coupleNamesElement) {
                const originalText = coupleNamesElement.textContent || '';
                // Replace " & " with translated separator
                const translatedText = originalText.replace(/\s*&\s*/g, translateText(' & ', language));
                coupleNamesElement.textContent = translatedText;
            }

            // Update separator in bride/groom names
            const brideGroomElement = previewCard.querySelector('#previewBrideGroom');
            if (brideGroomElement) {
                const brideName = document.getElementById('previewBrideName')?.textContent || '';
                const groomName = document.getElementById('previewGroomName')?.textContent || '';
                if (brideName && groomName) {
                    const separator = translateText(' & ', language);
                    brideGroomElement.innerHTML = `<span id="previewBrideName">${brideName}</span>${separator}<span id="previewGroomName">${groomName}</span>`;
                }
            }

            // Update separator in mother/father names
            const motherFatherElement = previewCard.querySelector('#previewMotherFather');
            if (motherFatherElement) {
                const motherName = document.getElementById('previewMotherName')?.textContent || '';
                const fatherName = document.getElementById('previewFatherName')?.textContent || '';
                if (motherName && fatherName) {
                    const separator = translateText(' & ', language);
                    motherFatherElement.innerHTML = `<span id="previewMotherName">${motherName}</span>${separator}<span id="previewFatherName">${fatherName}</span>`;
                }
            }

            // Update separator in graduate name and degree
            const graduateElement = previewCard.querySelector('#previewGraduate');
            if (graduateElement) {
                const graduateName = document.getElementById('previewGraduateName')?.textContent || '';
                const degree = document.getElementById('previewDegree')?.textContent || '';
                if (graduateName && degree) {
                    const separator = translateText(' - ', language);
                    graduateElement.innerHTML = `<span id="previewGraduateName">${graduateName}</span>${separator}<span id="previewDegree">${degree}</span>`;
                }
            }

            // Update "years old" text in birthday person age
            const ageElement = previewCard.querySelector('#previewAge');
            if (ageElement) {
                const ageText = ageElement.textContent || '';
                if (ageText.includes('years old')) {
                    ageElement.textContent = ageText.replace('years old', translateText('years old', language));
                } else if (ageText.includes('years')) {
                    ageElement.textContent = ageText.replace('years', translateText('years', language));
                }
            }
        }

        // Function to apply font style to preview
        function applyFontStyleToPreview(fontStyle) {
            const previewCard = document.getElementById('invitationPreviewCard');
            if (!previewCard) return;

            // Apply font family to entire preview card using setProperty for !important
            previewCard.style.setProperty('font-family', fontStyle, 'important');
            
            // Also apply to all text elements within preview (but not icons)
            const allTextElements = previewCard.querySelectorAll('*:not(i):not(.fas):not(.fa)');
            allTextElements.forEach(el => {
                // Skip icon elements
                if (!el.classList.contains('fas') && !el.classList.contains('fa') && el.tagName !== 'I') {
                    el.style.setProperty('font-family', fontStyle, 'important');
                }
            });
        }

        // Add event listeners for language and font style
        const languageSelect = document.getElementById('language');
        const fontStyleSelect = document.getElementById('fontStyle');

        if (languageSelect) {
            languageSelect.addEventListener('change', function() {
                const selectedLanguage = this.value;
                applyLanguageToPreview(selectedLanguage);
                // All supported languages (English, Hindi, Telugu, Tamil, Kannada) are LTR
                const previewCard = document.getElementById('invitationPreviewCard');
                if (previewCard) {
                    previewCard.style.direction = 'ltr';
                    previewCard.style.textAlign = 'center';
                }
            });
        }

        if (fontStyleSelect) {
            fontStyleSelect.addEventListener('change', function() {
                const selectedFontStyle = this.value;
                applyFontStyleToPreview(selectedFontStyle);
                // Also trigger preview update to ensure all text gets the font
                if (typeof instantUpdatePreview === 'function') {
                    instantUpdatePreview();
                }
            });
            
            // Apply initial font style on page load
            setTimeout(() => {
                if (fontStyleSelect.value) {
                    applyFontStyleToPreview(fontStyleSelect.value);
                }
            }, 100);
        }
        
        // Font preview function
        window.updateFontPreview = function(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const fontFamily = selectedOption.value;
            const previewDiv = document.getElementById('fontPreview');
            if (previewDiv) {
                const previewSpan = previewDiv.querySelector('span');
                if (previewSpan) {
                    previewSpan.style.fontFamily = fontFamily;
                }
            }
            // Also apply to preview card
            if (fontFamily) {
                applyFontStyleToPreview(fontFamily);
            }
        };
        
        // Theme selection from dropdown
        window.handleThemeSelection = function(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            if (!selectedOption || !selectedOption.value) {
                document.getElementById('selectedThemePreview').style.display = 'none';
                document.getElementById('continueToDetails').disabled = true;
                return;
            }
            
            const templateId = selectedOption.value;
            const templateImage = selectedOption.getAttribute('data-template-image');
            const templateName = selectedOption.getAttribute('data-template-name');
            const eventType = selectedOption.getAttribute('data-event-type');
            
            console.log('ðŸŽ¯ Theme selected from dropdown:', {
                templateId: templateId,
                templateImage: templateImage,
                templateName: templateName
            });
            
            // Show preview
            const previewDiv = document.getElementById('selectedThemePreview');
            const previewImage = document.getElementById('themePreviewImage');
            const previewName = document.getElementById('themePreviewName');
            
            if (previewDiv && previewImage && previewName) {
                previewImage.src = templateImage || '';
                previewName.textContent = templateName || '';
                previewDiv.style.display = 'block';
            }
            
            // Enable continue button
            const continueBtn = document.getElementById('continueToDetails');
            if (continueBtn) {
                continueBtn.disabled = false;
            }
            
            // Store selected template
            window.selectedTemplateId = templateId;
            window.selectedTemplateImage = templateImage;
            
            // Update hidden form fields
            const templateIdInput = document.getElementById('templateIdInput');
            const templateImageUrlInput = document.getElementById('templateImageUrlInput');
            if (templateIdInput) {
                templateIdInput.value = templateId;
            }
            if (templateImageUrlInput) {
                templateImageUrlInput.value = templateImage || '';
            }
            
            // CRITICAL: Apply template to live preview IMMEDIATELY
            if (templateImage) {
                const cleanUrl = normalizeImagePath(templateImage);
                if (cleanUrl && !cleanUrl.includes('placeholder')) {
                    console.log('âœ… Applying template to live preview from dropdown:', cleanUrl);
                    
                    // Get preview card
                    const previewCard = document.getElementById('invitationPreviewCard');
                    if (previewCard) {
                        // Make preview visible
                        previewCard.style.display = 'flex';
                        previewCard.style.visibility = 'visible';
                        previewCard.style.opacity = '1';
                        
                        // Remove default background
                        previewCard.style.removeProperty('background');
                        previewCard.style.backgroundColor = 'transparent';
                        
                        // Add template-bg class
                        previewCard.classList.remove('wedding-bg');
                        previewCard.classList.add('template-bg');
                        
                        // Apply background image
                        const escapedUrl = cleanUrl.replace(/'/g, "\\'");
                        const bgImageUrl = `url('${escapedUrl}')`;
                        previewCard.style.setProperty('background-image', bgImageUrl, 'important');
                        previewCard.style.backgroundImage = bgImageUrl;
                        previewCard.style.setProperty('background-size', '100% 100%', 'important');
                        previewCard.style.backgroundSize = '100% 100%';
                        previewCard.style.setProperty('background-position', 'center center', 'important');
                        previewCard.style.backgroundPosition = 'center center';
                        previewCard.style.setProperty('background-repeat', 'no-repeat', 'important');
                        previewCard.style.backgroundRepeat = 'no-repeat';
                        previewCard.style.setProperty('background-attachment', 'scroll', 'important');
                        previewCard.style.backgroundAttachment = 'scroll';
                        previewCard.style.setProperty('height', 'auto', 'important');
                        previewCard.style.height = 'auto';
                        
                        // Force reflow
                        void previewCard.offsetHeight;
                        
                        // Verify after delay
                        setTimeout(() => {
                            const computedBg = window.getComputedStyle(previewCard).backgroundImage;
                            console.log('ðŸ” Computed background after dropdown selection:', computedBg);
                            if (!computedBg || computedBg === 'none') {
                                // Re-apply
                                previewCard.style.setProperty('background-image', bgImageUrl, 'important');
                                console.log('ðŸ”„ Re-applied template background');
                            }
                        }, 100);
                        
                        // Also call updatePreviewBackground for additional setup
                        updatePreviewBackground(templateId, cleanUrl, templateName);
                        
                        console.log('âœ… Template applied to live preview from dropdown');
                    } else {
                        console.warn('âš ï¸ Preview card not found when applying template from dropdown');
                    }
                }
            }
            
            // CRITICAL: Detect event type and show/hide form fields
            if (eventType) {
                const eventTypeLower = (eventType || '').toLowerCase().trim();
                const previewCard = document.getElementById('invitationPreviewCard');
                if (previewCard) {
                    previewCard.setAttribute('data-event-type', eventTypeLower);
                }
                const eventTypeInput = document.getElementById('eventTypeInput');
                if (eventTypeInput) {
                    eventTypeInput.value = eventTypeLower;
                }
                // Show/hide form fields based on event type
                showEventSpecificFields(eventTypeLower);
                if (typeof window.showEventSpecificImages === 'function') {
                    window.showEventSpecificImages(eventTypeLower);
                } else if (typeof showEventSpecificImages === 'function') {
                    showEventSpecificImages(eventTypeLower);
                }
                updateEventIcon(eventTypeLower);
            } else if (templateName) {
                // Fallback: Detect from template name
                const templateNameLower = templateName.toLowerCase();
                let detectedEventType = '';
                if (templateNameLower.includes('wedding') || templateNameLower.includes('marriage')) {
                    detectedEventType = 'wedding';
                } else if (templateNameLower.includes('birthday') || templateNameLower.includes('bday')) {
                    detectedEventType = 'birthday';
                } else if (templateNameLower.includes('anniversary')) {
                    detectedEventType = 'anniversary';
                } else if (templateNameLower.includes('graduation')) {
                    detectedEventType = 'graduation';
                } else if (templateNameLower.includes('baby') || templateNameLower.includes('shower')) {
                    detectedEventType = 'babyshower';
                } else if (templateNameLower.includes('retirement')) {
                    detectedEventType = 'retirement';
                }
                
                if (detectedEventType) {
                    const previewCard = document.getElementById('invitationPreviewCard');
                    if (previewCard) {
                        previewCard.setAttribute('data-event-type', detectedEventType);
                    }
                    const eventTypeInput = document.getElementById('eventTypeInput');
                    if (eventTypeInput) {
                        eventTypeInput.value = detectedEventType;
                    }
                    showEventSpecificFields(detectedEventType);
                    if (typeof window.showEventSpecificImages === 'function') {
                        window.showEventSpecificImages(detectedEventType);
                    } else if (typeof showEventSpecificImages === 'function') {
                        showEventSpecificImages(detectedEventType);
                    }
                    updateEventIcon(detectedEventType);
                }
            }
        };
        
        // Apply initial language on page load
        if (languageSelect) {
            setTimeout(() => {
                if (languageSelect.value) {
                    applyLanguageToPreview(languageSelect.value);
                }
            }, 100);
        }

        // Update preview as user types - Event Name (INSTANT updates)
        if (eventNameInput) {
            // Generate default name if input is empty
            const currentValue = eventNameInput.value.trim();
            const defaultName = eventNameInput.getAttribute('data-default-name') || '';
            const eventType = eventNameInput.getAttribute('data-event-type') || '';
            
            // If input is empty and we have data to build a default name
            if (!currentValue && defaultName && eventType) {
                let eventLabel = 'Event';
                switch(eventType.toLowerCase()) {
                    case 'wedding': eventLabel = 'Wedding'; break;
                    case 'birthday': eventLabel = 'Birthday'; break;
                    case 'anniversary': eventLabel = 'Anniversary'; break;
                    case 'graduation': eventLabel = 'Graduation'; break;
                    case 'babyshower': eventLabel = 'Baby Shower'; break;
                    case 'retirement': eventLabel = 'Retirement'; break;
                }
                eventNameInput.value = `${defaultName}'s ${eventLabel}`;
                console.log(`âœ“ Default event name set: ${eventNameInput.value}`);
            }
            
            eventNameInput.addEventListener('input', function() {
                hidePlaceholderIfContent();
                instantUpdatePreview();
            });
            eventNameInput.addEventListener('change', function() {
                hidePlaceholderIfContent();
                instantUpdatePreview();
            });
            eventNameInput.addEventListener('keyup', function() {
                hidePlaceholderIfContent();
                instantUpdatePreview();
            });
            
            // Initialize preview with current value immediately (after ensuring default is set)
            setTimeout(() => {
                console.log(`âœ“ Updating preview with event name: "${eventNameInput.value}"`);
                instantUpdatePreview();
                
                // Force preview to show event name
                if (previewEventName && eventNameInput.value) {
                    previewEventName.textContent = eventNameInput.value;
                    previewEventName.style.display = 'block';
                    previewEventName.style.visibility = 'visible';
                    previewEventName.style.opacity = '1';
                    console.log(`âœ“ Preview event name updated to: "${previewEventName.textContent}"`);
                }
            }, 150);
        }
        
        // Update preview for critical fields - INSTANT updates
        const criticalFields = ['eventDate', 'eventTime', 'hostedBy', 'personalMessage', 'venueName', 'venueAddress'];
        criticalFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                // Hide placeholder immediately when field has content
                field.addEventListener('input', function() {
                    hidePlaceholderIfContent();
                    instantUpdatePreview();
                });
                field.addEventListener('change', function() {
                    hidePlaceholderIfContent();
                    instantUpdatePreview();
                });
                field.addEventListener('keyup', function() {
                    hidePlaceholderIfContent();
                    instantUpdatePreview();
                });
                field.addEventListener('blur', function() {
                    hidePlaceholderIfContent();
                    instantUpdatePreview();
                });
            }
        });
        
        // Ensure date field updates preview
        if (eventDateInput) {
            eventDateInput.addEventListener('change', instantUpdatePreview);
            eventDateInput.addEventListener('blur', instantUpdatePreview);
        }

        // Update preview for all form fields - Real-time updates
        const allInputs = document.querySelectorAll('#invitationForm input, #invitationForm textarea, #invitationForm select');
        allInputs.forEach(input => {
            // Skip file inputs - they have their own handlers
            if (input.type === 'file') {
                // Add handler for file inputs to toggle background
                input.addEventListener('change', function() {
                    toggleFormGroupBackground();
                });
                return;
            }
            
            // Use instant updates for text inputs, debounced for selects
            if (input.tagName === 'SELECT') {
                input.addEventListener('change', function() {
                    debouncedUpdatePreview();
                    toggleFormGroupBackground();
                });
            } else {
                // Instant updates for text inputs
                input.addEventListener('input', function() {
                    instantUpdatePreview();
                    toggleFormGroupBackground();
                });
                input.addEventListener('keyup', function() {
                    instantUpdatePreview();
                    toggleFormGroupBackground();
                });
                input.addEventListener('change', function() {
                    instantUpdatePreview();
                    toggleFormGroupBackground();
                });
            }
            
            // Update immediately on focus for better UX
            input.addEventListener('focus', function() {
                instantUpdatePreview();
                toggleFormGroupBackground();
            });
            
            // Update on blur to check if value was cleared
            input.addEventListener('blur', function() {
                toggleFormGroupBackground();
            });
        });
        
        console.log(`Connected ${allInputs.length} form fields to live preview`);
        
        // Initialize preview immediately with any existing form values
        instantUpdatePreview();
        
        // Initial check for form groups with content
        toggleFormGroupBackground();
        
        // Also initialize after a short delay to ensure all elements are ready
        setTimeout(function() {
            instantUpdatePreview();
            toggleFormGroupBackground();
        }, 100);

        // Show/hide event-specific fields based on event type
        function showEventSpecificFields(eventType) {
            const eventTypeLower = (eventType || '').toLowerCase().trim();
            
            // Hide all event-specific fields first
            document.querySelectorAll('.event-specific-fields').forEach(field => {
                field.style.display = 'none';
                field.style.setProperty('display', 'none', 'important');
            });
            
            // Hide all event-specific image upload fields
            const imageUploadFields = [
                'mainImage',
                'brideImage',
                'groomImage',
                'birthdayImage',
                'coupleImage',
                'graduateImage',
                'honoreeImage'
            ];
            
            // Hide all image upload form groups
            imageUploadFields.forEach(fieldId => {
                const fieldInput = document.getElementById(fieldId);
                if (fieldInput) {
                    const formGroup = fieldInput.closest('.form-group');
                    if (formGroup) {
                        formGroup.style.display = 'none';
                        formGroup.style.setProperty('display', 'none', 'important');
                    }
                }
            });

            // Show relevant fields based on event type
            const eventTypeMap = {
                'wedding': 'weddingFields',
                'birthday': 'birthdayFields',
                'anniversary': 'anniversaryFields',
                'babyshower': 'babyshowerFields',
                'graduation': 'graduationFields',
                'retirement': 'retirementFields'
            };

            const fieldId = eventTypeMap[eventTypeLower];
            if (fieldId) {
                const fieldElement = document.getElementById(fieldId);
                if (fieldElement) {
                    fieldElement.style.display = 'block';
                    fieldElement.style.setProperty('display', 'block', 'important');
                }
            }
            
            // Show only relevant image upload fields based on event type
            if (eventTypeLower === 'wedding') {
                // Wedding: Show bride and groom image fields (hide main image)
                const brideImageField = document.getElementById('brideImage');
                const groomImageField = document.getElementById('groomImage');
                if (brideImageField) {
                    const formGroup = brideImageField.closest('.form-group');
                    if (formGroup) {
                        formGroup.style.display = 'block';
                        formGroup.style.setProperty('display', 'block', 'important');
                    }
                }
                if (groomImageField) {
                    const formGroup = groomImageField.closest('.form-group');
                    if (formGroup) {
                        formGroup.style.display = 'block';
                        formGroup.style.setProperty('display', 'block', 'important');
                    }
                }
            } else if (eventTypeLower === 'birthday') {
                // Birthday: Show birthday person image field (hide main image)
                const birthdayImageField = document.getElementById('birthdayImage');
                if (birthdayImageField) {
                    const formGroup = birthdayImageField.closest('.form-group');
                    if (formGroup) {
                        formGroup.style.display = 'block';
                        formGroup.style.setProperty('display', 'block', 'important');
                    }
                }
            } else if (eventTypeLower === 'anniversary') {
                // Anniversary: Show couple image field (hide main image)
                const coupleImageField = document.getElementById('coupleImage');
                if (coupleImageField) {
                    const formGroup = coupleImageField.closest('.form-group');
                    if (formGroup) {
                        formGroup.style.display = 'block';
                        formGroup.style.setProperty('display', 'block', 'important');
                    }
                }
            } else if (eventTypeLower === 'babyshower' || eventTypeLower === 'baby shower') {
                // Baby Shower: Show main image field only (no separate image fields)
                const mainImageField = document.getElementById('mainImage');
                if (mainImageField) {
                    const formGroup = mainImageField.closest('.form-group');
                    if (formGroup) {
                        formGroup.style.display = 'block';
                        formGroup.style.setProperty('display', 'block', 'important');
                    }
                }
            } else if (eventTypeLower === 'graduation') {
                // Graduation: Show graduate image field (hide main image)
                const graduateImageField = document.getElementById('graduateImage');
                if (graduateImageField) {
                    const formGroup = graduateImageField.closest('.form-group');
                    if (formGroup) {
                        formGroup.style.display = 'block';
                        formGroup.style.setProperty('display', 'block', 'important');
                    }
                }
            } else if (eventTypeLower === 'retirement') {
                // Retirement: Show honoree image field (hide main image)
                const honoreeImageField = document.getElementById('honoreeImage');
                if (honoreeImageField) {
                    const formGroup = honoreeImageField.closest('.form-group');
                    if (formGroup) {
                        formGroup.style.display = 'block';
                        formGroup.style.setProperty('display', 'block', 'important');
                    }
                }
            } else {
                // Default: Show main image field if no specific event type
                const mainImageField = document.getElementById('mainImage');
                if (mainImageField) {
                    const formGroup = mainImageField.closest('.form-group');
                    if (formGroup) {
                        formGroup.style.display = 'block';
                        formGroup.style.setProperty('display', 'block', 'important');
                    }
                }
            }
        }

        // Function to update icon based on event type
        function updateEventIcon(eventType) {
            const previewIcon = document.getElementById('previewIcon');
            if (!previewIcon) return;
            
            const eventTypeLower = (eventType || '').toLowerCase().trim();
            
            // Set icon based on event type
            if (eventTypeLower === 'wedding') {
                previewIcon.textContent = 'ðŸ’';
            } else if (eventTypeLower === 'birthday') {
                previewIcon.textContent = 'ðŸŽ‚';
            } else if (eventTypeLower === 'anniversary') {
                previewIcon.textContent = 'ðŸ’‘';
            } else if (eventTypeLower === 'graduation') {
                previewIcon.textContent = 'ðŸŽ“';
            } else if (eventTypeLower === 'babyshower' || eventTypeLower === 'baby shower') {
                previewIcon.textContent = 'ðŸ‘¶';
            } else if (eventTypeLower === 'retirement') {
                previewIcon.textContent = 'ðŸŽ‰';
            } else {
                // Default icon if event type is not specified
                previewIcon.textContent = 'ðŸŽŠ';
            }
            
            // Keep icon hidden when template background is active (template design has its own icons)
            const previewCard = document.getElementById('invitationPreviewCard');
            if (previewCard && (previewCard.classList.contains('template-bg') || previewCard.classList.contains('wedding-bg'))) {
                previewIcon.style.display = 'none';
            }
        }
        
        // Function already defined earlier - this is just a reference to avoid duplicate definition
        // window.showEventSpecificImages is defined at the top of the script

        // Initialize event-specific fields based on current event type
        // Get event type from data attribute to avoid IDE parsing errors
        const eventTypeElement = document.getElementById('invitationPreviewCard');
        const currentEventType = eventTypeElement ? (eventTypeElement.getAttribute('data-event-type') || '') : '';
        if (currentEventType) {
            // Show only relevant images for this event type
            if (typeof window.showEventSpecificImages === 'function') {
                window.showEventSpecificImages(currentEventType);
            } else if (typeof showEventSpecificImages === 'function') {
                showEventSpecificImages(currentEventType);
            }
            showEventSpecificFields(currentEventType);
            updateEventIcon(currentEventType); // Update icon on page load
        }

        // Update default text based on event type
        function setDefaultTexts(eventType) {
            const eventNameInput = document.getElementById('eventName');
            const personalMessageInput = document.getElementById('personalMessage');
            const hostedByInput = document.getElementById('hostedBy');
            
            if (!eventNameInput || !personalMessageInput) return;

            // Get user name from hostedBy input (which is pre-filled with current_user.name)
            // If hostedBy is empty, try to get from the input's default value attribute
            let userName = '';
            if (hostedByInput) {
                userName = hostedByInput.value ? hostedByInput.value.trim() : '';
                // If empty, try to get from the value attribute (server-rendered)
                if (!userName && hostedByInput.getAttribute('value')) {
                    userName = hostedByInput.getAttribute('value').trim();
                }
            }
            
            // Map event types to display names
            const eventTypeNames = {
                'wedding': 'Wedding',
                'birthday': 'Birthday',
                'anniversary': 'Anniversary',
                'graduation': 'Graduation',
                'babyshower': 'Baby Shower',
                'retirement': 'Retirement'
            };
            
            const eventTypeName = eventTypeNames[eventType] || 'Event';

            const defaultTexts = {
                'wedding': {
                    eventName: eventNameInput.value || (userName ? `${userName}'s Wedding` : 'We request the pleasure of your company at our wedding'),
                    message: personalMessageInput.value || 'Join us as we celebrate the beginning of our new journey together. Your presence would make our special day even more meaningful.'
                },
                'birthday': {
                    eventName: eventNameInput.value || (userName ? `${userName}'s Birthday` : 'You\'re invited to celebrate!'),
                    message: personalMessageInput.value || 'Join us for a celebration filled with joy, laughter, and wonderful memories. Your presence will make this birthday truly special!'
                },
                'anniversary': {
                    eventName: eventNameInput.value || (userName ? `${userName}'s Anniversary` : 'Join us in celebrating our anniversary'),
                    message: personalMessageInput.value || 'We\'re celebrating another year of love, laughter, and cherished memories. Your presence would make our celebration complete.'
                },
                'babyshower': {
                    eventName: eventNameInput.value || (userName ? `${userName}'s Baby Shower` : 'Showering our little one with love'),
                    message: personalMessageInput.value || 'Join us as we celebrate the upcoming arrival of our little bundle of joy. Your love and blessings are warmly welcome!'
                },
                'graduation': {
                    eventName: eventNameInput.value || (userName ? `${userName}'s Graduation` : 'Celebrating a milestone achievement'),
                    message: personalMessageInput.value || 'Join us in celebrating this incredible milestone. Your presence would mean the world to us on this special day!'
                },
                'retirement': {
                    eventName: eventNameInput.value || (userName ? `${userName}'s Retirement` : 'Celebrating a remarkable career'),
                    message: personalMessageInput.value || 'Join us in honoring years of dedication and celebrating the beginning of a new chapter. Your presence would be greatly appreciated!'
                }
            };

            const defaults = defaultTexts[eventType];
            if (defaults && !eventNameInput.value) {
                eventNameInput.value = defaults.eventName;
                // Trigger input event to update preview
                instantUpdatePreview();
            }
            if (defaults && !personalMessageInput.value) {
                personalMessageInput.value = defaults.message;
                debouncedUpdatePreview();
            }
        }

        // Set default texts on page load
        if (currentEventType) {
            setDefaultTexts(currentEventType);
        }
            
        // Theme Selection - Enhanced with better feedback
        window.selectTheme = function(themeId, templateId, element) {
            // Remove previous selection
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Mark selected with smooth animation
            element.classList.add('selected');
            selectedThemeValue = templateId || themeId;
            
                // Store template ID and image for form submission
            window.selectedTemplateId = templateId;
            
            // Update hidden form fields immediately
            const templateIdInput = document.getElementById('templateIdInput');
            const templateImageUrlInput = document.getElementById('templateImageUrlInput');
            
            // Get template image and name from the selected card
            const templateImg = element.querySelector('.theme-image');
            const templateTitle = element.querySelector('.theme-title');
            
            // Get the image source - prioritize data-template-image attribute
            let templateImageUrl = null;
            
            // First, try data-template-image attribute (most reliable)
            const templateDataImage = element.getAttribute('data-template-image');
            if (templateDataImage) {
                templateImageUrl = templateDataImage;
            }
            
            // If not found, try from img element - check multiple possible classes
            if (!templateImageUrl && templateImg) {
                templateImageUrl = templateImg.getAttribute('data-src') || templateImg.src;
            }
            
            // If still not found, try finding image with different class names
            if (!templateImageUrl) {
                const themePreviewImg = element.querySelector('.theme-preview-image');
                if (themePreviewImg) {
                    templateImageUrl = themePreviewImg.getAttribute('data-src') || themePreviewImg.src;
                }
            }
            
            // If still not found, try getting from img tag directly
            if (!templateImageUrl) {
                const anyImg = element.querySelector('img');
                if (anyImg) {
                    templateImageUrl = anyImg.getAttribute('data-src') || anyImg.src;
                }
            }
            
            // Normalize the image path using the global function
            if (templateImageUrl) {
                templateImageUrl = normalizeImagePath(templateImageUrl);
                
                // Skip if normalization returned null (placeholder/invalid URL)
                if (!templateImageUrl) {
                    console.warn('Invalid template image URL (placeholder), skipping:', templateImg?.src || templateDataImage);
                    return;
                }
            }
            
            // Safely get template name - textContent is already safe, but ensure fallback is properly escaped
            const templateName = templateTitle ? templateTitle.textContent : (themeId || '');
            
            // Detect event type from template name and update icon
            const templateNameLower = templateName.toLowerCase();
            let detectedEventType = '';
            if (templateNameLower.includes('wedding') || templateNameLower.includes('marriage')) {
                detectedEventType = 'wedding';
            } else if (templateNameLower.includes('birthday') || templateNameLower.includes('bday')) {
                detectedEventType = 'birthday';
            } else if (templateNameLower.includes('anniversary')) {
                detectedEventType = 'anniversary';
            } else if (templateNameLower.includes('graduation')) {
                detectedEventType = 'graduation';
            } else if (templateNameLower.includes('baby') || templateNameLower.includes('shower')) {
                detectedEventType = 'babyshower';
            } else if (templateNameLower.includes('retirement')) {
                detectedEventType = 'retirement';
            }
            
            // Update icon based on detected event type
            if (detectedEventType) {
                updateEventIcon(detectedEventType);
                // Also update the data-event-type attribute on preview card
                const previewCard = document.getElementById('invitationPreviewCard');
                if (previewCard) {
                    previewCard.setAttribute('data-event-type', detectedEventType);
                }
                // Update the hidden event type input
                const eventTypeInput = document.getElementById('eventTypeInput');
                if (eventTypeInput) {
                    eventTypeInput.value = detectedEventType;
                }
                // Update default event name text based on detected event type
                setDefaultTexts(detectedEventType);
                // Filter images to show only event-specific ones
                if (typeof window.showEventSpecificImages === 'function') {
                    window.showEventSpecificImages(detectedEventType);
                } else if (typeof showEventSpecificImages === 'function') {
                    showEventSpecificImages(detectedEventType);
                }
                // CRITICAL: Show/hide form fields based on event type
                showEventSpecificFields(detectedEventType);
            }
            
            // Update preview background with selected template immediately
            // Apply template image as background in live preview
            // CRITICAL: Double-check for placeholder URLs after normalization
            if (templateImageUrl && !templateImageUrl.includes('placeholder') && !templateImageUrl.includes('via.placeholder')) {
                // Normalize the URL using the global function (this also filters placeholders)
                let cleanUrl = normalizeImagePath(templateImageUrl);
                
                // Final safety check - if normalization returned null or still has placeholder, skip
                if (!cleanUrl || cleanUrl.includes('placeholder') || cleanUrl.includes('via.placeholder')) {
                    console.warn('âŒ Placeholder URL detected after normalization, skipping:', templateImageUrl);
                    return;
                }
                
                console.log('âœ… Template selected - Applying background:', templateId, cleanUrl);
                console.log('ðŸ” Debug - Template Image URL:', cleanUrl);
                console.log('ðŸ” Debug - Template ID:', templateId || themeId);
                console.log('ðŸ” Debug - Template Name:', templateName);
                
                // Store template image URL for form submission
                window.selectedTemplateImage = cleanUrl;
                window.selectedTemplateId = templateId || themeId;
                window.selectedTemplateName = templateName;
                
                // Update hidden form fields immediately
                if (templateIdInput) templateIdInput.value = templateId || '';
                if (templateImageUrlInput) templateImageUrlInput.value = cleanUrl;
                
                // Get preview card FIRST - apply immediately regardless of page state
                const previewCard = document.getElementById('invitationPreviewCard');
                console.log('ðŸ” Debug - Preview Card Found:', !!previewCard);
                
                if (previewCard) {
                    // CRITICAL: Make preview card visible FIRST
                    previewCard.style.display = 'flex';
                    previewCard.style.visibility = 'visible';
                    previewCard.style.opacity = '1';
                    
                    // Ensure preview content container is visible
                    const previewContent = previewCard.closest('.preview-content') || document.querySelector('.preview-content');
                    if (previewContent) {
                        previewContent.style.display = 'flex';
                        previewContent.style.visibility = 'visible';
                        previewContent.style.opacity = '1';
                        console.log('ðŸ” Debug - Preview Content Visible:', true);
                    }
                    
                    // Ensure live preview card is visible
                    const livePreviewCard = document.querySelector('.live-preview-card');
                    if (livePreviewCard) {
                        livePreviewCard.style.display = 'flex';
                        livePreviewCard.style.visibility = 'visible';
                        livePreviewCard.style.opacity = '1';
                        console.log('ðŸ” Debug - Live Preview Card Visible:', true);
                    }
                    
                    // CRITICAL: Remove ALL background properties first (exactly like working code)
                    previewCard.style.removeProperty('background');
                    previewCard.style.removeProperty('background-image');
                    previewCard.style.removeProperty('background-color');
                    previewCard.style.removeProperty('background-size');
                    previewCard.style.removeProperty('background-position');
                    previewCard.style.removeProperty('background-repeat');
                    
                    // Set transparent background color
                    previewCard.style.setProperty('background-color', 'transparent', 'important');
                    
                    // Remove wedding-bg class and add template-bg
                    previewCard.classList.remove('wedding-bg');
                    previewCard.classList.add('template-bg');
                    console.log('ðŸ” Debug - Template-bg class added');
                    
                    // Escape single quotes in URL for CSS (exactly like working code)
                    const escapedUrl = cleanUrl.replace(/'/g, "\\'");
                    const bgImageUrl = `url('${escapedUrl}')`;
                    
                    // CRITICAL: Apply background image MULTIPLE ways (exactly like working code)
                    // Method 1: CSS variable
                    previewCard.style.setProperty('--template-bg-image-url', bgImageUrl, 'important');
                    
                    // Method 2: setProperty with !important - Use 100% 100% to fill entire card
                    previewCard.style.setProperty('background-image', bgImageUrl, 'important');
                    previewCard.style.setProperty('background-size', '100% 100%', 'important');
                    previewCard.style.setProperty('background-position', 'center center', 'important');
                    previewCard.style.setProperty('background-repeat', 'no-repeat', 'important');
                    previewCard.style.setProperty('background-attachment', 'scroll', 'important');
                    previewCard.style.setProperty('height', 'auto', 'important');
                    previewCard.style.setProperty('min-height', 'auto', 'important');
                    previewCard.style.setProperty('width', '100%', 'important');
                    
                    // Method 3: Direct style assignment - Use 100% 100% to fill entire card
                    previewCard.style.backgroundImage = bgImageUrl;
                    previewCard.style.backgroundSize = '100% 100%';
                    previewCard.style.backgroundPosition = 'center center';
                    previewCard.style.backgroundRepeat = 'no-repeat';
                    previewCard.style.backgroundAttachment = 'scroll';
                    previewCard.style.backgroundColor = 'transparent';
                    previewCard.style.height = 'auto';
                    previewCard.style.minHeight = '700px';
                    previewCard.style.width = '100%';
                    
                    console.log('ðŸ” Debug - Background Image URL Applied:', bgImageUrl);
                    
                    // Force a reflow to ensure background is applied
                    void previewCard.offsetHeight;
                    
                    // Use requestAnimationFrame for better rendering (exactly like working code)
                    requestAnimationFrame(() => {
                        previewCard.style.setProperty('background-image', bgImageUrl, 'important');
                        previewCard.style.backgroundImage = bgImageUrl;
                        
                        const computedBg = window.getComputedStyle(previewCard).backgroundImage;
                        console.log('ðŸ” Debug - Computed Background (after RAF):', computedBg);
                    });
                    
                    // Verify immediately
                    const computedBg = window.getComputedStyle(previewCard).backgroundImage;
                    console.log('ðŸ” Debug - Computed Background (immediate):', computedBg);
                    
                    // Double-check after a brief delay (exactly like working code)
                    setTimeout(() => {
                        const computedBg2 = window.getComputedStyle(previewCard).backgroundImage;
                        console.log('ðŸ” Debug - Computed Background (after delay):', computedBg2);
                        if (computedBg2 && computedBg2 !== 'none' && computedBg2.includes('url')) {
                            console.log('âœ… Template background confirmed in live preview:', cleanUrl);
                        } else {
                            // Re-apply if not set - try different approach
                            console.warn('âš ï¸ Background not applied, re-applying with all methods...');
                            previewCard.style.setProperty('background-image', bgImageUrl, 'important');
                            previewCard.style.backgroundImage = bgImageUrl;
                            previewCard.style.setProperty('--template-bg-image-url', bgImageUrl, 'important');
                            
                            // Force one more time
                            setTimeout(() => {
                                previewCard.style.setProperty('background-image', bgImageUrl, 'important');
                                const finalBg = window.getComputedStyle(previewCard).backgroundImage;
                                console.log('ðŸ” Debug - Final Background Check:', finalBg);
                            }, 50);
                        }
                    }, 100);
                    
                    // Hide emoji icon when template background is active
                    const previewIcon = document.getElementById('previewIcon');
                    if (previewIcon) {
                        previewIcon.style.display = 'none';
                    }
                    
                    // Hide placeholder when template is selected
                    const previewPlaceholder = document.getElementById('previewPlaceholder');
                    if (previewPlaceholder) {
                        previewPlaceholder.style.display = 'none';
                    }
                    
                    console.log('âœ… Template overlay applied to live preview IMMEDIATELY:', cleanUrl);
                    
                    // Test if image actually exists by creating an Image object (exactly like working code)
                    const testImg = new Image();
                    testImg.onload = function() {
                        console.log('âœ… Template image loaded successfully:', cleanUrl);
                        // Ensure it's still applied after image loads
                        previewCard.style.setProperty('background-image', bgImageUrl, 'important');
                        previewCard.style.backgroundImage = bgImageUrl;
                        previewCard.style.setProperty('--template-bg-image-url', bgImageUrl, 'important');
                        
                        // Ensure all preview content is visible on top of template
                        ensurePreviewContentVisible();
                    };
                    testImg.onerror = function() {
                        console.error('âŒ Template image failed to load:', cleanUrl);
                        console.error('âŒ Trying fallback image...');
                        const fallbackUrl = '/images/templatesimages/wedding.png';
                        const fallbackImageUrl = `url('${fallbackUrl}')`;
                        previewCard.style.setProperty('background-image', fallbackImageUrl, 'important');
                        previewCard.style.backgroundImage = fallbackImageUrl;
                        
                        // Ensure all preview content is visible on top of template
                        ensurePreviewContentVisible();
                    };
                    testImg.src = cleanUrl;
                } else {
                    console.warn('âš ï¸ Preview card not found!');
                }
                
                // Also call updatePreviewBackground function for additional setup
                updatePreviewBackground(templateId || themeId, cleanUrl, templateName);
                
                // Ensure all preview content is visible on top of template
                ensurePreviewContentVisible();
                
                // Also ensure preview card is updated immediately - even if details page isn't visible yet
                if (previewCard) {
                    // Apply background immediately so it's ready when user goes to details
                    // Remove default background first
                    // CRITICAL: Don't set background: 'none' as it resets background-image!
                    previewCard.style.removeProperty('background');
                    previewCard.style.backgroundColor = 'transparent';
                    // Remove wedding-bg class and add template-bg to show template overlay
                    previewCard.classList.remove('wedding-bg');
                    previewCard.classList.add('template-bg');
                    // Set template image directly as background-image with !important
                    const escapedUrl = cleanUrl.replace(/'/g, "\\'");
                    const bgImageUrl = `url('${escapedUrl}')`;
                    previewCard.style.setProperty('background-image', bgImageUrl, 'important');
                    previewCard.style.backgroundImage = bgImageUrl;
                    previewCard.style.setProperty('background-size', '100% 100%', 'important');
                    previewCard.style.backgroundSize = '100% 100%';
                    previewCard.style.setProperty('background-position', 'center center', 'important');
                    previewCard.style.backgroundPosition = 'center center';
                    previewCard.style.setProperty('background-repeat', 'no-repeat', 'important');
                    previewCard.style.backgroundRepeat = 'no-repeat';
                    previewCard.style.setProperty('background-attachment', 'scroll', 'important');
                    previewCard.style.backgroundAttachment = 'scroll';
                    previewCard.style.setProperty('height', 'auto', 'important');
                    previewCard.style.height = 'auto';
                    
                    // Hide emoji icon when template background is active
                    const previewIcon = document.getElementById('previewIcon');
                    if (previewIcon) {
                        previewIcon.style.display = 'none';
                    }
                    
                    // Hide placeholder when template is selected
                    const previewPlaceholder = document.getElementById('previewPlaceholder');
                    if (previewPlaceholder) {
                        previewPlaceholder.style.display = 'none';
                    }
                    
                    // Force a reflow to ensure background is applied
                    void previewCard.offsetHeight;
                    
                    // Double-check after a brief delay
                    setTimeout(() => {
                        const computedBg = window.getComputedStyle(previewCard).backgroundImage;
                        if (computedBg && computedBg !== 'none') {
                            console.log('âœ… Template background confirmed in live preview:', cleanUrl);
                        } else {
                            // Re-apply if not set
                            previewCard.style.setProperty('background-image', bgImageUrl, 'important');
                            console.log('ðŸ”„ Re-applied template background to live preview');
                        }
                    }, 100);
                    
                    console.log('âœ… Template overlay applied to live preview IMMEDIATELY:', cleanUrl);
                    
                    // Ensure all preview content is visible on top of template
                    ensurePreviewContentVisible();
                } else {
                    // Preview card doesn't exist yet (user still on theme selection page)
                    // Store the template info so it applies when details page loads
                    console.log('â³ Preview card not found yet - template will apply when details page loads');
                    // CRITICAL: Final check before storing in sessionStorage - block placeholder URLs
                    if (cleanUrl && (cleanUrl.includes('placeholder.com') || cleanUrl.includes('via.placeholder') || cleanUrl.includes('placeholder'))) {
                        console.error('âŒ Placeholder URL blocked from sessionStorage:', cleanUrl);
                        cleanUrl = '/images/templatesimages/wedding.png'; // Default fallback
                    }
                    
                    // Store for later application
                    sessionStorage.setItem('selectedTemplateBackground', cleanUrl);
                    sessionStorage.setItem('selectedTemplateId', templateId || themeId);
                }
            } else {
                console.warn('Template image URL not found or invalid:', templateImageUrl);
                // Still try to show the template even if URL has issues
                if (templateImg && templateImg.src) {
                    let cleanUrl = normalizeImagePath(templateImg.src);
                    if (cleanUrl) {
                        updatePreviewBackground(templateId || themeId, cleanUrl, templateName);
                    }
                }
            }
            
            // Update hidden input with template ID or name
            const templateInput = document.getElementById('selectedTemplate');
            if (templateInput) {
                templateInput.value = templateId || themeId;
            }
            
            // Enable continue button with smooth transition
            const continueBtn = document.getElementById('continueToDetails');
            if (continueBtn) {
                continueBtn.disabled = false;
                continueBtn.style.opacity = '1';
                continueBtn.style.cursor = 'pointer';
                continueBtn.style.transition = 'all 0.3s ease';
            }
            
            // Optional: Scroll to continue button on mobile
            if (window.innerWidth < 968 && continueBtn) {
                setTimeout(() => {
                    continueBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 300);
            }
        };

        // Continue to Details
        window.continueToDetails = function() {
            // Check for dropdown selection first
            const themeSelect = document.getElementById('themeSelect');
            let templateId = null;
            let templateImageUrl = null;
            let templateName = null;
            
            if (themeSelect && themeSelect.value) {
                const selectedOption = themeSelect.options[themeSelect.selectedIndex];
                templateId = selectedOption.value;
                templateImageUrl = selectedOption.getAttribute('data-template-image');
                templateName = selectedOption.getAttribute('data-template-name');
                selectedThemeValue = templateId;
            } else if (!selectedThemeValue) {
                // Fallback to card selection
                const selectedCard = document.querySelector('.theme-card.selected');
                if (selectedCard) {
                    const templateDataImage = selectedCard.getAttribute('data-template-image');
                    const templateImg = selectedCard.querySelector('.theme-image');
                    const templateTitle = selectedCard.querySelector('.theme-title');
                    
                    templateImageUrl = templateDataImage || (templateImg ? templateImg.src : null);
                    templateName = templateTitle ? templateTitle.textContent : (selectedThemeValue || '');
                    templateId = selectedCard.getAttribute('data-template-id') || selectedThemeValue;
                } else {
                    alert('Please select a theme first');
                    return;
                }
            } else {
                // Use existing selectedThemeValue
                const selectedCard = document.querySelector('.theme-card.selected');
                if (selectedCard) {
                    const templateDataImage = selectedCard.getAttribute('data-template-image');
                    const templateImg = selectedCard.querySelector('.theme-image');
                    const templateTitle = selectedCard.querySelector('.theme-title');
                    
                    templateImageUrl = templateDataImage || (templateImg ? templateImg.src : null);
                    templateName = templateTitle ? templateTitle.textContent : (selectedThemeValue || '');
                }
            }

            // Normalize the URL using the global function (this will filter out placeholder URLs)
            if (templateImageUrl) {
                templateImageUrl = normalizeImagePath(templateImageUrl);
            }
            
            // Skip if normalization returned null (placeholder/invalid URL)
            if (templateImageUrl) {
                // CRITICAL: Final check before storing in sessionStorage - block placeholder URLs
                if (templateImageUrl.includes('placeholder.com') || templateImageUrl.includes('via.placeholder') || templateImageUrl.includes('placeholder')) {
                    console.error('âŒ Placeholder URL blocked from sessionStorage in continueToDetails:', templateImageUrl);
                    templateImageUrl = '/images/templatesimages/wedding.png'; // Default fallback
                }
                
                // Store in sessionStorage as backup
                sessionStorage.setItem('selectedTemplateBackground', templateImageUrl);
                sessionStorage.setItem('selectedTemplateId', templateId || selectedThemeValue);
            }
            
            // Also check sessionStorage for template background (from theme selection)
            if (!templateImageUrl) {
                templateImageUrl = sessionStorage.getItem('selectedTemplateBackground');
                const storedTemplateId = sessionStorage.getItem('selectedTemplateId');
                if (storedTemplateId) {
                    selectedThemeValue = storedTemplateId;
                    templateId = storedTemplateId;
                }
            }
            
            if (templateImageUrl && !templateImageUrl.includes('placeholder')) {
                console.log('ðŸŽ¯ Applying template background when continuing to details:', templateImageUrl);
                updatePreviewBackground(selectedThemeValue, templateImageUrl, templateName || selectedThemeValue);
                
                // Also directly apply to preview card to ensure it's visible
                const previewCard = document.getElementById('invitationPreviewCard');
                if (previewCard) {
                    // Remove default background first
                    // CRITICAL: Don't set background: 'none' as it resets background-image!
                    previewCard.style.removeProperty('background');
                    // CRITICAL: Final check before setting background - block placeholder URLs
                    if (templateImageUrl && (templateImageUrl.includes('placeholder.com') || templateImageUrl.includes('via.placeholder'))) {
                        console.error('âŒ Placeholder URL detected, using fallback instead:', templateImageUrl);
                        templateImageUrl = '/images/templatesimages/wedding.png';
                    }
                    
                    previewCard.style.backgroundColor = 'transparent';
                    previewCard.classList.remove('wedding-bg');
                    previewCard.classList.add('template-bg');
                    // Set template image directly as background-image - Use 100% 100% to fill entire card
                    previewCard.style.backgroundImage = `url('${templateImageUrl}')`;
                    previewCard.style.backgroundSize = '100% 100%';
                    previewCard.style.backgroundPosition = 'center center';
                    previewCard.style.backgroundRepeat = 'no-repeat';
                    previewCard.style.backgroundAttachment = 'scroll';
                    previewCard.style.height = 'auto';
                    previewCard.style.setProperty('background-image', `url('${templateImageUrl}')`, 'important');
                    previewCard.style.setProperty('background-size', '100% 100%', 'important');
                    previewCard.style.setProperty('background-position', 'center center', 'important');
                    previewCard.style.setProperty('background-attachment', 'scroll', 'important');
                    previewCard.style.setProperty('height', 'auto', 'important');
                    
                    console.log('âœ… Template overlay applied directly to preview card');
                }
            }

            document.getElementById('themeSelectionPage').classList.remove('active');
            document.getElementById('detailsFormPage').classList.add('active');
            
            // Update progress bar
            updateProgressBar(3);
        };

        // Update Progress Bar
        function updateProgressBar(step) {
            document.querySelectorAll('.progress-step').forEach((stepEl, index) => {
                const stepNum = index + 1;
                    const circle = stepEl.querySelector('.step-circle');
                const label = stepEl.querySelector('.step-label');
                
                // Ensure circle and label are always visible
                    if (circle) {
                    circle.style.visibility = 'visible';
                    circle.style.opacity = '1';
                    circle.style.display = 'flex';
                }
                if (label) {
                    label.style.visibility = 'visible';
                    label.style.opacity = '1';
                    label.style.display = 'block';
                    label.style.color = 'var(--reddish-brown-dark)';
                }
                
                // Add animation delay based on step position for sequential animation
                const delay = index * 0.2;
                
                // Reset progress line by temporarily removing classes to reset width
                const wasCompleted = stepEl.classList.contains('completed');
                const wasActive = stepEl.classList.contains('active');
                if (wasCompleted || wasActive) {
                    stepEl.classList.remove('completed', 'active');
                    // Force reflow to reset width
                    void stepEl.offsetWidth;
                }
                
                if (stepNum < step) {
                    // Animate to completed state with checkmark
                    stepEl.classList.remove('active', 'pending', 'animating-line');
                    // Reset line width
                    stepEl.style.setProperty('--line-width', '0');
                    // Force reflow
                    void stepEl.offsetWidth;
                    // Add animating class first, then completed class to trigger line animation
                    setTimeout(() => {
                        stepEl.classList.add('animating-line', 'completed');
                    }, delay * 100);
                    
                    if (circle) {
                        // Reset animation first
                        circle.style.animation = 'none';
                        // Force reflow
                        void circle.offsetWidth;
                        // Animate checkmark appearance
                        setTimeout(() => {
                        circle.textContent = 'âœ“';
                            circle.style.background = 'var(--reddish-brown-dark)';
                            circle.style.color = '#FFFFFF';
                            circle.style.animation = 'checkmarkAppear 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
                        }, delay * 100 + 300);
                    }
                } else if (stepNum === step) {
                    // Animate to active state with pulse
                    stepEl.classList.remove('completed', 'pending', 'animating-line');
                    // Reset line width
                    stepEl.style.setProperty('--line-width', '0');
                    // Force reflow
                    void stepEl.offsetWidth;
                    // Add animating class first, then active class to trigger line animation
                    setTimeout(() => {
                        stepEl.classList.add('animating-line', 'active');
                    }, delay * 100);
                    
                    if (circle) {
                        // Reset animation first
                        circle.style.animation = 'none';
                        // Force reflow
                        void circle.offsetWidth;
                        // Animate active step appearance
                        setTimeout(() => {
                            circle.textContent = stepNum.toString();
                            circle.style.background = 'var(--golden-yellow)';
                            circle.style.color = 'var(--reddish-brown-dark)';
                            circle.style.animation = 'activeStepAppear 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards, pulseActive 2s ease-in-out infinite 0.5s';
                        }, delay * 100 + 300);
                    }
            } else {
                    // Set to pending state (no animation)
                    stepEl.classList.remove('active', 'completed');
                    stepEl.classList.add('pending');
                    
                    if (circle) {
                        circle.textContent = stepNum.toString();
                        circle.style.background = '#FFFFFF';
                        circle.style.color = 'var(--reddish-brown-dark)';
                        circle.style.border = '2px solid var(--reddish-brown-dark)';
                        circle.style.animation = 'none';
                    }
                }
            });
        }
        
        // Ensure all progress bar elements are visible on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Make sure all step circles and labels are visible
            document.querySelectorAll('.step-circle').forEach(circle => {
                circle.style.visibility = 'visible';
                circle.style.opacity = '1';
                circle.style.display = 'flex';
            });
            
            document.querySelectorAll('.step-label').forEach(label => {
                label.style.visibility = 'visible';
                label.style.opacity = '1';
                label.style.display = 'block';
                label.style.color = 'var(--reddish-brown-dark)';
            });
            
            // Ensure progress bar container has no background
            const progressBarContainer = document.querySelector('.progress-bar-container');
            if (progressBarContainer) {
                progressBarContainer.style.background = 'transparent';
            }
            
            const progressBar = document.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.background = 'transparent';
            }
            
            // CRITICAL: Ensure preview card is always visible from the start
            const previewCard = document.getElementById('invitationPreviewCard');
            const livePreviewCard = document.querySelector('.live-preview-card');
            const previewContent = document.querySelector('.preview-content');
            const previewTitle = document.querySelector('.preview-title');
            const previewPlaceholder = document.getElementById('previewPlaceholder');
            
            // Force preview card to be visible
            if (previewCard) {
                previewCard.style.setProperty('display', 'flex', 'important');
                previewCard.style.setProperty('visibility', 'visible', 'important');
                previewCard.style.setProperty('opacity', '1', 'important');
            }
            
            // Force live preview card to be visible
            if (livePreviewCard) {
                livePreviewCard.style.setProperty('display', 'flex', 'important');
                livePreviewCard.style.setProperty('visibility', 'visible', 'important');
                livePreviewCard.style.setProperty('opacity', '1', 'important');
            }
            
            // Force preview content to be visible
            if (previewContent) {
                previewContent.style.setProperty('display', 'flex', 'important');
                previewContent.style.setProperty('visibility', 'visible', 'important');
                previewContent.style.setProperty('opacity', '1', 'important');
            }
            
            // Force preview title to be visible
            if (previewTitle) {
                previewTitle.style.setProperty('display', 'block', 'important');
                previewTitle.style.setProperty('visibility', 'visible', 'important');
                previewTitle.style.setProperty('opacity', '1', 'important');
            }
            
            // Check if there's any content in form fields and hide placeholder immediately
            if (typeof hidePlaceholderIfContent === 'function') {
                hidePlaceholderIfContent();
            }
            
            // Show placeholder if no content yet (but keep preview card visible)
            if (previewPlaceholder) {
                const hasContent = previewCard && (
                    (previewCard.querySelector('#previewEventName') && previewCard.querySelector('#previewEventName').textContent && previewCard.querySelector('#previewEventName').textContent.trim()) ||
                    (previewCard.querySelector('#previewDate') && previewCard.querySelector('#previewDate').style.display !== 'none') ||
                    previewCard.classList.contains('template-bg')
                );
                
                // Also check form fields directly
                const formHasContent = document.getElementById('eventName')?.value.trim() ||
                                     document.getElementById('eventDate')?.value ||
                                     document.getElementById('eventTime')?.value ||
                                     document.getElementById('venueName')?.value.trim() ||
                                     document.getElementById('venueAddress')?.value.trim() ||
                                     document.getElementById('hostedBy')?.value.trim() ||
                                     document.getElementById('mainImage')?.files.length > 0;
                
                if (!hasContent && !formHasContent) {
                    previewPlaceholder.style.setProperty('display', 'block', 'important');
                    previewPlaceholder.style.setProperty('visibility', 'visible', 'important');
                    previewPlaceholder.style.setProperty('opacity', '1', 'important');
                } else {
                    previewPlaceholder.style.setProperty('display', 'none', 'important');
                    previewPlaceholder.style.setProperty('visibility', 'hidden', 'important');
                    previewPlaceholder.style.setProperty('opacity', '0', 'important');
                }
            }
            
            // Ensure Preview button is always visible and clearly visible
            const previewButton = document.querySelector('.btn-preview');
            if (previewButton) {
                previewButton.style.setProperty('visibility', 'visible', 'important');
                previewButton.style.setProperty('opacity', '1', 'important');
                previewButton.style.setProperty('display', 'inline-flex', 'important');
                previewButton.style.setProperty('color', '#FFFFFF', 'important');
                previewButton.style.setProperty('background', 'linear-gradient(135deg, #6F4E37 0%, #D4AF37 100%)', 'important');
                previewButton.style.setProperty('border', '3px solid #FFFFFF', 'important');
                previewButton.style.setProperty('box-shadow', '0 4px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(111, 78, 55, 0.5)', 'important');
                previewButton.style.setProperty('position', 'relative', 'important');
                previewButton.style.setProperty('z-index', '100', 'important');
                previewButton.style.setProperty('backdrop-filter', 'blur(5px)', 'important');
                
                // Ensure text content is visible
                const buttonText = previewButton.childNodes;
                buttonText.forEach(node => {
                    if (node.nodeType === 3) { // Text node
                        node.parentElement.style.setProperty('color', '#FFFFFF', 'important');
                        node.parentElement.style.setProperty('text-shadow', '1px 1px 3px rgba(0, 0, 0, 0.5)', 'important');
                    }
                });
                
                // Ensure icon is visible
                const icon = previewButton.querySelector('i');
                if (icon) {
                    icon.style.setProperty('visibility', 'visible', 'important');
                    icon.style.setProperty('opacity', '1', 'important');
                    icon.style.setProperty('display', 'inline-block', 'important');
                    icon.style.setProperty('color', '#FFFFFF', 'important');
                    icon.style.setProperty('text-shadow', '1px 1px 3px rgba(0, 0, 0, 0.5)', 'important');
                }
            }
            
            // Ensure form navigation container is visible
            const formNavigation = document.querySelector('.form-navigation');
            if (formNavigation) {
                formNavigation.style.setProperty('display', 'flex', 'important');
                formNavigation.style.setProperty('visibility', 'visible', 'important');
                formNavigation.style.setProperty('opacity', '1', 'important');
            }
        });

        // ============================================
        // THREE-COLUMN EDITOR FUNCTIONALITY
        // ============================================
        
        // Sidebar Tab Switching - FIXED
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarTabs = document.querySelectorAll('.sidebar-tab');
            const sidebarPanels = document.querySelectorAll('.sidebar-panel');
            
            console.log('Sidebar tabs found:', sidebarTabs.length);
            console.log('Sidebar panels found:', sidebarPanels.length);
            
            sidebarTabs.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const targetTab = this.getAttribute('data-tab');
                    console.log('Tab clicked:', targetTab);
                    
                    // Remove active class from all tabs and panels
                    sidebarTabs.forEach(t => {
                        t.classList.remove('active');
                    });
                    sidebarPanels.forEach(p => {
                        p.classList.remove('active');
                        p.style.display = 'none';
                    });
                    
                    // Add active class to clicked tab and corresponding panel
                    this.classList.add('active');
                    const targetPanel = document.getElementById(targetTab + '-panel');
                    if (targetPanel) {
                        targetPanel.classList.add('active');
                        targetPanel.style.display = 'block';
                        console.log('âœ… Panel activated:', targetTab + '-panel');
                    } else {
                        console.error('Panel not found:', targetTab + '-panel');
                    }
                });
            });
            
            // Desktop/Mobile View Toggle - FIXED
            const desktopViewBtn = document.getElementById('desktopViewBtn');
            const mobileViewBtn = document.getElementById('mobileViewBtn');
            const desktopPreviewView = document.getElementById('desktopPreviewView');
            const mobilePreviewView = document.getElementById('mobilePreviewView');
            
            if (desktopViewBtn && mobileViewBtn) {
                // Desktop View Button Click Handler
                desktopViewBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Update button states
                    desktopViewBtn.classList.add('active');
                    mobileViewBtn.classList.remove('active');
                    
                    // Show desktop view - FILL ENTIRE PREVIEW
                    if (desktopPreviewView) {
                        desktopPreviewView.style.display = 'block';
                        desktopPreviewView.style.setProperty('display', 'block', 'important');
                        desktopPreviewView.style.visibility = 'visible';
                        desktopPreviewView.style.opacity = '1';
                        desktopPreviewView.style.width = '100%';
                        desktopPreviewView.style.maxWidth = '100%';
                        desktopPreviewView.style.height = 'auto';
                        desktopPreviewView.style.overflow = 'visible';
                        desktopPreviewView.classList.remove('hidden');
                        
                        // Ensure invitation fills the desktop view
                        const desktopInvitation = desktopPreviewView.querySelector('.invitation-preview');
                        if (desktopInvitation) {
                            desktopInvitation.style.width = '100%';
                            desktopInvitation.style.maxWidth = '100%';
                            desktopInvitation.style.margin = '0 auto';
                        }
                    }
                    
                    // Hide mobile view
                    if (mobilePreviewView) {
                        mobilePreviewView.style.display = 'none';
                        mobilePreviewView.style.setProperty('display', 'none', 'important');
                        mobilePreviewView.style.visibility = 'hidden';
                        mobilePreviewView.style.opacity = '0';
                        mobilePreviewView.classList.remove('active');
                    }
                    
                    console.log('âœ… Desktop view activated');
                });
                
                // Mobile View Button Click Handler
                mobileViewBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Update button states
                    mobileViewBtn.classList.add('active');
                    desktopViewBtn.classList.remove('active');
                    
                    // Hide desktop view
                    if (desktopPreviewView) {
                        desktopPreviewView.style.display = 'none';
                        desktopPreviewView.style.setProperty('display', 'none', 'important');
                        desktopPreviewView.style.visibility = 'hidden';
                        desktopPreviewView.style.opacity = '0';
                        desktopPreviewView.classList.add('hidden');
                    }
                    
                    // Show mobile view - PROPER MOBILE DISPLAY
                    if (mobilePreviewView) {
                        mobilePreviewView.style.display = 'block';
                        mobilePreviewView.style.setProperty('display', 'block', 'important');
                        mobilePreviewView.style.visibility = 'visible';
                        mobilePreviewView.style.opacity = '1';
                        mobilePreviewView.style.width = '100%';
                        mobilePreviewView.style.maxWidth = '100%';
                        mobilePreviewView.style.height = 'auto';
                        mobilePreviewView.style.overflow = 'visible';
                        mobilePreviewView.classList.add('active');
                        
                        // Sync mobile preview with desktop content FIRST
                        syncMobilePreview();
                        
                        // Then ensure invitation displays properly in mobile view
                        setTimeout(() => {
                            const mobileInvitation = mobilePreviewView.querySelector('.invitation-preview');
                            const mobileCard = mobilePreviewView.querySelector('.live-preview-card');
                            
                            if (mobileInvitation) {
                                mobileInvitation.style.maxWidth = '400px';
                                mobileInvitation.style.width = '100%';
                                mobileInvitation.style.margin = '0 auto';
                                mobileInvitation.style.transform = 'scale(0.85)';
                                mobileInvitation.style.transformOrigin = 'top center';
                                mobileInvitation.style.display = 'flex';
                                mobileInvitation.style.setProperty('display', 'flex', 'important');
                                mobileInvitation.style.visibility = 'visible';
                                mobileInvitation.style.opacity = '1';
                            }
                            
                            if (mobileCard) {
                                mobileCard.style.display = 'flex';
                                mobileCard.style.setProperty('display', 'flex', 'important');
                                mobileCard.style.visibility = 'visible';
                                mobileCard.style.opacity = '1';
                            }
                        }, 100);
                    }
                    
                    console.log('âœ… Mobile view activated');
                });
                
                // Initialize: Ensure desktop view is active by default
                if (desktopPreviewView && mobilePreviewView) {
                    // Desktop view should be visible by default
                    desktopPreviewView.style.display = 'block';
                    desktopPreviewView.style.setProperty('display', 'block', 'important');
                    desktopPreviewView.style.visibility = 'visible';
                    desktopPreviewView.style.opacity = '1';
                    desktopPreviewView.classList.remove('hidden');
                    
                    // Mobile view should be hidden by default
                    mobilePreviewView.style.display = 'none';
                    mobilePreviewView.style.setProperty('display', 'none', 'important');
                    mobilePreviewView.style.visibility = 'hidden';
                    mobilePreviewView.style.opacity = '0';
                    mobilePreviewView.classList.remove('active');
                    
                    // Ensure buttons are in correct state
                    desktopViewBtn.classList.add('active');
                    mobileViewBtn.classList.remove('active');
                    
                    console.log('âœ… Desktop view initialized as default');
                }
            }
            
            // Template Select Button Handlers - Setup for dynamically loaded templates
            function setupTemplateSelectButtons() {
                document.querySelectorAll('.template-select-btn').forEach(btn => {
                    // Remove existing listeners
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    
                    newBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const templateId = this.getAttribute('data-template-id');
                        const templateName = this.getAttribute('data-template-name');
                        const templateImage = this.getAttribute('data-template-image');
                        const eventType = this.getAttribute('data-event-type');
                        
                        console.log('Select button clicked:', { templateId, templateName, templateImage, eventType });
                        
                        if (templateId && templateImage) {
                            selectTemplateFromSidebar(templateId, templateName, templateImage, eventType);
                            
                            // Visual feedback
                            this.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                            this.innerHTML = '<i class="fas fa-check" style="margin-right: 6px;"></i>Selected';
                            
                            // Reset other buttons
                            document.querySelectorAll('.template-select-btn').forEach(b => {
                                if (b !== this) {
                                    b.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                                    b.innerHTML = '<i class="fas fa-check-circle" style="margin-right: 6px;"></i>Select';
                                }
                            });
                        }
                    });
                });
            }
            
            // Template Select Buttons - FIXED
            function setupSelectButtons() {
                document.querySelectorAll('.template-select-btn').forEach(btn => {
                    // Remove existing listeners
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    
                    newBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const templateId = this.getAttribute('data-template-id');
                        const templateName = this.getAttribute('data-template-name');
                        const templateImage = this.getAttribute('data-template-image');
                        const eventType = this.getAttribute('data-event-type');
                        
                        console.log('Select button clicked:', { templateId, templateName, templateImage, eventType });
                        
                        if (templateId && templateImage) {
                            selectTemplateFromSidebar(templateId, templateName, templateImage, eventType);
                            
                            // Visual feedback
                            this.style.setProperty('background', 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)', 'important');
                            this.innerHTML = '<i class="fas fa-check" style="margin-right: 6px; color: white !important;"></i><span style="color: white !important;">Selected</span>';
                            
                            // Reset other buttons
                            document.querySelectorAll('.template-select-btn').forEach(b => {
                                if (b !== this) {
                                    b.style.setProperty('background', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', 'important');
                                    b.innerHTML = '<i class="fas fa-check-circle" style="margin-right: 6px; color: white !important;"></i><span style="color: white !important;">Select</span>';
                                }
                            });
                        } else {
                            console.error('Missing template data:', { templateId, templateImage });
                        }
                    });
                });
            }
            
            // Setup select buttons immediately
            setupSelectButtons();
            
            // Also setup for dynamically added templates
            const templateListContainer = document.querySelector('.template-list');
            if (templateListContainer) {
                const templateObserver = new MutationObserver(function(mutations) {
                    setupSelectButtons();
                });
                templateObserver.observe(templateListContainer, { childList: true, subtree: true });
            }
            
            // Style Filter Buttons - FIXED
            const styleFilterBtns = document.querySelectorAll('.style-filter-btn');
            styleFilterBtns.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Remove active class from all buttons
                    styleFilterBtns.forEach(b => {
                        b.classList.remove('active');
                        b.style.setProperty('background', 'rgba(255,255,255,0.15)', 'important');
                        b.style.setProperty('color', 'white', 'important');
                        b.style.setProperty('border', '1px solid rgba(255,255,255,0.2)', 'important');
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    this.style.setProperty('background', 'rgba(102, 126, 234, 0.8)', 'important');
                    this.style.setProperty('color', 'white', 'important');
                    this.style.setProperty('border', 'none', 'important');
                    
                    const style = this.getAttribute('data-style');
                    console.log('Style filter clicked:', style);
                    filterTemplatesByStyle(style);
                });
            });
            
            // Template Search
            const templateSearch = document.getElementById('templateSearch');
            if (templateSearch) {
                templateSearch.addEventListener('input', function() {
                    filterTemplatesBySearch(this.value);
                });
            }
            
            // Drag and Drop for Elements
            const elementItems = document.querySelectorAll('.element-item');
            const previewCard = document.getElementById('invitationPreviewCard');
            
            elementItems.forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.getAttribute('data-element'));
                    this.style.opacity = '0.5';
                });
                
                item.addEventListener('dragend', function(e) {
                    this.style.opacity = '1';
                });
            });
            
            if (previewCard) {
                previewCard.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.style.border = '2px dashed #667eea';
                });
                
                previewCard.addEventListener('dragleave', function(e) {
                    this.style.border = '';
                });
                
                previewCard.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.border = '';
                    const elementType = e.dataTransfer.getData('text/plain');
                    addElementToPreview(elementType, e.offsetX, e.offsetY);
                });
            }
            
            // One-Tap Editing - Click element in preview to edit
            if (previewCard) {
                previewCard.addEventListener('click', function(e) {
                    const clickedElement = e.target.closest('.editable-element');
                    if (clickedElement) {
                        editElement(clickedElement);
                    }
                });
            }
            
            // Background Color Picker
            const bgColorInput = document.querySelector('#background-panel input[type="color"]');
            if (bgColorInput) {
                bgColorInput.addEventListener('change', function(e) {
                    if (previewCard) {
                        previewCard.style.backgroundColor = e.target.value;
                    }
                });
            }
            
            // Text Styling Controls
            const textFontFamily = document.getElementById('textFontFamily');
            const textFontSize = document.getElementById('textFontSize');
            const textColor = document.getElementById('textColor');
            const fontSizeValue = document.getElementById('fontSizeValue');
            
            if (textFontSize && fontSizeValue) {
                textFontSize.addEventListener('input', function(e) {
                    fontSizeValue.textContent = e.target.value + 'px';
                });
            }
            
            // Element Tab Switching (Stickers, Icons, Shapes)
            const elementTabBtns = document.querySelectorAll('.element-tab-btn');
            elementTabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    elementTabBtns.forEach(b => {
                        b.classList.remove('active');
                        b.style.background = 'rgba(255,255,255,0.1)';
                        b.style.color = 'rgba(255,255,255,0.7)';
                    });
                    this.classList.add('active');
                    this.style.background = 'rgba(255,255,255,0.2)';
                    this.style.color = 'white';
                    
                    const elementType = this.getAttribute('data-element-type');
                    loadElementsByType(elementType);
                });
            });
            
            // File Upload for Sidebar
            const sidebarFileUpload = document.getElementById('sidebarFileUpload');
            const uploadSection = document.querySelector('.upload-section');
            
            if (uploadSection && sidebarFileUpload) {
                uploadSection.addEventListener('click', function() {
                    sidebarFileUpload.click();
                });
                
                sidebarFileUpload.addEventListener('change', function(e) {
                    handleFileUpload(e.target.files);
                });
            }
        });
        
        // Add Element to Preview
        function addElementToPreview(elementType, x, y) {
            const previewCard = document.getElementById('invitationPreviewCard');
            if (!previewCard) return;
            
            const element = document.createElement('div');
            element.className = 'editable-element';
            element.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                cursor: move;
                z-index: 100;
                padding: 10px;
                background: rgba(255,255,255,0.9);
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            `;
            
            // Create icon based on element type
            const iconMap = {
                'heart': '<i class="fas fa-heart" style="font-size: 32px; color: #ff6b9d;"></i>',
                'star': '<i class="fas fa-star" style="font-size: 32px; color: #ffd700;"></i>',
                'gift': '<i class="fas fa-gift" style="font-size: 32px; color: #4ecdc4;"></i>',
                'balloon': '<i class="fas fa-birthday-cake" style="font-size: 32px; color: #ff6b6b;"></i>',
                'flower': '<i class="fas fa-flower" style="font-size: 32px; color: #ff9ff3;"></i>',
                'music': '<i class="fas fa-music" style="font-size: 32px; color: #667eea;"></i>'
            };
            
            element.innerHTML = iconMap[elementType] || '<i class="fas fa-star"></i>';
            element.setAttribute('data-element-type', elementType);
            
            // Make draggable
            makeElementDraggable(element);
            
            previewCard.appendChild(element);
        }
        
        // Make Element Draggable
        function makeElementDraggable(element) {
            let isDragging = false;
            let currentX, currentY, initialX, initialY;
            
            element.addEventListener('mousedown', function(e) {
                if (e.target.closest('.editable-element') === element) {
                    isDragging = true;
                    initialX = e.clientX - element.offsetLeft;
                    initialY = e.clientY - element.offsetTop;
                }
            });
            
            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    element.style.left = currentX + 'px';
                    element.style.top = currentY + 'px';
                }
            });
            
            document.addEventListener('mouseup', function() {
                isDragging = false;
            });
        }
        
        // Edit Element (One-Tap Editing)
        function editElement(element) {
            // Show edit panel or modal
            console.log('Editing element:', element);
            // You can add a modal or inline editor here
        }
        
        // Sync Mobile Preview with Desktop - Enhanced to copy all content properly
        function syncMobilePreview() {
            const desktopPreview = document.getElementById('invitationPreviewCard');
            const mobilePreviewCard = document.getElementById('invitationPreviewCardMobile');
            const mobilePreviewContent = document.getElementById('mobilePreviewContent');
            
            if (!desktopPreview) {
                console.warn('âš ï¸ Desktop preview card not found');
                return;
            }
            
            if (!mobilePreviewCard) {
                console.warn('âš ï¸ Mobile preview card not found');
                return;
            }
            
            console.log('ðŸ”„ Syncing mobile preview from desktop...');
            
            // Get all the content from desktop preview
            const desktopHTML = desktopPreview.innerHTML;
            const desktopStyles = desktopPreview.getAttribute('style') || '';
            const desktopClasses = desktopPreview.className;
            const desktopDataAttrs = {
                'data-event-type': desktopPreview.getAttribute('data-event-type'),
                'data-template-id': desktopPreview.getAttribute('data-template-id'),
                'data-selected-template': desktopPreview.getAttribute('data-selected-template'),
                'data-template-image': desktopPreview.getAttribute('data-template-image'),
                'data-template-image-url': desktopPreview.getAttribute('data-template-image-url')
            };
            
            // Update mobile preview card with desktop content
            mobilePreviewCard.innerHTML = desktopHTML;
            mobilePreviewCard.setAttribute('style', desktopStyles);
            mobilePreviewCard.className = desktopClasses;
            
            // Copy all data attributes
            Object.keys(desktopDataAttrs).forEach(attr => {
                if (desktopDataAttrs[attr]) {
                    mobilePreviewCard.setAttribute(attr, desktopDataAttrs[attr]);
                }
            });
            
            // Update mobile preview content container if it exists
            if (mobilePreviewContent) {
                mobilePreviewContent.innerHTML = desktopHTML;
            }
            
            // Ensure mobile preview elements have correct IDs (add Mobile suffix to avoid conflicts)
            const mobileElements = mobilePreviewCard.querySelectorAll('[id]');
            mobileElements.forEach(el => {
                const originalId = el.id;
                if (originalId && !originalId.includes('Mobile')) {
                    el.id = originalId + 'Mobile';
                }
            });
            
            // Apply mobile-specific styling - ENSURE VISIBILITY
            mobilePreviewCard.style.maxWidth = '400px';
            mobilePreviewCard.style.width = '100%';
            mobilePreviewCard.style.margin = '0 auto';
            mobilePreviewCard.style.transform = 'scale(0.85)';
            mobilePreviewCard.style.transformOrigin = 'top center';
            mobilePreviewCard.style.display = 'flex';
            mobilePreviewCard.style.setProperty('display', 'flex', 'important');
            mobilePreviewCard.style.visibility = 'visible';
            mobilePreviewCard.style.opacity = '1';
            mobilePreviewCard.style.position = 'relative';
            mobilePreviewCard.style.zIndex = '10';
            
            // Ensure all child elements are visible
            const allMobileElements = mobilePreviewCard.querySelectorAll('*');
            allMobileElements.forEach(el => {
                if (el.style) {
                    // Don't override elements that are intentionally hidden
                    if (el.style.display === 'none' && el.classList.contains('preview-placeholder')) {
                        return; // Skip placeholder
                    }
                    // Ensure other elements are visible
                    if (el.classList.contains('preview-event-name') || 
                        el.classList.contains('preview-date-time') || 
                        el.classList.contains('preview-venue') ||
                        el.classList.contains('preview-hosted') ||
                        el.classList.contains('preview-message') ||
                        el.classList.contains('preview-content')) {
                        el.style.display = '';
                        el.style.visibility = 'visible';
                        el.style.opacity = '1';
                    }
                }
            });
            
            console.log('âœ… Mobile preview synced successfully');
        }
        
        // Select Template from Sidebar - FIXED & ENHANCED
        function selectTemplateFromSidebar(templateId, templateName, templateImage, eventType) {
            console.log('ðŸŽ¨ Selecting template:', { templateId, templateName, templateImage, eventType });
            
            // Update hidden inputs
            const templateIdInput = document.getElementById('templateIdInput');
            const templateImageUrlInput = document.getElementById('templateImageUrlInput');
            const selectedTemplateInput = document.getElementById('selectedTemplate');
            
            if (templateIdInput) templateIdInput.value = templateId;
            if (templateImageUrlInput) templateImageUrlInput.value = templateImage;
            if (selectedTemplateInput) selectedTemplateInput.value = templateName;
            
            // Apply template to preview (keep user's text) - FIXED
            const previewCard = document.getElementById('invitationPreviewCard');
            const mobilePreviewCard = document.getElementById('invitationPreviewCardMobile');
            
            if (previewCard) {
                // Remove any existing background properties
                previewCard.style.removeProperty('background');
                previewCard.style.removeProperty('background-color');
                previewCard.style.removeProperty('background-image');
                
                // Normalize image URL
                let normalizedUrl = templateImage;
                if (!normalizedUrl.startsWith('http') && !normalizedUrl.startsWith('/')) {
                    normalizedUrl = '/images/templatesimages/' + normalizedUrl;
                }
                if (normalizedUrl.includes('/static/images/')) {
                    normalizedUrl = normalizedUrl.replace('/static/images/', '/images/');
                }
                
                // Set background image with proper escaping
                const escapedUrl = normalizedUrl.replace(/'/g, "\\'").replace(/"/g, '\\"');
                
                // Apply background using multiple methods to ensure it works
                previewCard.style.setProperty('background-image', `url("${escapedUrl}")`, 'important');
                previewCard.style.setProperty('background-size', '100% 100%', 'important');
                previewCard.style.setProperty('background-position', 'center center', 'important');
                previewCard.style.setProperty('background-repeat', 'no-repeat', 'important');
                previewCard.style.setProperty('background-attachment', 'scroll', 'important');
                previewCard.style.setProperty('background-color', 'transparent', 'important');
                previewCard.classList.add('template-bg');
                
                // Also set via CSS variable
                previewCard.style.setProperty('--template-bg-image-url', `url("${escapedUrl}")`);
                
                // Update data attributes
                previewCard.setAttribute('data-template-id', templateId);
                previewCard.setAttribute('data-template-image', normalizedUrl);
                previewCard.setAttribute('data-selected-template', templateName);
                
                // Force reflow and verify
                void previewCard.offsetHeight;
                
                // Verify background was applied
                setTimeout(() => {
                    const bgImage = previewCard.style.backgroundImage || window.getComputedStyle(previewCard).backgroundImage;
                    if (bgImage && bgImage !== 'none') {
                        console.log('âœ… Template applied to desktop preview:', normalizedUrl);
                    } else {
                        console.warn('âš ï¸ Background not applied, retrying...');
                        previewCard.style.backgroundImage = `url("${escapedUrl}")`;
                    }
                }, 100);
            }
            
            if (mobilePreviewCard) {
                let normalizedUrl = templateImage;
                if (!normalizedUrl.startsWith('http') && !normalizedUrl.startsWith('/')) {
                    normalizedUrl = '/images/templatesimages/' + normalizedUrl;
                }
                const escapedUrl = normalizedUrl.replace(/'/g, "\\'").replace(/"/g, '\\"');
                mobilePreviewCard.style.removeProperty('background');
                mobilePreviewCard.style.setProperty('background-image', `url("${escapedUrl}")`, 'important');
                mobilePreviewCard.style.setProperty('background-size', '100% 100%', 'important');
                mobilePreviewCard.style.setProperty('background-position', 'center center', 'important');
                mobilePreviewCard.style.setProperty('background-repeat', 'no-repeat', 'important');
                mobilePreviewCard.classList.add('template-bg');
                console.log('âœ… Template applied to mobile preview:', normalizedUrl);
            }
            
            // Highlight selected template in sidebar
            document.querySelectorAll('.template-item').forEach(item => {
                item.style.border = '2px solid transparent';
                item.style.background = 'rgba(255,255,255,0.1)';
            });
            const selectedItem = document.querySelector(`[data-template-id="${templateId}"]`);
            if (selectedItem) {
                selectedItem.style.border = '2px solid #667eea';
                selectedItem.style.background = 'rgba(102, 126, 234, 0.3)';
            }
            
            // Show event-specific fields if needed
            if (eventType) {
                if (typeof showEventSpecificFields === 'function') {
                    showEventSpecificFields(eventType);
                }
            }
            
            // Trigger preview update to ensure text is still visible
            if (typeof instantUpdatePreview === 'function') {
                setTimeout(() => {
                    instantUpdatePreview();
                }, 200);
            }
            
            // Show success feedback
            console.log('âœ… Template selected and applied successfully!');
        }
        
        // Filter Templates by Category
        function filterTemplatesByCategory(category) {
            const templateItems = document.querySelectorAll('.template-item');
            templateItems.forEach(item => {
                if (category === 'all') {
                    item.style.display = 'block';
                } else {
                    const itemCategory = item.getAttribute('data-event-type');
                    if (itemCategory === category) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                }
            });
        }
        
        // Filter Templates by Style - FIXED
        function filterTemplatesByStyle(style) {
            const templateItems = document.querySelectorAll('.template-item');
            console.log('Filtering by style:', style, 'Total templates:', templateItems.length);
            
            let visibleCount = 0;
            templateItems.forEach(item => {
                const itemStyle = (item.getAttribute('data-style') || 'normal').toLowerCase();
                const styleLower = (style || 'all').toLowerCase();
                
                let showItem = false;
                
                if (styleLower === 'all') {
                    showItem = true;
                } else {
                    // Check if style matches (case-insensitive)
                    showItem = itemStyle === styleLower || itemStyle.includes(styleLower) || styleLower.includes(itemStyle);
                }
                
                if (showItem) {
                    item.style.display = 'block';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            console.log('Visible templates after filter:', visibleCount);
            
            // Show message if no templates found
            const templateList = document.querySelector('.template-list');
            let noResultsMsg = templateList.querySelector('.no-results-message');
            if (visibleCount === 0) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.className = 'no-results-message';
                    noResultsMsg.style.cssText = 'text-align: center; color: rgba(255,255,255,0.6); padding: 30px 20px; font-size: 13px; grid-column: 1 / -1;';
                    noResultsMsg.textContent = `No templates found for "${style}" style`;
                    templateList.appendChild(noResultsMsg);
                }
            } else {
                if (noResultsMsg) {
                    noResultsMsg.remove();
                }
            }
        }
        
        // Filter Templates by Search
        function filterTemplatesBySearch(searchTerm) {
            const templateItems = document.querySelectorAll('.template-item');
            const searchLower = searchTerm.toLowerCase();
            
            templateItems.forEach(item => {
                const templateName = item.getAttribute('data-template-name').toLowerCase();
                const eventType = item.getAttribute('data-event-type').toLowerCase();
                const style = item.getAttribute('data-style').toLowerCase();
                
                if (templateName.includes(searchLower) || 
                    eventType.includes(searchLower) || 
                    style.includes(searchLower)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Load Elements by Type
        function loadElementsByType(type) {
            // This would load different elements based on type
            // For now, we'll just show/hide existing elements
            console.log('Loading elements of type:', type);
        }
        
        // Current selected shape (default: circle)
        let currentSelectedShape = 'circle';
        
        // Shape Selection Handler
        document.addEventListener('DOMContentLoaded', function() {
            const shapeButtons = document.querySelectorAll('.shape-btn');
            shapeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    shapeButtons.forEach(b => {
                        b.classList.remove('active');
                        b.style.background = 'rgba(255,255,255,0.15)';
                        b.style.border = '2px solid rgba(255,255,255,0.2)';
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    this.style.background = 'rgba(255,255,255,0.2)';
                    this.style.border = '2px solid rgba(102, 126, 234, 0.8)';
                    
                    // Update current shape
                    currentSelectedShape = this.getAttribute('data-shape');
                    console.log('Shape selected:', currentSelectedShape);
                    
                    // Apply shape to all existing images in preview
                    document.querySelectorAll('.preview-image-overlay').forEach(img => {
                        // Remove all shape classes
                        img.classList.remove('shape-circle', 'shape-square', 'shape-hexagon', 'shape-diamond', 'shape-heart', 'shape-star', 'shape-rounded', 'shape-oval');
                        // Add new shape class
                        img.classList.add('shape-' + currentSelectedShape);
                    });
                });
            });
        });
        
        // Add Image to Preview with Shape
        function addImageToPreview(imageUrl, shape) {
            const previewCard = document.getElementById('invitationPreviewCard');
            if (!previewCard) return;
            
            // Create image element with shape
            const imgContainer = document.createElement('div');
            imgContainer.className = 'preview-image-overlay shape-' + (shape || 'circle');
            imgContainer.style.cssText = 'position: absolute; cursor: move; z-index: 15;';
            
            // Random position (user can drag to reposition)
            const maxX = previewCard.offsetWidth - 120;
            const maxY = previewCard.offsetHeight - 120;
            const x = Math.random() * maxX;
            const y = Math.random() * maxY;
            
            imgContainer.style.left = x + 'px';
            imgContainer.style.top = y + 'px';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = 'width: 100%; height: 100%; object-fit: cover; display: block;';
            imgContainer.appendChild(img);
            
            // Make draggable
            makeImageDraggable(imgContainer);
            
            // Add delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = 'Ã—';
            deleteBtn.style.cssText = 'position: absolute; top: -10px; right: -10px; background: red; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 18px; z-index: 16;';
            deleteBtn.onclick = function(e) {
                e.stopPropagation();
                imgContainer.remove();
            };
            imgContainer.appendChild(deleteBtn);
            
            previewCard.appendChild(imgContainer);
            console.log('Image added to preview with shape:', shape);
        }
        
        // Make Image Draggable
        function makeImageDraggable(element) {
            let isDragging = false;
            let currentX, currentY, initialX, initialY;
            
            element.addEventListener('mousedown', function(e) {
                if (e.target.tagName === 'BUTTON') return;
                isDragging = true;
                initialX = e.clientX - (element.offsetLeft || 0);
                initialY = e.clientY - (element.offsetTop || 0);
                element.style.cursor = 'grabbing';
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                
                const previewCard = document.getElementById('invitationPreviewCard');
                if (previewCard) {
                    const maxX = previewCard.offsetWidth - element.offsetWidth;
                    const maxY = previewCard.offsetHeight - element.offsetHeight;
                    currentX = Math.max(0, Math.min(currentX, maxX));
                    currentY = Math.max(0, Math.min(currentY, maxY));
                }
                
                element.style.left = currentX + 'px';
                element.style.top = currentY + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    element.style.cursor = 'move';
                }
            });
        }
        
        // Handle File Upload
        function handleFileUpload(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const uploadedImagesGrid = document.querySelector('.uploaded-images-grid');
                        if (uploadedImagesGrid) {
                            const imgDiv = document.createElement('div');
                            imgDiv.style.cssText = 'position: relative; border-radius: 8px; overflow: hidden; cursor: pointer;';
                            imgDiv.className = 'uploaded-image-item';
                            imgDiv.setAttribute('data-image-url', e.target.result);
                            imgDiv.setAttribute('data-shape', currentSelectedShape);
                            
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.style.cssText = 'width: 100%; height: 100px; object-fit: cover;';
                            
                            const overlay = document.createElement('div');
                            overlay.style.cssText = 'position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;';
                            overlay.innerHTML = '<i class="fas fa-plus" style="color: white; font-size: 24px;"></i>';
                            
                            const deleteBtn = document.createElement('button');
                            deleteBtn.innerHTML = 'Ã—';
                            deleteBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; z-index: 10;';
                            deleteBtn.onclick = function(e) {
                                e.stopPropagation();
                                imgDiv.remove();
                            };
                            
                            imgDiv.appendChild(img);
                            imgDiv.appendChild(overlay);
                            imgDiv.appendChild(deleteBtn);
                            
                            imgDiv.addEventListener('mouseenter', () => overlay.style.opacity = '1');
                            imgDiv.addEventListener('mouseleave', () => overlay.style.opacity = '0');
                            
                            // Click to add to preview with selected shape
                            imgDiv.addEventListener('click', function(e) {
                                if (e.target === deleteBtn || e.target === overlay) return;
                                const imageUrl = this.getAttribute('data-image-url');
                                const shape = this.getAttribute('data-shape') || currentSelectedShape;
                                if (imageUrl) {
                                    addImageToPreview(imageUrl, shape);
                                }
                            });
                            
                            uploadedImagesGrid.appendChild(imgDiv);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Navigate to step - Make progress bar clickable
        window.navigateToStep = function(step) {
            const themeSelectionPage = document.getElementById('themeSelectionPage');
            const detailsFormPage = document.getElementById('detailsFormPage');
            
            if (step === 1) {
                // Navigate to templates page (occasion/event selection)
                window.location.href = '/templates';
            } else if (step === 2) {
                // Navigate to theme selection
                if (themeSelectionPage) {
                    themeSelectionPage.classList.add('active');
                    if (detailsFormPage) {
                        detailsFormPage.classList.remove('active');
                    }
                    updateProgressBar(2);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } else if (step === 3) {
                // Navigate to details form (only if template is selected)
                if (selectedThemeValue || window.selectedTemplateId) {
                    if (detailsFormPage) {
                        detailsFormPage.classList.add('active');
                        if (themeSelectionPage) {
                            themeSelectionPage.classList.remove('active');
                        }
                        updateProgressBar(3);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
            } else {
                    alert('Please select a theme first');
                }
            } else if (step === 4) {
                // Navigate to preview (not implemented yet)
                alert('Preview step not available yet');
            }
        };
        
        // Form submission - Capture all form data including template background
        // Define submitForm globally to ensure it's available for onclick handlers
        window.submitForm = function() {
            // Prevent double submission
            if (window.formSubmitting) {
                console.log('Form submission already in progress');
                return;
            }
            window.formSubmitting = true;
            
            const form = document.getElementById('invitationForm');
            if (!form) {
                console.error('Form not found');
                window.formSubmitting = false;
                return;
            }
            
            // Show loading state - only once
            const submitBtn = document.querySelector('button[onclick="submitForm()"]') || document.querySelector('.btn-preview');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.7';
                submitBtn.style.cursor = 'not-allowed';
                const originalText = submitBtn.innerHTML;
                submitBtn.setAttribute('data-original-text', originalText);
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Invitation...';
                }
            
            // Show loading overlay - only once
            if (typeof showLoadingWithIcon === 'function') {
                showLoadingWithIcon('Creating your invitation...', 'Please wait while we process your request', 'ðŸŽ‰');
            } else if (typeof showLoading === 'function') {
                showLoading('Generating your invitation...');
            }
            
            // Capture template background info before submission
            const templateIdInput = document.getElementById('templateIdInput');
            const templateImageUrlInput = document.getElementById('templateImageUrlInput');
            
            // Also check dropdown selection
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect && themeSelect.value) {
                const selectedOption = themeSelect.options[themeSelect.selectedIndex];
                if (templateIdInput) {
                    templateIdInput.value = selectedOption.value;
                }
                if (templateImageUrlInput) {
                    templateImageUrlInput.value = selectedOption.getAttribute('data-template-image') || '';
                }
            } else if (selectedTemplateId && templateIdInput) {
                templateIdInput.value = selectedTemplateId;
            }
            
            if (selectedTemplateImage && templateImageUrlInput && !templateImageUrlInput.value) {
                // Clean the URL
                let cleanUrl = selectedTemplateImage.split('?')[0].split('#')[0];
                if (!cleanUrl.startsWith('/images/') && cleanUrl.includes('templatesimages')) {
                    cleanUrl = cleanUrl.replace(/^.*?templatesimages/, '/images/templatesimages');
                }
                templateImageUrlInput.value = cleanUrl;
            }
            
            // Validate required fields before submission
            const eventTitle = form.querySelector('[name="eventTitle"]')?.value.trim();
            const eventDate = form.querySelector('[name="eventDate"]')?.value.trim();
            
            if (!eventTitle) {
                alert('Please enter an Event Name');
                window.formSubmitting = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                    const originalText = submitBtn.getAttribute('data-original-text');
                    if (originalText) {
                        submitBtn.innerHTML = originalText;
                    } else {
                        submitBtn.innerHTML = 'Preview <i class="fas fa-arrow-right"></i>';
                    }
                }
                return;
            }
            
            if (!eventDate) {
                alert('Please enter an Event Date');
                window.formSubmitting = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                    const originalText = submitBtn.getAttribute('data-original-text');
                    if (originalText) {
                        submitBtn.innerHTML = originalText;
                    } else {
                        submitBtn.innerHTML = 'Preview <i class="fas fa-arrow-right"></i>';
                    }
                }
                return;
            }
            
            console.log('Submitting form with template data:', {
                templateId: templateIdInput ? templateIdInput.value : selectedTemplateId,
                templateImage: templateImageUrlInput ? templateImageUrlInput.value : selectedTemplateImage,
                eventTitle: eventTitle,
                eventDate: eventDate
            });
            
            // Ensure form action is correct
            const formAction = form.getAttribute('action');
            console.log('Form action:', formAction);
            console.log('Form method:', form.getAttribute('method'));
            
            // Add voice message blob to form if recorded
            const voiceMessageBlob = document.getElementById('voiceMessageBlob');
            if (voiceMessageBlob && voiceMessageBlob.value && voiceMessageBlob.value.startsWith('data:')) {
                try {
                    // Convert base64 data URL to blob
                    const base64Data = voiceMessageBlob.value.split(',')[1];
                    const binaryString = atob(base64Data);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    const blob = new Blob([bytes], { type: 'audio/webm' });
                    
                    // Create a file input for the voice message
                    const voiceFileInput = document.createElement('input');
                    voiceFileInput.type = 'file';
                    voiceFileInput.name = 'voiceMessage';
                    voiceFileInput.style.display = 'none';
                    
                    // Create file from blob
                    const file = new File([blob], 'voice-message.webm', { type: 'audio/webm' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    voiceFileInput.files = dataTransfer.files;
                    
                    form.appendChild(voiceFileInput);
                    console.log('âœ… Voice message added to form');
                } catch (error) {
                    console.error('Error adding voice message to form:', error);
                }
            }
            
            // Submit form
            try {
                // Double-check form is ready
                if (!form.checkValidity()) {
                    form.reportValidity();
                    window.formSubmitting = false;
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '1';
                        submitBtn.style.cursor = 'pointer';
                        const originalText = submitBtn.getAttribute('data-original-text');
                        if (originalText) {
                            submitBtn.innerHTML = originalText;
                        } else {
                            submitBtn.innerHTML = 'Preview <i class="fas fa-arrow-right"></i>';
                        }
                    }
                    return;
                }
                
                console.log('Form is valid, submitting...');
                form.submit();
            } catch (error) {
                console.error('Error submitting form:', error);
                window.formSubmitting = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                    const originalText = submitBtn.getAttribute('data-original-text');
                    if (originalText) {
                        submitBtn.innerHTML = originalText;
                    } else {
                        submitBtn.innerHTML = 'Preview <i class="fas fa-arrow-right"></i>';
                    }
                }
                alert('Error submitting form: ' + error.message);
            }
        };

        window.goBack = function() {
            const themePage = document.getElementById('themeSelectionPage');
            if (themePage && !themePage.classList.contains('hidden')) {
                themePage.classList.add('active');
                document.getElementById('detailsFormPage').classList.remove('active');
                updateProgressBar(2);
            } else {
                window.history.back();
            }
        };
        });
        
        // Function to ensure preview content is visible on top of template background
        function ensurePreviewContentVisible() {
            const previewCard = document.getElementById('invitationPreviewCard');
            if (!previewCard) return;
            
            // Ensure all text elements are visible
            const textElements = [
                'previewEventName', 'previewDate', 'previewTime', 'previewVenue',
                'previewHosted', 'previewMessage', 'previewBrideGroom',
                'previewBirthdayPerson', 'previewCoupleNames', 'previewMotherFather',
                'previewGraduate', 'previewIcon'
            ];
            
            textElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.position = 'relative';
                    element.style.zIndex = '15';
                    // Only show if it has content
                    if (element.textContent && element.textContent.trim()) {
                        element.style.display = 'block';
                    }
                    element.style.visibility = 'visible';
                    element.style.opacity = '1';
                }
            });
            
            // Filter images based on event type instead of showing all
            const previewCardForFilter = document.getElementById('invitationPreviewCard');
            const eventTypeForFilter = previewCardForFilter ? (previewCardForFilter.getAttribute('data-event-type') || '') : '';
            if (eventTypeForFilter) {
                // Call function if available (should always be available now)
                if (typeof window.showEventSpecificImages === 'function') {
                    window.showEventSpecificImages(eventTypeForFilter);
                }
            } else {
                // If no event type, show all images (fallback)
                const imageContainers = [
                    'previewMainImageContainer', 'previewBrideGroomContainer',
                    'previewBirthdayImageContainer', 'previewCoupleImageContainer',
                    'previewGraduateImageContainer', 'previewHonoreeImageContainer'
                ];
                
                imageContainers.forEach(id => {
                    const container = document.getElementById(id);
                    if (container) {
                        const images = container.querySelectorAll('img');
                        if (images && images.length > 0) {
                            let hasVisibleImage = false;
                            images.forEach(img => {
                                if (img && img.src && img.src !== '' && !img.src.includes('data:,')) {
                                    hasVisibleImage = true;
                                    container.style.position = 'relative';
                                    container.style.zIndex = '15';
                                    container.style.setProperty('z-index', '15', 'important');
                                    container.style.display = 'block';
                                    container.style.setProperty('display', 'block', 'important');
                                    container.style.visibility = 'visible';
                                    container.style.opacity = '1';
                                    img.style.position = 'relative';
                                    img.style.zIndex = '15';
                                    img.style.setProperty('z-index', '15', 'important');
                                    img.style.display = 'block';
                                    img.style.setProperty('display', 'block', 'important');
                                    img.style.visibility = 'visible';
                                    img.style.opacity = '1';
                                    img.style.width = '100%';
                                    img.style.maxWidth = '100%';
                                    img.style.height = 'auto';
                                    img.style.objectFit = 'cover';
                                }
                            });
                            if (hasVisibleImage) {
                                container.style.display = 'block';
                                container.style.setProperty('display', 'block', 'important');
                            }
                        }
                    }
                });
            }
            
            // Ensure gallery images are visible
            const previewGallerySection = document.getElementById('previewGallerySection');
            const previewGalleryGrid = document.getElementById('previewGalleryGrid');
            if (previewGalleryGrid && previewGallerySection) {
                const galleryImages = previewGalleryGrid.querySelectorAll('img');
                if (galleryImages && galleryImages.length > 0) {
                    previewGallerySection.style.display = 'block';
                    previewGallerySection.style.setProperty('display', 'block', 'important');
                    previewGallerySection.style.visibility = 'visible';
                    previewGallerySection.style.opacity = '1';
                    previewGallerySection.style.zIndex = '20';
                    previewGallerySection.style.setProperty('z-index', '20', 'important');
                    previewGallerySection.style.position = 'relative';
                    previewGalleryGrid.style.display = 'grid';
                    previewGalleryGrid.style.setProperty('display', 'grid', 'important');
                    previewGalleryGrid.style.visibility = 'visible';
                    previewGalleryGrid.style.opacity = '1';
                    galleryImages.forEach(img => {
                        if (img && img.src && img.src !== '') {
                            img.style.display = 'block';
                            img.style.setProperty('display', 'block', 'important');
                            img.style.visibility = 'visible';
                            img.style.opacity = '1';
                            img.style.zIndex = '20';
                            img.style.setProperty('z-index', '20', 'important');
                            img.style.position = 'relative';
                        }
                    });
                    console.log('âœ… Gallery images ensured visible:', galleryImages.length);
                }
            }
            
            console.log('âœ… Preview content visibility ensured');
        }
        
        // Add event delegation for theme card clicks (replaces inline onclick to avoid HTML entity issues)
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(e) {
                const themeCard = e.target.closest('.theme-card');
                if (themeCard) {
                    const templateId = themeCard.getAttribute('data-template-id');
                    const themeId = themeCard.getAttribute('data-theme');
                    if (templateId || themeId) {
                        selectTheme(themeId, templateId, themeCard);
                    }
                }
            });
            
            // Ensure preview content is visible after DOM loads
            setTimeout(ensurePreviewContentVisible, 500);
        });

        // Image preview functions - Must be global for inline onchange handlers
        window.previewImage = function(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                    preview.innerHTML = '<img src="' + (e.target.result || '') + '" alt="Preview">';
                preview.style.display = 'block';
                // Toggle form group background when image is selected
                if (typeof toggleFormGroupBackground === 'function') {
                    toggleFormGroupBackground();
                }
                    
                    // Hide placeholder immediately when image is uploaded
                    if (typeof hidePlaceholderIfContent === 'function') {
                        hidePlaceholderIfContent();
                    }
                    
                    // Update live preview based on image type
                    const inputId = input.id;
                    const imageSrc = e.target.result;
                    
                    if (inputId === 'mainImage') {
                        // Hide placeholder immediately when image is uploaded
                        hidePlaceholderIfContent();
                        
                        // Show image shape format selector
                        const shapeFormatGroup = document.getElementById('imageShapeFormatGroup');
                        if (shapeFormatGroup) {
                            shapeFormatGroup.style.display = 'block';
                        }
                        
                        const mainImg = document.getElementById('previewMainImage');
                        const mainContainer = document.getElementById('previewMainImageContainer');
                        const mainSection = document.getElementById('previewMainImageSection') || mainContainer;
                        if (mainImg && mainContainer) {
                            mainImg.src = imageSrc;
                            mainImg.style.display = 'block';
                            mainImg.style.setProperty('display', 'block', 'important');
                            mainImg.style.visibility = 'visible';
                            mainImg.style.opacity = '1';
                            mainImg.style.marginBottom = '20px';
                            mainImg.style.border = '2px solid rgba(255, 255, 255, 0.9)';
                            mainImg.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
                            mainImg.style.zIndex = '15';
                            mainImg.style.position = 'relative';
                            
                            // Apply default shape format (rounded) or selected format
                            const shapeFormat = document.getElementById('imageShapeFormat');
                            const selectedFormat = shapeFormat ? shapeFormat.value : 'rounded';
                            applyImageShapeToElement(mainImg, selectedFormat);
                            mainImg.onerror = function() {
                                console.error('Error loading main image');
                                mainImg.style.display = 'none';
                            };
                            mainImg.onload = function() {
                                mainContainer.style.display = 'block';
                                mainContainer.style.setProperty('display', 'block', 'important');
                                mainContainer.style.visibility = 'visible';
                                mainContainer.style.opacity = '1';
                                mainContainer.style.zIndex = '15';
                                mainContainer.style.setProperty('z-index', '15', 'important');
                                // Hide icon when main image is shown
                                const previewIcon = document.getElementById('previewIcon');
                                if (previewIcon) {
                                    previewIcon.style.display = 'none';
                                }
                                console.log('Main image displayed in preview');
                            };
                            // Set z-index and display immediately
                            mainImg.style.zIndex = '15';
                            mainImg.style.setProperty('z-index', '15', 'important');
                            mainImg.style.position = 'relative';
                            mainImg.style.visibility = 'visible';
                            mainImg.style.opacity = '1';
                            if (mainSection) {
                                mainSection.style.display = 'block';
                                mainSection.style.setProperty('display', 'block', 'important');
                            }
                            mainContainer.style.zIndex = '15';
                            mainContainer.style.setProperty('z-index', '15', 'important');
                            mainContainer.style.display = 'block';
                            mainContainer.style.setProperty('display', 'block', 'important');
                            mainContainer.style.visibility = 'visible';
                            mainContainer.style.opacity = '1';
                            mainImg.style.display = 'block';
                            mainImg.style.setProperty('display', 'block', 'important');
                            // Immediate display fallback
                            setTimeout(() => {
                                if (mainImg.src) {
                                    if (mainSection) {
                                        mainSection.style.display = 'block';
                                        mainSection.style.setProperty('display', 'block', 'important');
                                    }
                                    mainContainer.style.display = 'block';
                                    mainContainer.style.setProperty('display', 'block', 'important');
                                    mainImg.style.display = 'block';
                                    mainImg.style.setProperty('display', 'block', 'important');
                                    mainImg.style.zIndex = '15';
                                    mainImg.style.setProperty('z-index', '15', 'important');
                                    mainImg.style.visibility = 'visible';
                                    mainImg.style.opacity = '1';
                                    mainContainer.style.zIndex = '15';
                                    mainContainer.style.setProperty('z-index', '15', 'important');
                                    mainContainer.style.visibility = 'visible';
                                    mainContainer.style.opacity = '1';
                                }
                            }, 100);
                        }
                    } else if (inputId === 'brideImage') {
                        const brideImg = document.getElementById('previewBrideImage');
                        const brideGroomContainer = document.getElementById('previewBrideGroomContainer');
                        if (brideImg && brideGroomContainer) {
                            brideImg.src = imageSrc;
                            brideImg.style.display = 'block';
                            brideImg.style.setProperty('display', 'block', 'important');
                            brideImg.style.zIndex = '15';
                            brideImg.style.setProperty('z-index', '15', 'important');
                            brideImg.style.position = 'relative';
                            brideImg.style.visibility = 'visible';
                            brideImg.style.opacity = '1';
                            brideGroomContainer.style.display = 'flex';
                            brideGroomContainer.style.setProperty('display', 'flex', 'important');
                            brideGroomContainer.style.zIndex = '15';
                            brideGroomContainer.style.setProperty('z-index', '15', 'important');
                            brideGroomContainer.style.visibility = 'visible';
                            brideGroomContainer.style.opacity = '1';
                            console.log('Bride image displayed in preview');
                        }
                    } else if (inputId === 'groomImage') {
                        const groomImg = document.getElementById('previewGroomImage');
                        const brideGroomContainer = document.getElementById('previewBrideGroomContainer');
                        if (groomImg && brideGroomContainer) {
                            groomImg.src = imageSrc;
                            groomImg.style.display = 'block';
                            groomImg.style.setProperty('display', 'block', 'important');
                            groomImg.style.zIndex = '15';
                            groomImg.style.setProperty('z-index', '15', 'important');
                            groomImg.style.position = 'relative';
                            groomImg.style.visibility = 'visible';
                            groomImg.style.opacity = '1';
                            brideGroomContainer.style.display = 'flex';
                            brideGroomContainer.style.setProperty('display', 'flex', 'important');
                            brideGroomContainer.style.zIndex = '15';
                            brideGroomContainer.style.setProperty('z-index', '15', 'important');
                            brideGroomContainer.style.visibility = 'visible';
                            brideGroomContainer.style.opacity = '1';
                            console.log('Groom image displayed in preview');
                        }
                    } else if (inputId === 'birthdayImage') {
                        const birthdayImg = document.getElementById('previewBirthdayImage');
                        const birthdayContainer = document.getElementById('previewBirthdayImageContainer');
                        if (birthdayImg && birthdayContainer) {
                            birthdayImg.src = imageSrc;
                            birthdayImg.style.display = 'block';
                            birthdayImg.style.setProperty('display', 'block', 'important');
                            birthdayImg.style.zIndex = '15';
                            birthdayImg.style.setProperty('z-index', '15', 'important');
                            birthdayImg.style.position = 'relative';
                            birthdayImg.style.visibility = 'visible';
                            birthdayImg.style.opacity = '1';
                            birthdayContainer.style.display = 'block';
                            birthdayContainer.style.setProperty('display', 'block', 'important');
                            birthdayContainer.style.zIndex = '15';
                            birthdayContainer.style.setProperty('z-index', '15', 'important');
                            birthdayContainer.style.visibility = 'visible';
                            birthdayContainer.style.opacity = '1';
                            console.log('Birthday image displayed in preview');
                        }
                    } else if (inputId === 'coupleImage') {
                        const coupleImg = document.getElementById('previewCoupleImage');
                        const coupleContainer = document.getElementById('previewCoupleImageContainer');
                        if (coupleImg && coupleContainer) {
                            coupleImg.src = imageSrc;
                            coupleImg.style.display = 'block';
                            coupleImg.style.setProperty('display', 'block', 'important');
                            coupleImg.style.zIndex = '15';
                            coupleImg.style.setProperty('z-index', '15', 'important');
                            coupleImg.style.position = 'relative';
                            coupleImg.style.visibility = 'visible';
                            coupleImg.style.opacity = '1';
                            coupleContainer.style.display = 'block';
                            coupleContainer.style.setProperty('display', 'block', 'important');
                            coupleContainer.style.zIndex = '15';
                            coupleContainer.style.setProperty('z-index', '15', 'important');
                            coupleContainer.style.visibility = 'visible';
                            coupleContainer.style.opacity = '1';
                            console.log('Couple image displayed in preview');
                        }
                    } else if (inputId === 'graduateImage') {
                        const graduateImg = document.getElementById('previewGraduateImage');
                        const graduateContainer = document.getElementById('previewGraduateImageContainer');
                        if (graduateImg && graduateContainer) {
                            graduateImg.src = imageSrc;
                            graduateImg.style.display = 'block';
                            graduateImg.style.setProperty('display', 'block', 'important');
                            graduateImg.style.zIndex = '15';
                            graduateImg.style.setProperty('z-index', '15', 'important');
                            graduateImg.style.position = 'relative';
                            graduateImg.style.visibility = 'visible';
                            graduateImg.style.opacity = '1';
                            graduateContainer.style.display = 'block';
                            graduateContainer.style.setProperty('display', 'block', 'important');
                            graduateContainer.style.zIndex = '15';
                            graduateContainer.style.setProperty('z-index', '15', 'important');
                            graduateContainer.style.visibility = 'visible';
                            graduateContainer.style.opacity = '1';
                            console.log('Graduate image displayed in preview');
                        }
                    } else if (inputId === 'honoreeImage') {
                        const honoreeImg = document.getElementById('previewHonoreeImage');
                        const honoreeContainer = document.getElementById('previewHonoreeImageContainer');
                        if (honoreeImg && honoreeContainer) {
                            honoreeImg.src = imageSrc;
                            honoreeImg.style.display = 'block';
                            honoreeImg.style.setProperty('display', 'block', 'important');
                            honoreeImg.style.zIndex = '15';
                            honoreeImg.style.setProperty('z-index', '15', 'important');
                            honoreeImg.style.position = 'relative';
                            honoreeImg.style.visibility = 'visible';
                            honoreeImg.style.opacity = '1';
                            honoreeContainer.style.display = 'block';
                            honoreeContainer.style.setProperty('display', 'block', 'important');
                            honoreeContainer.style.zIndex = '15';
                            honoreeContainer.style.setProperty('z-index', '15', 'important');
                            honoreeContainer.style.visibility = 'visible';
                            honoreeContainer.style.opacity = '1';
                            console.log('Honoree image displayed in preview');
                        }
                    }
                    
                    // After setting image, filter to show only event-specific images
                    const previewCard = document.getElementById('invitationPreviewCard');
                    const eventType = previewCard ? (previewCard.getAttribute('data-event-type') || '') : '';
                    if (eventType) {
                        setTimeout(() => {
                            if (typeof window.showEventSpecificImages === 'function') {
                                window.showEventSpecificImages(eventType);
                            } else if (typeof showEventSpecificImages === 'function') {
                                showEventSpecificImages(eventType);
                            }
                        }, 100);
                    }
                };
                reader.readAsDataURL(input.files[0]);
                    } else {
                preview.innerHTML = '';
                preview.style.display = 'none';
                
                // Hide corresponding preview images
                const inputId = input.id;
                if (inputId === 'mainImage') {
                    document.getElementById('previewMainImageContainer').style.display = 'none';
                } else if (inputId === 'brideImage') {
                    document.getElementById('previewBrideImage').style.display = 'none';
                    if (!document.getElementById('previewGroomImage').style.display || 
                        document.getElementById('previewGroomImage').style.display === 'none') {
                        document.getElementById('previewBrideGroomContainer').style.display = 'none';
                    }
                } else if (inputId === 'groomImage') {
                    document.getElementById('previewGroomImage').style.display = 'none';
                    if (!document.getElementById('previewBrideImage').style.display || 
                        document.getElementById('previewBrideImage').style.display === 'none') {
                        document.getElementById('previewBrideGroomContainer').style.display = 'none';
                    }
                } else if (inputId === 'birthdayImage') {
                    document.getElementById('previewBirthdayImageContainer').style.display = 'none';
                } else if (inputId === 'coupleImage') {
                    document.getElementById('previewCoupleImageContainer').style.display = 'none';
                } else if (inputId === 'graduateImage') {
                    document.getElementById('previewGraduateImageContainer').style.display = 'none';
                } else if (inputId === 'honoreeImage') {
                    document.getElementById('previewHonoreeImageContainer').style.display = 'none';
                }
            }
        }

        function previewMultipleImages(input, previewId) {
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';
            
            if (input.files && input.files.length > 0) {
                Array.from(input.files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = 'Gallery Image ' + (index + 1);
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
                preview.style.display = 'grid';
                
                // Also update live preview gallery - show at end of template
                const previewGallerySection = document.getElementById('previewGallerySection');
                const previewGalleryGrid = document.getElementById('previewGalleryGrid');
                if (previewGalleryGrid) {
                    previewGalleryGrid.innerHTML = '';
                    Array.from(input.files).forEach((file) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.alt = 'Gallery Image';
                            img.style.width = '100%';
                            img.style.height = '180px';
                            img.style.objectFit = 'cover';
                            img.style.borderRadius = '10px';
                            img.style.border = '3px solid rgba(255, 255, 255, 0.9)';
                            img.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
                            img.style.cursor = 'pointer';
                            img.style.transition = 'transform 0.3s ease, box-shadow 0.3s ease';
                            img.style.display = 'block';
                            img.style.visibility = 'visible';
                            img.style.opacity = '1';
                            img.style.position = 'relative';
                            img.style.zIndex = '25';
                            img.style.background = '#ffffff';
                            // Add hover effect
                            img.onmouseenter = function() {
                                this.style.transform = 'scale(1.05)';
                                this.style.boxShadow = '0 6px 20px rgba(0,0,0,0.4)';
                            };
                            img.onmouseleave = function() {
                                this.style.transform = 'scale(1)';
                                this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
                            };
                            previewGalleryGrid.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    });
                }
                if (previewGallerySection) {
                    previewGallerySection.style.display = 'block';
                    previewGallerySection.style.setProperty('display', 'block', 'important');
                    previewGallerySection.style.visibility = 'visible';
                    previewGallerySection.style.opacity = '1';
                    previewGallerySection.style.zIndex = '20';
                    previewGallerySection.style.setProperty('z-index', '20', 'important');
                    previewGallerySection.style.position = 'relative';
                    console.log('âœ… Gallery section displayed from previewMultipleImages');
                }
                if (previewGalleryGrid) {
                    previewGalleryGrid.style.display = 'grid';
                    previewGalleryGrid.style.setProperty('display', 'grid', 'important');
                    previewGalleryGrid.style.visibility = 'visible';
                    previewGalleryGrid.style.opacity = '1';
                }
                    } else {
                preview.style.display = 'none';
                const previewGallerySection = document.getElementById('previewGallerySection');
                if (previewGallerySection) {
                    previewGallerySection.style.display = 'none';
                    previewGallerySection.style.setProperty('display', 'none', 'important');
                }
                    }
                }
    // Emotional Features Toggle Interactions
    document.addEventListener('DOMContentLoaded', function() {
        // Personal Messages Toggle
        const personalMessagesToggle = document.querySelector('input[name="enablePersonalMessages"]');
        const personalMessagePreview = document.getElementById('personalMessagePreview');
        
        if (personalMessagesToggle) {
            personalMessagesToggle.addEventListener('change', function() {
                if (this.checked) {
                    if (personalMessagePreview) personalMessagePreview.style.display = 'block';
                    // Update toggle visual
                    const toggleSpan = this.nextElementSibling;
                    if (toggleSpan) {
                        toggleSpan.style.backgroundColor = '#667eea';
                        const toggleCircle = toggleSpan.querySelector('span');
                        if (toggleCircle) toggleCircle.style.left = '27px';
                    }
                } else {
                    if (personalMessagePreview) personalMessagePreview.style.display = 'none';
                    // Update toggle visual
                    const toggleSpan = this.nextElementSibling;
                    if (toggleSpan) {
                        toggleSpan.style.backgroundColor = '#cbd5e0';
                        const toggleCircle = toggleSpan.querySelector('span');
                        if (toggleCircle) toggleCircle.style.left = '3px';
                    }
                }
            });
        }
        
        // Countdown Toggle
        const countdownToggle = document.querySelector('input[name="enableCountdown"]');
        if (countdownToggle && countdownToggle.checked) {
            const toggleSpan = countdownToggle.nextElementSibling;
            if (toggleSpan) {
                toggleSpan.style.backgroundColor = '#667eea';
                const toggleCircle = toggleSpan.querySelector('span');
                if (toggleCircle) toggleCircle.style.left = '27px';
            }
        }
        
        if (countdownToggle) {
            countdownToggle.addEventListener('change', function() {
                const toggleSpan = this.nextElementSibling;
                if (toggleSpan) {
                    if (this.checked) {
                        toggleSpan.style.backgroundColor = '#667eea';
                        const toggleCircle = toggleSpan.querySelector('span');
                        if (toggleCircle) toggleCircle.style.left = '27px';
                    } else {
                        toggleSpan.style.backgroundColor = '#cbd5e0';
                        const toggleCircle = toggleSpan.querySelector('span');
                        if (toggleCircle) toggleCircle.style.left = '3px';
                    }
                }
            });
        }
    });
    
    // Voice Recorder Functionality
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingTimer = null;
    let recordingStartTime = null;
    const MAX_RECORDING_TIME = 15; // 15 seconds
    
    document.addEventListener('DOMContentLoaded', function() {
        const startBtn = document.getElementById('voice-record-start-btn');
        const stopBtn = document.getElementById('voice-record-stop-btn');
        const timerDisplay = document.getElementById('voice-timer');
        const timerDisplayContainer = document.getElementById('voice-timer-display');
        const audioPreview = document.getElementById('voice-audio-preview');
        const playbackSection = document.getElementById('voice-playback-section');
        const recordingControls = document.getElementById('voice-recording-controls');
        const reRecordBtn = document.getElementById('voice-rerecord-btn');
        const removeBtn = document.getElementById('voice-remove-btn');
        const voiceMessageBlob = document.getElementById('voiceMessageBlob');
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    if (audioPreview) {
                        audioPreview.src = audioUrl;
                        audioPreview.style.display = 'block';
                    }
                    
                    // Store blob data
                    if (voiceMessageBlob) {
                        // Convert blob to base64 for storage
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            voiceMessageBlob.value = reader.result;
                        };
                        reader.readAsDataURL(audioBlob);
                    }
                    
                    // Show playback section
                    if (playbackSection) playbackSection.style.display = 'block';
                    if (recordingControls) recordingControls.style.display = 'none';
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                recordingStartTime = Date.now();
                
                // Update UI
                if (startBtn) startBtn.style.display = 'none';
                if (stopBtn) stopBtn.style.display = 'block';
                if (timerDisplayContainer) timerDisplayContainer.style.display = 'block';
                
                // Start timer
                recordingTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const remaining = MAX_RECORDING_TIME - elapsed;
                    
                    if (timerDisplay) {
                        const mins = Math.floor(remaining / 60);
                        const secs = remaining % 60;
                        timerDisplay.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                    }
                    
                    if (remaining <= 0) {
                        stopRecording();
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Unable to access microphone. Please check your permissions and try again.');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            
            if (stopBtn) stopBtn.style.display = 'none';
            if (timerDisplayContainer) timerDisplayContainer.style.display = 'none';
        }
        
        function reRecord() {
            audioChunks = [];
            if (audioPreview) {
                audioPreview.src = '';
                audioPreview.style.display = 'none';
            }
            if (playbackSection) playbackSection.style.display = 'none';
            if (recordingControls) recordingControls.style.display = 'block';
            if (startBtn) startBtn.style.display = 'block';
            if (voiceMessageBlob) voiceMessageBlob.value = '';
        }
        
        function removeRecording() {
            reRecord();
        }
        
        if (startBtn) startBtn.addEventListener('click', startRecording);
        if (stopBtn) stopBtn.addEventListener('click', stopRecording);
        if (reRecordBtn) reRecordBtn.addEventListener('click', reRecord);
        if (removeBtn) removeBtn.addEventListener('click', removeRecording);
    });
    
    // Image Shape Format Functions
    function applyImageShapeToElement(imgElement, shapeFormat) {
        if (!imgElement) return;
        
        // CRITICAL: Ensure image remains visible
        imgElement.style.display = 'block';
        imgElement.style.setProperty('display', 'block', 'important');
        imgElement.style.visibility = 'visible';
        imgElement.style.opacity = '1';
        imgElement.style.setProperty('visibility', 'visible', 'important');
        imgElement.style.setProperty('opacity', '1', 'important');
        
        // Remove all shape classes
        imgElement.classList.remove('image-shape-square', 'image-shape-circle', 'image-shape-rounded', 'image-shape-rounded-lg');
        
        // Apply new shape class
        const shapeClass = 'image-shape-' + shapeFormat;
        imgElement.classList.add(shapeClass);
        
        // Apply shape-specific styles
        switch(shapeFormat) {
            case 'square':
                imgElement.style.borderRadius = '0';
                imgElement.style.width = '200px';
                imgElement.style.height = '200px';
                imgElement.style.objectFit = 'cover';
                imgElement.style.maxWidth = '200px';
                imgElement.style.maxHeight = '200px';
                imgElement.style.minWidth = '200px';
                imgElement.style.minHeight = '200px';
                break;
            case 'circle':
                imgElement.style.borderRadius = '50%';
                imgElement.style.width = '200px';
                imgElement.style.height = '200px';
                imgElement.style.objectFit = 'cover';
                imgElement.style.maxWidth = '200px';
                imgElement.style.maxHeight = '200px';
                imgElement.style.minWidth = '200px';
                imgElement.style.minHeight = '200px';
                break;
            case 'rounded':
                imgElement.style.borderRadius = '12px';
                imgElement.style.width = '200px';
                imgElement.style.height = '200px';
                imgElement.style.objectFit = 'cover';
                imgElement.style.maxWidth = '200px';
                imgElement.style.maxHeight = '200px';
                imgElement.style.minWidth = '200px';
                imgElement.style.minHeight = '200px';
                break;
            case 'rounded-lg':
                imgElement.style.borderRadius = '24px';
                imgElement.style.width = '200px';
                imgElement.style.height = '200px';
                imgElement.style.objectFit = 'cover';
                imgElement.style.maxWidth = '200px';
                imgElement.style.maxHeight = '200px';
                imgElement.style.minWidth = '200px';
                imgElement.style.minHeight = '200px';
                break;
            default:
                imgElement.style.borderRadius = '12px';
                imgElement.style.width = '200px';
                imgElement.style.height = '200px';
                imgElement.style.objectFit = 'cover';
                imgElement.style.maxWidth = '200px';
                imgElement.style.maxHeight = '200px';
                imgElement.style.minWidth = '200px';
                imgElement.style.minHeight = '200px';
        }
        
        // Ensure container is also visible
        const mainContainer = document.getElementById('previewMainImageContainer');
        if (mainContainer) {
            mainContainer.style.display = 'block';
            mainContainer.style.setProperty('display', 'block', 'important');
            mainContainer.style.visibility = 'visible';
            mainContainer.style.opacity = '1';
            mainContainer.style.setProperty('visibility', 'visible', 'important');
            mainContainer.style.setProperty('opacity', '1', 'important');
        }
        
        console.log('âœ… Image shape applied:', shapeFormat, 'Image visible:', imgElement.style.display);
    }
    
    window.applyImageShapeFormat = function() {
        const shapeFormatSelect = document.getElementById('imageShapeFormat');
        const mainImg = document.getElementById('previewMainImage');
        
        if (!shapeFormatSelect || !mainImg) {
            console.error('Shape format select or main image not found');
            return;
        }
        
        const selectedFormat = shapeFormatSelect.value;
        
        if (!selectedFormat) {
            console.error('No shape format selected');
            return;
        }
        
        // Ensure image has a source before applying shape
        if (!mainImg.src || mainImg.src === '' || mainImg.src === window.location.href) {
            console.warn('Main image has no source, cannot apply shape');
            return;
        }
        
        console.log('Applying shape format:', selectedFormat, 'to image:', mainImg.src);
        applyImageShapeToElement(mainImg, selectedFormat);
    };
    </script>
{% endblock %}


