{% extends "base.html" %}

{% block title %}Create Invitation - {{ title }}{% endblock %}

{% block extra_css %}
<style>
/* NOTE: The linter will show errors for Jinja2 template syntax */

/* ======================================== 
   TEXT VISIBILITY - COFFEE & GOLD THEME
   ======================================== */
* {
    color: #3E2723 !important;
}

h1, h2, h3, h4, h5, h6 {
    color: #5D4037 !important;
    font-weight: 700 !important;
}

.page-title, .section-title, .form-section-title {
    color: #5D4037 !important;
    font-weight: 700 !important;
    text-shadow: 0 1px 2px rgba(93, 64, 55, 0.1);
}

label, .form-label {
    color: #5D4037 !important;
    font-weight: 600 !important;
}

p, span, div {
    color: #3E2723 !important;
}

.form-control, .form-select, input, textarea, select {
    color: #3E2723 !important;
}

.btn {
    color: white !important;
}

/* Create Page Layout */
.create-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 40px 20px 80px;
    background: #FFFFFF !important;
}

/* 3-Step Progress Bar */
    .progress-bar-container {
    max-width: 700px;
    margin: 0 auto 50px;
    }

.progress-steps {
        display: flex;
        justify-content: space-between;
    align-items: center;
        position: relative;
    margin-bottom: 15px;
}

.progress-steps::before {
    content: '';
    position: absolute;
    top: 25px;
    left: 12%;
    right: 12%;
    height: 4px;
    background: #E8E8E8;
    z-index: 0;
    }

    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 1;
    flex: 1;
}

.progress-step-circle {
    width: 50px;
    height: 50px;
        border-radius: 50%;
    background: white;
    border: 3px solid #E8E8E8;
        display: flex;
        align-items: center;
        justify-content: center;
    font-weight: 700;
    font-size: 18px;
    color: #999;
        transition: all 0.3s ease;
    margin-bottom: 10px;
    }

.progress-step.active .progress-step-circle {
    border-color: var(--reddish-brown-dark);
        background: var(--reddish-brown-dark);
        color: white;
    box-shadow: 0 4px 15px rgba(93, 64, 55, 0.3);
    }

.progress-step.completed .progress-step-circle {
    border-color: var(--golden-yellow);
        background: var(--golden-yellow);
    color: var(--reddish-brown-dark);
}

.progress-step-label {
        font-size: 14px;
    color: #5D4037 !important;
    font-weight: 600;
        text-align: center;
    }

.progress-step.active .progress-step-label {
        color: #3E2723 !important;
    font-weight: 700;
}

/* Content Grid */
.content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    align-items: start;
}

/* Left Panel - Template Selection & Form */
.left-panel {
    display: flex;
    flex-direction: column;
    gap: 30px;
}

.step-content {
    display: none;
}

.step-content.active {
    display: block;
}

/* Theme Gallery */
.themes-container {
    background: white;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.themes-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
}

.themes-header h3 {
    font-size: 24px;
    font-weight: 700;
        color: #5D4037 !important;
    margin: 0;
}

.themes-grid {
        display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 20px;
    max-height: 500px;
    overflow-y: auto;
    padding-right: 10px;
    }

    .theme-card {
    position: relative;
    border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
    transition: all 0.3s ease;
    border: 3px solid transparent;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .theme-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .theme-card.selected {
    border-color: var(--golden-yellow);
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
}

.theme-preview-image {
        width: 100%;
    height: 180px;
        object-fit: cover;
        display: block;
}

.theme-card-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(93, 64, 55, 0.95), transparent) !important;
    padding: 15px 10px;
    color: white !important;
    font-size: 14px !important;
    font-weight: 700 !important;
    text-align: center;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5) !important;
    z-index: 10 !important;
    opacity: 1 !important;
    display: block !important;
    visibility: visible !important;
}

/* Form Container */
.form-container {
    background: white;
    padding: 35px;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.form-section-title {
    font-size: 20px;
        font-weight: 700;
    color: var(--reddish-brown-dark);
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-section-title i {
    color: var(--golden-yellow);
}

.form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

.form-group label {
        display: block;
        font-weight: 600;
    color: #5D4037 !important;
        margin-bottom: 8px;
    font-size: 14px;
}

.form-control {
        width: 100%;
    padding: 12px 15px;
    border: 2px solid #E8E8E8;
        border-radius: 10px;
    font-size: 14px;
    transition: all 0.3s ease;
}

.form-control:focus {
        border-color: var(--reddish-brown-dark);
    outline: none;
    box-shadow: 0 0 0 3px rgba(93, 64, 55, 0.1);
    }

textarea.form-control {
    min-height: 100px;
        resize: vertical;
}

/* Navigation Buttons */
.form-navigation {
    display: flex;
    justify-content: space-between;
    gap: 15px;
    margin-top: 30px;
}

.btn-nav {
    flex: 1;
    padding: 15px 30px;
    border: none;
    border-radius: 50px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
        display: flex;
        align-items: center;
    justify-content: center;
        gap: 10px;
    }

.btn-prev {
    background: #F5F5F5;
    color: var(--reddish-brown-dark);
}

.btn-prev:hover {
    background: #E8E8E8;
    transform: translateX(-3px);
}

.btn-next, .btn-submit {
    background: var(--reddish-brown-dark);
    color: white;
}

.btn-next:hover, .btn-submit:hover {
    background: var(--reddish-brown);
    transform: translateX(3px);
    box-shadow: 0 6px 20px rgba(93, 64, 55, 0.3);
}

/* Right Panel - Live Preview */
.right-panel {
    position: sticky;
    top: 100px;
}

.preview-container {
    background: white;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.preview-header h3 {
    font-size: 22px;
    font-weight: 700;
    color: #5D4037 !important;
    color: var(--reddish-brown-dark);
    margin: 0;
}

.invitation-preview {
    width: 100%;
    aspect-ratio: 9/16;
    border-radius: 15px;
    background: #FFFFFF !important;  /* Clean white background */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 30px;
    text-align: center;
    position: relative;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
}

/* Template Background - ALWAYS VISIBLE */
.template-background-image {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    z-index: 0 !important;
    opacity: 1 !important;
    display: block !important;
    visibility: visible !important;
    filter: brightness(1) contrast(1) !important;
    background: none !important;
}

/* Ensure all preview text is visible on templates */
.invitation-preview > *:not(.template-background-image) {
    position: relative;
    z-index: 1;
    color: #FFFFFF;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }

    .preview-event-name {
    font-size: clamp(24px, 5vw, 32px);
        font-weight: 700;
    color: #FFFFFF;
    margin: 15px 0;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8), 0 0 10px rgba(0, 0, 0, 0.5);
    background: rgba(0, 0, 0, 0.3);
    padding: 10px 20px;
    border-radius: 10px;
}

.preview-details {
    font-size: clamp(12px, 3vw, 14px);
    color: #FFFFFF;
    margin: 8px 0;
    display: flex;
        align-items: center;
        gap: 8px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8), 0 0 8px rgba(0, 0, 0, 0.5);
    background: rgba(0, 0, 0, 0.25);
    padding: 8px 15px;
    border-radius: 8px;
    display: inline-block;
}

.preview-icon {
    font-size: 18px;
    color: #FFFFFF;
    filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.8));
    }

    .preview-message {
    font-size: clamp(13px, 3.5vw, 16px);
    color: #FFFFFF;
        margin-top: 20px;
        font-style: italic;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
}

.preview-placeholder {
    color: #999;
    font-size: 16px;
}

.preview-host-name {
    font-size: clamp(14px, 3.5vw, 18px);
    color: #FFFFFF;
    margin-top: 20px;
    font-weight: 600;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
}

/* Event-Specific Fields */
.wedding-fields {
    display: none;
}

.wedding-fields.active {
    display: block;
}

/* Image Upload */
.image-upload-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
}

.image-upload-box {
    border: 2px dashed #E8E8E8;
    border-radius: 10px;
    padding: 30px 20px;
        text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.image-upload-box:hover {
    border-color: var(--golden-yellow);
    background: rgba(212, 175, 55, 0.05);
}

.image-upload-box i {
    font-size: 36px;
    color: var(--golden-yellow);
    margin-bottom: 10px;
}

.image-upload-box p {
    margin: 0;
    font-size: 13px;
    color: #666;
}

.image-upload-box input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
        width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.image-preview {
        width: 100%;
    max-height: 150px;
        object-fit: cover;
        border-radius: 8px;
    margin-top: 10px;
}

/* Font & Language Selection */
.style-selection {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .content-grid {
        grid-template-columns: 1fr;
    }
    
    .right-panel {
        position: static;
        order: -1;
    }
    
    .themes-grid {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 15px;
    }
}

@media (max-width: 768px) {
    .create-container {
        padding: 20px 15px 60px;
    }
    
    .progress-bar-container {
        margin-bottom: 30px;
    }
    
    .progress-step-circle {
        width: 40px;
        height: 40px;
        font-size: 16px;
    }
    
    .progress-step-label {
        font-size: 12px;
    }
    
    .themes-container,
    .form-container,
    .preview-container {
        padding: 20px;
    }
    
    .form-row,
    .image-upload-container,
    .style-selection {
        grid-template-columns: 1fr !important;
    }
    
    .themes-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .theme-preview-image {
        height: 150px;
    }
    
    .invitation-preview {
        aspect-ratio: 9/16;
        padding: 20px;
    }
    
    .form-navigation {
        flex-direction: column;
    }
    
    .btn-nav {
        width: 100%;
    }
}

@media (max-width: 480px) {
    .progress-steps::before {
        left: 8%;
        right: 8%;
    }
    
    .themes-header h3,
    .form-section-title,
    .preview-header h3 {
        font-size: 18px;
    }
    
    .themes-grid {
        max-height: 400px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="create-container">
    <!-- Progress Bar -->
    <div class="progress-bar-container">
        <div class="progress-steps">
            <div class="progress-step active" id="progressStep1">
                <div class="progress-step-circle">1</div>
                <div class="progress-step-label">Choose Template</div>
    </div>
            <div class="progress-step" id="progressStep2">
                <div class="progress-step-circle">2</div>
                <div class="progress-step-label">Add Details</div>
    </div>
            <div class="progress-step" id="progressStep3">
                <div class="progress-step-circle">3</div>
                <div class="progress-step-label">Preview & Submit</div>
        </div>
            </div>
    </div>

    <!-- Content Grid -->
    <div class="content-grid">
        <!-- Left Panel -->
        <div class="left-panel">
            <form method="POST" action="{{ url_for('create_invitation') }}" enctype="multipart/form-data" id="invitationForm">
                {{ form.hidden_tag() }}
                
                <!-- Hidden inputs for template selection -->
                <input type="hidden" id="templateIdInput" name="template_id" value="">
                <input type="hidden" id="templateImageUrlInput" name="template_image_url" value="">
                <input type="hidden" id="autoColorTheme" name="auto_color_theme" value="">
                
                <!-- Step 1: Template Selection -->
                <div class="step-content active" id="step1">
                    <div class="themes-container">
                        <div class="themes-header">
                            <h3><i class="fas fa-palette me-2"></i>Choose Your Template</h3>
                        </div>
                        <div class="themes-grid">
            {% if templates %}
                {% for template in templates %}
                                <div class="theme-card" 
                                     data-template-id="{{ template.id }}"
                                     data-template-image="{{ template.preview_image }}"
                                     onclick="selectTheme('{{ template.id }}', this)">
                                    <img src="/static{{ template.preview_image }}" 
                         alt="{{ template.name }}" 
                                         class="theme-preview-image"
                                         loading="lazy">
                                    <div class="theme-card-overlay">{{ template.name }}</div>
    </div>
                {% endfor %}
    {% else %}
                                <p class="text-center">No templates available for this event type.</p>
                            {% endif %}
    </div>
    </div>

        <div class="form-navigation">
                        <button type="button" class="btn-nav btn-next" onclick="nextStep()">
                Continue <i class="fas fa-arrow-right"></i>
                        </button>
        </div>
        </div>

                <!-- Step 2: Event Details -->
                <div class="step-content" id="step2">
                    <div class="form-container">
                        <div class="form-section-title">
                            <i class="fas fa-info-circle"></i> Event Details
    </div>
                    
                    <div class="form-group">
                            <label for="eventName">Event Name *</label>
                            {{ form.title(class="form-control", id="eventName", placeholder="e.g., John's 30th Birthday", required=True, oninput="updatePreview()") }}
                    </div>

                        <div class="form-row">
                    <div class="form-group">
                                <label for="eventDate">Event Date *</label>
                                {{ form.event_date(class="form-control", id="eventDate", required=True, oninput="updatePreview()") }}
                    </div>
                        <div class="form-group">
                                <label for="eventTime">Event Time *</label>
                                {{ form.event_time(class="form-control", id="eventTime", required=True, oninput="updatePreview()") }}
                </div>
                </div>

                        <div class="form-group">
                            <label for="venue">Venue *</label>
                            {{ form.venue(class="form-control", id="venue", placeholder="e.g., Grand Ballroom Hotel", required=True, oninput="updatePreview()") }}
                </div>

                <div class="form-group">
                            <label for="hostName">Host Name *</label>
                            {{ form.host_name(class="form-control", id="hostName", placeholder="Hosted by...", required=True, oninput="updatePreview()") }}
            </div>

                        <div class="form-group">
                            <label for="message">Personal Message</label>
                            {{ form.message(class="form-control", id="message", placeholder="Add a special message...", oninput="updatePreview()") }}
                </div>

                        <!-- Wedding-Specific Fields -->
                        <div class="wedding-fields" id="weddingFields">
                            <div class="form-section-title" style="margin-top: 30px;">
                                <i class="fas fa-ring"></i> Couple Details
                    </div>

                            <div class="form-row">
                    <div class="form-group">
                                    <label for="brideName">Bride's Name</label>
                                    {{ form.bride_name(class="form-control", id="brideName", placeholder="Bride's Name", oninput="updatePreview()") }}
                    </div>
                    <div class="form-group">
                                    <label for="groomName">Groom's Name</label>
                                    {{ form.groom_name(class="form-control", id="groomName", placeholder="Groom's Name", oninput="updatePreview()") }}
                    </div>
                    </div>

                            <div class="image-upload-container">
                                <div class="image-upload-box">
                                    <i class="fas fa-image"></i>
                                    <p>Bride's Photo</p>
                                    {{ form.bride_image(id="brideImage", onchange="previewImage(this, 'bridePreview')") }}
                                    <img id="bridePreview" class="image-preview" style="display:none;">
                </div>
                                <div class="image-upload-box">
                                    <i class="fas fa-image"></i>
                                    <p>Groom's Photo</p>
                                    {{ form.groom_image(id="groomImage", onchange="previewImage(this, 'groomPreview')") }}
                                    <img id="groomPreview" class="image-preview" style="display:none;">
                        </div>
                        </div>
                    </div>
                        
                        <!-- Main Image Upload (Non-Wedding) -->
                        <div class="form-group" id="mainImageUpload">
                            <label>Event Image</label>
                            <div class="image-upload-box">
                                <i class="fas fa-camera"></i>
                                <p>Upload Image</p>
                                {{ form.main_image(id="mainImage", onchange="previewImage(this, 'mainPreview')") }}
                                <img id="mainPreview" class="image-preview" style="display:none;">
                        </div>
                        </div>
                        
                        <!-- RSVP Contact -->
                        <div class="form-section-title" style="margin-top: 30px;">
                            <i class="fas fa-address-book"></i> RSVP Contact
                </div>

                        <div class="form-row">
                        <div class="form-group">
                                <label for="rsvpMobile">Mobile Number</label>
                                {{ form.rsvp_contact(class="form-control", id="rsvpMobile", placeholder="+1 234 567 8900", type="tel") }}
                        </div>
                        <div class="form-group">
                                <label for="rsvpEmail">Email Address</label>
                                {{ form.rsvp_email(class="form-control", id="rsvpEmail", placeholder="rsvp@example.com", type="email") }}
                    </div>
                </div>

                        <!-- Style Selection -->
                        <div class="form-section-title" style="margin-top: 30px;">
                            <i class="fas fa-paint-brush"></i> Styling
                    </div>

                        <div class="style-selection">
                        <div class="form-group">
                                <label for="language">Language</label>
                                {{ form.language(class="form-control", id="language") }}
                        </div>
                        <div class="form-group">
                                <label for="fontStyle">Font Style</label>
                                {{ form.font_style(class="form-control", id="fontStyle") }}
                        </div>
                    </div>
                </div>

                    <div class="form-navigation">
                        <button type="button" class="btn-nav btn-prev" onclick="prevStep()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <button type="button" class="btn-nav btn-next" onclick="nextStep()">
                            Continue <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Review & Submit -->
                <div class="step-content" id="step3">
                    <div class="form-container">
                        <div class="form-section-title">
                            <i class="fas fa-check-circle"></i> Review Your Invitation
                        </div>
                        <p style="color: #666; margin-bottom: 30px;">
                            Check the preview on the right and make sure everything looks perfect. You can go back to edit if needed.
                        </p>
                </div>

                    <div class="form-navigation">
                        <button type="button" class="btn-nav btn-prev" onclick="prevStep()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <button type="submit" class="btn-nav btn-submit">
                            <i class="fas fa-paper-plane"></i> Create Invitation
                        </button>
                    </div>
                        </div>
                </form>
                        </div>

        <!-- Right Panel - Live Preview -->
        <div class="right-panel">
            <div class="preview-container">
                <div class="preview-header">
                    <h3><i class="fas fa-eye me-2"></i>Live Preview</h3>
                    </div>
                <div class="invitation-preview" id="invitationPreview">
                    <img src="" alt="Template Background" class="template-background-image" id="templateBackgroundImage" style="display:none;">
                    <div class="preview-icon" id="previewIcon">ðŸŽ‰</div>
                    <div class="preview-event-name" id="previewEventName">Your Event Name</div>
                    <div class="preview-details" id="previewDate">
                        <i class="fas fa-calendar"></i> Select Date
                        </div>
                    <div class="preview-details" id="previewTime">
                        <i class="fas fa-clock"></i> Select Time
                        </div>
                    <div class="preview-details" id="previewVenue">
                        <i class="fas fa-map-marker-alt"></i> Venue Location
                    </div>
                    <div class="preview-message" id="previewMessage"></div>
                    <div class="preview-host-name" id="previewHost">Hosted by...</div>
                </div>
            </div>
        </div>
            </div>
        </div>

{# Hidden data container for server-injected values #}
<div id="serverData" style="display:none;">
    <script type="application/json" id="serverDataJson">
    {
        "eventType": {{ event_type|tojson|safe if event_type else '""' }},
        "templateId": {{ template_id|tojson|safe if template_id else 'null' }},
        "templates": {{ templates|tojson|safe if templates else '[]' }}
    }
    </script>
            </div>
{% endblock %}

{% block extra_scripts %}
<script>
// @ts-ignore - Suppress linter errors for this file
// Global variables
let selectedTemplateId = null;
let selectedTemplateImage = null;

// Read server data from JSON script tag
const serverDataJson = document.getElementById('serverDataJson');
const SERVER_DATA = serverDataJson ? JSON.parse(serverDataJson.textContent) : {
    eventType: '',
    templateId: null,
    templates: []
};

// Event type from server
var currentEventType = SERVER_DATA.eventType ? String(SERVER_DATA.eventType).toLowerCase() : '';

// Icon mapping
const eventIcons = {
    'birthday': 'ðŸŽ‚',
    'wedding': 'ðŸ’',
    'anniversary': 'ðŸ’‘',
    'babyshower': 'ðŸ‘¶',
    'graduation': 'ðŸŽ“',
    'retirement': 'ðŸŽ‰'
};

// Theme selection
window.selectTheme = function(templateId, element) {
    document.querySelectorAll('.theme-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    element.classList.add('selected');
    selectedTemplateId = String(templateId);
    selectedTemplateImage = element.getAttribute('data-template-image');
    
    console.log('âœ… Template selected:', {id: selectedTemplateId, image: selectedTemplateImage});
    
    // Set form inputs
        const templateIdInput = document.getElementById('templateIdInput');
        const templateImageUrlInput = document.getElementById('templateImageUrlInput');
    if (templateIdInput) templateIdInput.value = String(selectedTemplateId);
    if (templateImageUrlInput) templateImageUrlInput.value = String(selectedTemplateImage);
    
    // Save to sessionStorage
    sessionStorage.setItem('selectedTemplateId', selectedTemplateId);
    sessionStorage.setItem('selectedTemplateImage', selectedTemplateImage);
    
    // Apply template background immediately
    applyTemplateBackground();
};

// Apply template background image
function applyTemplateBackground() {
    const templateBg = document.getElementById('templateBackgroundImage');
    if (!templateBg) return;
    
    if (selectedTemplateImage && selectedTemplateImage !== '') {
        let imagePath = selectedTemplateImage;
        
        // Normalize path
        if (!imagePath.startsWith('http') && !imagePath.startsWith('/')) {
            imagePath = '/static/images/templatesimages/' + imagePath;
        }
        if (imagePath.startsWith('/images/')) {
            imagePath = '/static' + imagePath;
        }
        
        console.log('ðŸŽ¨ Applying template background:', imagePath);
        templateBg.src = imagePath;
        templateBg.style.display = 'block';
        templateBg.style.visibility = 'visible';
        templateBg.style.opacity = '0.95';
    } else {
        templateBg.style.display = 'none';
    }
}

// Show event-specific fields
function showEventSpecificFields() {
    const weddingFields = document.getElementById('weddingFields');
    const mainImageUpload = document.getElementById('mainImageUpload');
    
    if (currentEventType === 'wedding' || currentEventType === 'anniversary') {
        weddingFields.classList.add('active');
        mainImageUpload.style.display = 'none';
        } else {
        weddingFields.classList.remove('active');
        mainImageUpload.style.display = 'block';
    }
    
    // Update icon
    const previewIcon = document.getElementById('previewIcon');
    if (previewIcon && eventIcons[currentEventType]) {
        previewIcon.textContent = eventIcons[currentEventType];
    }
}

// Update live preview
function updatePreview() {
    const eventName = document.getElementById('eventName').value || 'Your Event Name';
    const eventDate = document.getElementById('eventDate').value;
    const eventTime = document.getElementById('eventTime').value;
    const venue = document.getElementById('venue').value || 'Venue Location';
    const message = document.getElementById('message').value;
    const hostName = document.getElementById('hostName').value || 'Hosted by...';
    
    document.getElementById('previewEventName').textContent = eventName;
    document.getElementById('previewDate').innerHTML = `<i class="fas fa-calendar"></i> ${eventDate || 'Select Date'}`;
    document.getElementById('previewTime').innerHTML = `<i class="fas fa-clock"></i> ${eventTime || 'Select Time'}`;
    document.getElementById('previewVenue').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${venue}`;
    document.getElementById('previewMessage').textContent = message;
    document.getElementById('previewHost').textContent = hostName;
}

// Image preview
window.previewImage = function(input, previewId) {
        const preview = document.getElementById(previewId);
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
            preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        
        // Auto color theme extraction (for main image)
        if (input.id === 'mainImage' && input.files[0]) {
            extractColorsFromImage(input.files[0]);
        }
    }
};

// Extract dominant colors from uploaded image
function extractColorsFromImage(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let r = 0, g = 0, b = 0, count = 0;
            for (let i = 0; i < data.length; i += 4) {
                r += data[i];
                g += data[i + 1];
                b += data[i + 2];
                count++;
            }
            
            r = Math.floor(r / count);
            g = Math.floor(g / count);
            b = Math.floor(b / count);
            
            const dominantColor = `rgb(${r}, ${g}, ${b})`;
            console.log('ðŸŽ¨ Dominant color extracted:', dominantColor);
            
            // Store in hidden input
            document.getElementById('autoColorTheme').value = dominantColor;
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// Step navigation
let currentStep = 1;

function nextStep() {
    if (currentStep === 1 && !selectedTemplateId) {
        alert('Please select a template first!');
        return;
    }
    
    if (currentStep < 3) {
        document.getElementById(`step${currentStep}`).classList.remove('active');
        document.getElementById(`progressStep${currentStep}`).classList.remove('active');
        document.getElementById(`progressStep${currentStep}`).classList.add('completed');
        
        currentStep++;
        
        document.getElementById(`step${currentStep}`).classList.add('active');
        document.getElementById(`progressStep${currentStep}`).classList.add('active');
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function prevStep() {
    if (currentStep > 1) {
        document.getElementById(`step${currentStep}`).classList.remove('active');
        document.getElementById(`progressStep${currentStep}`).classList.remove('active');
        
        currentStep--;
        
        document.getElementById(`step${currentStep}`).classList.add('active');
        document.getElementById(`progressStep${currentStep}`).classList.remove('completed');
        document.getElementById(`progressStep${currentStep}`).classList.add('active');
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ Page loaded, initializing...');
    showEventSpecificFields();
    
    // Check if template was passed from URL - Using SERVER_DATA
    if (SERVER_DATA.templateId && SERVER_DATA.templates.length > 0) {
        const urlTemplateId = String(SERVER_DATA.templateId);
        console.log('ðŸ” Checking URL template ID:', urlTemplateId);
        
        for (const template of SERVER_DATA.templates) {
            if (String(template.id) === urlTemplateId) {
                selectedTemplateId = String(template.id);
                
                // Normalize template image path
                let templateImg = template.preview_image || '';
                if (templateImg && !templateImg.startsWith('http')) {
                    if (templateImg.startsWith('/images/')) {
                        // Already correct
                    } else if (templateImg.startsWith('/static/images/')) {
                        templateImg = templateImg.replace('/static/images/', '/images/');
                    } else if (templateImg.includes('templatesimages')) {
                        if (!templateImg.startsWith('/')) {
                            templateImg = '/images/' + templateImg;
                        }
                    } else if (!templateImg.startsWith('/')) {
                        templateImg = '/images/templatesimages/' + templateImg;
                    }
                }
                selectedTemplateImage = templateImg;
                
                console.log('âœ… Template from URL:', {id: selectedTemplateId, image: selectedTemplateImage});
                
                // Set form inputs
                const templateIdInput = document.getElementById('templateIdInput');
                const templateImageUrlInput = document.getElementById('templateImageUrlInput');
                if (templateIdInput && selectedTemplateId) {
                    templateIdInput.value = String(selectedTemplateId);
                }
                if (templateImageUrlInput && selectedTemplateImage) {
                    templateImageUrlInput.value = String(selectedTemplateImage);
                }
                
                // Apply template immediately with retries
                if (selectedTemplateImage) {
                    setTimeout(() => applyTemplateBackground(), 100);
                    setTimeout(() => applyTemplateBackground(), 500);
                }
                                break;
            }
        }
    }
    
    // Check sessionStorage
    const storedId = sessionStorage.getItem('selectedTemplateId');
    const storedImage = sessionStorage.getItem('selectedTemplateImage');
    
    if (storedId && storedImage) {
        selectedTemplateId = storedId;
        let imagePath = storedImage;
        selectedTemplateImage = imagePath;
        
                    const templateIdInput = document.getElementById('templateIdInput');
                    const templateImageUrlInput = document.getElementById('templateImageUrlInput');
        if (templateIdInput) templateIdInput.value = String(storedId);
        if (templateImageUrlInput) templateImageUrlInput.value = String(imagePath);
        
        const templateCard = document.querySelector(`.theme-card[data-template-id="${storedId}"]`);
        if (templateCard) {
            templateCard.classList.add('selected');
        }
        
        applyTemplateBackground();
    }
});
    </script>
{% endblock %}
